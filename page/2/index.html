<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>SatanWoo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="SatanWoo">
<meta property="og:url" content="http://satanwoo.github.io/page/2/index.html">
<meta property="og:site_name" content="SatanWoo">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SatanWoo">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="SatanWoo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">SatanWoo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/sitemap.xml">map</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://satanwoo.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-DXXcodeConsoleUnicodePlugin" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/14/DXXcodeConsoleUnicodePlugin/" class="article-date">
  <time datetime="2016-03-13T16:18:52.000Z" itemprop="datePublished">2016-03-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/14/DXXcodeConsoleUnicodePlugin/">DXXcodeConsoleUnicodePluginæºç è§£æ</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="Xcodeæ’ä»¶å¼€å‘">Xcodeæ’ä»¶å¼€å‘</h4><p>å˜¿å˜¿ï¼Œä»Šå¤©å¸¦å¤§å®¶å­¦ä¹ ä¸€ä¸‹åŸºäºXcodeçš„æ’ä»¶å¼€å‘ã€‚å¯èƒ½å¾ˆå¤šäººä¸€å¬åˆ°æ’ä»¶å¼€å‘ï¼Œæƒ³åˆ°çš„éƒ½æ˜¯Sublime Textï¼ŒAtomè¿™æ ·è½»é‡çº§çš„ç¼–è¾‘å™¨çš„æ‰©å±•æ’ä»¶ï¼Œä½†æ˜¯å®é™…ä¸Šï¼Œæ— è®ºæ˜¯VisualStudio, Eclipseä»¥åŠXcodeè¿™æ ·é‡é‡çº§çš„IDEï¼Œéƒ½æ˜¯æ”¯æŒè‡ªå®šä¹‰çš„æ’ä»¶å¼€å‘çš„ã€‚å­¦ä¹ å¥½äº†Xcodeçš„æ’ä»¶å¼€å‘ï¼Œä¸ä»…å¯ä»¥æ‰“é€ åº¦èº«å®šåšçš„<strong>ç¥å™¨</strong>ï¼Œä¹Ÿæœ‰åŠ©äºä½ å°†æ¥è¿›è¡Œ<strong>Mac OS</strong>çš„åº”ç”¨å¼€å‘ã€‚</p>
<h4 id="DXXcodeConsoleUnicodePlugin">DXXcodeConsoleUnicodePlugin</h4><p>DXXcodeConsoleUnicodePluginæ˜¯ä¸€ä¸ªå¸®åŠ©ä½ è‡ªåŠ¨å°†<code>\u6061</code>è¿™æ ·çš„unicodeç è½¬æ¢æˆå¯¹åº”çš„æ±‰å­—çš„æ’ä»¶ã€‚</p>
<p>è¿™ä¸ªæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿæƒ³æƒ³çœ‹ï¼Œæˆ‘ä»¬åœ¨ç½‘ç»œä¼ è¾“çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨å¦‚æœè¿”å›çš„æ•°æ®æ˜¯ä¸­æ–‡ï¼ˆ<strong>æˆ–è€…éASCIIç </strong>ï¼‰ï¼Œé€šè¿‡NSLogåœ¨consoleè¾“å‡ºçš„å†…å®¹æ˜¯ä¸ç›´è§‚çš„ï¼ŒåŸºæœ¬éƒ½æ˜¯ç±»ä¼¼<code>\u6061</code>è¿™ç§ï¼Œè¿™å¯¹äºæˆ‘ä»¬å¼€å‘è°ƒè¯•æ¥è¯´æ˜¯éå¸¸å›°éš¾çš„ã€‚</p>
<p>å› æ­¤ï¼Œè¿™æ¬¾æ’ä»¶å¯ä»¥è‡ªåŠ¨å¸®åŠ©æˆ‘ä»¬å°†æ£€æµ‹åˆ°çš„Unicodeå­—ç¬¦è¿›è¡Œè½¬æ¢ï¼Œç›´æ¥è¾“å‡ºæˆæˆ‘ä»¬æƒ³è¦çš„å¯¹åº”å†…å®¹ã€‚æ€ä¹ˆæ ·ï¼Ÿè®©æˆ‘ä»¬èµ¶å¿«æ¥ä¸€æ¢ç©¶ç«Ÿå§ï¼</p>
<p><strong> åœ¨å¼€å§‹æ¢è®¨å®ç°ä¹‹å‰ï¼Œæˆ‘ä¸ªäººé¦–å…ˆå¼ºè°ƒä¸€ç‚¹ï¼ŒåŸºäºUnicodeæ£€æµ‹å¯¹åº”çš„å­—ç¬¦æ˜¯ä¸€ä¸ªéå¸¸éš¾çš„é—®é¢˜ã€‚ä¸ä»…ä»…æ˜¯ä¸­æ–‡ï¼ŒéŸ©æ–‡ã€æ—¥æ–‡ã€big-5å­—ç¬¦ç­‰ç­‰éƒ½å±äºUnicodeï¼Œè¿™äº›å­—ç¬¦é›†ä¹‹é—´å¥½å¸¸å¸¸æœ‰äº¤é›†ã€‚ç°æœ‰æ¯”è¾ƒå¥½çš„å¼€æºå®ç°æ˜¯</strong>Mozillaçš„UcharSet**ã€‚</p>
<h4 id="å®ç°">å®ç°</h4><p>é¦–å…ˆæ‰“å¼€å·¥ç¨‹ï¼Œæ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š</p>
<ul>
<li>DXXcodeConsoleUnicodePlugin.h/.m</li>
<li>RegExCategories.h/.m</li>
</ul>
<p>å…¶ä¸­ï¼Œ<code>DXXcodeConsoleUnicodePlugin</code>æ˜¯å…¥å£ã€‚åŒä¼ ç»Ÿçš„iOS/Mac OSå¼€å‘ä¸åŒï¼Œæ’ä»¶å¼€å‘å¹¶ä¸å­˜åœ¨ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„mainå‡½æ•°ï¼Œæ›´å¤šçš„æ˜¯åˆ©ç”¨æ‰€è°“çš„<code>Template Method</code>è®¾è®¡æ¨¡å¼å°†ä½ éœ€è¦çš„è‡ªå®šä¹‰éƒ¨åˆ†è¿›è¡Œå¤å†™ã€‚</p>
<p>äºæ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä¸‰æ®µå‡½æ•°ï¼š</p>
<pre><code>+ (<span class="keyword">void</span>)pluginDidLoad:(<span class="built_in">NSBundle</span> *)plugin
{
  <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;
  <span class="built_in">NSString</span> *currentApplicationName = [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][<span class="string">@"CFBundleName"</span>];
  <span class="keyword">if</span> ([currentApplicationName isEqual:<span class="string">@"Xcode"</span>]) {
    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^{
      sharedPlugin = [[<span class="keyword">self</span> alloc] initWithBundle:plugin];

      [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span>
                                               selector:<span class="keyword">@selector</span>(menuDidChange)
                                                   name:<span class="built_in">NSMenuDidChangeItemNotification</span>
                                                 object:<span class="literal">nil</span>];
    });
  }
}

- (<span class="keyword">id</span>)initWithBundle:(<span class="built_in">NSBundle</span> *)plugin
{
  <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) {
    <span class="comment">// reference to plugin's bundle, for resource acccess</span>
    <span class="keyword">self</span><span class="variable">.bundle</span> = plugin;

    <span class="comment">// Create menu items, initialize UI, etc.</span>

    <span class="comment">// Sample Menu Item:</span>
    [<span class="keyword">self</span> createMenu];

    I<span class="built_in">MP_IDEConsoleItem_initWithAdaptorType</span> = ReplaceInstanceMethod(<span class="built_in">NSClassFromString</span>(<span class="string">@"IDEConsoleItem"</span>), <span class="keyword">@selector</span>(initWithAdaptorType:content:kind:),
                                                                   [XcodeConsoleUnicode_IDEConsoleItem class], <span class="keyword">@selector</span>(initWithAdaptorType:content:kind:));
  }

  <span class="keyword">return</span> <span class="keyword">self</span>;
}

- (<span class="keyword">void</span>)createMenu
{
  <span class="built_in">NSMenuItem</span> *menuItem = [[<span class="built_in">NSApp</span> mainMenu] itemWithTitle:<span class="string">@"Edit"</span>];
  <span class="keyword">if</span> (menuItem &amp;&amp; !<span class="keyword">self</span><span class="variable">.convertInConsoleItem</span>) {
    [[menuItem submenu] addItem:[<span class="built_in">NSMenuItem</span> separatorItem]];

    <span class="built_in">NSMenuItem</span> *convertItem = [[<span class="built_in">NSMenuItem</span> alloc] initWithTitle:<span class="string">@"ConvertUnicode"</span> action:<span class="keyword">@selector</span>(convertAction) keyEquivalent:<span class="string">@"c"</span>];
    [convertItem setKeyEquivalentModifierMask:<span class="built_in">NSAlternateKeyMask</span>];
    [convertItem setTarget:<span class="keyword">self</span>];
    [[menuItem submenu] addItem:convertItem];

    <span class="keyword">self</span><span class="variable">.convertInConsoleItem</span> = [[<span class="built_in">NSMenuItem</span> alloc] initWithTitle:<span class="string">@"ConvertUnicodeInConsole"</span>
                                                           action:<span class="keyword">@selector</span>(convertUnicodeInConsoleAction)
                                                    keyEquivalent:<span class="string">@""</span>];
    [<span class="keyword">self</span><span class="variable">.convertInConsoleItem</span> setTarget:<span class="keyword">self</span>];
    [[menuItem submenu] addItem:<span class="keyword">self</span><span class="variable">.convertInConsoleItem</span>];

    sIsConvertInConsoleEnabled = [[<span class="built_in">NSUserDefaults</span> standardUserDefaults] boolForKey:sConvertInConsoleEnableKey];
    <span class="keyword">if</span> (sIsConvertInConsoleEnabled) {
      <span class="keyword">self</span><span class="variable">.convertInConsoleItem</span><span class="variable">.state</span> = <span class="built_in">NSOnState</span>;
    } <span class="keyword">else</span> {
      <span class="keyword">self</span><span class="variable">.convertInConsoleItem</span><span class="variable">.state</span> = <span class="built_in">NSOffState</span>;
    }
  }
}
</code></pre><p>ä¸Šé¢ä¸‰æ®µå‡½æ•°æˆ‘ä»¬ä¸€ä¸€è¿›è¡Œè§£æã€‚</p>
<ol>
<li><p><code>pluginDidLoad</code>ï¼Œå¤§å®¶å¯ä»¥ç†è§£ä¸ºæ’ä»¶çš„ç¨‹åºå…¥å£ï¼Œåœ¨è¿™ä¸ªå…¥å£ä¸­æˆ‘ä»¬é€šè¿‡å•ä¾‹è¿›è¡Œæˆ‘ä»¬è‡ªå·±å¼€å‘çš„æ’ä»¶åŠ è½½ã€‚**ä¹‹æ‰€ä»¥ä½¿ç”¨å•ä¾‹æ˜¯å› ä¸ºè¿™ä¸ª<code>pluginDidLoad</code>å¯èƒ½ä¼šç”±äºåŠ è½½å¤šä¸ªæ’ä»¶è€Œè¢«å¤šæ¬¡è§¦å‘ã€‚</p>
</li>
<li><p><code>initWithBundle</code>å‡½æ•°æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰æ’ä»¶çš„æ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬é€šè¿‡å®ƒè¿›è¡Œè‡ªå·±ä»»åŠ¡çš„åˆ›å»ºå’Œè°ƒç”¨ã€‚</p>
</li>
<li><p><code>createMenu</code>åˆ™æ˜¯å¯¹Xcodeç¼–è¾‘å™¨ä¸Šçš„èœå•æ·»åŠ å±äºæˆ‘ä»¬è‡ªå·±çš„é€‰é¡¹ã€‚</p>
</li>
</ol>
<p>åœ¨è¿™é‡Œï¼Œä½œè€…åœ¨<strong>Edit</strong>èœå•ä¸‹åˆ›å»ºäº†å±äºè‡ªå·±çš„<strong>ConvertUnicode</strong>ä»¥åŠ<strong>ConvertUnicodeInConsole</strong>ï¼Œå¹¶å¯¹è¿™äº›é€‰é¡¹è¿›è¡Œäº†å¿«æ·é”®ç»‘å®šã€‚</p>
<p>è¿™äº›ä¸œè¥¿ï¼Œé™¤äº†è‡ªå®šä¹‰çš„èœå•é¡¹åŠæ“ä½œéœ€è¦æˆ‘ä»¬è‡ªå·±å†™ä»¥å¤–ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡<code>Plugin Template</code>è¿™ä¸ªæ’ä»¶è‡ªåŠ¨ç”Ÿæˆã€‚</p>
<p>åˆ°ç°åœ¨ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰çœ‹åˆ°ä»»ä½•å®è´¨æ€§çš„è½¬æ¢å†…å®¹ï¼Œåˆ«æ€¥ï¼Œåœ¨<code>initWithBundle</code>ä¸­ï¼Œä½œè€…é€šè¿‡<strong>Method Swizzling</strong>å°†<code>IDEConsoleItem</code>çš„<code>- (id)initWithAdaptorType:(id)arg1 content:(id)arg2 kind:(int)arg3</code>å’Œè‡ªå·±å®ç°çš„<code>XcodeConsoleUnicode_IDEConsoleItem</code>è¿›è¡Œçš„è°ƒæ¢ã€‚</p>
<p>ç„¶ååœ¨æ›¿æ¢åçš„æ–¹æ³•ä¸­ï¼Œå®ç°è§£æï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>- (<span class="keyword">id</span>)initWithAdaptorType:(<span class="keyword">id</span>)arg1 content:(<span class="keyword">id</span>)arg2 kind:(<span class="keyword">int</span>)arg3
{
  <span class="keyword">id</span> item = I<span class="built_in">MP_IDEConsoleItem_initWithAdaptorType</span>(<span class="keyword">self</span>, _cmd, arg1, arg2, arg3);

  <span class="keyword">if</span> (sIsConvertInConsoleEnabled) {
    <span class="built_in">NSString</span> *logText = [item valueForKey:<span class="string">@"content"</span>];
    <span class="built_in">NSString</span> *resultText = [DXXcodeConsoleUnicodePlugin convertUnicode:logText];
    [item setValue:resultText forKey:<span class="string">@"content"</span>];
  }

  <span class="keyword">return</span> item;
}
</code></pre><p>è¿™ä¸ªæ–¹æ³•éå¸¸ç®€å•ï¼Œé€šè¿‡åŸæ–¹æ³•è·å–consoleä¸­çš„<strong>item</strong>ï¼Œå¹¶è·å–å¯¹åº”çš„<strong>content</strong>è¿›è¡Œè§£æã€‚è€Œè§£æä¹Ÿä»…ä»…æ˜¯é‡‡ç”¨äº†<code>UTF8StringEncoding</code>ç›´æ¥è¿›è¡Œè½¬æ¢ã€‚</p>
<h4 id="è¡¥å……çŸ¥è¯†ï¼šNSRegularExpressionå’Œæ­£åˆ™è¡¨è¾¾å¼">è¡¥å……çŸ¥è¯†ï¼šNSRegularExpressionå’Œæ­£åˆ™è¡¨è¾¾å¼</h4><p>åœ¨æœ¬æ–‡çš„å®ç°å½“ä¸­ï¼Œä½œè€…å¯¹äºä¸­æ–‡å­—ç¬¦çš„Unicodeçš„è¡¨è¾¾æ–¹å¼<strong>\u4582</strong>è¿™æ ·çš„æ ¼å¼ï¼Œé‡‡ç”¨äº†æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œäº†æå–ã€‚åœ¨ä¼ ç»Ÿçš„Unicodeçš„æ ¼å¼ä¸­ï¼Œ<strong>å•ç‹¬ä¸€ä¸ª<code>\</code></strong>è¡¨ç¤ºä¸ºè½¬ä¹‰å­—ç¬¦ï¼Œä¸èƒ½ç›´æ¥è¡¨è¾¾ä¸€èˆ¬å­—ç¬¦ã€‚æ‰€ä»¥ï¼Œåœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é‡‡ç”¨<strong><code>\\</code></strong>æ¥è¡¨ç¤ºä¸€ä¸ª<code>\</code>ã€‚åŒæ—¶ï¼Œå¯¹äº4582è¿™æ ·çš„å­—ç¬¦ï¼Œæˆ‘ä»¬å½“ç„¶å¯ä»¥è®¤ä¸ºå…¶æ¨¡å¼ä¸ºå››ä¸ªè¿ç»­çš„å­—ç¬¦ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é‡‡ç”¨<code>\w{4}</code>ã€‚ï¼ˆ<strong>åˆ‡è®°ï¼Œä¸èƒ½é‡‡ç”¨<code>\W</code></strong>ã€‚å¤§å†™çš„<code>\W</code>è¡¨å¾çš„æ˜¯éå­—ç¬¦ã€‚ï¼‰ç„¶å<code>{4}</code>è¡¨ç¤ºå‰é¢çš„æ¨¡å¼é‡å¤<strong>4æ¬¡</strong>ï¼Œå³<code>\w</code>è¿ç»­å‡ºç°4æ¬¡ã€‚</p>
<p>å¥½äº†ï¼Œç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬ä¸éš¾å†™å‡ºé’ˆå¯¹ä¸­æ–‡Unicodeæå–çš„æ­£åˆ™è¡¨è¾¾å¼ï¼š<strong><code>\\u\w{4}</code></strong></p>
<p>ä½†æ˜¯ï¼Œåœ¨ä½œè€…çš„ä»£ç ä¸­ï¼Œä½œè€…çš„æ­£åˆ™è¡¨è¾¾å¼å´æ˜¯ï¼š<code>\\\\[uU]\\w{4}</code>ï¼Œé‚£è¿™ä¸ªæ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ<br>åŸå› åœ¨äºï¼Œ å¯¹äºåœ¨å­—ç¬¦ä¸²å½¢å¼å‡ºç°çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œé¦–å…ˆè§£æçš„æ˜¯å­—ç¬¦ä¸²è§„åˆ™ï¼Œç„¶åæ‰æ˜¯æ­£åˆ™è¡¨è¾¾å¼å¼•æ“çš„è§£æã€‚</p>
<p>æ‰€ä»¥ï¼Œ<code>\\\\</code>è¢«å­—ç¬¦ä¸²è§£ææˆ<code>\\</code>ï¼Œç„¶åæ­£åˆ™è§£ææˆ<code>\</code>ã€‚ç„¶åå¯¹äº<code>[uU]</code>ï¼Œæ˜¯ä¸€ä¸ªç»„ï¼Œè¡¨ç¤ºæˆ–è€…uæˆ–è€…Uï¼Œå› ä¸ºæœ‰äº›è¾“å‡ºçš„æ–‡æœ¬é‡Œï¼Œå¯¹äºUçš„å¤§å°å†™å¹¶æ²¡æœ‰è§„å®šï¼Œæ‰€ä»¥ä¸¤ç§æƒ…å†µéƒ½éœ€è¦è€ƒè™‘ã€‚</p>
<p>åé¢çš„å°±ä¸å†èµ˜è¿°äº†ï¼ŒåŸç†ä¸€è‡´ã€‚å¤§å®¶æœ‰å…´è¶£çš„è‡ªå·±æ·±å…¥å­¦ä¹ ä¸‹å§ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2016/03/14/DXXcodeConsoleUnicodePlugin/" data-id="cjqdxq21u003dmxi13xars6hn" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2016/03/14/DXXcodeConsoleUnicodePlugin/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-check-manifest" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/27/check-manifest/" class="article-date">
  <time datetime="2016-02-27T10:23:21.000Z" itemprop="datePublished">2016-02-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/27/check-manifest/">Check Pods Manifest.lock</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>åˆæ¬¡çœ‹åˆ°è¿™ä¸ªé¢˜ç›®çš„ä½ ï¼Œå¯èƒ½è¿˜ä¸äº†è§£è¿™æ˜¯ä¸ªå•¥ã€‚ä½†æ˜¯ï¼Œæˆ‘æƒ³ä¸‹é¢è¿™ä¸ªé”™è¯¯æç¤ºï¼Œä½ è‚¯å®šä¼šéå¸¸ç†Ÿæ‚‰ï¼š</p>
<pre><code><span class="keyword">error</span>: The sandbox <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">in</span> sync <span class="keyword">with</span> <span class="keyword">the</span>  
Podfile.lock. Run 'pod install' <span class="keyword">or</span> update 
your CocoaPods installation.
</code></pre><p>æ²¡é”™ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨<code>cocoapods</code>çš„æ—¶å€™ï¼Œç»å¸¸ä¼šé‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ã€‚å…¶åŸå› åœ¨äºæˆ‘ä»¬æœ¬åœ°çš„<code>manifest.lock</code>å’Œé€šè¿‡<code>git</code>åŒæ­¥çš„<code>Pod.lock</code>çš„äº§ç”Ÿäº†å·®å¼‚ã€‚</p>
<p><strong>æ³¨ï¼šmanifest.lockç®€å•å¯ä»¥ç†è§£ä¸ºæˆ‘ä»¬åœ¨æœ¬åœ°æ‰§è¡Œä¸€æ¬¡<code>pod install</code>åç”Ÿæˆçš„å½“å‰Podfileçš„çŠ¶æ€çš„è¡¨å¾æ–‡ä»¶ã€‚è€ŒPod.lockæ˜¯åŒæ­¥ä»–äººæ›´æ–°è¿‡Podfileåçš„çŠ¶æ€ã€‚</strong></p>
<p>é‚£ä¹ˆï¼Œè¿™ä¸ªå·®å¼‚æŠ¥é”™çš„åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥æ‰“å¼€Xcodeé¡¹ç›®ä¸­å¯¹åº”çš„<code>Target</code>çš„<code>Build Phase</code>ï¼Œå¯ä»¥å‘ç°ï¼Œå…¶ä¸­å­˜åœ¨åœ¨ä¸€é¡¹åä¸º<code>Check Pods Manifest.lock</code>ï¼Œæ˜¯ä¸€ä¸ª<code>shell script</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code>// <span class="number">1.</span>
diff <span class="string">"${PODS_ROOT}/../Podfile.lock"</span> <span class="string">"${PODS_ROOT}/Manifest.lock"</span> &gt; /dev/null

// <span class="number">2.</span>
<span class="keyword">if</span> <span class="string">[[ $? != 0 ]]</span> ; <span class="keyword">then</span>

// <span class="number">3.</span>
    cat &lt;&lt; EOM
<span class="built_in">error</span>: The sandbox is <span class="keyword">not</span> <span class="keyword">in</span> sync with the Podfile.lock. Run <span class="string">'pod install'</span> <span class="keyword">or</span> update your CocoaPods installation.
EOM
    exit <span class="number">1</span>
fi
</code></pre><p>æˆ‘ä»¬æ¥è§£è¯»ä¸‹è¿™æ®µä»£ç çš„æ„æ€ï¼š</p>
<ol>
<li><p>é€šè¿‡diffå‘½ä»¤æ¥æ£€æŸ¥<code>Podfile.lock</code>å’Œ<code>Manifest.lock</code>çš„åŒºåˆ«ã€‚è¿™ä¸ªå‘½ä»¤ä¸­çš„<code>&gt; /dev/null</code> å¯ä»¥è§†ä¸ºä¸€ä¸ª<strong>é»‘æ´</strong>ï¼Œç­‰ä»·äºä¸€ä¸ªåªè¯»æ–‡ä»¶ï¼Œæ‰€æœ‰å†™å…¥å®ƒçš„å†…å®¹éƒ½ä¼šæ°¸è¿œä¸¢å¤±. è€Œå°è¯•ä»å®ƒé‚£å„¿è¯»å–å†…å®¹åˆ™ä»€ä¹ˆä¹Ÿè¯»ä¸åˆ°ã€‚ç”±äºåœ¨æ‰§è¡Œ<code>diff</code>å‘½ä»¤çš„è¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿå¤§é‡çš„æ ‡å‡†è¾“å‡ºï¼Œå¯èƒ½ä¼šå¹²æ‰°æˆ‘ä»¬çš„çš„å·¥ä½œæµç¨‹æ‰§è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å®ƒä»¬å…¨éƒ¨ä¸¢å¼ƒç»™<strong>é»‘æ´</strong>ï¼Œåªå…³å¿ƒ<strong>è¿”å›å€¼</strong>ã€‚</p>
</li>
<li><p><code>if [[ $? != 0 ]] then</code>è¿™ä¸ªå‘½ä»¤æŒ‡çš„ä¸Šä¸€ä¸ªå‘½ä»¤çš„è¿”å›å€¼å¦‚æœä¸ç­‰äº0ï¼Œå°±æ‰§è¡Œxxxxã€‚å…¶ä¸­$?ä¹Ÿå°±ä»£è¡¨ç€ä¸Šä¸€ä¸ªå‘½ä»¤<code>diff</code>çš„è¿”å›å€¼ã€‚</p>
</li>
<li><p>å¥½ï¼Œå¦‚æœè¿”å›å€¼ä¸ä¸º0ï¼Œè¯´æ˜æœ‰å·®å¼‚ï¼Œå› æ­¤é€šè¿‡<code>cat &lt;&lt; EOM</code> å’Œ <code>EOM</code>å°†å¤„äºè¿™ä¸¤è€…ä¹‹å‰çš„å†…å®¹è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºã€‚</p>
</li>
</ol>
<h3 id="æ”¹é€ è„šæœ¬">æ”¹é€ è„šæœ¬</h3><p>å¥½ï¼Œæ—¢ç„¶æˆ‘ä»¬å·²ç»è¯»æ‡‚äº†ä¸Šè¿°çš„<code>shell script</code>ï¼Œæˆ‘ä»¬ä¸å¦‚å°†è¿™ä¸ªé”™è¯¯çš„æç¤ºæ¥è¿›è¡Œæ•´æ”¹ï¼Œå½“æœ‰å·®å¼‚çš„æƒ…å†µä¸‹ï¼Œè‡ªåŠ¨å»è¿›è¡Œ<code>pod install</code>ã€‚</p>
<p>æ•´ä½“æ”¹é€ åçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code><span class="comment">// 1.</span>
diff <span class="string">"<span class="subst">${PODS_ROOT}</span>/../Podfile.lock"</span> <span class="string">"<span class="subst">${PODS_ROOT}</span>/Manifest.lock"</span> &gt; /dev/<span class="keyword">null</span>

<span class="comment">// 2.</span>
<span class="keyword">if</span> [[ $? != <span class="number">0</span> ]] ; then

<span class="comment">// 3.</span>
    pod install --project-directory=<span class="string">"<span class="subst">${PODS_ROOT}</span>/../"</span>
fi
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2016/02/27/check-manifest/" data-id="cjqdxq1y20013mxi1hhmnfcms" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2016/02/27/check-manifest/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell/">shell</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-pod-install-plugin" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/27/pod-install-plugin/" class="article-date">
  <time datetime="2016-02-27T10:23:09.000Z" itemprop="datePublished">2016-02-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/27/pod-install-plugin/">å¼€å‘ä¸€ä¸ªç®€å•çš„Pod Install æ’ä»¶</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>å‰å‡ å¤©åˆšåˆšç²—ç•¥äº†å­¦ä¹ äº†ä¸€ä¸‹Xcodeçš„æ’ä»¶å¼€å‘ï¼Œä¸€æ—¶å¿ƒç—’ï¼Œå°±å‡†å¤‡åšä¸ªç®€å•çš„æ’ä»¶ç»ƒç»ƒæ‰‹ã€‚</p>
<p>å“å“Ÿæˆ‘æ“¦ï¼Œæ­£å½“æˆ‘å‡†å¤‡å¤§å±•èº«æ‰‹çš„æ—¶å€™ï¼Œæˆ‘çªç„¶æƒ³åˆ°æˆ‘è¯¥åšä¸ªå•¥å‘¢?  æˆ‘è¿™çœŸæ˜¯æœ‰äº†ç¨‹åºå‘˜ï¼Œåªå·®ä¸€ä¸ªå¥½Ideaäº†ã€‚</p>
<p>å¥½å§ï¼Œæ­£å·§è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘å‘ç°æˆ‘å’Œæœ‹å‹åä½œçš„ä¸€ä¸ªiOSé¡¹ç›®åœ¨ä¸¤ä¸ªåˆ†æ”¯ä¸ŠåŒæ­¥å¼€å‘ï¼Œæ¯æ¬¡è¦åˆå¹¶åæ‹‰ä¸‹åˆ†æ”¯ï¼Œéƒ½å‘ç°Pod.lockæ–‡ä»¶éƒ½äº§ç”Ÿäº†å˜åŒ–ï¼Œæ— æ³•ç¼–è¯‘æˆåŠŸã€‚æ¯å½“è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘éƒ½è¦è¿›å…¥<code>terminal</code>è¾“å…¥ä¸€å¤§å †çš„<code>cd ..</code>è¿›å…¥å¯¹åº”çš„æ–‡ä»¶ç›®å½•æ‰§è¡Œ<code>pod install</code>å‘½ä»¤ï¼Œç”šæ˜¯ç¹çã€‚</p>
<p>å½“ç„¶å•¦ï¼Œä½ å¯ä»¥é€šè¿‡<code>alias</code> é…ç½®å¿«é€Ÿçš„æ‰§è¡Œå‘½ä»¤ï¼Œä½†æ˜¯ï¼Œä½ ä»ç„¶å¾—åˆ‡æ¢å‡ºXcodeçš„çª—å£ï¼Œå¯¹äºæˆ‘ä»¬è¿™ç§æ•ˆç‡æ§æ¥è¯´ä¸èƒ½æ¥å—ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘å°±æƒ³åˆ°äº†ï¼Œåœ¨Xcodeä¸­åˆ©ç”¨æ’ä»¶é›†æˆä¸€ä¸‹å…³äºpodçš„ä¸€äº›åŠŸèƒ½ï¼ŒåŒæ—¶ç»‘å®šå¿«æ·é”®æé«˜æ“ä½œæ•ˆç‡ã€‚</p>
<p>è¯´å¹²å°±å¹²ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬åˆ©ç”¨Xcodeçš„plugin templateç”Ÿæˆé¡¹ç›®çš„ä¸€äº›åŸºæœ¬æµç¨‹ç»“æ„ã€‚å…³äºæ’ä»¶çš„å…·ä½“æ€è·¯å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« ã€ŠDXXcodeConsoleUnicodePluginæºç è§£æã€‹</p>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç€é‡ä»‹ç»ä¸€ä¸‹åˆ©ç”¨ <code>NSTask</code> å»æ‰§è¡Œè¯¸å¦‚<code>pod install</code>è¿™æ ·çš„å‘½ä»¤ã€‚</p>
<h4 id="å®ç°æ€è·¯">å®ç°æ€è·¯</h4><p>åœ¨å®ç°çœŸæ­£çš„<code>Objective-C</code>ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆç°åœ¨<code>terminal</code>ä¸­éšä¾¿æ‰¾ä¸ªå®‰å…¨çš„ç›®å½•æ•²å…¥<code>pod install</code>æ¥è¯•è¯•çœ‹ç»“æœï¼Œå¦‚ä¸‹æ‰€è¯´ï¼š</p>
<pre><code>pod install
[!] <span class="keyword">No</span> <span class="label">`Podfile'</span> found <span class="keyword">in</span> the project directory.
</code></pre><p>ä»è¿™ä¸ªé”™è¯¯æç¤ºä¸­æˆ‘ä»¬å¯ä»¥å¤§è‡´äº†è§£ï¼Œ<code>pod install</code>çš„å‘½ä»¤ä¾èµ–äºæ‰€è°“çš„<code>Podfile</code>ã€‚äºæ˜¯ï¼Œæˆ‘ä»¬è¾“å…¥<code>pod install --help</code>æŸ¥çœ‹å…¶å¯¹åº”çš„å¸®åŠ©æ‰‹å†Œï¼š</p>
<pre><code>-<span class="ruby">-project-directory=<span class="regexp">/project/dir</span><span class="regexp">/   The path to the root of the project
</span></span>                                       directory
-<span class="ruby"><span class="regexp">-no-clean                          Leave SCM dirs like `.git` and `.svn`
</span></span>                                       intact after downloading
-<span class="ruby"><span class="regexp">-no-integrate                      Skip integration of the Pods libraries
</span></span>                                       in the Xcode project(s)
-<span class="ruby"><span class="regexp">-no-repo-update                    Skip running `pod repo update` before
</span></span>                                       install
-<span class="ruby"><span class="regexp">-silent                            Show nothing
</span></span>-<span class="ruby"><span class="regexp">-verbose                           Show more debugging information
</span></span>-<span class="ruby"><span class="regexp">-no-ansi                           Show output without ANSI codes
</span></span>-<span class="ruby"><span class="regexp">-help                              Show help banner of specified command</span></span>
</code></pre><p>ä»ç¬¬ä¸€æ¡å¸®åŠ©å‘½ä»¤å¼ ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡<strong>â€“project-directory=</strong>æ¥è®¾ç½®<code>pod install</code>çš„æ ¹ç›®å½•ï¼Œä¹Ÿå³<code>Podfile</code>çš„æ‰€åœ¨ã€‚</p>
<p>å¥½ï¼Œäº‹æƒ…åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬åœ¨ç¼–å†™æ’ä»¶å‰éœ€è¦çš„å‡†å¤‡å·¥ä½œå°±åŸºæœ¬å®Œæˆäº†ï¼Œæˆ‘ä»¬ç°åœ¨åªéœ€åˆ©ç”¨<code>NSTask</code>å°†æˆ‘ä»¬åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥çš„å‘½ä»¤æ‰§è¡Œå³å¯ã€‚</p>
<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ç°çš„ä»£ç ï¼š</p>
<pre><code> <span class="comment">// 1.</span>
 [<span class="keyword">self</span> searchMainProjectPath];

 <span class="comment">// 2.</span>
 <span class="built_in">NSTask</span> *podInstallAction = [[<span class="built_in">NSTask</span> alloc] init];
 podInstallAction<span class="variable">.currentDirectoryPath</span> = <span class="keyword">self</span><span class="variable">.mainProjectPath</span>;
 podInstallAction<span class="variable">.arguments</span> = @[<span class="string">@"install"</span>];
 podInstallAction<span class="variable">.launchPath</span> = <span class="string">@"/usr/bin/pod"</span>;

 <span class="comment">// 3.</span>
 <span class="built_in">NSPipe</span> *pipeOut = [<span class="built_in">NSPipe</span> pipe];
 [podInstallAction setStandardOutput:pipeOut];
 <span class="built_in">NSFileHandle</span> *output = [pipeOut fileHandleForReading];

 [output setReadabilityHandler:^(<span class="built_in">NSFileHandle</span> * _Nonnull fileHandler) {
   <span class="built_in">NSData</span> *data = [fileHandler availableData];
   <span class="built_in">NSString</span> *text = [[<span class="built_in">NSString</span> alloc] initWithData:data encoding:<span class="built_in">NSASCIIStringEncoding</span>];

   <span class="built_in">NSLog</span>(<span class="string">@"text is %@"</span>, text);
 }];

[podInstallAction launch];
[podInstallAction waitUntilExit];
</code></pre><ol>
<li>æˆ‘ä»¬é¦–å…ˆè¦å¯»æ‰¾åˆ°å½“å‰é¡¹ç›®çš„ä¸»ç›®å½•ï¼Œä¹Ÿå°±æ˜¯<code>Podfile</code>çš„è·¯å¾„</li>
<li>ç„¶åæˆ‘ä»¬æ„å»ºNSTaskï¼Œå°†å…¶çš„æ‰§è¡Œç›®å½•è®¾ç½®æˆæˆ‘ä»¬çš„ä¸»ç›®å½•ï¼Œç„¶å<code>/usr/bin</code>ä¸­è°ƒå‡º<code>pod</code>çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰§è¡Œ<code>pod install</code>ã€‚</li>
<li>æˆ‘ä»¬åˆ©ç”¨NSPipeå°†é»˜è®¤çš„NSTaskçš„è¾“å‡º(stdout)é‡å®šå‘åˆ°æˆ‘ä»¬çš„æŒ‡å®šçš„åœ°æ–¹ï¼Œè¿™æ ·æœ‰åŠ©äºæˆ‘ä»¬æŸ¥çœ‹logæˆ–è€…è¿›è¡Œæµç¨‹å·¥ç¨‹ã€‚</li>
</ol>
<p>åˆ°è¿™é‡Œï¼ŒåŸºæœ¬ä¸Šä¸€ä¸ªç®€å•çš„å°æ’ä»¶å°±å®Œæˆäº†ï¼Œä½†æ˜¯æˆ‘åœ¨è¿™é‡Œæƒ³è¦å¼ºè°ƒä¸€ç‚¹å…³äºä¸»å·¥ç¨‹è·¯å¾„æœç´¢çš„ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä»£ç ï¼š</p>
<pre><code><span class="built_in">NSArray</span> *workspaceWindowControllers = [<span class="built_in">NSClassFromString</span>(<span class="string">@"IDEWorkspaceWindowController"</span>) workspaceWindowControllers];
[workspaceWindowControllers enumerateObjectsUsingBlock:^(<span class="keyword">id</span> controller, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) {
  <span class="keyword">if</span> ([[controller valueForKey:<span class="string">@"window"</span>] isMainWindow]) {
    <span class="keyword">id</span> workspace = [controller valueForKey:<span class="string">@"_workspace"</span>];
    <span class="built_in">NSString</span> *filePath = [[workspace valueForKey:<span class="string">@"representingFilePath"</span>] valueForKey:<span class="string">@"pathString"</span>];
    <span class="built_in">NSString</span> *projectName = [[filePath lastPathComponent] stringByDeletingPathExtension];
    <span class="built_in">NSLog</span>(<span class="string">@"CocoaPodUI::ProjectName::%@"</span>, projectName);

    <span class="built_in">NSString</span> *text = [[filePath stringByDeletingLastPathComponent] stringByAppendingPathComponent:<span class="string">@"Podfile"</span>];

    <span class="keyword">self</span><span class="variable">.mainProjectPath</span> = [filePath stringByDeletingLastPathComponent];

    <span class="built_in">NSLog</span>(<span class="string">@"pod ifle is %@"</span>, text);
  }
}];
</code></pre><p><strong>åŸºäºXcodeçš„æ’ä»¶å¼€å‘å®é™…ä¸Šåˆ©ç”¨äº†å¤§é‡çš„ç§æœ‰å¤´æ–‡ä»¶ã€‚ç”±äºObjective-Cè‘—åçš„runtimeç‰¹æ€§ï¼Œå› æ­¤ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨key-value-codingçš„æ–¹å¼è·å–æˆ‘ä»¬æ™®é€šé€”å¾„ä¸‹æ— æ³•å¾—åˆ°çš„ç»“æœã€‚<br>åŒæ—¶ï¼Œå½“æœ‰ä¸€ä¸ªç±»çš„æ–¹æ³•æ˜¯ç§æœ‰æ–¹æ³•çš„æ—¶å€™ï¼Œä½ å¯ä»¥åˆ©ç”¨ä¸€ä¸ª<code>category</code>å£°æ˜åŒæ ·çš„å‡½æ•°ç­¾åï¼Œä¸éœ€è¦å®ç°ï¼Œ<code>Objective-C</code>çš„runtimeä¼šè‡ªåŠ¨å¸®ä½ è½¬å‘å¯¹åº”çš„<code>message passing</code>ã€‚</strong>ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2016/02/27/pod-install-plugin/" data-id="cjqdxq1vk0009mxi1se7o46sq" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2016/02/27/pod-install-plugin/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-FBKVOController" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/27/FBKVOController/" class="article-date">
  <time datetime="2016-02-27T10:21:55.000Z" itemprop="datePublished">2016-02-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/27/FBKVOController/">FBKVOController æºç è§£æ</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>å¼€å‘è¿‡iOSçš„appå·²ç»ä¸è®¡å…¶æ•°äº†ï¼Œåœ¨ä¸åŒçš„é¡¹ç›®ä¸­é‡‡ç”¨çš„æ¶æ„ä¹Ÿå„ä¸ç›¸åŒï¼Œæœ‰ä¼ ç»Ÿçš„<strong>MVC</strong>ï¼Œç®€åŒ–çš„<strong>VIPER</strong>ï¼Œä»¥åŠä¸€äº›ç®€å•çš„<strong>MVVM</strong>ã€‚</p>
<p>è¿™å…¶ä¸­ï¼Œæˆ‘æœ€ä¸æ¨èçš„å°±æ˜¯<strong>VIPER</strong>ï¼Œè°å†™è°çŸ¥é“ï¼Œï¼Œç»å¯¹æ˜¯å¢åŠ äº†é¡¹ç›®çš„å¤æ‚æ€§ã€‚<strong>MVVM</strong>ç”±äºè‡ªå·±æ€»æ˜¯å—é™äºä¼ ç»Ÿçš„<code>Object-Oriented</code>çš„æ€è·¯ï¼Œæ€»æ˜¯æƒ³ä¸å‡ºçœŸæ­£çš„Functional Programmingçš„ä»£ç ï¼Œå› æ­¤ï¼Œç»å¤§å¤šæ•°æƒ…å†µï¼Œå†™ç€å†™ç€éƒ½å›å½’åˆ°äº†<strong>MVC</strong>ã€‚</p>
<p>å…¶å®ï¼Œç›¸è¾ƒäºç½‘ä¸Šå¤§å®¶æ€»å–œæ¬¢æåˆ°çš„<strong>Massive View Controller</strong>é—®é¢˜ï¼Œæˆ‘æ›´æƒ³è¯´çš„æ˜¯è¿™ç§ä¼ ç»Ÿæ¶æ„ä¸­å¯¹äºä¿¡æ¯æµçš„ä¸å‹å¥½ã€‚</p>
<p>åœ¨ä¸€ä¸ªå…¸å‹çš„iOSçš„é—®é¢˜ä¸­ï¼Œæˆ‘ä»¬çš„ä»£ç æ‰§è¡Œæµç¨‹ï¼Œé€šå¸¸éƒ½æ˜¯ä»View Controllerçš„<strong>ç”Ÿå‘½å‘¨æœŸ</strong>å¼€å§‹ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå®Œå…¨åŸºäºé¡ºåºæ‰§è¡Œçš„åº”ç”¨ï¼Œé‚£æ•´ä¸ªappçš„ä¿¡æ¯æµæ˜¯<strong>å•å‘å¯è·Ÿè¸ªçš„</strong>ã€‚ä½†æ˜¯å¾€å¾€äº‹æƒ…å¹¶ä¸ä¼šé‚£ä¹ˆç®€å•ï¼Œæˆ‘ä»¬ä¼šåŒ…å«è‡³å°‘å¦‚ä¸‹è¿™äº›æ½œåœ¨æ‰“ä¹±ä¿¡æ¯æµçš„<em>åè›‹</em></p>
<ul>
<li>Delegateå›è°ƒ</li>
<li>NSNotification</li>
<li>UIViewæ§ä»¶çš„Target-Action</li>
<li>KVO</li>
</ul>
<p>åœ¨è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šä»¥ä¸ºæˆ‘æƒ³è°ˆè°ˆ<strong>ReactiveCocoa</strong>å’Œ<strong>RxSwift</strong>ï¼Œé‚£ä½ é”™å•¦ï¼Œé‚£ä¸ªå¼€æºé¡¹ç›®æˆ‘æš‚æ—¶è¿˜æ²¡æœ‰èƒ½åŠ›å»æ·±ç©¶ï¼Œæ‰€ä»¥æˆ‘æƒ³ä»KVOäº‹ä»¶å…¥æ‰‹ï¼Œè¯»ä¸€è¯»Facebookå‡ºå“çš„<strong>FBKVOController</strong>ã€‚</p>
<h4 id="FBKVOController">FBKVOController</h4><p>ç®€å•æ¥è¯´ï¼ŒFBKVOControlleræ˜¯å¯¹KVOæœºåˆ¶çš„ä¸€å±‚å°è£…ï¼ŒåŒæ—¶æä¾›äº†çº¿ç¨‹å®‰å…¨çš„ç‰¹æ€§å’Œå¹¶å¯¹å¦‚ä¸‹è¿™ä¸ª<strong>è‡­åæ˜­è‘—</strong>çš„å‡½æ•°è¿›è¡Œäº†å°è£…ï¼Œæä¾›äº†å¹²å‡€çš„blockçš„å›è°ƒï¼Œé¿å…äº†å¤„ç†è¿™ä¸ªå‡½æ•°çš„é€»è¾‘æ•£è½çš„åˆ°å¤„éƒ½æ˜¯ã€‚</p>
<pre><code>- (<span class="typename">void</span>)<span class="string">observeValueForKeyPath:</span>(NSString *)keyPath <span class="string">ofObject:</span>(id)object <span class="string">change:</span>(NSDictionary *)change <span class="string">context:</span>(<span class="typename">void</span> *)context
</code></pre><h4 id="æºç åˆ†æ">æºç åˆ†æ</h4><p>æ•´ä¸ªé¡¹ç›®çš„ç»“æ„éå¸¸ç®€å•ï¼ŒåŒ…å«å¦‚ä¸‹å››ä¸ªæ–‡ä»¶ï¼š</p>
<ul>
<li>FBKVOController.h/.m</li>
<li>NSObject+FBKVOController.h/.m</li>
</ul>
<p>å…¶ä¸­ï¼Œ<code>NSObject+FBKVOController</code>åªæ˜¯é€šè¿‡<code>AssociateObject</code>ç»™NSObjectæä¾›äº†ä¸€ä¸ª<code>retain</code>åŠä¸€ä¸ª<code>éretain</code>å‹çš„KVOControllerã€‚</p>
<p>è¿™ä¸¤ç§ä¸åŒç±»å‹çš„KVOControlleræœ‰å•¥åŒºåˆ«ï¼Œæˆ‘ä»¬ç¨åå†æï¼Œæˆ‘ä»¬å°†é‡ç‚¹æŠ•å‘<code>FBKVOController</code>è¿™ä¸ªæ–‡ä»¶ã€‚</p>
<p>æ‰“å¼€è¿™ä¸ª<code>FBKVOController.m</code>æ–‡ä»¶ï¼Œå“å‘€ï¼Œ600å¤šè¡Œæ–‡ä»¶ï¼Œæœ‰ç‚¹è›‹ç–¼ã€‚æ²¡äº‹ï¼Œé…åˆå¤´æ–‡ä»¶ç²—ç•¥æ‰«ä¸€çœ¼ä»¥åï¼Œå¯ä»¥å‘ç°å…¶ä¸­å¾ˆå¤šæ–¹æ³•éƒ½æ˜¯<code>convenience method</code>ã€‚</p>
<p>ç®€å•å‰¥ç¦»ä¸€ä¸‹æ•°æ®ç»“æ„ä»¥åï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œä¸»è¦çš„æ•°æ®ç»“æ„æœ‰å¦‚ä¸‹ä¸‰ä¸ªã€‚</p>
<ul>
<li>FBKVOInfo</li>
<li>FBKVOSharedController</li>
<li>FBKVOController</li>
</ul>
<h4 id="FBKVOController-1">FBKVOController</h4><p>æ—¢ç„¶æˆ‘ä»¬å‰é¢é€šè¿‡<code>NSObject+FBKVOController</code>çŸ¥é“äº†æ¯ä¸ªå¯¹è±¡éƒ½ä¼šæœ‰å…¶å¯¹åº”çš„<code>FBKVOController</code>ï¼Œé‚£æˆ‘ä»¬å°±å…ˆæ¥çœ‹çœ‹è¿™ä¸ªç±»å§ã€‚</p>
<pre><code><span class="comment">//1.</span>
<span class="class"><span class="keyword">@implementation</span> <span class="title">FBKVOController</span></span>
{
  <span class="built_in">NSMapTable</span> *_objectInfosMap;
  OSSpinLock _lock;
}

<span class="comment">//2.</span>
- (instancetype)initWithObserver:(<span class="keyword">id</span>)observer retainObserved:(<span class="built_in">BOOL</span>)retainObserved
{
  <span class="keyword">self</span> = [<span class="keyword">super</span> init];
  <span class="keyword">if</span> (<span class="literal">nil</span> != <span class="keyword">self</span>) {
    <span class="comment">// 2.</span>
    _observer = observer;

    <span class="comment">// 3.</span>
    <span class="built_in">NSPointerFunctionsOptions</span> keyOptions = retainObserved ? <span class="built_in">NSPointerFunctionsStrongMemory</span>|<span class="built_in">NSPointerFunctionsObjectPointerPersonality</span> : <span class="built_in">NSPointerFunctionsWeakMemory</span>|<span class="built_in">NSPointerFunctionsObjectPointerPersonality</span>;
    _objectInfosMap = [[<span class="built_in">NSMapTable</span> alloc] initWithKeyOptions:keyOptions valueOptions:<span class="built_in">NSPointerFunctionsStrongMemory</span>|<span class="built_in">NSPointerFunctionsObjectPersonality</span> capacity:<span class="number">0</span>];

    <span class="comment">// 4.</span>
    _lock = OS_SPINLOCK_INIT;
  }
  <span class="keyword">return</span> <span class="keyword">self</span>;
}
</code></pre><ol>
<li><p>é¦–å…ˆæˆ‘ä»¬çœ‹åˆ°ï¼Œè¿™ä¸ªå¯¹è±¡æŒæœ‰ä¸€ä¸ª<code>OSSpinLock</code>åŠä¸€ä¸ª<code>NSMapTable</code>ã€‚å…¶ä¸­<code>OSSpinLock</code>å³ä¸ºè‡ªæ—‹é”ï¼Œå½“å¤šä¸ªçº¿ç¨‹ç«äº‰ç›¸åŒçš„<strong>critical section</strong>æ—¶ï¼Œèµ·åˆ°ä¿æŠ¤ä½œç”¨ã€‚<code>NSMapTable</code>å¯èƒ½å¤§å®¶æ¥è§¦ä¸æ˜¯å¾ˆå¤šï¼Œæˆ‘ä»¬åœ¨åæ–‡ä¼šè¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œå¤§å®¶å¯ä»¥å…ˆç†è§£ä¸ºä¸€ä¸ªé«˜çº§çš„NSDictionaryã€‚</p>
</li>
<li><p>åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œé¦–å…ˆå°†ä¼ å…¥çš„observerè¿›è¡Œ<code>weak</code>æŒæœ‰ï¼Œè¿™ä¸»è¦ä¸ºäº†é¿å…<strong>Retain Cycle</strong>ã€‚</p>
</li>
<li><p>è¿™ä¸€æ®µçš„å†…å®¹å¯èƒ½å¤§å®¶ä¸å¤ªç†Ÿæ‚‰ï¼Œ<code>NSPointerFunctionsOptions</code>ç®€å•æ¥è¯´å°±æ˜¯å®šä¹‰<code>NSMapTable</code>ä¸­çš„keyå’Œvalueé‡‡ç”¨ä½•ç§å†…å­˜ç®¡ç†ç­–ç•¥ï¼ŒåŒ…æ‹¬<code>strong</code>å¼ºå¼•ç”¨ï¼Œ<code>weak</code>å¼±å¼•ç”¨ä»¥åŠ<code>copy</code>ï¼ˆè¦æ”¯æŒNSCopyingåè®®ï¼‰</p>
</li>
<li><p>åˆå§‹åŒ–è‡ªæ—‹é”  </p>
</li>
</ol>
<p>æ¥ä¸‹æ¥ï¼Œä½¿æˆ‘ä»¬é€šè¿‡<code>FBKVOController</code>æ¥å¯¹ä¸€ä¸ªå¯¹è±¡çš„æŸä¸ªæˆ–è€…æŸäº›keypathè¿›è¡Œè§‚å¯Ÿã€‚</p>
<pre><code>- (<span class="typename">void</span>)<span class="string">observe:</span>(id)object <span class="string">keyPath:</span>(NSString *)keyPath <span class="string">options:</span>(NSKeyValueObservingOptions)options <span class="string">block:</span>(FBKVONotificationBlock)block
{
  NSAssert(<span class="number">0</span> != keyPath.length &amp;&amp; NULL != block, @<span class="string">"missing required parameters observe:%@ keyPath:%@ block:%p"</span>, object, keyPath, block);
  <span class="keyword">if</span> (nil == object || <span class="number">0</span> == keyPath.length || NULL == block) {
    <span class="keyword">return</span>;
  }

  <span class="comment">// 1. create info</span>
  _FBKVOInfo *info = [[_FBKVOInfo alloc] <span class="string">initWithController:</span>self <span class="string">keyPath:</span>keyPath <span class="string">options:</span>options <span class="string">block:</span>block];

  <span class="comment">// 2. observe object with info</span>
  [self <span class="string">_observe:</span>object <span class="string">info:</span>info];
}
</code></pre><ol>
<li>å¯¹äºä¼ å…¥çš„å‚æ•°ï¼Œæ„å»ºä¸€ä¸ªå†…éƒ¨çš„FBKVOInfoæ•°æ®ç»“æ„</li>
<li>è°ƒç”¨<code>[self _observe:object info:info];</code></li>
</ol>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è·Ÿè¸ªä¸€ä¸‹<code>[self _observe:object info:info];</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code>- (<span class="typename">void</span>)<span class="string">_observe:</span>(id)object <span class="string">info:</span>(_FBKVOInfo *)info
{
  <span class="comment">// lock</span>
  OSSpinLockLock(&amp;_lock);

  <span class="comment">// 1.</span>
  NSMutableSet *infos = [_objectInfosMap <span class="string">objectForKey:</span>object];

  <span class="comment">// 2. </span>
  _FBKVOInfo *existingInfo = [infos <span class="string">member:</span>info];
  <span class="keyword">if</span> (nil != existingInfo) {
    NSLog(@<span class="string">"observation info already exists %@"</span>, existingInfo);

    <span class="comment">// unlock and return</span>
    OSSpinLockUnlock(&amp;_lock);
    <span class="keyword">return</span>;
  }

  <span class="comment">// lazilly create set of infos</span>
  <span class="keyword">if</span> (nil == infos) {
    infos = [NSMutableSet set];
    [_objectInfosMap <span class="string">setObject:</span>infos <span class="string">forKey:</span>object];
  }

  <span class="comment">// add info and oberve</span>
  [infos <span class="string">addObject:</span>info];

  <span class="comment">// unlock prior to callout</span>
  OSSpinLockUnlock(&amp;_lock);

  <span class="comment">// 3.</span>
  [[_FBKVOSharedController sharedController] <span class="string">observe:</span>object <span class="string">info:</span>info];
}
</code></pre><p>æŠ›å¼€Facebookè‡ªèº«æ ‡è®°çš„æ³¨é‡Šï¼Œæœ‰ä¸‰å¤„æ¯”è¾ƒå€¼å¾—æˆ‘ä»¬æ³¨æ„ï¼š</p>
<ol>
<li><p>æ ¹æ®è¢«è§‚å¯Ÿçš„objectè·å–å…¶å¯¹åº”çš„<strong>infos set</strong>ã€‚è¿™ä¸ªä¸»è¦ä½œç”¨åœ¨äºé¿å…å¤šæ¬¡å¯¹åŒä¸€ä¸ªkeyPathæ·»åŠ å¤šæ¬¡è§‚å¯Ÿï¼Œé¿å…crashã€‚<strong>å› ä¸ºæ¯è°ƒç”¨ä¸€æ¬¡<code>addObserverForKeyPath</code>å°±è¦æœ‰ä¸€ä¸ªå¯¹åº”çš„<code>removeObserverForKey</code>ã€‚</strong></p>
</li>
<li><p>ä»<strong>infos set</strong>åˆ¤æ–­æ˜¯ä¸æ˜¯å·²ç»æœ‰äº†ä¸æ­¤æ¬¡infoç›¸åŒçš„è§‚å¯Ÿã€‚</p>
</li>
<li><p>å¦‚æœä»¥ä¸Šéƒ½é¡ºåˆ©é€šè¿‡ï¼Œå°†è§‚å¯Ÿçš„ä¿¡æ¯åŠå…³ç³»æ³¨å†Œåˆ°<code>_FBKVOSharedController</code>ä¸­ã€‚</p>
</li>
</ol>
<p>è‡³æ­¤ï¼ŒFBKVOControllerçš„ä»»åŠ¡åŸºæœ¬éƒ½ç»“æŸï¼Œ<code>unObserve</code>ç›¸å…³çš„ä»»åŠ¡é€»è¾‘å¤§åŒå°å¼‚ï¼Œä¸å†èµ˜è¿°ã€‚</p>
<h4 id="FBKVOSharedController">FBKVOSharedController</h4><p>åˆæ¬¡çœ‹åˆ°è¿™ä¸ªç±»çš„æ—¶å€™ï¼Œæˆ‘çš„è„‘æµ·ä¸­æµ®ç°äº†ä¸¤ä¸ªé—®é¢˜ï¼ŒFBKVOSharedControlleræ˜¯å¹²å˜›çš„?ä¸ºä»€ä¹ˆFBKVOControllerè¿˜éœ€è¦å°†è§‚å¯Ÿçš„ä¿¡æ¯è½¬äº¤å‘¢ï¼Ÿ</p>
<p><strong>å…¶å®æˆ‘ä¸ªäººè§‰å¾—è¿™ä¸€å±‚ä¸æ˜¯å¿…è¦çš„</strong>ï¼Œä½†æ˜¯æŒ‰ç…§Facebookçš„ç†å¿µæ¥è¯´å°±æ˜¯å°†æ‰€æœ‰çš„è§‚å¯Ÿä¿¡æ¯ç»Ÿä¸€äº¤ç”±ä¸€ä¸ª<code>FBKVOSharedController</code>çš„<strong>å•ä¾‹</strong>è¿›è¡Œç»´æŠ¤ã€‚å¦‚æœå¤§å®¶è¯»è¿‡Facebookå‡ºå“çš„<strong>Flux</strong>æ¶æ„ï¼Œä¹Ÿä¼šå‘ç°ï¼ŒFacebookç»å¸¸å–œæ¬¢ç»´æŠ¤ä¸€ä¸ªç±»ä¼¼äºä¸­é—´ä»¶çš„æ³¨å†Œè¡¨ï¼Œåœ¨è¿™é‡Œï¼Œ<code>FBKVOSharedController</code>æ‰¿æ‹…çš„ä¹Ÿæ˜¯ç±»ä¼¼çš„èŒè´£ã€‚</p>
<p>äºæ˜¯ï¼Œé€šè¿‡å¦‚ä¸‹æ–¹æ³•ï¼Œæˆ‘ä»¬åƒä½¿ç”¨æ³¨å†Œè¡¨ä¸€æ ·å°†å¯¹KVOInfoæ³¨å†Œã€‚</p>
<pre><code>- (<span class="typename">void</span>)<span class="string">observe:</span>(id)object <span class="string">info:</span>(_FBKVOInfo *)info
{
  <span class="keyword">if</span> (nil == info) {
    <span class="keyword">return</span>;
  }

  <span class="comment">// register info</span>
  OSSpinLockLock(&amp;_lock);
  [_infos <span class="string">addObject:</span>info];
  OSSpinLockUnlock(&amp;_lock);

  <span class="comment">// 1.</span>
  [object <span class="string">addObserver:</span>self <span class="string">forKeyPath:</span>info-&gt;_keyPath <span class="string">options:</span>info-&gt;_options <span class="string">context:</span>(<span class="typename">void</span> *)info];
}
</code></pre><ol>
<li>ä»£è¡¨æ‰€æœ‰çš„è§‚å¯Ÿä¿¡æ¯éƒ½é¦–å…ˆç”±<code>FBKVOSharedController</code>è¿›è¡Œæ¥å—ï¼Œéšåè¿›è¡Œè½¬å‘ã€‚</li>
</ol>
<p>å®ç°<code>observeValueForKeyPath:ofObject:Change:context</code><br>æ¥æ¥æ”¶é€šçŸ¥ã€‚</p>
<pre><code>- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span> *)change context:(<span class="keyword">void</span> *)context
{
  <span class="built_in">NSAssert</span>(context, <span class="string">@"missing context keyPath:%@ object:%@ change:%@"</span>, keyPath, object, change);

  _FBKVOInfo *info;

  {
    <span class="comment">// 1. </span>
    OSSpinLockLock(&amp;_lock);
    info = [_infos member:(__bridge <span class="keyword">id</span>)context];
    OSSpinLockUnlock(&amp;_lock);
  }

  <span class="keyword">if</span> (<span class="literal">nil</span> != info) {

    <span class="comment">// take strong reference to controller</span>
    FBKVOController *controller = info-&gt;_controller;
    <span class="keyword">if</span> (<span class="literal">nil</span> != controller) {

      <span class="comment">// take strong reference to observer</span>
      <span class="keyword">id</span> observer = controller<span class="variable">.observer</span>;
      <span class="keyword">if</span> (<span class="literal">nil</span> != observer) {

        <span class="comment">// dispatch custom block or action, fall back to default action</span>
        <span class="keyword">if</span> (info-&gt;_block) {
          info-&gt;_block(observer, object, change);
        } <span class="keyword">else</span> <span class="keyword">if</span> (info-&gt;_action) {
<span class="preprocessor">#pragma clang diagnostic push</span>
<span class="preprocessor">#pragma clang diagnostic ignored <span class="title">"-Warc-performSelector-leaks"</span></span>
          [observer performSelector:info-&gt;_action withObject:change withObject:object];
<span class="preprocessor">#pragma clang diagnostic pop</span>
        } <span class="keyword">else</span> {
          [observer observeValueForKeyPath:keyPath ofObject:object change:change context:info-&gt;_context];
        }
      }
    }
  }
}
</code></pre><ol>
<li>æ ¹æ®contextä¸Šä¸‹æ–‡è·å–å¯¹åº”çš„KVOInfo</li>
<li>åˆ¤æ–­å½“å‰<code>info</code>çš„<code>observer</code>å’Œ<code>controller</code>ï¼Œæ˜¯å¦ä»ç„¶å­˜åœ¨ï¼ˆå› ä¸ºä¹‹å‰æˆ‘ä»¬é‡‡ç”¨çš„weakæŒæœ‰ï¼‰</li>
<li>æ ¹æ®    <code>info</code>çš„<code>block</code>æˆ–è€…<code>selector</code>æˆ–è€…<code>override</code>è¿›è¡Œæ¶ˆæ¯è½¬å‘ã€‚</li>
</ol>
<p>åˆ°è¿™é‡Œï¼Œ<code>FBKVOController</code>æ•´ä½“çš„å®ç°å°±ä»‹ç»å®Œäº†ï¼Œæ€ä¹ˆæ ·ï¼Œæ˜¯ä¸æ˜¯å±€éƒ¨çœ‹è‡ªå·±éƒ½ä¼šå®ç°ï¼Œä½†æ˜¯ä¸€ç»“åˆèµ·å®Œæ•´çš„è®¾è®¡æ€è·¯ï¼Œå°±è§‰å¾—ï¼Œä¸äºæ˜¯Facebookå‘¢ã€‚</p>
<h3 id="NSMapTable">NSMapTable</h3><p>ä¹‹å‰æˆ‘ä»¬åœ¨å‰æ–‡ä¸­æåˆ°äº†<code>NSMapTable</code>ï¼Œç°åœ¨æˆ‘ä»¬æ¥è¯¦ç»†ä»‹ç»ä»–ä¸€ä¸‹ã€‚<br>æˆ‘ä»¬åœ¨å¹³å¸¸çš„å¼€å‘ä¸­éƒ½ä½¿ç”¨è¿‡<code>NSDictionary</code>æˆ–è€…<code>NSMutableDictionary</code>ï¼Œä½†æ˜¯è¿™ä¸¤ç§æ•°æ®ç»“æ„æœ‰å…¶çš„å±€é™æ€§ã€‚</p>
<p>ä»¥<code>NSDictionary</code>ä¸ºä¾‹ï¼Œ<code>NSDictionary</code>å°†<code>key</code>çš„<code>hash</code>å€¼ä½œä¸ºç´¢å¼•ï¼Œå­˜å‚¨å¯¹åº”çš„<code>value</code>ã€‚å› æ­¤ï¼Œ<code>key</code>çš„è¦æ±‚æ˜¯ä¸èƒ½æ›´æ”¹ã€‚æ‰€ä»¥ï¼Œ<code>NSDictionary</code>ä¸ºäº†ç¡®ä¿å®‰å…¨ï¼Œå¯¹äº<code>key</code>é‡‡ç”¨äº†<strong>copy</strong>çš„ç­–ç•¥ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ”¯æŒ<strong>NSCopying</strong>åè®®çš„ç±»å‹éƒ½å¯ä»¥ä½œä¸ºkeyã€‚ä½†æ˜¯è€ƒè™‘åˆ°copyå¸¦æ¥çš„å¼€é”€ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬éƒ½ä½¿ç”¨ç®€å•çš„è¯¸å¦‚æ•°å­—æˆ–è€…å­—ç¬¦ä¸²ä½œä¸ºkeyã€‚</p>
<p>é‚£ä¹ˆï¼Œå¦‚æœè¦ä½¿ç”¨<code>Object</code>ä½œä¸ºkeyï¼Œæƒ³æ„å»º<strong>Object to Object</strong>çš„å…³ç³»æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™å°±ç”¨åˆ°<code>NSMapTable</code>ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡NSFunctionsPointeræ¥åˆ†åˆ«å®šä¹‰å¯¹keyå’Œvalueçš„å‚¨å­˜å…³ç³»ï¼Œç®€å•å¯ä»¥åˆ†ç±»ä¸º<code>strong</code>,<code>weak</code>ä»¥åŠ<code>copy</code>ã€‚è€Œå½“åˆ©ç”¨<code>object</code>ä½œä¸ºkeyçš„æ—¶å€™ï¼Œå¯ä»¥å®šä¹‰è¯„åˆ¤ç›¸ç­‰çš„æ ‡å‡†ï¼Œå¦‚ï¼š<strong>use shifted pointer hash and direct equality, object descriptionæˆ–è€…size</strong>ã€‚</p>
<p>å…·ä½“ä½ éœ€è¦å»overrideå¦‚ä¸‹å‡ ç§æ–¹æ³•ï¼š</p>
<pre><code><span class="comment">// pointer personality functions</span>
<span class="keyword">@property</span> (nullable) <span class="built_in">NSUInteger</span> (*hashFunction)(<span class="keyword">const</span> <span class="keyword">void</span> *item, <span class="built_in">NSUInteger</span> (* __nullable size)(<span class="keyword">const</span> <span class="keyword">void</span> *item));
<span class="keyword">@property</span> (nullable) <span class="built_in">BOOL</span> (*isEqualFunction)(<span class="keyword">const</span> <span class="keyword">void</span> *item1, <span class="keyword">const</span> <span class="keyword">void</span>*item2, <span class="built_in">NSUInteger</span> (* __nullable size)(<span class="keyword">const</span> <span class="keyword">void</span> *item));
<span class="keyword">@property</span> (nullable) <span class="built_in">NSUInteger</span> (*sizeFunction)(<span class="keyword">const</span> <span class="keyword">void</span> *item);
<span class="keyword">@property</span> (nullable) <span class="built_in">NSString</span> * __nullable (*descriptionFunction)(<span class="keyword">const</span> <span class="keyword">void</span> *item);
</code></pre><p>åœ¨<code>FBKVOController</code>è‡ªå®šä¹‰çš„å¯ä»¥ä½œä¸ºkeyçš„ç»“æ„<code>FBKVOInfo</code>ï¼Œå°±å¤å†™äº†</p>
<pre><code>- (<span class="type">NSUInteger</span>)hash
{
  <span class="keyword">return</span> [_keyPath hash];
}

- (<span class="type">BOOL</span>)isEqual:(id)<span class="class"><span class="keyword">object</span>
</span>{
  <span class="keyword">if</span> (nil == <span class="class"><span class="keyword">object</span>) {</span>
    <span class="keyword">return</span> <span class="type">NO</span>;
  }
  <span class="keyword">if</span> (self == <span class="class"><span class="keyword">object</span>) {</span>
    <span class="keyword">return</span> <span class="type">YES</span>;
  }
  <span class="keyword">if</span> (![<span class="class"><span class="keyword">object</span> <span class="title">isKindOfClass</span>:</span>[self <span class="class"><span class="keyword">class</span>]]) {</span>
    <span class="keyword">return</span> <span class="type">NO</span>;
  }
  <span class="keyword">return</span> [_keyPath isEqualToString:((_FBKVOInfo *)<span class="class"><span class="keyword">object</span>)<span class="title">-&gt;_keyPath</span>];</span>
}
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2016/02/27/FBKVOController/" data-id="cjqdxq21k0036mxi1rakdgjnr" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2016/02/27/FBKVOController/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-DGRunKeeperSwitch" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/05/DGRunKeeperSwitch/" class="article-date">
  <time datetime="2016-02-05T14:35:57.000Z" itemprop="datePublished">2016-02-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/05/DGRunKeeperSwitch/">DGRunKeeperSwitch æºç è§£æ</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>DGRunKeeperSwitchæ˜¯éå¸¸æœ‰è¶£çš„è‡ªå®šä¹‰çš„<em>Segment Control</em>çš„å®ç°ï¼Œä»å…¶Githubä¸Šçš„å±•ç°æ•ˆæœæ¥çœ‹ï¼Œå¯ä»¥å‘ç°åœ¨ <em>åŒä¸€ä¸ª</em> UILabelä¸­çš„æ–‡æœ¬ç«Ÿç„¶å¯ä»¥å±•ç°å‡ºä¸¤ç§ä¸åŒçš„é¢œè‰²ï¼Œæ˜¯ä¸æ˜¯å¾ˆå¥‡å¦™ï¼Ÿä»Šå¤©å°±è®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<p><img src="https://raw.githubusercontent.com/gontovnik/DGRunkeeperSwitch/master/DGRunkeeperSwitch.gif" alt=""></p>
<h3 id="æºç åˆ†æ">æºç åˆ†æ</h3><p>æ‰“å¼€é¡¹ç›®ï¼Œå‘ç°è¿™ä¸ªé¡¹ç›®çœŸçš„å¾ˆç®€å•ï¼Œå°±ä¸€ä¸ªæ–‡ä»¶ï¼Œ<code>DGRunkeeperSwitch.swift</code>ï¼Œå¹¶ä¸”å®ç°ä¹Ÿåªæœ‰æ¥è¿‘260è¡Œå·¦å³ã€‚</p>
<p>æ—¢ç„¶è¿™ä¸ªé¡¹ç›®æ˜¯ä¸ªUIçš„å¼€æºåº“ï¼Œæˆ‘ä»¬ä¸»è¦è¿˜æ˜¯å…ˆä»ç•Œé¢å±‚çº§å…¥æ‰‹ã€‚å’Œ<a href="http:glowing.com" target="_blank" rel="external">Glowçš„å¼€æºåº“(GLCalendar)</a>ä¸åŒï¼Œè¿™ä¸ªæ˜¯çº¯æ‰‹å†™çš„æ§ä»¶ï¼Œå› æ­¤æ— æ³•ä»<strong>.xib</strong>æ–‡ä»¶æ¥å¿«é€Ÿäº†è§£ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠç›®æ ‡é¦–å…ˆæŠ•å‘ç›¸å…³çš„UIKitå­å±æ€§ï¼ŒåŒ…æ‹¬å¦‚ä¸‹ï¼š</p>
<pre><code><span class="comment">// 1. </span>
private <span class="tag">var</span> titleLabelsContentView = <span class="function"><span class="title">UIView</span><span class="params">()</span></span>
private <span class="tag">var</span> leftTitleLabel = <span class="function"><span class="title">UILabel</span><span class="params">()</span></span>
private <span class="tag">var</span> rightTitleLabel = <span class="function"><span class="title">UILabel</span><span class="params">()</span></span>

<span class="comment">// 2.</span>
private <span class="tag">var</span> selectedTitleLabelsContentView = <span class="function"><span class="title">UIView</span><span class="params">()</span></span>
private <span class="tag">var</span> selectedLeftTitleLabel = <span class="function"><span class="title">UILabel</span><span class="params">()</span></span>
private <span class="tag">var</span> selectedRightTitleLabel = <span class="function"><span class="title">UILabel</span><span class="params">()</span></span>

<span class="comment">// 3.</span>
<span class="function"><span class="title">private</span><span class="params">(set)</span></span> <span class="tag">var</span> selectedBackgroundView = <span class="function"><span class="title">UIView</span><span class="params">()</span></span> 
private <span class="tag">var</span> titleMaskView: UIView = <span class="function"><span class="title">UIView</span><span class="params">()</span></span>
</code></pre><p>å…¶ä¸­ç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬ä¸€çœ‹å‘½åå°±å¾ˆå®¹æ˜“ç†è§£äº†ï¼Œæœ‰ä¸€ä¸ª<code>ContentView</code>ä½œä¸º<code>container</code>ï¼ŒåŒ…å«äº†<code>segment control</code>å¯¹åº”çš„å·¦å³ä¸¤ä¸ªLabelã€‚</p>
<p>ç„¶åæ¥çœ‹ç¬¬äºŒéƒ¨åˆ†ï¼Œç¬¬äºŒéƒ¨åˆ†ä»å‘½åä¸Šä¹Ÿå¾ˆç›´è§‚ï¼Œæ„Ÿè§‰ä¸Šå’Œç¬¬ä¸€éƒ¨åˆ†æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯å´<strong>å¯èƒ½ä»£è¡¨çš„æ˜¯é€‰ä¸­çš„çŠ¶æ€</strong>ã€‚ä¸è¿‡æˆ‘ä»¬å¾ˆå¥‡æ€ªï¼Œä½œè€…ä¸ºä»€ä¹ˆè¦æ„å»ºä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„æ¥è¡¨å¾ä¸åŒçš„çŠ¶æ€å‘¢ï¼Œç›´æ¥ç”¨ä¸€ä¸ªå˜é‡æ¯”å¦‚ <code>var selected = false</code> è¿›è¡Œæ ·å¼çš„æ§åˆ¶ä¸å¯ä»¥å—ï¼Ÿ</p>
<p>å¥½ï¼Œå…ˆåˆ«æ€¥ï¼Œè¿™é‡Œå–ä¸ªå…³å­ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>
<p>ç¬¬ä¸‰éƒ¨åˆ†ï¼Œ<code>selectedBackgroundView</code>å’Œ<code>titleMaskView</code>ï¼Œä»åå­—çœ‹ï¼Œä¹Ÿä¸èƒ½ä¸€ä¸‹å­äº†è§£å«ä¹‰ï¼Œæˆ‘ä»¬å…ˆå…¨å±€æœç´¢ä¸‹ç›¸å…³è¿çš„ä»£ç ï¼Œä¸<code>titleMaskView</code>ç›¸å…³çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code>titleMaskView<span class="class">.backgroundColor</span> = .<span class="function"><span class="title">blackColor</span><span class="params">()</span></span>
selectedTitleLabelsContentView<span class="class">.layer</span><span class="class">.mask</span> = titleMaskView.layer
</code></pre><p>çœ‹èµ·æ¥æ˜¯ç”¨<code>titleMaskView</code>ç»™ä¹‹å‰<strong>å¯èƒ½çš„é€‰ä¸­çŠ¶æ€çš„</strong><code>selectedTitleLabelsContentView</code>åŠ äº†ä¸€å±‚é®ç½©ã€‚</p>
<p>ç”±äºé®ç½©æ˜¯ç™½è‰²çš„åœ°æ–¹ä¸æ˜¾ç¤ºï¼Œé»‘è‰²çš„åœ°æ–¹ï¼ˆå‡†ç¡®æ¥è¯´æ˜¯éç™½è‰²çš„åŒºåŸŸï¼‰æ˜¾ç¤ºï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç†è§£ä¸Šè¿°ä»£ç æ˜¯é€šè¿‡<code>titleMaskView</code>æ¥æ˜¾ç¤º<code>selectedTitleLabelsContentView</code>ä¸­çš„å†…å®¹ï¼ˆ<strong>ä¹Ÿå°±æ˜¯ä¸¤ä¸ªUILabel</strong>ï¼‰ï¼Œé<code>titleMaskView</code>åŒºåŸŸè‡ªåŠ¨éšè—äº†ã€‚</p>
<pre><code>addObserver(<span class="keyword">self</span>, forKeyPath: <span class="string">"selectedBackgroundView.frame"</span>, options: .<span class="type">New</span>, context: <span class="literal">nil</span>)

<span class="keyword">override</span> public <span class="func"><span class="keyword">func</span> <span class="title">observeValueForKeyPath</span><span class="params">(keyPath: String?, ofObject object: AnyObject?, change: [String : AnyObject]?, context: UnsafeMutablePointer&lt;Void&gt;)</span></span> {
    <span class="keyword">if</span> keyPath == <span class="string">"selectedBackgroundView.frame"</span> {
        titleMaskView.frame = selectedBackgroundView.frame
    }
}
</code></pre><p>å“¦ï¼Œçœ‹å®Œä¸Šè¿°è¿™æ®µä»£ç ï¼Œæˆ‘å¼€å§‹æœ‰ç‚¹æç„¶å¤§æ‚Ÿäº†ï¼Œé€šè¿‡ç›‘å¬<code>selectedBackgroundView.frame</code>ï¼Œæˆ‘ä»¬å®æ—¶æ”¹å˜<code>titleMaskView</code>çš„<code>frame</code>ã€‚è€Œé€šè¿‡å®é™…è¿è¡Œé¡¹ç›®ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“ç†è§£<code>selectedBackgroundView</code>å°±æ˜¯ç”¨æˆ·å¯æ‹–æ‹½çš„é€‰é¡¹é«˜äº®æ¡ã€‚</p>
<p>åˆ°è¿™ï¼Œæˆ‘æ¸æ¸æœ‰ç‚¹ç†è§£ä½œè€…ä¸ºä»€ä¹ˆè¦æ„å»ºä¸¤ä¸ªå®Œå…¨ä¸€æ ·çš„contentViewï¼Œå¹¶éƒ½åŒ…å«å·¦å³ä¸¤ä¸ªUILabeläº†ã€‚</p>
<p>ä½œè€…åº”è¯¥æ˜¯å¯¹äº<code>titleLabelsContentView</code>è®¾å®šä¸ºæ™®é€šçŠ¶æ€çš„Labelï¼Œå·¦å³ä¸¤ä¸ªLabeléƒ½æ˜¯æœªé€‰ä¸­çš„é¢œè‰²çŠ¶æ€ï¼ŒåŒæ—¶å°†<code>selectedTitleLabelsContentView</code>è®¾å®šä¸ºé€‰å®šçŠ¶æ€ï¼Œå·¦å³Labeléƒ½ä½¿ç”¨äº†é€‰ä¸­æ—¶å€™çš„é¢œè‰²çŠ¶æ€ï¼Œç„¶åé€šè¿‡<code>titleMaskView</code>è¿›è¡Œé®ç½©ï¼Œè¿™æ ·ï¼Œ<code>selectedTitleLabelsContentView</code>å…¶ä½™éƒ¨åˆ†å°±è¢«éšè—ï¼Œä¼šæ˜¾ç¤ºå‡ºä¸‹éƒ¨<code>titleLabelsContentView</code>æ™®é€šçŠ¶æ€çš„Labelé¢œè‰²ã€‚</p>
<p>å˜¿å˜¿ï¼Œè¯»ä¸€ä¸‹å‰©ä¸‹çš„æºä»£ç ï¼Œå’Œæˆ‘çš„çŒœæµ‹ä¸€è‡´ï¼Œä¸å¾—ä¸è¯´ï¼Œ<strong>æˆ‘çœŸæ˜¯å¤ªèªæ˜äº†</strong>ï¼Œè¿™ä¸ªæ€è·¯çœŸæ˜¯å¤ªèµäº†ã€‚</p>
<h3 id="å¦‚ä½•çœŸæ­£å®ç°ä¸€ä¸ªå¥½çš„UIåº“">å¦‚ä½•çœŸæ­£å®ç°ä¸€ä¸ªå¥½çš„UIåº“</h3><p>çœ‹åˆ°è¿™ä¸ªå°æ ‡é¢˜ï¼Œå¯èƒ½æœ‰äººä¼šäº§ç”Ÿç–‘æƒ‘ï¼Œå®ç°å¥½ä¸€ä¸ªUIåº“ä¸å°±æ˜¯åŠŸèƒ½æ­£ç¡®ï¼Œæ•ˆæœæ­£å¸¸å—ï¼Ÿé”™ï¼</p>
<p>æˆ‘è®¤ä¸ºè¿™åªæ˜¯åŸºæœ¬çš„ä¸¤ç‚¹ï¼Œè¿˜æœ‰å¦‚ä¸‹å‡ ç‚¹éœ€è¦åŒ…å«ï¼š</p>
<ul>
<li>ä½¿ç”¨æ­£ç¡®çš„ç±»å‹</li>
<li>åœ¨æ­£ç¡®çš„å‡½æ•°ä¸­åšæ­£ç¡®çš„äº‹</li>
<li>æš´éœ²ä¸è¿‡å¤šä¹Ÿä¸è¿‡å°‘çš„å±æ€§</li>
<li>æŠ›å‡ºã€ç›‘å¬ç›¸å¯¹åº”çš„äº‹ä»¶</li>
<li>æ ¹æ®ä¸åŒå±å¹•å¤§å°ã€å±å¹•æ–¹å‘è¿›è¡Œé€‚é…</li>
<li>æ¨ªç«–å±æƒ…å†µéƒ½èƒ½å±•ç¤ºè‰¯å¥½</li>
</ul>
<ol>
<li><p>ç¬¬ä¸€ï¼Œä»DGRunkeeperSwitchæ¥çœ‹ï¼Œé¦–å…ˆç”±äºå…¶æ¨¡ä»¿çš„æ˜¯UISegmentControlï¼Œæ‰€ä»¥è‡ªç„¶è€Œç„¶çš„åº”è¯¥ç»§æ‰¿ä¸<strong>UIControl</strong>è€Œä¸æ˜¯UIViewã€‚æœ‰äººè¦é—®æœ‰å•¥åŒºåˆ«ï¼Œç®€å•æ¥è¯´å°±æ˜¯<strong>UIControlå°†UIViewä¸­èƒ½æ¥å—çš„Touchäº‹ä»¶ï¼Œè½¬æ¢æˆäº†æ›´é«˜çº§çš„UIEventï¼Œæ¯”å¦‚UITouchUpInsideã€‚</strong></p>
</li>
<li><p>ç¬¬äºŒï¼Œä½œè€…é€šè¿‡initå‡½æ•°è¿›è¡Œåˆå§‹åŒ–ï¼Œé€šè¿‡layoutSubviewè¿›è¡Œé¡µé¢å¸ƒå±€ï¼Œè€Œä¸æ˜¯åƒå¾ˆå¤šäººè‡ªå·±å†™ä»£ç æ—¶å°†å¾ˆå¤šä¸œè¥¿ä¸€çªèœ‚çš„å †åˆ°äº†initä¸­ã€‚</p>
</li>
<li><p>æä¾›äº†é¢œè‰²ã€å­—ä½“ã€è¾¹è·ä»¥åŠåŠ¨ç”»å¼¹æ€§ç­‰å±æ€§ç»™å¤–éƒ¨è°ƒç”¨ï¼ŒåŒæ—¶å°†ä¸åº”è¯¥æš´éœ²çš„å†…éƒ¨UIKitå˜é‡è¿›è¡Œç§æœ‰åŒ–ï¼Œå¹¶å°†<code>selectedIndex</code>é€šè¿‡<code>private(set)</code>å¯¹å¤–è®¾ç½®ä¸ºåªè¯»ã€‚</p>
</li>
<li><p>åœ¨åˆ‡æ¢Segmenté€‰æ‹©åï¼ŒæŠ›å‡ºäº†ç›¸åº”çš„<code>sendActionsForControlEvents(.ValueChanged)</code> ç”¨äºç»™å¤–éƒ¨ç›‘å¬ã€‚</p>
</li>
</ol>
<h3 id="æ•ˆæœä¹‹å¤–çš„é‡ç‚¹">æ•ˆæœä¹‹å¤–çš„é‡ç‚¹</h3><p>ä½œè€…åœ¨å®ç°è¿™ä¸ªé¡¹ç›®ä¹‹ä¸­ï¼Œæœ‰å‡ ç‚¹æ˜¯æ¯”è¾ƒå€¼å¾—æ³¨æ„çš„ï¼š</p>
<h4 id="åˆ©ç”¨å…ƒç»„åŒæ—¶èµ‹å€¼å¤šä¸ªå±æ€§">åˆ©ç”¨å…ƒç»„åŒæ—¶èµ‹å€¼å¤šä¸ªå±æ€§</h4><pre><code><span class="keyword">public</span> var leftTitle: <span class="keyword">String</span> {
    <span class="built_in">set</span> { (leftTitleLabel.<span class="built_in">text</span>, selectedLeftTitleLabel.<span class="built_in">text</span>) = (newValue, newValue) }
    <span class="built_in">get</span> { <span class="keyword">return</span> leftTitleLabel.<span class="built_in">text</span>! }
}
</code></pre><p>åœ¨Swiftä¸­å¼•å…¥äº†ä¸€ä¸ªå…ƒç»„çš„æ–°ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ•°æ®ç»“æ„åŒæ—¶ç»™å¤šä¸ªå±æ€§èµ‹å€¼ã€‚</p>
<h4 id="private(set)">private(set)</h4><pre><code><span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">public</span> <span class="variable"><span class="keyword">var</span> selectedIndex</span>: <span class="typename">Int</span> = <span class="number">0</span>
</code></pre><p>ä½œè€…åœ¨å®ç°è¿‡ç¨‹ä¸­ä¿ç•™äº†ä¸€ä¸ª<code>selectedIndex</code> å˜é‡ï¼Œä½†æ˜¯è¿™ä¸ªç±»å¯¹å¤–åªè¯»ï¼Œå¯¹å†…å¯ä»¥è¯»å†™ï¼Œå› æ­¤ç”¨äº†<strong>private(set)</strong>ã€‚</p>
<p><strong>è¿™ç›¸å½“äºåœ¨Objective-Cæ—¶ä»£ï¼Œæˆ‘ä»¬åœ¨.hæ–‡ä»¶ä¸­å£°æ˜  <code>@property(nonatomic, strong, readonly) Class *A</code><br>ç„¶ååˆåœ¨.mæ–‡ä»¶ä¸­ï¼Œå£°æ˜  <code>@property(nonatomic, strong, readwrite) Class *A</code></strong></p>
<h4 id="UIViewå’ŒCALayer">UIViewå’ŒCALayer</h4><p>å¾ˆå¤šäººå†™iOSçš„æ—¶å€™ï¼Œåˆ†ä¸æ¸…UIViewå’ŒCALayerä¹‹é—´çš„åŒºåˆ«ï¼Œå¾ˆå¤šäººéƒ½ç†è§£æˆäº†ç»§æ‰¿çš„å…³ç³»ã€‚å¤§é”™ç‰¹é”™ï¼</p>
<ul>
<li>å®é™…ä¸ŠUIViewé‡Œé¢æœ‰ä¸ªæˆå‘˜å˜é‡æ˜¯CALayerï¼Œè€ŒCALayerçš„delegateæ˜¯UIView(è¿™ä¼šæ¶‰åŠåˆ°å¾ˆå¤šçš„éšå¼åŠ¨ç”»ä¹‹ç±»çš„ï¼Œä¸å±•å¼€äº†)</li>
<li>UIViewå¯ä»¥æ¥å—Touchäº‹ä»¶ï¼Œè€ŒLayerä¸è¡Œ</li>
<li>UIViewæœ‰ä¸ªlayerClassçš„ç±»å‹æ–¹æ³•ï¼Œå¯ä»¥è¢«å¤å†™ï¼Œç”¨äºæ”¹å˜è¿™ä¸ªUIViewå¯¹åº”çš„åŸºç¡€Layerç±»å‹ï¼Œæ¯”å¦‚ä½ å¯ä»¥å°†èµ‹å€¼CAGradientLayerç»™è¿™ä¸ªView</li>
</ul>
<p>åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œä½œè€…å¤å†™äº†layerClassï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code><span class="keyword">override</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">layerClass</span>() -&gt; <span class="title">AnyClass</span> </span>{
    <span class="keyword">return</span> DGRunkeeperSwitchRoundedLayer.self
}
</code></pre><p>å¥½å•¦ï¼Œä»Šå¤©å°±å·®ä¸å¤šåˆ°è¿™å•¦~ä¸‹å‘¨å†è§ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2016/02/05/DGRunKeeperSwitch/" data-id="cjqdxq21y003fmxi1htovyz36" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2016/02/05/DGRunKeeperSwitch/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-PureLayout" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/05/PureLayout/" class="article-date">
  <time datetime="2016-02-05T14:33:20.000Z" itemprop="datePublished">2016-02-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/05/PureLayout/">PureLayout æºç è§£æ</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>åœ¨å¼€å§‹è¿™ç¯‡æ–‡ç« ä¹‹å‰ï¼Œæƒ³å¿…å¤§å®¶éƒ½åº”è¯¥ä½¿ç”¨è¿‡Autolayoutæ–¹å¼çš„ç•Œé¢å¸ƒå±€ï¼Œç›¸ä¿¡å¤§å®¶éƒ½æœ‰è¿‡ç±»ä¼¼äºå¦‚ä¸‹è¿™æ ·çš„APIè°ƒç”¨ï¼š    </p>
<pre><code>[NSLayoutConstraint(item: self.viewA, attribute: .CenterY, relatedBy: .Equal, toItem: self.viewB, attribute: .CenterY, multiplier: <span class="number">1.0</span>, constant: <span class="number">0.0</span>)]
</code></pre><p>æŠ‘æˆ–æ˜¯Visual Format Language</p>
<pre><code>NSLayoutConstraint.constraintsWithVisualFormat(<span class="string">"|-(leftPadding)-[imageView(imageViewWidth)]-(rigntPadding)-[labelA]-(4)-[labelB]-(&gt;=44)-|"</span>, <span class="string">options:</span> NSLayoutFormatOptions(<span class="string">rawValue:</span> <span class="number">0</span>), <span class="string">metrics:</span> methics, <span class="string">views:</span> views)
</code></pre><p>è¿™ç§å†—é•¿è€Œåˆæ™¦æ¶©çš„ä»£ç ï¼ŒçœŸæ˜¯æ¶å¿ƒäººå•Šã€‚å› æ­¤åœ¨Githubä¸Šæ¶Œç°äº†ä¸€å¤§å †ç®€åŒ–å¸ƒå±€çš„å¼€æºåº“ï¼Œå¦‚SnapKit, Mansoryä»¥åŠä»Šå¤©æˆ‘ä»¬è¦è¯´çš„PureLayoutã€‚  </p>
<p>åœ¨è¿™ä¹‹ä¸­ï¼ŒPureLayoutæ˜¯æœ€è½»é‡çº§çš„ï¼Œå®ƒä»…ä»…æ˜¯å¯¹Autolayoutç°æˆçš„è¯­æ³•è¿›è¡Œäº†ä¸€å±‚å°è£…ï¼Œç›¸è¾ƒäºMansoryå¼•å…¥çš„ä¸€äº›<strong>æ–°æ¦‚å¿µ</strong>ï¼ŒPurelayoutæ›´ç›´æ¥æ˜“æ‡‚ã€‚</p>
<h3 id="æºç è§£æ">æºç è§£æ</h3><p>Purelayoutçš„æºç åŸºæœ¬æ²¡ä»€ä¹ˆéš¾æ‡‚çš„åœ°æ–¹ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€ä¸‹å…¶é¡¹ç›®ç»“æ„ï¼š</p>
<ul>
<li>PurelayoutDefines.h</li>
<li>ALView + PureLayout.h/.m</li>
<li>NSArray + PureLayout.h/.m</li>
<li>NSLayoutConstraint + Purelayout.h/.m</li>
</ul>
<h4 id="PurelayoutDefines">PurelayoutDefines</h4><p>é¦–å…ˆä»PurelayoutDefinesä¸Šå…¥æ‰‹ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸»è¦æ˜¯è¿›è¡Œä¸€äº›ç±»ä¼¼<strong>Domain Specific Language</strong>å®šä¹‰çš„è½¬åŒ–ï¼Œå¦‚ï¼š</p>
<pre><code>typedef NS_ENUM(NSInteger, ALEdge) {
    /** The <span class="built_in">left</span> edge of the view. */
    ALEdgeLeft = NSLayoutAttributeLeft,
    /** The <span class="built_in">right</span> edge of the view. */
    ALEdgeRight = NSLayoutAttributeRight,
    /** The top edge of the view. */
    ALEdgeTop = NSLayoutAttributeTop,
    /** The bottom edge of the view. */
    ALEdgeBottom = NSLayoutAttributeBottom,
    /** The leading edge of the view (<span class="built_in">left</span> edge <span class="keyword">for</span> <span class="built_in">left</span>-<span class="keyword">to</span>-<span class="built_in">right</span> languages like English, <span class="built_in">right</span> edge <span class="keyword">for</span> <span class="built_in">right</span>-<span class="keyword">to</span>-<span class="built_in">left</span> languages like Arabic). */
    ALEdgeLeading = NSLayoutAttributeLeading,
    /** The trailing edge of the view (<span class="built_in">right</span> edge <span class="keyword">for</span> <span class="built_in">left</span>-<span class="keyword">to</span>-<span class="built_in">right</span> languages like English, <span class="built_in">left</span> edge <span class="keyword">for</span> <span class="built_in">right</span>-<span class="keyword">to</span>-<span class="built_in">left</span> languages like Arabic). */
    ALEdgeTrailing = NSLayoutAttributeTrailing
};
</code></pre><p>ä¸Šè¿°è¿™æ®µä»£ç ï¼Œå°±æ˜¯å°†ä¼ ç»Ÿçš„UIKitä¸­çš„NSLayoutAttributeçš„æšä¸¾ç±»å‹å…¨éƒ¨è½¬æ¢æˆå¯¹åº”çš„PureLayoutä¸­çš„å®šä¹‰ï¼Œå¦‚ALEdgeRightå¯¹åº”åˆ°NSLayoutAttributeRightã€‚</p>
<p><strong>LayoutMargins</strong><br>åœ¨è¿™é‡Œè¡¥å……ä¸€ç‚¹é¢˜å¤–çŸ¥è¯†ï¼Œåœ¨iOS8ä¸­ï¼Œè‹¹æœä¸ºAutolayoutå¼•å…¥äº†LayoutMarginsè¿™ä¸€æ¦‚å¿µã€‚è¿™ä¸ªæ¦‚å¿µä¹ä¸€å¬å¯èƒ½éƒ½ä¸äº†è§£ï¼Œä½†æ˜¯å¤§å®¶å›å¿†ä¸‹ï¼Œæ¯”å¦‚åœ¨Storyboardä¸­ï¼Œæˆ‘ä»¬æ‹–æ‹½ä¸€ä¸ªUIViewåˆ°ViewControllerçš„viewå¹¶è®¾ç½®è¾¹è·çš„æ—¶å€™ï¼Œä¸Šè¾¹è·å’Œä¸‹è¾¹è·å¯¹åº”çš„é™åˆ¶éƒ½æ˜¯layout guideï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://7lrzqz.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-01-26%20%E4%B8%8B%E5%8D%882.55.37.png" alt=""></p>
<p><img src="http://7lrzqz.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-01-26%20%E4%B8%8B%E5%8D%882.56.23.png" alt=""><br><img src="http://7lrzqz.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-01-26%20%E4%B8%8B%E5%8D%882.56.13.png" alt=""></p>
<p><strong>ç®€å•æ¥è¯´ï¼Œåœ¨iOS7ä¸Šå°±å·²ç»å­˜åœ¨äº†LayoutMarginäº†ï¼Œå½“æ—¶çš„ä½œç”¨æ˜¯ç”¨æ¥é™åˆ¶viewçš„çœŸå®å†…å®¹ä¸ä¼šè¢«UINavigationBarï¼ˆä¸Šéƒ¨ï¼‰ä»¥åŠUIToolbarï¼ˆä¸‹éƒ¨ï¼‰æ‰€é®ç›–</strong>ã€‚è€Œä»iOS8ä¸­å¼€å§‹ï¼Œè‹¹æœå°†è¿™ä¸€æŠ€æœ¯å¼•å…¥åˆ°äº†ä»»æ„ä¸€ä¸ªUIViewä¸­ã€‚</p>
<h4 id="ALView_+_Purelayout">ALView + Purelayout</h4><p><strong>ALViewå®é™…ä¸Šæ˜¯UIViewæˆ–è€…NSViewçš„åˆ«åï¼Œé€šè¿‡æ·»åŠ ALViewçš„åˆ†ç±»ï¼Œå¯ä»¥é€šè¿‡Defineåœ¨ç¼–è¯‘æœŸè¿›è¡Œæ›¿æ¢ï¼Œé¿å…ä¸ºNSViewå’ŒUIViewå„åˆ›å»ºä¸€ä»½é‡å¤çš„ä»£ç </strong>ã€‚è¿™ä¸ªç±»ä¸­çš„APIè¿‡å¤šï¼Œå› æ­¤æˆ‘ä»¬ä»¥è½´å¯¹é½ä¸ºå…¸å‹çš„ä¾‹å­æ¥åˆ†è§£ä¸‹æºç ï¼š</p>
<ol>
<li>è½´å¯¹é½<br>åœ¨PureLayoutä¸­ï¼ŒåŒ…æ‹¬<code>Vertical</code>, <code>Horizontal</code>, <code>Baseline</code>ç­‰å‡ ç§è½´å¯¹é½æ–¹å¼ï¼Œå…¶ä¸­BaselineæŒ‡çš„æ˜¯Viewä¸­æ½œåœ¨åŒ…å«æ–‡å­—çš„Baselineã€‚</li>
</ol>
<p>å¥½ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ç›¸å…³çš„API</p>
<pre><code><span class="comment">/** Aligns an axis of the view to the same axis of another view. */</span>
<span class="tag">-</span> (<span class="tag">NSLayoutConstraint</span> *)<span class="rule"><span class="attribute">autoAlignAxis</span>:<span class="value">(ALAxis)axis toSameAxisOfView:(ALView *)otherView</span></span>;
</code></pre><p>ä»è¯¥APIçš„åç§°ï¼Œæˆ‘ä»¬å¯ä»¥ç›´è§‚çš„æ„Ÿè§‰å‡ºå…¶ä½œç”¨æ˜¯ç”¨äºå°†ä¸¤ä¸ªViewæŒ‰ç…§åŒä¸€ä¸ªè½´å¯¹é½ã€‚è¿™ä¸ªAPIæ˜¯ä¸€ä¸ª<strong>Convenience Init</strong>ï¼Œå…¶å±‚å±‚ä¼ é€’</p>
<pre><code>- (NSLayoutConstraint *)<span class="string">autoAlignAxis:</span>(ALAxis)axis <span class="string">toSameAxisOfView:</span>(ALView *)otherView
{
    <span class="keyword">return</span> [self <span class="string">autoAlignAxis:</span>axis <span class="string">toSameAxisOfView:</span>otherView <span class="string">withOffset:</span><span class="number">0.0</span>];
}

- (NSLayoutConstraint *)<span class="string">autoAlignAxis:</span>(ALAxis)axis <span class="string">toSameAxisOfView:</span>(ALView *)otherView <span class="string">withOffset:</span>(CGFloat)offset
{
    <span class="keyword">return</span> [self <span class="string">autoConstrainAttribute:</span>(ALAttribute)axis <span class="string">toAttribute:</span>(ALAttribute)axis <span class="string">ofView:</span>otherView <span class="string">withOffset:</span>offset];
}
</code></pre><p>æœ€åè°ƒç”¨äº†</p>
<pre><code><span class="pp">- <span class="params">(<span class="variable">NSLayoutConstraint</span> *)</span>autoConstrainAttribute:<span class="params">(<span class="variable">ALAttribute</span>)</span>attribute toAttribute:<span class="params">(<span class="variable">ALAttribute</span>)</span>toAttribute ofView:<span class="params">(<span class="variable">ALView</span> *)</span>otherView withOffset:<span class="params">(<span class="variable">CGFloat</span>)</span>offset`</span>
</code></pre><p>å¥½ï¼Œé‚£å°±è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªä¸Šè¿°è¿™ä¸ªå‡½æ•°çš„å®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code><span class="comment">//1.</span>
self.translatesAutoresizingMaskIntoConstraints = NO;

<span class="comment">//2.</span>
NSLayoutAttribute layoutAttribute = [NSLayoutConstraint <span class="string">al_layoutAttributeForAttribute:</span>attribute];
NSLayoutAttribute toLayoutAttribute = [NSLayoutConstraint <span class="string">al_layoutAttributeForAttribute:</span>toAttribute];

<span class="comment">//3.</span>
NSLayoutConstraint *constraint = [NSLayoutConstraint <span class="string">constraintWithItem:</span>self <span class="string">attribute:</span>layoutAttribute <span class="string">relatedBy:</span>relation <span class="string">toItem:</span>otherView <span class="string">attribute:</span>toLayoutAttribute <span class="string">multiplier:</span><span class="number">1.0</span> <span class="string">constant:</span>offset];

<span class="comment">//4.</span>
[constraint autoInstall];
<span class="keyword">return</span> constraint;
</code></pre><ul>
<li>1.é¦–å…ˆå°†translatesAutoresizingMaskIntoConstraintsè®¾ç½®ä¸ºfalseï¼Œå¯¹äºè¦ä½¿ç”¨autolayoutçš„UIViewï¼Œå¿…é¡»è®¾ç½®ä¸ºfalseï¼Œä¹Ÿå°±æ˜¯ä¸å°†ä¼ ç»Ÿframeå¸ƒå±€ä¸­çš„Autoresizing Maskè½¬æ¢æˆçº¦æŸã€‚</li>
<li>2.æ ¹æ®ä¼ å…¥çš„<strong>PureLayoutå±æ€§</strong>è½¬æ¢æˆå¯¹åº”çš„NSLayoutAttribute</li>
<li>3.è°ƒç”¨å†—é•¿æ¶å¿ƒçš„Autolayout APIæ„å»ºçº¦æŸ</li>
<li>4.æ·»åŠ çº¦æŸ</li>
</ul>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€ä¸‹è¿™ä¸ª<code>[constraint autoInstall]</code>ï¼Œè®©æˆ‘ä»¬æ¥æ¢ä¸€æ¢å®ç°ï¼š</p>
<pre><code>- (<span class="keyword">void</span>)autoInstall
{
<span class="comment">// 1. iOS8+</span>
<span class="preprocessor">#if __PureLayout_MinBaseSDK_iOS_8_0 || __PureLayout_MinBaseSDK_OSX_10_10</span>
    <span class="keyword">if</span> ([<span class="keyword">self</span> respondsToSelector:<span class="keyword">@selector</span>(setActive:)]) {
        [<span class="built_in">NSLayoutConstraint</span> al_applyGlobalStateToConstraint:<span class="keyword">self</span>];
        <span class="comment">// 1.1</span>
        <span class="keyword">if</span> ([<span class="built_in">NSLayoutConstraint</span> al_preventAutomaticConstraintInstallation]) {         
            [[<span class="built_in">NSLayoutConstraint</span> al_currentArrayOfCreatedConstraints] addObject:<span class="keyword">self</span>];
        } <span class="keyword">else</span> {
        <span class="comment">// 1.2 </span>
            <span class="keyword">self</span><span class="variable">.active</span> = <span class="literal">YES</span>;
        }
        <span class="keyword">return</span>;
    }
<span class="preprocessor">#endif /* __PureLayout_MinBaseSDK_iOS_8_0 || __PureLayout_MinBaseSDK_OSX_10_10 */</span>

<span class="comment">// 2. iOS 7</span>
    <span class="built_in">NSAssert</span>(<span class="keyword">self</span><span class="variable">.firstItem</span> || <span class="keyword">self</span><span class="variable">.secondItem</span>, <span class="string">@"Can't install a constraint with nil firstItem and secondItem."</span>);
    <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.firstItem</span>) {
        <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.secondItem</span>) {
            <span class="built_in">NSAssert</span>([<span class="keyword">self</span><span class="variable">.firstItem</span> isKindOfClass:[ALView class]] &amp;&amp; [<span class="keyword">self</span><span class="variable">.secondItem</span> isKindOfClass:[ALView class]], <span class="string">@"Can only automatically install a constraint if both items are views."</span>);
            ALView *commonSuperview = [<span class="keyword">self</span><span class="variable">.firstItem</span> al_commonSuperviewWithView:<span class="keyword">self</span><span class="variable">.secondItem</span>];
            [commonSuperview al_addConstraint:<span class="keyword">self</span>];
        } <span class="keyword">else</span> {
            <span class="built_in">NSAssert</span>([<span class="keyword">self</span><span class="variable">.firstItem</span> isKindOfClass:[ALView class]], <span class="string">@"Can only automatically install a constraint if the item is a view."</span>);
            [<span class="keyword">self</span><span class="variable">.firstItem</span> al_addConstraint:<span class="keyword">self</span>];
        }
    } <span class="keyword">else</span> {
        <span class="built_in">NSAssert</span>([<span class="keyword">self</span><span class="variable">.secondItem</span> isKindOfClass:[ALView class]], <span class="string">@"Can only automatically install a constraint if the item is a view."</span>);
        [<span class="keyword">self</span><span class="variable">.secondItem</span> al_addConstraint:<span class="keyword">self</span>];
    }
}
</code></pre><p>æ•´ä¸ªå®ç°çš„éƒ¨åˆ†è¢«ä¸€åˆ†ä¸ºäºŒï¼Œä¸ŠåŠéƒ¨åˆ†ä¸“é—¨é’ˆå¯¹iOS8+çš„ï¼Œä¸‹åŠéƒ¨åˆ†é’ˆå¯¹iOS7ï¼ˆ<strong>äº‹å®ä¸Šåœ¨æ•´ä¸ªPureLayoutçš„è®¾è®¡ä¸­ï¼Œå¤§éƒ¨åˆ†åœ°æ–¹çš„å¤„ç†æ–¹å¼éƒ½ä¸€åˆ†ä¸ºäºŒäº†</strong>ï¼‰</p>
<p>æˆ‘ä»¬æš‚æ—¶ä¹Ÿä¸ç®¡<code>al_applyGlobalStateToConstraint:self</code> ä»¥åŠ <code>al_preventAutomaticConstraintInstallation</code>çš„ä½œç”¨ï¼Œæˆ‘ä»¬ä»1.2çœ‹èµ·ã€‚</p>
<ul>
<li>åœ¨iOS8ä¸Šï¼Œå¯ç”¨æˆ–è€…ç¦ç”¨ä¸€ä¸ªAutoLayoutçš„Constraintå˜å¾—æ›´åŠ å®¹æ˜“äº†ï¼Œä»…ä»…éœ€è¦è®¾ç½®activeå³å¯</li>
<li>åœ¨iOS7ä¸Šï¼Œéœ€è¦æ‰‹åŠ¨çš„addConstraintæˆ–è€…removeConstraint</li>
<li>åœ¨å¤„ç†iOS7çš„é€»è¾‘å½“ä¸­ï¼Œéœ€è¦åˆ¤æ–­å½“å‰è¿™ä¸ªConstraintæ˜¯å¦æ˜¯é’ˆå¯¹ä¸¤ä¸ªItemçš„ï¼Œå¦‚æœæ˜¯ï¼Œæ‰¾åˆ°ä»–ä»¬çš„å…¬å…±çˆ¶Viewï¼Œåœ¨çˆ¶Viewåœ¨æ·»åŠ çº¦æŸï¼Œæ¯”å¦‚æ·»åŠ View Aå’ŒView Bä¹‹é—´çš„é—´è·ï¼›è€Œå¦‚æœæ˜¯å•ä¸€ä¸€ä¸ªViewï¼Œæ¯”å¦‚æ˜¯è®¾ç½®é«˜åº¦æˆ–è€…å®½åº¦çš„ï¼Œç›´æ¥åœ¨å½“å‰Viewæ·»åŠ å³å¯ã€‚</li>
<li>é€šè¿‡è°ƒç”¨<code>al_addConstraint</code>è¿›è¡Œçº¦æŸå®é™…çš„æ·»åŠ ã€‚</li>
</ul>
<p>è€Œ<strong>al_addConstraint</strong>çš„å®ç°åˆ™å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code><span class="attr_selector">[NSLayoutConstraint al_applyGlobalStateToConstraint:constraint]</span>;
<span class="tag">if</span> ([NSLayoutConstraint al_preventAutomaticConstraintInstallation]) {
    <span class="attr_selector">[[NSLayoutConstraint al_currentArrayOfCreatedConstraints]</span> <span class="tag">addObject</span><span class="pseudo">:constraint</span>];
} <span class="tag">else</span> {
    <span class="attr_selector">[self addConstraint:constraint]</span>;
}
</code></pre><p>è¿™é‡Œåˆå‡ºç°äº†<code>al_applyGlobalStateToConstraint:constraint</code>ä»¥åŠ<code>al_preventAutomaticConstraintInstallation</code>äº†ï¼Œè¿™æ¬¡æˆ‘ä»¬å¯ä¸èƒ½å†èº²ç€å®ƒäº†ï¼Œèµ¶ç´§ç§ä¸€ç§ã€‚</p>
<p>é¦–å…ˆæ˜¯<code>al_applyGlobalStateToConstraint:constraint</code>ï¼Œè¿™ä¸ªå‚æ•°å¯¹åº”çš„æ˜¯ä¸€ä¸ªå…¨å±€é™æ€å˜é‡ï¼Œç”¨äºåˆ¤æ–­ï¼š</p>
<pre><code><span class="keyword">if</span> ([<span class="built_in">NSLayoutConstraint</span> al_isExecutingPriorityConstraintsBlock]) {
    constraint<span class="variable">.priority</span> = [<span class="built_in">NSLayoutConstraint</span> al_currentGlobalConstraintPriority];
}
</code></pre><p>è€Œè¿™ä¸ª<code>al_isExecutingPriorityConstraintsBlock</code>åˆ™æ˜¯ç”¨äºå¦‚ä¸‹è¿™ä¸ªå‡½æ•°ï¼š</p>
<pre><code>+ (void)autoSetPriority:(ALLayoutPriority)priority forConstraints:(ALConstraintsBlock)<span class="keyword">block
</span>{
    NSAssert(<span class="keyword">block, </span><span class="comment">@"The constraints block cannot be nil.");</span>
    <span class="preprocessor">if</span> (<span class="keyword">block) </span>{
        [[<span class="keyword">self </span>al_globalConstraintPriorities] <span class="keyword">addObject:@(priority)];
</span>        <span class="keyword">block();
</span>        [[<span class="keyword">self </span>al_globalConstraintPriorities] removeLastObject]<span class="comment">;</span>
    }
}
</code></pre><p>è¿™é‡Œå¯èƒ½å¤§å®¶æœ‰ç‚¹æ™¦æ¶©ï¼Œä¸»è¦åœ¨äºPureLayoutå¯¹äºç»™Constraintè®¾ç½®Priorityå®šä¹‰äº†ä¸€ä¸ªBlock-basedçš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯<code>autoSetPriority</code>ã€‚åœ¨å›è°ƒçš„Blockä¸­ï¼Œå¯ä»¥å¯¹å¤šä¸ªConstraintè®¾ç½®åŒä¸€ä¸ªå¤§å°çš„Priorityã€‚ï¼ˆ<strong>å…¶å®æˆ‘ä¹Ÿä¸æ˜¯å¾ˆç†è§£è¿™ä¸ªé›†ä½“åŠ Priorityè®¾è®¡çš„ç›®çš„</strong>ï¼‰</p>
<p><strong>ä¸è¿‡éœ€è¦æœ‰ä¸€ç‚¹å¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œè®¾ç½®Constraintçš„Priorityçš„æ—¶æœºä¸€å®šè¦åœ¨<code>addConstraint</code>æˆ–è€…<code>active = true</code>ä¹‹å‰</strong></p>
<p>è€Œå¯¹äº<code>al_preventAutomaticConstraintInstallation</code>è¿™ä¸ªå˜é‡ï¼Œä½œè€…åœ¨APIä¸­æè¿°äº†å¦‚ä¸‹ä¸€æ®µè¯ï¼š</p>
<blockquote>Creates all of the constraints in the block, then installs (activates) them all at once.<br> All constraints created from calls to the PureLayout API in the block are returned in a single array.<br> This may be more efficient than installing (activating) each constraint one-by-one.</blockquote>

<p>ç®€è€Œè¨€ä¹‹ï¼Œä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰çº¦æŸï¼ˆå®é™…ä¸Šè°ƒç”¨äº†UIKitçš„API<code>activateConstraints</code>ï¼‰ï¼Œæ¯”ä¸€ä¸ªä¸ªæ·»åŠ è¦æœ‰æ•ˆç‡ã€‚<strong>ç„¶è€Œï¼ŒPurelayoutçš„è¿™ä¸ªç‰¹æ€§å¯¹äºiOS7æ¥è¯´ï¼Œç”¨ä¸ä¸Šï¼Œåªèƒ½é€šè¿‡<code>addConstraint</code>ä¸€ä¸ªä¸ªè£…ï¼Œå“ˆå“ˆï¼Œä¹ˆä¹ˆå“’</strong></p>
<h4 id="NSArray_+_Purelayout">NSArray + Purelayout</h4><p>è¯´å®Œäº†ALViewçš„layoutï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è¯´è¯´å¦å¤–çš„NSArray + Purelayoutã€‚é¡¾åæ€ä¹‰ï¼Œè¯¥åˆ†ç±»çš„ä¸»è¦ç›®çš„å°±æ˜¯ç»™ä¸€ä¸ªNSArrayä¸­çš„æ‰€æœ‰UIViewæ·»åŠ çº¦æŸã€‚</p>
<p>æ¯”å¦‚è¿™ä¸ªAPIï¼š</p>
<pre><code>- <span class="list">(<span class="keyword">__NSArray_of</span><span class="list">(<span class="keyword">NSLayoutConstraint</span> <span class="variable">*) *</span>)</span>autoDistributeViewsAlongAxis:<span class="list">(<span class="keyword">ALAxis</span>)</span>axis
                                                           alignedTo:<span class="list">(<span class="keyword">ALAttribute</span>)</span>alignment
                                                    withFixedSpacing:<span class="list">(<span class="keyword">CGFloat</span>)</span>spacing
                                                        insetSpacing:<span class="list">(<span class="keyword">BOOL</span>)</span>shouldSpaceInsets
                                                        matchedSizes:<span class="list">(<span class="keyword">BOOL</span>)</span>shouldMatchSizes</span>
</code></pre><p>å…¶å®ç°å¦‚ä¸‹ï¼š</p>
<pre><code><span class="built_in">NSAssert</span>([<span class="keyword">self</span> al_containsMinimumNumberOfViews:<span class="number">1</span>], <span class="string">@"This array must contain at least 1 view to distribute."</span>);

<span class="comment">//1. ç¬¬ä¸€éƒ¨åˆ†</span>
    ALDimension matchedDimension;
    ALEdge firstEdge, lastEdge;
    <span class="keyword">switch</span> (axis) {
        <span class="keyword">case</span> ALAxisHorizontal:
        <span class="keyword">case</span> ALAxisBaseline: <span class="comment">// same value as ALAxisLastBaseline</span>
<span class="preprocessor">#if __PureLayout_MinBaseSDK_iOS_8_0</span>
        <span class="keyword">case</span> ALAxisFirstBaseline:
<span class="preprocessor">#endif /* __PureLayout_MinBaseSDK_iOS_8_0 */</span>
            matchedDimension = ALDimensionWidth;
            firstEdge = ALEdgeLeading;
            lastEdge = ALEdgeTrailing;
            <span class="keyword">break</span>;
        <span class="keyword">case</span> ALAxisVertical:
            matchedDimension = ALDimensionHeight;
            firstEdge = ALEdgeTop;
            lastEdge = ALEdgeBottom;
            <span class="keyword">break</span>;
        <span class="keyword">default</span>:
            <span class="built_in">NSAssert</span>(<span class="literal">nil</span>, <span class="string">@"Not a valid ALAxis."</span>);
            <span class="keyword">return</span> <span class="literal">nil</span>;
    }
    <span class="built_in">CGFloat</span> leadingSpacing = shouldSpaceInsets ? spacing : <span class="number">0.0</span>;
    <span class="built_in">CGFloat</span> trailingSpacing = shouldSpaceInsets ? spacing : <span class="number">0.0</span>;

<span class="comment">//2. ç¬¬äºŒéƒ¨åˆ†  </span>
    __<span class="built_in">NSMutableArray_of</span>(<span class="built_in">NSLayoutConstraint</span> *) *constraints = [<span class="built_in">NSMutableArray</span> new];
    ALView *previousView = <span class="literal">nil</span>;
    <span class="keyword">for</span> (<span class="keyword">id</span> object <span class="keyword">in</span> <span class="keyword">self</span>) {
        <span class="keyword">if</span> ([object isKindOfClass:[ALView class]]) {
            ALView *view = (ALView *)object;
            view<span class="variable">.translatesAutoresizingMaskIntoConstraints</span> = <span class="literal">NO</span>;
            <span class="keyword">if</span> (previousView) {
                <span class="comment">// Second, Third, ... View</span>
                [constraints addObject:[view autoPinEdge:firstEdge toEdge:lastEdge ofView:previousView withOffset:spacing]];
                <span class="keyword">if</span> (shouldMatchSizes) {
                    [constraints addObject:[view autoMatchDimension:matchedDimension toDimension:matchedDimension ofView:previousView]];
                }
                [constraints addObject:[view al_alignAttribute:alignment toView:previousView forAxis:axis]];
            }
            <span class="keyword">else</span> {
                <span class="comment">// First view</span>
                [constraints addObject:[view autoPinEdgeToSuperviewEdge:firstEdge withInset:leadingSpacing]];
            }
            previousView = view;
        }
    }
    <span class="keyword">if</span> (previousView) {
        <span class="comment">// Last View</span>
        [constraints addObject:[previousView autoPinEdgeToSuperviewEdge:lastEdge withInset:trailingSpacing]];
    }
    <span class="keyword">return</span> constraints;            
</code></pre><ol>
<li>è¿™ä¸ªAPIçš„ç›®çš„æ˜¯å°†ä¸€ç»„UIViewæŒ‰ç…§Spacingé—´è·è¿›è¡Œå‡åˆ†ï¼ŒåŒæ—¶æ¯ä¸ªUIViewçš„å®½åº¦æˆ–è€…é«˜åº¦ä¿æŒä¸€è‡´ã€‚</li>
<li>ç¬¬ä¸€éƒ¨åˆ†æ˜¯æ ¹æ®ä¼ å…¥çš„è½´ï¼Œè¿›è¡Œåˆ¤æ–­ï¼Œæ˜¯åœ¨ç«–ç›´æ–¹å‘å‡åˆ†è¿˜æ˜¯æ°´å¹³æ–¹å‘å‡åˆ†ï¼ŒåŒæ—¶å½±å“çš„è¿˜æœ‰æ˜¯å®½åº¦ä¸€è‡´è¿˜æ˜¯é«˜åº¦ä¸€è‡´ã€‚</li>
<li>ç¬¬äºŒéƒ¨åˆ†æ˜¯æ ¹æ®ä¼ å…¥çš„è½´ï¼ˆæ¯”å¦‚æ°´å¹³æ–¹å‘ï¼‰ï¼Œå°†å‰ä¸€ä¸ªViewçš„å³è¾¹è·å’Œåä¸€ä¸ªViewçš„å·¦è¾¹è·æ·»åŠ é—´è·ï¼Œå¾ªç¯æ·»åŠ ï¼Œç›´è‡³æœ€åä¸€ä¸ªViewçš„å³è¾¹è·å’Œçˆ¶Viewçš„å³è¾¹è·æ·»åŠ å®Œæˆçº¦æŸã€‚  </li>
</ol>
<p>å…¶ä»–æ–¹é¢ï¼Œè¿™ä¸ªåˆ†ç±»çš„ä½œç”¨åŸºæœ¬å’Œ<code>ALView + PureLayoutä¸€è‡´</code>ï¼Œä¹Ÿå°±ä¸å†é‡å¤è§£é‡Šäº†ã€‚<br>è‡³æ­¤ï¼ŒPureLayoutçš„æºç è§£æåŸºæœ¬ä¸Šå·®ä¸å¤šäº†ï¼Œå…¶ä½™ç±»ä¼¼äºè¾¹å¯¹é½çš„APIï¼Œå¦‚ï¼š</p>
<pre><code><span class="pp">- <span class="params">(<span class="variable">NSLayoutConstraint</span> *)</span>autoPinEdge:<span class="params">(<span class="variable">ALEdge</span>)</span>edge toEdge:<span class="params">(<span class="variable">ALEdge</span>)</span>toEdge ofView:<span class="params">(<span class="variable">ALView</span> *)</span>otherView;</span>
</code></pre><p>åˆæˆ–è€…æ˜¯çº¦æŸå°ºå¯¸çš„ï¼Œå¦‚ï¼š</p>
<pre><code>- <span class="list">(<span class="keyword">__NSArray_of</span><span class="list">(<span class="keyword">NSLayoutConstraint</span> <span class="variable">*) *</span>)</span>autoSetDimensionsToSize:<span class="list">(<span class="keyword">CGSize</span>)</span>size<span class="comment">;</span></span>
</code></pre><p>éƒ½å¤§åŒå°å¼‚ï¼Œåœ¨æ­¤å°±ä¸ä¸€ä¸€èµ˜è¿°äº†ã€‚</p>
<p>æœ€åï¼Œ<strong>å¼ºè°ƒä¸€ç‚¹</strong>ï¼š</p>
<ol>
<li>PureLayoutå¿…é¡»åœ¨ä¸»çº¿ç¨‹ä½¿ç”¨ï¼Œå…¶æœ¬èº«å®ç°éå¸¸ä¾èµ–äºé™æ€çš„å…¨å±€å˜é‡ã€‚</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2016/02/05/PureLayout/" data-id="cjqdxq1zz0022mxi1zrcsqbkf" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2016/02/05/PureLayout/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-Refactor-Mega-ViewController" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/30/Refactor-Mega-ViewController/" class="article-date">
  <time datetime="2015-12-29T16:37:56.000Z" itemprop="datePublished">2015-12-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/30/Refactor-Mega-ViewController/">é‡æ„ä½ çš„ViewController</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>è¿™ç¯‡æ–‡ç« æ¥è‡ªé˜…è¯»<a href="https://realm.io/news/andy-matuschak-refactor-mega-controller/" target="_blank" rel="external">Letâ€™s Play: Refactor the Mega Controller!</a></p>
<p>åœ¨è¯¥æ–‡ä¸­ï¼Œä½œè€…é˜è¿°äº†å¦‚ä½•ä½¿ç”¨Swifté‡æ„ä¸€ä¸ªè‡­åæ˜­è‘—çš„Massive View Controllerã€‚ä»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€çª¥Swiftè¯¸å¤šä¼˜ç§€çš„ç‰¹æ€§ä»¥åŠå¦‚ä½•åˆ©ç”¨è¿™äº›ç‰¹æ€§å°†ViewControllerçš„èŒè´£è¿›è¡Œè§£è€¦ã€‚</p>
<p>ä½†æ˜¯ä½œè€…ç”±äºæ—¶é—´æœ‰é™ï¼Œå¹¶æ²¡æœ‰è®²è¿°å®Œå…¨ï¼Œå› æ­¤æœ¬æ–‡æ˜¯æˆ‘é˜…è¯»<a href="https://github.com/andymatuschak/refactor-the-mega-controller" target="_blank" rel="external">æºç </a>åçš„ç†è§£ã€‚</p>
<p><strong>å»ºè®®å¤§å®¶åœ¨é˜…è¯»æœ¬æ–‡ä¹‹å‰ï¼Œèƒ½å¤Ÿå…ˆå»çœ‹çœ‹é“¾æ¥ä¸­çš„è§†é¢‘ã€‚</strong></p>
<h3 id="Letâ€™s_get_started">Letâ€™s get started</h3><p>é¦–å…ˆæˆ‘ä»¬ä¸‹è½½æºç ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ–‡ä»¶ï¼š</p>
<pre><code>-<span class="ruby"> <span class="constant">NavigationController</span>.swift
</span>-<span class="ruby"> <span class="constant">ViewController</span>.swift
</span>-<span class="ruby"> <span class="constant">AddViewController</span>.swift</span>
</code></pre><p>å…¶ä¸­ï¼Œ<code>ViewController.swift</code>æ˜¯é¡¹ç›®çš„æ ¸å¿ƒï¼Œä»£ç è¡Œæ•°è¶…è¿‡<strong>246</strong>è¡Œã€‚åœ¨è¿™é‡Œæˆ‘è¦å¼ºè°ƒä¸€ä¸‹ï¼Œå¹¶ä¸æ˜¯ä»£ç è¡Œæ•°å¤šä¸å¥½ï¼Œè€Œæ˜¯è¦çœ‹ä½ è¿™ä¸ªèŒè´£æ˜¯ä¸æ˜¯ç›¸å…³ã€‚å¦‚æœ246è¡Œéƒ½æ˜¯åœ¨å®ç°ä¸€ä¸ªæ•°æ®ç»“æ„æˆ–è€…ç®—æ³•ï¼Œå½“ç„¶å¯è¡Œã€‚ä½†æ˜¯å¦‚æœ246è¡Œé‡Œé¢åŒ…å«äº†é€»è¾‘ä¸šåŠ¡ã€ç½‘ç»œè¯·æ±‚ã€æ•°æ®æŒä¹…åŒ–ï¼Œé‚£å¿…ç„¶æ˜¯å¯ä»¥åˆ†ç¦»ä¸€éƒ¨åˆ†èŒè´£å‡ºå»ã€‚</p>
<p>åœ¨æœ¬æ–‡çš„<code>ViewController.swift</code>ï¼Œè¿™ä¸ªç±»åœ¨åˆå§‹çŠ¶æ€ä¸‹åŒ…å«äº†<code>UITableViewDataSource</code>, <code>UITableViewDelegate</code>, <code>UIViewControllerTransitioningDelegate</code>, <code>UIViewControllerAnimatedTransitioning</code>, <code>NSFetchedResultsController</code>ä»¥åŠä¸€ç³»ç±»è·ŸUIæ˜¾ç¤ºç›¸å…³çš„ä»£ç ã€‚</p>
<h4 id="1-_å¹²æ‰UINavigationBarç›¸å…³çš„å†…å®¹">1. å¹²æ‰UINavigationBarç›¸å…³çš„å†…å®¹</h4><p>ä½œè€…åœ¨appä¸­æ„å»ºäº†å¯å˜åŒ–çš„NavigationBarï¼Œå› æ­¤barçš„æ ·å¼æ˜¯æ ¹æ®ä¸åŒçŠ¶æ€è¿›è¡Œæ”¹å˜çš„ã€‚åŸæ¥çš„é€»è¾‘æ•´ä½“å†™åœ¨äº†<code>ViewController.swift</code>ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code> func updateNavigationBar() {
        <span class="keyword">switch</span> fetchedResultsController!<span class="variable">.fetchedObjects</span>!<span class="variable">.count</span> {
        <span class="keyword">case</span> <span class="number">0.</span>.<span class="number">.3</span>:
            navigationController!<span class="variable">.navigationBar</span><span class="variable">.barTintColor</span> = <span class="literal">nil</span>
            navigationController!<span class="variable">.navigationBar</span><span class="variable">.titleTextAttributes</span> = <span class="literal">nil</span>
            navigationController!<span class="variable">.navigationBar</span><span class="variable">.tintColor</span> = <span class="literal">nil</span>
        <span class="keyword">case</span> <span class="number">4.</span>.<span class="number">.9</span>:
            navigationController!<span class="variable">.navigationBar</span><span class="variable">.barTintColor</span> = <span class="built_in">UIColor</span>(red: <span class="number">235</span>/<span class="number">255</span>, green: <span class="number">156</span>/<span class="number">255</span>, blue: <span class="number">77</span>/<span class="number">255</span>, alpha: <span class="number">1.0</span>)
            navigationController!<span class="variable">.navigationBar</span><span class="variable">.titleTextAttributes</span> = [<span class="built_in">NSForegroundColorAttributeName</span>: <span class="built_in">UIColor</span><span class="variable">.whiteColor</span>()]
            navigationController!<span class="variable">.navigationBar</span><span class="variable">.tintColor</span> = <span class="built_in">UIColor</span><span class="variable">.whiteColor</span>()
        <span class="keyword">default</span>:
            navigationController!<span class="variable">.navigationBar</span><span class="variable">.barTintColor</span> = <span class="built_in">UIColor</span>(red: <span class="number">248</span>/<span class="number">255</span>, green: <span class="number">73</span>/<span class="number">255</span>, blue: <span class="number">68</span>/<span class="number">255</span>, alpha: <span class="number">1.0</span>)
            navigationController!<span class="variable">.navigationBar</span><span class="variable">.titleTextAttributes</span> = [<span class="built_in">NSForegroundColorAttributeName</span>: <span class="built_in">UIColor</span><span class="variable">.whiteColor</span>()]
            navigationController!<span class="variable">.navigationBar</span><span class="variable">.tintColor</span> = <span class="built_in">UIColor</span><span class="variable">.whiteColor</span>()
        }
    }

override func preferredStatusBarStyle() -&gt; <span class="built_in">UIStatusBarStyle</span> {
    <span class="keyword">switch</span> fetchedResultsController?<span class="variable">.fetchedObjects</span>!<span class="variable">.count</span> {
    <span class="keyword">case</span> <span class="variable">.Some</span>(<span class="number">0.</span>.<span class="number">.3</span>), <span class="variable">.None</span>:
        <span class="keyword">return</span> <span class="variable">.Default</span>
    <span class="keyword">case</span> <span class="variable">.Some</span>(_):
        <span class="keyword">return</span> <span class="variable">.LightContent</span>
    }
}
</code></pre><p>åŒæ—¶ï¼Œè¿˜åœ¨å‡ ä¸ªäº‹ä»¶å›è°ƒçš„åœ°æ–¹ï¼Œå¦‚Core Dataçš„<code>controllerDidChange</code>ï¼Œè°ƒç”¨äº†<code>setNeedsStatusBarAppearanceUpdate()</code>ã€‚</p>
<p>è¿™ä¸ªæƒ³æ³•ç²—ç•¥æƒ³æƒ³å¹¶æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦æ ¹æ®ä¸€ç³»åˆ—çš„äº‹ä»¶å˜åŒ–æ¥æ”¹å˜æˆ‘ä»¬çš„ç•Œé¢æ ·å¼ï¼Œè¿™æ˜¯å¾ˆæ˜æ˜¾çš„ä¸šåŠ¡é€»è¾‘ã€‚è€Œæˆ‘ä»¬éƒ½å¾ˆæ¸…æ¥šï¼ŒViewControllerå°±æ˜¯ç”¨æ¥å†™ä¸šåŠ¡é€»è¾‘çš„åœ°æ–¹ã€‚</p>
<p>å…ˆæŠ›å¼€ViewControlleræ˜¯å¦æ˜¯åº”è¯¥å†™ä¸šåŠ¡é€»è¾‘çš„åœ°æ–¹è¿™ä¸€ä¸ªæœ‰å¾…å•†æ¦·çš„è®ºç‚¹ä¹‹å¤–ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥å¦‚ä½•é‡æ„ç°æœ‰ä»£ç ã€‚</p>
<p><strong>é¦–å…ˆ</strong>ï¼Œ<code>updateNavigationBar</code>ä¸­å¤šä¸ªcaseä¸­çš„ä»£ç æœ‰äº†é‡å¤ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†å…¶é‡æ„æˆä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—ä¸‰ä¸ªå…³äºæ ·å¼çš„å‚æ•°ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code>func applyTheme(<span class="string">barTintColor:</span>newBarTintColor, <span class="string">tintColor:</span>newTintColor, <span class="string">titleTextAttributes:</span>newTextAttributes) {
    barTintColor = <span class="string">barTintColor:</span>newBarTintColor
    tintColor = <span class="string">tintColor:</span>newTintColor
    titleTextAttributes = <span class="string">titleTextAttributes:</span>newTextAttributes
}
</code></pre><p>é‡æ„å®Œå‡½æ•°ä»¥åï¼Œæˆ‘ä»¬å‘ç°åœ¨å¤šä¸ªæ ·å¼ä¸­ç”¨åˆ°äº†switch caseè¿›è¡Œä¸šåŠ¡é€»è¾‘å‚æ•°è½¬æ¢æ ·å¼å‚æ•°çš„è¿‡ç¨‹ã€‚<strong>è¿™è¯´æ˜ä»€ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥å°†è½¬æ¢é€»è¾‘å’Œswitch caseä¸€èµ·é€šè¿‡Enumè¿›è¡Œé‡æ„ï¼ˆè¿™é‡Œè¯´çš„ä¸œè¥¿éƒ½æ˜¯åŸºäºä½ æ‡‚Enumï¼‰</strong></p>
<pre><code><span class="keyword">enum</span> NavigationTheme {
    <span class="keyword">case</span> Normal
    <span class="keyword">case</span> Warning
    <span class="keyword">case</span> Doomed

    var statusBarStyle: <span class="built_in">UIStatusBarStyle</span> {
        <span class="keyword">switch</span> <span class="keyword">self</span> {
        <span class="keyword">case</span> <span class="variable">.Normal</span>: <span class="keyword">return</span> <span class="variable">.Default</span>
        <span class="keyword">case</span> <span class="variable">.Warning</span>, <span class="variable">.Doomed</span>: <span class="keyword">return</span> <span class="variable">.LightContent</span>
        }
    }

    var barTintColor: <span class="built_in">UIColor</span>? {
        <span class="keyword">switch</span> <span class="keyword">self</span> {
        <span class="keyword">case</span> <span class="variable">.Normal</span>:
            <span class="keyword">return</span> <span class="literal">nil</span>
        <span class="keyword">case</span> <span class="variable">.Warning</span>:
            <span class="keyword">return</span> <span class="built_in">UIColor</span>(red: <span class="number">235</span>/<span class="number">255</span>, green: <span class="number">156</span>/<span class="number">255</span>, blue: <span class="number">77</span>/<span class="number">255</span>, alpha: <span class="number">1.0</span>)
        <span class="keyword">case</span> <span class="variable">.Doomed</span>:
            <span class="keyword">return</span> <span class="built_in">UIColor</span>(red: <span class="number">248</span>/<span class="number">255</span>, green: <span class="number">73</span>/<span class="number">255</span>, blue: <span class="number">68</span>/<span class="number">255</span>, alpha: <span class="number">1.0</span>)
        }
    }

    var titleTextAttributes: [String: <span class="built_in">NSObject</span>]? {
        <span class="keyword">switch</span> <span class="keyword">self</span> {
        <span class="keyword">case</span> <span class="variable">.Normal</span>:
            <span class="keyword">return</span> <span class="literal">nil</span>
        <span class="keyword">case</span> <span class="variable">.Warning</span>, <span class="variable">.Doomed</span>:
            <span class="keyword">return</span> [<span class="built_in">NSForegroundColorAttributeName</span>: <span class="built_in">UIColor</span><span class="variable">.whiteColor</span>()]
        }
    }

    var tintColor: <span class="built_in">UIColor</span>? {
        <span class="keyword">switch</span> <span class="keyword">self</span> {
        <span class="keyword">case</span> <span class="variable">.Normal</span>:
            <span class="keyword">return</span> <span class="literal">nil</span>
        <span class="keyword">case</span> <span class="variable">.Warning</span>, <span class="variable">.Doomed</span>:
            <span class="keyword">return</span> <span class="built_in">UIColor</span><span class="variable">.whiteColor</span>()
        }
    }
}

extension NavigationTheme {
    init(numberOfImminentTasks: Int) {
        <span class="keyword">switch</span> numberOfImminentTasks {
        <span class="keyword">case</span> -Int<span class="variable">.max</span> ... <span class="number">3</span>:
            <span class="keyword">self</span> = <span class="variable">.Normal</span>
        <span class="keyword">case</span> <span class="number">4.</span>.<span class="number">.9</span>:
            <span class="keyword">self</span> = <span class="variable">.Warning</span>
        <span class="keyword">default</span>:
            <span class="keyword">self</span> = <span class="variable">.Doomed</span>
        }
    }
}    
</code></pre><p>ç”±äºEnumåœ¨swiftä¸­æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œå› æ­¤å¯ä»¥å¯ä»¥åœ¨å…¶ä¸­æ„å»ºå¤§é‡çš„<strong>Computed Properties</strong>ï¼Œè¿™äº›è®¡ç®—å˜é‡ä¾èµ–äºå½“å‰enumçš„çŠ¶æ€ã€‚ä¸ä»…å¦‚æ­¤ï¼Œæˆ‘ä»¬è¿˜å°†ä¹‹å‰åˆ†æ•£çš„ä¸‰ç§æ ·å¼ï¼Œç»„åˆæˆäº†ä¸€ä¸ª<strong>ç´§å‡‘çš„ç»“æ„ä½“</strong>ï¼Œå¤§å¤§ç®€åŒ–äº†å˜é‡ä¼ è¾“ã€‚</p>
<p>é‡æ„ç»“æŸåï¼Œæˆ‘ä»¬åœ¨<code>Viewcontroller.swift</code>ä¸­è®¾ç½®ä¸€ä¸ªè®¡ç®—å˜é‡<code>navigationTheme</code>ï¼Œå…¶çš„æ„é€ å‡½æ•°æ˜¯ä¹‹å‰çš„<code>fetchedResultsController?.fetchedObjects?.count</code>ã€‚</p>
<p>æœ€åæ˜¯åœ¨ç›¸åº”çš„äº‹ä»¶åè§¦å‘æ›´æ–°UINavigationBarå³å¯ï¼Œåœ¨æœ¬æ–‡çš„è§†çº¿ä¸­ï¼Œæ˜¯é‡‡ç”¨äº†closureçš„å½¢å¼å®Œæˆï¼š</p>
<pre><code>navigationThemeDidChangeHandler = { [<span class="keyword">weak</span> <span class="keyword">self</span>] theme <span class="keyword">in</span>
            <span class="keyword">if</span> <span class="keyword">let</span> navigationController = <span class="keyword">self</span>?.navigationController {
                navigationController.navigationBar.applyTheme(theme)
                navigationController.statusBarStyle = theme.statusBarStyle
            }
        }
</code></pre><h3 id="2-_å¹²æ‰æ—¶é—´ç›¸å…³çš„è½¬æ¢é€»è¾‘">2. å¹²æ‰æ—¶é—´ç›¸å…³çš„è½¬æ¢é€»è¾‘</h3><p>ç›¸ä¿¡å¾ˆå¤šäººåšappçš„æ—¶å€™é‡åˆ°è¿‡ï¼ŒæœåŠ¡å™¨è¿”å›çš„æ˜¯ä¸€ç³»åˆ—æ ‡å‡†æ—¶é—´å‚æ•°ï¼Œè€Œä½ éœ€è¦å°†å…¶è½¬æ¢æˆç•Œé¢éœ€è¦çš„ç”Ÿæ—¥ã€æ˜Ÿåº§ã€å¹´é¾„ç­‰ç­‰ï¼Œè¿™åˆæ˜¯ä¸€å¤§å †çš„ä¸šåŠ¡é€»è¾‘ã€‚ä¸ºäº†è§£å†³è¿™ç§é€»è¾‘ä»£ç å’ŒViewControllerçš„è€¦åˆï¼Œå¾ˆå¤šäººæå‡ºäº†<code>ViewModel</code>ï¼Œå°†éƒ¨åˆ†å¼±ä¸šåŠ¡é€»è¾‘ä»£ç å‰¥ç¦»å‡ºæ¥ï¼Œå•ç‹¬å†™åœ¨ä¸€ä¸ªåœ°æ–¹ã€‚</p>
<p><strong>ä½†æ˜¯ï¼Œæˆ‘éœ€è¦å¼ºè°ƒä¸€ç‚¹ï¼Œè¿™ç§å½¢å¼çš„å‰¥ç¦»ï¼Œå¹¶ä¸èƒ½å«ViewModalï¼Œè€Œæ˜¯ä¸€ä¸ªç®€å•çš„adapterè€Œå·²ã€‚</strong></p>
<p>åœ¨æœ¬æ–‡ä¸­ï¼Œåˆ—è¡¨Cellé‡Œé¢éœ€è¦æ ¹æ®æ—¥æœŸè·ç¦»å½“å‰æ—¶é—´çš„å·®è·æ˜¾ç¤ºæˆæ˜¨å¤©ã€ä»Šå¤©ã€æ˜å¤©ç­‰ç­‰ã€‚å› æ­¤ï¼Œå…¶æ„å»ºäº†ä¸€ä¸ªå•ç‹¬çš„çš„DateFormatterï¼Œæ ¹æ®ä¼ å…¥çš„ä¸¤ä¸ªDateè¿›è¡Œè½¬æ¢ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code><span class="class"><span class="keyword">struct</span> <span class="title">RelativeTimeDateFormatter</span> </span>{
    <span class="keyword">let</span> calendar: <span class="type">NSCalendar</span>

    <span class="keyword">init</span>(calendar: <span class="type">NSCalendar</span> = <span class="type">NSCalendar</span>.autoupdatingCurrentCalendar()) {
        <span class="keyword">self</span>.calendar = calendar
    }

    <span class="func"><span class="keyword">func</span> <span class="title">stringForDate</span><span class="params">(date: NSDate, relativeToDate baseDate: NSDate)</span></span> -&gt; <span class="type">String</span> {
        <span class="keyword">var</span> beginningOfDate: <span class="type">NSDate</span>? = <span class="literal">nil</span>
        <span class="keyword">var</span> beginningOfBaseDate: <span class="type">NSDate</span>? = <span class="literal">nil</span>

        calendar.rangeOfUnit(.<span class="type">Day</span>, startDate: &amp;beginningOfDate, interval: <span class="literal">nil</span>, forDate: date)
        calendar.rangeOfUnit(.<span class="type">Day</span>, startDate: &amp;beginningOfBaseDate, interval: <span class="literal">nil</span>, forDate: baseDate)
        <span class="keyword">let</span> numberOfCalendarDaysBetweenDates = calendar.components(<span class="type">NSCalendarUnit</span>.<span class="type">Day</span>, fromDate: beginningOfBaseDate!, toDate: beginningOfDate!, options: <span class="type">NSCalendarOptions</span>()).day

        <span class="keyword">switch</span> numberOfCalendarDaysBetweenDates {
        <span class="keyword">case</span> -<span class="type">Int</span>.<span class="built_in">max</span> ... -<span class="number">2</span>:
            <span class="keyword">return</span> <span class="string">"<span class="subst">\(<span class="built_in">abs</span>(numberOfCalendarDaysBetweenDates)</span>) days ago"</span>
        <span class="keyword">case</span> -<span class="number">1</span>:
            <span class="keyword">return</span> <span class="string">"Yesterday"</span>
        <span class="keyword">case</span> <span class="number">0</span>:
            <span class="keyword">return</span> <span class="string">"Today"</span>
        <span class="keyword">case</span> <span class="number">1</span>:
            <span class="keyword">return</span> <span class="string">"Tomorrow"</span>
        <span class="keyword">default</span>:
            <span class="keyword">return</span> <span class="string">"In <span class="subst">\(numberOfCalendarDaysBetweenDates)</span> days"</span>
        }
    }
}
</code></pre><p><strong>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒNSCalendarçš„åˆå§‹åŒ–éå¸¸è€—æ—¶ï¼Œè¿‡å»åœ¨Objective-Cæ—¶ä»£å¸¸å¸¸ä½¿ç”¨dispatch_onceæ„å»ºå•ä¾‹ä¼ è¾“ï¼Œåœ¨è¿™é‡Œé€šè¿‡ç»“æ„ä½“ä¸­çš„æˆå‘˜å˜é‡ç»´æŠ¤äº†ä¸€ä»½ï¼Œä½œç”¨æ˜¯åŒæ ·çš„ã€‚</strong></p>
<h3 id="3-_å¹²æ‰NSPredicate">3. å¹²æ‰NSPredicate</h3><p>å¯¹äºNSPredicateï¼Œæœ‰äº›äººå¯èƒ½è¿˜ä¸ç†Ÿæ‚‰ï¼Œä»–å°±æ˜¯ç±»ä¼¼äºSQLiteä¸­çš„æŸ¥è¯¢è¯­å¥ï¼Œåªä¸è¿‡å…¶åº”ç”¨èŒƒå›´æ˜¯CoreDataã€‚å’¦ï¼ŒæŸ¥è¯¢è¯­å¥è¿˜èƒ½é‡æ„ï¼Ÿ</p>
<p>å…¶å®åœ¨æœ¬æ–‡ä¸­ï¼Œå¯¹äºNSPredicateçš„ä½¿ç”¨åªæœ‰åŸå…ˆè¿™ä¸€å¥  <code>fetchRequest.predicate = NSPredicate(format: &quot;dueDate &lt;= %@&quot;, argumentArray: [NSCalendar.currentCalendar().dateByAddingUnit(.Day, value: 10, toDate: NSDate(), options: NSCalendarOptions())!])</code></p>
<p>è¿™æ®µä»£ç ä»é‡å¤æ€§ä¸Šæ¥è¯´æ˜¯ä¸éœ€è¦é‡æ„çš„ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™é‡Œçš„æ„é€ å‚æ•°é‡Œé¢ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¿›è¡Œäº†ä¸€å®šçš„ä¸šåŠ¡é€»è¾‘è½¬æ¢ã€‚æ‰€ä»¥ï¼Œå’ŒDateFormatterä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†è¿™éƒ¨åˆ†æ‰€è°“ä¸ºçš„â€å¼±ä¸šåŠ¡é€»è¾‘â€ä»£ç è¿›è¡Œå‰¥ç¦»ï¼š</p>
<pre><code>extension NSPredicate {
    convenience init(forTasksWithinNumberOfDays <span class="string">numberOfDays:</span> Int, ofDate <span class="string">date:</span> NSDate, <span class="string">calendar:</span> NSCalendar = NSCalendar.currentCalendar()) {
        self.init(<span class="string">format:</span> <span class="string">"dueDate &lt;= %@"</span>, <span class="string">argumentArray:</span> [calendar.dateByAddingUnit(.Day, <span class="string">value:</span> numberOfDays, <span class="string">toDate:</span> date, <span class="string">options:</span> NSCalendarOptions())!])
    }
}
</code></pre><p><strong>é™¤äº†ä¸šåŠ¡é€»è¾‘å‰¥ç¦»ä¹‹å¤–ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªNSPredicateçš„æ–°æ„é€ å‚æ•°ï¼Œå¯ä»¥æ¥å—ä¸€ä¸ª<code>calendar</code>ï¼Œè¿™å¯¹äºæµ‹è¯•ç”¨ä¾‹ç¼–å†™çš„ä¾èµ–æ³¨å…¥æ˜¯éå¸¸æœ‰å¥½å¤„çš„ã€‚</strong></p>
<h3 id="4-_Core_Data_Stack">4. Core Data Stack</h3><p>ç”¨è¿‡Core Dataçš„äººéƒ½çŸ¥é“ï¼ŒCore Dataçš„ä½¿ç”¨éå¸¸éº»çƒ¦ï¼Œéœ€è¦é…ç½®å¤§é‡çš„é€‰é¡¹ï¼Œç…§ç€è‹¹æœæºç å†™çš„ç»å†ç›¸ä¿¡å¤§å®¶éƒ½æœ‰è¿‡ï¼Œé‚£æ¶å¿ƒçš„200-300è¡Œé…ç½®ä»£ç ï¼ŒçœŸæ˜¯ä¹ˆä¹ˆå“’äº†ã€‚</p>
<p><strong>ä½†æ˜¯ï¼Œè¿™å‡ ç™¾è¡Œä»£ç åˆæ˜¯æ— æ³•çœç•¥çš„</strong>ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>ä¸€ä¸ªæ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ¡ˆå°±<code>Core Data Stack</code>    ã€‚æ„ä¸ºå°†CoreDataçš„åˆå§‹åŒ–ä»¥åŠå¤šä¸ªNSManagerObjectContextå°è£…è¿›<code>CoreDataStack</code> ç»´æŠ¤ã€‚ </p>
<p>åœ¨æœ¬æ–‡ä¸­ï¼Œå› ä¸ºåªæ˜¯ä½¿ç”¨äº†ä¸€ä¸ªä¸»çº¿ç¨‹çš„NSManagerObjectContextï¼Œæ‰€ä»¥å¯èƒ½è¯»è€…åœ¨é˜…è¯»æºç çš„æ—¶å€™å¯èƒ½è§‰å¾—è¿™ä¸ªé‡æ„åªæ˜¯å°†CoreDataé…ç½®ä»Viewå‰¥ç¦»äº†ã€‚ä½†æ˜¯å®é™…ä¸Šï¼Œä½¿ç”¨CoreDataStackå¯ä»¥åšåˆ°æ›´å¤šï¼Œå»ºè®®å¤§å®¶é˜…è¯»Githubä¸Šç›¸å…³é¡¹ç›®ã€‚</p>
<h3 id="5-_å¹²æ‰NSFetchedResultsControllerDelegate">5. å¹²æ‰NSFetchedResultsControllerDelegate</h3><p>NSFetchedResultsControllerå¤§å®¶å¯ä»¥ç®€å•ç†è§£ä¸ºè·å–CoreDataæ•°æ®çš„ä¸€ä¸ªä¸­ä»‹å±‚ã€‚æ ¹æ®ä¼ è¾“è¿›å…¥çš„è°“è¯­NSPredicateè¿›è¡ŒæŸ¥è¯¢ï¼ŒæŸ¥è¯¢ç»“æŸåé€šè¿‡ç›¸åº”çš„Delegateäº‹ä»¶å›è°ƒã€‚</p>
<p>åœ¨ä½œè€…çš„ä»£ç ä¸­ï¼Œä½œè€…é€šè¿‡æ„å»º<code>manager</code>çš„æ–¹å¼å‰¥ç¦»äº†NSFetchedResultsControllerçš„èŒè´£ï¼Œå°†NSFetchedResultsControllerçš„åˆå§‹åŒ–ã€å›è°ƒå°è£…è¿›äº†<code>UpcomingTaskDataManager.swift</code>ä¸­ã€‚</p>
<p><strong>ä¸è¿‡å€¼å¾—æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå°½ç®¡ä½œè€…å°è£…çš„NSFetchedResultsControllerDelegateçš„å›è°ƒï¼Œä½†æ˜¯ä¸ºäº†è®©è°ƒç”¨è€…å¯ä»¥è‡ªå®šä¹‰å¤„ç†äº‹ä»¶ï¼Œå®é™…ä¸Šä½œè€…è¿˜æ˜¯éœ€è¦æš´éœ²ä¸€äº›çš„Delegateï¼Œå½“ç„¶ï¼Œæ–°çš„å›è°ƒç›¸å¯¹æ¥è¯´è¿›è¡Œäº†ä¸€å®šçš„ç®€åŒ–ï¼ŒåŒæ—¶åœ¨æ•°æ®å›è°ƒæ—¶ç»è¿‡äº†ä¸šåŠ¡è½¬åŒ–ã€‚</strong></p>
<pre><code><span class="class"><span class="keyword">protocol</span> <span class="title">UpcomingTaskDataManagerDelegate</span> </span>{
    <span class="func"><span class="keyword">func</span> <span class="title">dataManagerWillChangeContent</span><span class="params">(dataManager: UpcomingTaskDataManager)</span></span>
    <span class="func"><span class="keyword">func</span> <span class="title">dataManagerDidChangeContent</span><span class="params">(dataManager: UpcomingTaskDataManager)</span></span>
    <span class="func"><span class="keyword">func</span> <span class="title">dataManager</span><span class="params">(dataManager: UpcomingTaskDataManager, didInsertRowAtIndexPath indexPath: NSIndexPath)</span></span>
    <span class="func"><span class="keyword">func</span> <span class="title">dataManager</span><span class="params">(dataManager: UpcomingTaskDataManager, didDeleteRowAtIndexPath indexPath: NSIndexPath)</span></span>
}
</code></pre><h3 id="6-_CoreDataModel_&lt;=&gt;_Model">6. CoreDataModel &lt;=&gt; Model</h3><p>è¿™ä¸€æ­¥æ˜¯å°†ä»Core Dataä¸­è·å–çš„NSManagedObject Model è½¬æ¢æˆä¸šåŠ¡ä¸­ä½¿ç”¨çš„Modelã€‚ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼ŸåŸå› æœ‰ä¸‰ä¸ªï¼š  </p>
<ul>
<li>CoreDataä¸­çš„å±æ€§ä¸€æ›´æ”¹ï¼Œå°±ä¼šè§¦å‘NSFetchedResultsControllerï¼Œè¿™ä¼šå¾ˆå½±å“æ€§èƒ½ã€‚</li>
<li>CoreDataä¸­çš„å±æ€§å­˜åœ¨å¾ˆå¤šbug</li>
<li>NSManagedObjectä¸æ˜¯ä¸€ä¸ªstructç±»å‹ï¼Œå¾ˆæœ‰å¯èƒ½<strong>è¯¯ä¼¤</strong></li>
</ul>
<pre>
import CoreData  
import Foundation

struct Task: Equatable {
    var id: String
    var title: String
    var dueDate: NSDate
}

func ==(lhs: Task, rhs: Task) -> Bool {
    return lhs.id == rhs.id && lhs.title == rhs.title && lhs.dueDate == rhs.dueDate
}

extension Task {
    init(managedTask: NSManagedObject) {
        self.id = managedTask.valueForKey("id") as! String
        self.title = managedTask.valueForKey("title") as! String
        self.dueDate = managedTask.valueForKey("dueDate") as! NSDate
    }
}
</pre>

<p>ä½œè€…ç”¨ä»¥ä¸Šçš„Taskç±»å‹æ›¿æ¢äº†CoreDataä¸­çš„ManagedObjectï¼Œå¯ä»¥æœ‰æ•ˆçš„é¿å…ä»¥ä¸Šé—®é¢˜ã€‚</p>
<h3 id="7-å°è£…æ•°æ®ç»“æ„">7.å°è£…æ•°æ®ç»“æ„</h3><p>åœ¨è¿™ä¸€æ­¥é‡Œï¼Œæˆ‘å°†ä½œè€…è‡ªå®šä¹‰<code>TaskTableViewCell</code>å’Œæ„å»º<code>AddCompletionSegue</code>åˆå¹¶åˆ°äº†ä¸€å—è¯´ã€‚</p>
<p>è¿™ä¸¤æ­¥çš„é‡æ„ï¼Œçœ‹ä¼¼ç®€å•ï¼Œä½†æ˜¯å…¶å®ä¹Ÿè•´å«äº†ä¸€ä¸ªæ€æƒ³ï¼š<strong>ç±»å‹è¶Šç¡®å®šï¼Œç¼–ç¨‹è¶Šå®¹æ˜“ï¼Œè¿è¡Œè¶Šå®‰å…¨</strong></p>
<p>åœ¨åŸæ–‡çš„å®ç°ï¼Œä¸€å¼€å§‹ä½œè€…éƒ½æ˜¯é€šè¿‡é‡‡ç”¨åŸºç¡€çš„æ•°æ®ç»“æ„UITableViewCellå’ŒUISegueã€‚è¿™æ ·å¸¦æ¥çš„åå¤„å°±æ˜¯ç±»å‹ä¸æ˜ç¡®å¯¼è‡´çš„èŒè´£ä¸æ˜ç¡®ã€‚å¯¹äºåŸºç¡€çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å¸¸å¸¸è¿˜è¦è¿›è¡Œç±»å‹åˆ¤æ–­å’Œè½¬æ¢ï¼Œå®¹æ˜“çŠ¯é”™ã€‚</p>
<h3 id="8-å¹²æ‰UITableViewDelegateå’ŒUITableViewDataSource">8.å¹²æ‰UITableViewDelegateå’ŒUITableViewDataSource</h3><p>è¿™ä¸€æ­¥æƒ³å¿…å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰äº†ï¼Œå¾®åšä¸Šæ•´å¤©çƒ­ä¼ äº†<em>ç”¨ViewModelé‡æ„ä½ çš„ViewController</em>ç»å¸¸æåŠçš„å°±æ˜¯å¹²æ‰UITableViewDelegateå’ŒUITableViewDataSourceã€‚</p>
<p>é‚£è¯´äº†é‚£ä¹ˆå¤šï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ç©¶ç«Ÿå¦‚ä½•å¹²æ‰å®ƒã€‚</p>
<p>æ¯«æ— ä»¥ä¸ºï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ„å»ºä¸€ä¸ªç±»å‹ï¼Œæ¥å®ç°UITableViewDelegateå’ŒDataSourceï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code><span class="comment">// 1. </span>
<span class="class"><span class="keyword">class</span> <span class="title">UpcomingTaskDataManagerTableViewAdapter</span>&lt;<span class="title">CellType</span>: <span class="title">UITableViewCell</span>&gt;: <span class="title">NSObject</span>, <span class="title">UITableViewDataSource</span>, <span class="title">UpcomingTaskDataManagerDelegate</span> </span>{
    private <span class="keyword">let</span> tableView: <span class="type">UITableView</span>
    private <span class="keyword">let</span> upcomingTaskDataManager: <span class="type">UpcomingTaskDataManager</span>
    private <span class="keyword">let</span> cellReuseIdentifier: <span class="type">String</span>
    private <span class="keyword">let</span> cellConfigurationHandler: (<span class="type">CellType</span>, <span class="type">Task</span>) -&gt; ()
    private <span class="keyword">let</span> didChangeHandler: () -&gt; <span class="type">Void</span>

<span class="comment">// .2</span>
    <span class="keyword">init</span>(tableView: <span class="type">UITableView</span>, upcomingTaskDataManager: <span class="type">UpcomingTaskDataManager</span>, cellReuseIdentifier: <span class="type">String</span>, cellConfigurationHandler: (<span class="type">CellType</span>, <span class="type">Task</span>) -&gt; (), didChangeHandler: () -&gt; <span class="type">Void</span>) {
        <span class="keyword">self</span>.tableView = tableView
        <span class="keyword">self</span>.upcomingTaskDataManager = upcomingTaskDataManager
        <span class="keyword">self</span>.cellReuseIdentifier = cellReuseIdentifier
        <span class="keyword">self</span>.cellConfigurationHandler = cellConfigurationHandler
        <span class="keyword">self</span>.didChangeHandler = didChangeHandler

        <span class="keyword">super</span>.<span class="keyword">init</span>()
    }

<span class="comment">// 3.</span>
    <span class="func"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(tableView: UITableView, commitEditingStyle editingStyle: UITableViewCellEditingStyle, forRowAtIndexPath indexPath: NSIndexPath)</span></span> {
        upcomingTaskDataManager.deleteTask(upcomingTaskDataManager.taskSections[indexPath.section].items[indexPath.row])
    }

    <span class="func"><span class="keyword">func</span> <span class="title">numberOfSectionsInTableView</span><span class="params">(tableView: UITableView)</span></span> -&gt; <span class="type">Int</span> {
        <span class="keyword">return</span> upcomingTaskDataManager.taskSections.<span class="built_in">count</span>
    }

    <span class="func"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(tableView: UITableView, titleForHeaderInSection section: Int)</span></span> -&gt; <span class="type">String</span>? {
        <span class="keyword">return</span> upcomingTaskDataManager.taskSections[section].title
    }

    <span class="func"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(tableView: UITableView, numberOfRowsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> {
        <span class="keyword">return</span> upcomingTaskDataManager.taskSections[section].items.<span class="built_in">count</span>
    }

    <span class="func"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(tableView: UITableView, cellForRowAtIndexPath indexPath: NSIndexPath)</span></span> -&gt; <span class="type">UITableViewCell</span> {
        <span class="keyword">let</span> task = upcomingTaskDataManager.taskSections[indexPath.section].items[indexPath.row]
        <span class="keyword">let</span> cell = tableView.dequeueReusableCellWithIdentifier(cellReuseIdentifier, forIndexPath: indexPath) <span class="keyword">as</span>! <span class="type">CellType</span>
        cellConfigurationHandler(cell, task)
        <span class="keyword">return</span> cell
    }
</code></pre><ol>
<li>è¿™ä¸ª<code>UpcomingTaskDataManagerTableViewAdapter</code>é€šè¿‡ä¼ å…¥ä¸€ä¸ªCellTypeæ”¯æŒæ³›å‹ã€‚  </li>
<li>é€šè¿‡æ¥å—å‡ ä¸ªclosureæ¥è¿›è¡Œè‡ªå®šä¹‰çš„é…ç½®ï¼ŒåŒ…æ‹¬cellçš„æ ·å¼é…ç½®ä»¥åŠtableviewæ•°æ®æ›´æ–°åçš„å›è°ƒã€‚  </li>
<li>å®ç°çš„UITableViewDataSource</li>
</ol>
<p>åŒæ ·ï¼Œç”±äºèŒè´£çš„é‡æ–°åˆ†é…ï¼Œæˆ‘ä»¬è¦å°†è·Ÿ<code>TaskManager</code>ï¼ˆåŒ…æ‹¬NSFetchedResultsControllerï¼‰ç›¸å…³çš„åˆ’å…¥åˆ°è¿™ä¸ªadapterä¸­ã€‚</p>
<h3 id="å¤§ç»“å±€">å¤§ç»“å±€</h3><p>æœ€åé‡æ„åçš„ViewControllerï¼Œåªæœ‰<strong>37</strong>ä»£ç ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<pre><code><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UITableViewController</span> </span>{
    <span class="keyword">var</span> navigationThemeDidChangeHandler: ((<span class="type">NavigationTheme</span>) -&gt; <span class="type">Void</span>)?
    <span class="keyword">var</span> navigationTheme: <span class="type">NavigationTheme</span> {
        <span class="keyword">return</span> <span class="type">NavigationTheme</span>(numberOfImminentTasks: upcomingTaskDataManager.totalNumberOfTasks)
    }

    private <span class="keyword">let</span> upcomingTaskDataManager = <span class="type">UpcomingTaskDataManager</span>()
    private <span class="keyword">var</span> upcomingTaskDataManagerTableViewAdapter: <span class="type">UpcomingTaskDataManagerTableViewAdapter</span>&lt;<span class="type">TaskTableViewCell</span>&gt;!

    <span class="keyword">override</span> <span class="func"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> {
        <span class="keyword">super</span>.viewDidLoad()

        upcomingTaskDataManagerTableViewAdapter = <span class="type">UpcomingTaskDataManagerTableViewAdapter</span>(
            tableView: tableView,
            upcomingTaskDataManager: upcomingTaskDataManager,
            cellReuseIdentifier: <span class="string">"Cell"</span>,
            cellConfigurationHandler: { cell, task <span class="keyword">in</span>
                cell.viewData = <span class="type">TaskTableViewCell</span>.<span class="type">ViewData</span>(task: task, relativeToDate: <span class="type">NSDate</span>())
            },
            didChangeHandler: { [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span> <span class="keyword">self</span>?.updateNavigationBar() }
        )
        upcomingTaskDataManager.delegate = upcomingTaskDataManagerTableViewAdapter
        tableView.dataSource = upcomingTaskDataManagerTableViewAdapter

        updateNavigationBar()
    }

    <span class="keyword">override</span> <span class="func"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(tableView: UITableView, canEditRowAtIndexPath indexPath: NSIndexPath)</span></span> -&gt; <span class="type">Bool</span> {
        <span class="keyword">return</span> <span class="literal">true</span>
    }

    <span class="func"><span class="keyword">func</span> <span class="title">updateNavigationBar</span><span class="params">()</span></span> {
        navigationThemeDidChangeHandler?(navigationTheme)
    }

    <span class="preprocessor">@IBAction</span> <span class="func"><span class="keyword">func</span> <span class="title">unwindFromAddController</span><span class="params">(segue: AddCompletionSegue)</span></span> {
        upcomingTaskDataManager.createTaskWithTitle(segue.taskTitle, dueDate: segue.taskDueDate)
    }
}
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/12/30/Refactor-Mega-ViewController/" data-id="cjqdxq1zy0020mxi19zleiw2i" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/12/30/Refactor-Mega-ViewController/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-Learn-R-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/20/Learn-R-2/" class="article-date">
  <time datetime="2015-12-20T08:43:31.000Z" itemprop="datePublished">2015-12-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/20/Learn-R-2/">ä¸€æ­¥æ­¥å­¦Rï¼ˆ2ï¼‰</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="ç³»åˆ—è¿è½½">ç³»åˆ—è¿è½½</h3><p><a href="http://satanwoo.github.io/2015/12/13/Learn-R-1/">ä¸€æ­¥æ­¥å­¦Rï¼ˆ1ï¼‰</a><br><a href="http://satanwoo.github.io/2015/12/20/Learn-R-2/">ä¸€æ­¥æ­¥å­¦Rï¼ˆ2ï¼‰</a></p>
<h3 id="If-Else">If-Else</h3><p>R ç§çš„If-Elseç»“æ„å¹¶æ²¡æœ‰æ¯”è¾ƒç‰¹æ®Šçš„åœ°æ–¹ï¼Œä»ç„¶æ”¯æŒä¸¤ç§ç»“æ„ï¼š</p>
<pre><code><span class="tag">if</span> (condition) {
    <span class="comment">// Do Something</span>
} <span class="tag">else</span> {
   <span class="comment">// Do Otherthing</span>
}
</code></pre><p>æˆ–è€…å¦‚ä¸‹ï¼š</p>
<pre><code><span class="keyword">if</span> (condition) {
    // <span class="keyword">Do</span> Something
} <span class="keyword">else</span> <span class="keyword">if</span> (condition2) {
   // <span class="keyword">Do</span> Otherthing
} <span class="keyword">else</span> {
   // <span class="keyword">Do</span> <span class="keyword">Else</span>
}
</code></pre><p>ä½†æ˜¯åœ¨Rä¸­ï¼Œå¯¹äºIf-elseæœ‰ä¸€ä¸ªå¯ä»¥ç®€åŒ–çš„åœ°æ–¹ï¼Œå¦‚ï¼š</p>
<pre><code><span class="keyword">if</span> (x &gt; <span class="number">100</span>) {
    y &lt;- <span class="number">10</span>
} <span class="keyword">else</span> <span class="keyword">if</span> (x &lt; <span class="number">100</span>) {
   y &lt;- <span class="number">11</span>
} <span class="keyword">else</span> {
   y &lt;- <span class="number">5</span>
}
</code></pre><p>å¯ä»¥ç®€åŒ–æˆï¼š</p>
<pre><code>y &lt;- <span class="keyword">if</span> (x &gt; <span class="number">100</span>) {
    <span class="number">10</span>
} <span class="keyword">else</span> <span class="keyword">if</span> (x &lt; <span class="number">100</span>) {
   <span class="number">11</span>
} <span class="keyword">else</span> {
   <span class="number">5</span>
}
</code></pre><h3 id="For">For</h3><p>Forè¯­å¥çš„è¯­æ³•ä¹Ÿéå¸¸ç®€å•ï¼š</p>
<pre><code><span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span>:<span class="number">10</span>) {
    <span class="built_in">print</span>(i)
}
</code></pre><p><strong>seq_along</strong> å‡½æ•°æ˜¯forå¾ªç¯ä¸­å¯ä»¥æ³¨æ„çš„ä¸€ä¸ªç‚¹ã€‚å®ƒçš„å‚æ•°æ˜¯ä¸€ä¸ªvectorï¼Œå¦‚<code>x &lt;- c(&#39;a&#39;, &#39;b&#39;)</code>ï¼Œè°ƒç”¨<code>seq_along(x)</code>ä¼šå¾—åˆ°ä¸€ä¸ªåºåˆ—ï¼Œé•¿åº¦ä¸º2ï¼Œå€¼ä¸º1ï¼Œ2ã€‚å› æ­¤ï¼Œ<code>print(x[1])</code> å°±ç­‰äº <code>a</code>ã€‚</p>
<h3 id="While">While</h3><p>åŒæ ·ç®€å•ï¼š</p>
<pre><code><span class="keyword">while</span> <span class="comment">(condition)</span> {
   <span class="comment">// Do studyy</span>
}
</code></pre><h3 id="Repeat">Repeat</h3><p>repeatæ˜¯Rä¸­ç‰¹æœ‰çš„ä¸€ç§é€»è¾‘ç»“æ„ï¼Œç®€å•æ¥ç†è§£å°±æ˜¯<strong>æ­»å¾ªç¯</strong>ï¼Œæƒ³è¦é€€å‡ºçš„å”¯ä¸€æ–¹å¼æ˜¯<strong>æ˜¾å¼ä½¿ç”¨<code>break</code>ã€‚</strong></p>
<pre><code>repeat {
    x &lt;- something()

    <span class="keyword">if</span> (<span class="literal">A</span>) {
        <span class="keyword">break</span>
    } <span class="keyword">else</span> {
        x &lt;- x + <span class="number">1</span>
    }
}
</code></pre><h3 id="Next">Next</h3><p><code>next</code>å°±æ˜¯å…¶ä»–è¯­è¨€ä¸­çš„<code>continue</code></p>
<pre><code><span class="keyword">for</span> (i in <span class="number">1</span>:<span class="number">100</span>) {
     <span class="keyword">if</span> (i &lt; <span class="number">20</span>) {
         next
     }

     <span class="comment">// Do other</span>
}
</code></pre><h3 id="å‡½æ•°">å‡½æ•°</h3><p>Rä¸­çš„å‡½æ•°å¯ä»¥æ²¡æœ‰æ˜¾å¼çš„<code>return</code>ï¼Œé»˜è®¤è¿”å›æœ€åä¸€å¥è¯­å¥ã€‚</p>
<pre><code>add2 &lt;- <span class="function"><span class="keyword">function</span><span class="params">(x, y)</span> </span>{
     x + y
}
</code></pre><p>å’Œå…¶ä»–è¯­è¨€ä¸€æ ·ï¼Œä½ å¯ä»¥ç»™å‚æ•°è®¾ç½®é»˜è®¤å€¼ï¼Œå¦‚</p>
<pre><code>add2 &lt;- <span class="function"><span class="keyword">function</span><span class="params">(x, y = 10)</span> </span>{
     x + y
}
</code></pre><p>Rä¸­çš„å‡½æ•°å‚æ•°ä¼˜ç‚¹ç±»ä¼¼äºJavaScriptï¼Œ<strong>å¯ä»¥ä¸ç”¨èµ‹å€¼å®Œå…¨ï¼Œå‰ææ˜¯ä½ ç”¨ä¸åˆ°</strong>ã€‚è€Œä¸”ï¼Œå¯¹äºRä¸­çš„å‚æ•°ï¼Œä½ å¯ä»¥æ‰“ä¹±å‚æ•°ä¼ é€’ï¼Œåªè¦ä½ å‰é¢åŠ ä¸Šäº†è¡Œå‚çš„åç§°ï¼Œ</p>
<p>æ¯”å¦‚</p>
<pre><code>add2 &lt;- <span class="function"><span class="keyword">function</span><span class="params">(x, y)</span> </span>{
     x + y
}
</code></pre><p>ä½ å¯ä»¥é€šè¿‡<code>add2(y = 5, x = 7)</code>æ¥è¿›è¡Œè°ƒç”¨ã€‚</p>
<h4 id="å¯å˜å‚æ•°">å¯å˜å‚æ•°</h4><p>åœ¨Rä¸­ä¹Ÿæ˜¯æœ‰å¯å˜å‚æ•°çš„ï¼Œå³<code>...</code>ã€‚</p>
<pre><code>myplot &lt;- <span class="function"><span class="keyword">function</span><span class="params">(x, y, type = 1, <span class="rest_arg">...) {
    plot</span>(x, y, type, <span class="rest_arg">...)
}</span></span></span>
</code></pre><p>åŒæ ·ï¼Œ<code>...</code>ä¹Ÿå¯ä»¥ç”¨åœ¨æ³›å‹å‡½æ•°ä¸­ï¼Œåç»­å­¦ä¹ ä¸­æˆ‘ä»¬ä¼šè¯´åˆ°ã€‚</p>
<p>**ä¸è¿‡ï¼Œä¸å…¶ä»–ç¼–ç¨‹è¯­è¨€æ‰€ä¸åŒçš„æ˜¯ï¼ŒRä¸­çš„å¯å˜å‚æ•°å¯ä»¥æ”¾åœ¨å‡½æ•°åˆ—è¡¨çš„å‰é¢ï¼Œå¦‚</p>
<p><code>function(..., sep = &quot; &quot;, collsape = NULL)</code></p>
<p>è°ƒç”¨å¦‚ä¸Šçš„è¿™ç§å‡½æ•°ï¼Œå¿…é¡»<strong>æ˜¾å¼çš„</strong>é€šè¿‡å‡½æ•°å‚æ•°åç§°æ¥è°ƒç”¨åç»­å‚æ•°ï¼Œå¦‚</p>
<p><code>function(&quot;haha&quot;, &quot;heihei&quot;, sep = &quot;,&quot;)</code></p>
<h3 id="å˜é‡ä½œç”¨åŸŸ">å˜é‡ä½œç”¨åŸŸ</h3><h4 id="ä½¿ç”¨å˜é‡">ä½¿ç”¨å˜é‡</h4><p>å½“ä½ ä½¿ç”¨ä¸€ä¸ªRè¯­è¨€ä¸­çš„å˜é‡æ—¶ï¼Œæ¯”å¦‚xï¼Œä½ æœ‰æ²¡æœ‰æƒ³è¿‡xç©¶ç«Ÿæ˜¯å­˜åœ¨äºå“ªé‡Œå‘¢ï¼Ÿ</p>
<p>æœ‰äº›äººä¼šè¯´ï¼Œæˆ‘å®šä¹‰çš„å‘€ï¼Œæ¯”å¦‚<code>x &lt;- 5</code>ï¼Œé‚£ä¹ˆå¯¹äºé‚£äº›é»˜è®¤å‡½æ•°ï¼Œæ¯”å¦‚<code>vector()</code>å‘¢ï¼Ÿ</p>
<p>æ‰€ä»¥ï¼Œè¿™å°±æ¶‰åŠåˆ°Rä¸­çš„<strong>Symbol binding</strong>ï¼ˆå…¶ä»–è¯­è¨€çš„å˜é‡æŸ¥æ‰¾ï¼‰äº†ã€‚</p>
<p>åœ¨Rä¸­ï¼ŒæŸ¥æ‰¾é¡ºåºæ˜¯è¿™æ ·çš„ã€‚</p>
<pre><code>[<span class="number">1</span>] <span class="string">".GlobalEnv"</span>        <span class="string">"tools:rstudio"</span>     <span class="string">"package:stats"</span>     <span class="string">"package:graphics"</span>  <span class="string">"package:grDevices"</span>
[<span class="number">6</span>] <span class="string">"package:utils"</span>     <span class="string">"package:datasets"</span>  <span class="string">"package:methods"</span>   <span class="string">"Autoloads"</span>         <span class="string">"package:base"</span> 
</code></pre><p>é»˜è®¤æŸ¥æ‰¾çš„æ˜¯<strong>.GlobalEnv</strong>ï¼Œä¾æ¬¡ç±»æ¨ã€‚</p>
<p>å¦‚æœä½ è¿˜é€šè¿‡<code>library()</code>å‡½æ•°åŠ è½½äº†å…¶ä»–packageï¼Œå¦‚ggplot2ï¼Œé‚£ä¹ˆæŸ¥æ‰¾é¡ºåºæ˜¯</p>
<pre><code> [<span class="number">1</span>] <span class="string">".GlobalEnv"</span>        <span class="string">"package:ggplot2"</span>   <span class="string">"tools:rstudio"</span>     <span class="string">"package:stats"</span>     <span class="string">"package:graphics"</span> 
 [<span class="number">6</span>] <span class="string">"package:grDevices"</span> <span class="string">"package:utils"</span>     <span class="string">"package:datasets"</span>  <span class="string">"package:methods"</span>   <span class="string">"Autoloads"</span>        
[<span class="number">11</span>] <span class="string">"package:base"</span>     
</code></pre><p>ä¹Ÿå°±æ˜¯ç”¨æˆ·åŠ è½½çš„packageä¼šè‡ªåŠ¨åŠ åˆ°é™¤äº†<strong>.GlobalEnv</strong>ä¹‹å¤–çš„ä»»æ„æœç´¢é¡ºåºå‰ã€‚</p>
<p>å¦‚æœè¦æŸ¥çœ‹æœ€æ–°çš„æœç´¢é¡ºåºï¼Œå¯ä»¥é€šè¿‡<code>search()</code></p>
<h4 id="ä½œç”¨åŸŸ">ä½œç”¨åŸŸ</h4><p>Rä¸­çš„ä½œç”¨åŸŸï¼Œæ˜¯Lexical Scopingï¼Œä¹Ÿå°±æ˜¯é™æ€ä½œç”¨åŸŸï¼Œä¹Ÿå°±æ˜¯<strong>JavaScriptçš„ä½œç”¨åŸŸ</strong>ã€‚</p>
<p>å¥½äº†ï¼Œæˆ‘ä¸å¤šè¯´äº†ï¼Œå¦‚æœæƒ³å­¦ä¹ æ›´å¤šå† ä»¥é™æ€ä½œç”¨åŸŸçš„è¯ï¼Œçœ‹æˆ‘çš„JavaScriptåšå®¢éƒ¨åˆ†ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœä½ ä¸æ‡‚ï¼Œä½ å¯ä»¥é€šè¿‡å¦‚ä¸‹å‡½æ•°å¸®åŠ©ä½ ç†è§£ã€‚</p>
<p><code>ls(environment(functionName))</code><br><code>get(variableName, environment(functionName))</code></p>
<p><strong>ä¸€è¨€ä»¥è”½ä¹‹ï¼Œlexcial scopingå¯ä»¥ç®€å•ç†è§£ä¸ºä½ å‡½æ•°ä¸­éœ€è¦çš„å˜é‡ï¼Œæ˜¯é€šè¿‡å…¶å®šä¹‰æ—¶ç¯å¢ƒè¿›è¡ŒæŸ¥æ‰¾ã€‚</strong></p>
<h4 id="Data_and_Times">Data and Times</h4><p>Rä¸­çš„æ—¶é—´è¡¨ç¤ºï¼Œé‡‡ç”¨äº†ä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç»“æ„ã€‚</p>
<p>Dateæ˜¯é€šè¿‡<strong>Date</strong>è¿™ä¸€æ•°æ®ç»“æ„è¡¨ç¤ºï¼Œè€ŒTimeæ˜¯é€šè¿‡POSIXctæˆ–è€…POSIXltè¡¨ç¤ºã€‚</p>
<ul>
<li>Dateæ˜¯ä¸åŒ…å«Timeçš„ï¼Œåªæ˜¾ç¤ºå¹´ã€æœˆã€æ—¥ã€‚</li>
<li>Dateçš„å†…éƒ¨å‚¨å­˜æ˜¯è®¡ç®—1970-01-01åˆ°å½“å‰æ—¶é—´ä¹‹é—´çš„å¤©æ•°ã€‚</li>
<li>Timeçš„å†…éƒ¨å‚¨å­˜æ˜¯è®¡ç®—1979-01-01åˆ°å½“å‰æ—¶é—´ä¹‹é—´çš„ç§’æ•°ã€‚</li>
</ul>
<p>å¯ä»¥é‡‡ç”¨<code>as.Date</code>æ„å»ºDateï¼Œå¦‚<code>as.Date(&quot;1970-01-01&quot;)</code></p>
<p>è€ŒTimeç›¸å¯¹æ¥è¯´æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çœ‹çœ‹<code>Posixlt</code>çš„è¡¨ç°å½¢å¼ã€‚</p>
<p>æˆ‘ä»¬è¾“å…¥<code>p&lt;- Sys.time()</code>è·å–å½“å‰æ—¶é—´ï¼Œç»“æœæ˜¯<code>&quot;2015-12-27 00:59:18 CST&quot;</code>ï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨<code>unclass(p)</code>æ¥çœ‹çœ‹å…¶æ„æˆï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code>[<span class="number">1</span>] <span class="string">"sec"</span>    <span class="string">"min"</span>    <span class="string">"hour"</span>   <span class="string">"mday"</span>   <span class="string">"mon"</span>    <span class="string">"year"</span>   <span class="string">"wday"</span>   <span class="string">"yday"</span>   <span class="string">"isdst"</span>  <span class="string">"zone"</span>   <span class="string">"gmtoff"</span>
</code></pre><p><strong>è¿™è¡¨æ˜ï¼Œé€šè¿‡<code>Posixlt</code>è¡¨å¾çš„<code>Time</code></strong>ï¼Œå…¶å†…éƒ¨æ˜¯ç”±ä¸€ç³»åˆ—æˆåˆ†ç»„æˆçš„é›†åˆã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡<br><code>p$wday</code> æ¥æŸ¥çœ‹ä»Šå¤©æ˜¯å‘¨å‡ ã€‚  </p>
<p>è€Œ<code>Posixct</code>å°±æ˜¯å°±ç®—1970-01-01åˆ°å½“å‰æ—¶é—´çš„æè¿°ï¼Œæ˜¯ä¸ªéå¸¸å¤§çš„<strong>Integer</strong>ã€‚</p>
<p>ä½ å¯ä»¥å¯¹Dateæˆ–è€…Timeè¿›è¡Œå¤§å°æ¯”è¾ƒæ“ä½œï¼Œä½†æ˜¯æ³¨æ„ï¼Œ<strong>ä¸èƒ½è®²Dateå’ŒTimeæ··åˆæ“ä½œ</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/12/20/Learn-R-2/" data-id="cjqdxq20k002dmxi1j3or56fu" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/12/20/Learn-R-2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/R/">R</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-Regression-Model-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/15/Regression-Model-1/" class="article-date">
  <time datetime="2015-12-14T16:31:35.000Z" itemprop="datePublished">2015-12-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/15/Regression-Model-1/">Regression Model</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Regression_Modelæ˜¯ä»€ä¹ˆ">Regression Modelæ˜¯ä»€ä¹ˆ</h3><p>Regression Modelæ˜¯ä¸€ç§åŸºæœ¬çš„æ•°æ®åˆ†ææ¨¡å‹ï¼Œé€šä¿—ç‚¹æ¥è¯´å°±æ˜¯æˆ‘ä»¬åœ¨ä¸­å­¦æ—¶æœŸå­¦ä¹ çš„æˆªè·å¼ç›´çº¿æ–¹ç¨‹ã€‚é€šè¿‡æ–œç‡å’Œæˆªè·æ¥å®šä¹‰ä¸€ç§è¯¸å¦‚ <code>y = kx + b</code>çš„æ–¹ç¨‹ã€‚ä¸€æ—¦æœ‰äº†è¿™æ ·çš„æ–¹ç¨‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æˆ‘ä»¬ç°æœ‰çš„æ•°æ®é›†ï¼Œæ¯”å¦‚ä¸€å †<code>x</code> æ¥é¢„æµ‹yã€‚</p>
<p>ä»Šå¤©å°±è®©æˆ‘ä»¬æ¥ç ”ç©¶ç ”ç©¶è¿™ä¸€ç§æ•°æ®æ¨¡å‹</p>
<h4 id="Centering">Centering</h4><p>Centeringæ˜¯ä¸€ç§å¸¸ç”¨çš„æ•°å­¦ç”¨è¯­ï¼Œæ„ä¸º <em>é›†ä¸­åŒ–</em>ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘æœ‰ä»x1, x2 â€¦ xn è¿™nä¸ªæ•°æ®æ„æˆçš„æ•°æ®é›†{x}ï¼Œæˆ‘å¯ä»¥æ±‚å‡ºä»–ä»¬çš„å¹³å‡å€¼ä¸º<em>XM</em>ã€‚æˆ‘å¯ä»¥æ„å»º <code>bi = xi - XM</code> è¿™æ ·ä¸€ä¸ªæ•°åˆ—ï¼Œè¿™æ ·çš„è¯ï¼Œ{b}è¿™ä¸ªæ•°æ®é›†çš„å¹³å‡å€¼å°±ä¸º0ï¼Œè¿™ä¸€ä¸ªè¿‡ç¨‹å°±å«Centeringã€‚</p>
<h4 id="Variancesï¼ˆæ–¹å·®ï¼‰">Variancesï¼ˆæ–¹å·®ï¼‰</h4><p>æ–¹å¼çš„å®šä¹‰æ˜¯:</p>
<blockquote>
<p>æ±‚å‡ºä¸€ä¸ªæ•°æ®é›†çš„å¹³å‡æ•°XM, å¯¹äº{x} ä¸­çš„æ¯ä¸€ä¸ªæ•°ï¼Œæ±‚å…¶ä¸å¹³å‡æ•°å·®çš„å¹³æ–¹ã€‚å†è¿™è¿™äº›å·®çš„å¹³æˆ¿åŠ åœ¨ä¸€èµ·æ±‚å’Œï¼Œæœ€åç”¨å’Œé™¤ä»¥n - 1ï¼Œè¿™é‡Œçš„næ˜¯æ•°æ®é›†ä¸­æ•°æ®çš„ä¸ªæ•°ã€‚</p>
</blockquote>
<p>è€Œæ ‡å‡†å·®å°±æ˜¯æ–¹å·®çš„å¹³æ–¹æ ¹ã€‚ <strong>é€šè¿‡æ„å»º<code>bi = xi / æ ‡å‡†å·®s</code> å¯ä»¥å¾—åˆ°{b}æ•°æ®é›†ï¼Œå®ƒçš„æ ‡å‡†å·®ä¸º1ï¼Œè¿™ä¸€è¿‡ç¨‹ä¹Ÿå«åšScaling</strong></p>
<h4 id="Normalization">Normalization</h4><p>å°†æ•°æ®é›†å…ˆCenteringå†Scalingçš„è¿‡ç¨‹å«åšNormalizationã€‚</p>
<h4 id="Covarianceï¼ˆåæ–¹å·®ï¼‰">Covarianceï¼ˆåæ–¹å·®ï¼‰</h4><p>åæ–¹å·®çš„å®šä¹‰å…¶å®å’Œæ–¹å·®ç±»ä¼¼ï¼Œåªä¸è¿‡é’ˆå¯¹çš„æ˜¯ä¸€å¯¹æ•°æ®é›†{x, y}ã€‚</p>
<blockquote>
<p>æ±‚å‡ºæ•°æ®é›†{x}çš„å¹³å‡æ•°Mï¼Œæ±‚å‡ºæ•°æ®é›†{y}çš„å¹³å‡æ•°Nï¼Œå¯¹äºæ¯ä¸€ä¸ªiï¼Œæ±‚å’Œ<code>(xi - M) * (yi - N)</code>ï¼Œæœ€åå’Œé™¤ä»¥<code>n - 1</code>ï¼Œå…¶ä¸­næ˜¯æ•°æ®é›†ä¸­æ•°æ®çš„ä¸ªæ•°ã€‚</p>
</blockquote>
<h4 id="Corrleationï¼ˆä¸¤ä¸ªæ•°æ®é›†çš„å…³è”ï¼‰">Corrleationï¼ˆä¸¤ä¸ªæ•°æ®é›†çš„å…³è”ï¼‰</h4><p>Correlationå°±æ˜¯å°†ä¸¤ä¸ªæ•°æ®é›†çš„åæ–¹å·®é™¤ä»¥{x}çš„æ ‡å‡†å·®å’Œ{y}çš„æ ‡å‡†å·®çš„ä¹˜ç§¯ã€‚<br><strong>Correlationçš„å€¼åŸŸä»ï¼1åˆ°1ï¼Œè¶Šæ¥è¿‘ä¸¤ç«¯è¡¨ç¤ºä¸¤ä¸ªæ•°æ®é›†å…³è”åº¦è¶Šå¤§ï¼Œè¶Šé è¿‘0è¡¨ç¤ºè¶Šå°ã€‚</strong></p>
<h3 id="é‡ç‚¹">é‡ç‚¹</h3><p>å¯¹äº y = kx + b æ¥è¯´ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å…¬å¼æ±‚è§£æ–¹ç¨‹ï¼š</p>
<p><code>k = cor(y, x) * s(y) / s(x)</code>  ä»¥åŠ <code>b = mean(y) - k * mean(x)</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/12/15/Regression-Model-1/" data-id="cjqdxq1zu001xmxi1x0t5sg5n" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/12/15/Regression-Model-1/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Math/">Math</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-Learn-R-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/13/Learn-R-1/" class="article-date">
  <time datetime="2015-12-13T07:03:36.000Z" itemprop="datePublished">2015-12-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/13/Learn-R-1/">ä¸€æ­¥æ­¥å­¦Rï¼ˆ1ï¼‰</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="ç³»åˆ—è¿è½½">ç³»åˆ—è¿è½½</h3><p><a href="http://satanwoo.github.io/2015/12/13/Learn-R-1/">ä¸€æ­¥æ­¥å­¦Rï¼ˆ1ï¼‰</a><br><a href="http://satanwoo.github.io/2015/12/20/Learn-R-2/">ä¸€æ­¥æ­¥å­¦Rï¼ˆ2ï¼‰</a></p>
<p>å˜¿å˜¿ï¼Œä½œä¸ºä¸€åå¤©æ‰ï¼Œå½“ç„¶è¦æŒæ¡ä¸€å®šçš„æ•°æ®åˆ†æèƒ½åŠ›å•¦ï¼Œæ‰€ä»¥ä»ä»Šå¤©èµ·ï¼Œæˆ‘ä»¬æ¥ä¸€æ­¥æ­¥å­¦ä¹ Rè¿™é—¨æœ‰æ„æ€çš„è¯­è¨€ã€‚</p>
<p>è¿™ä¸€ç³»åˆ—çš„æ–‡ç« çš„å¼€å‘ç¯å¢ƒéƒ½æ˜¯åŸºäºMacçš„ã€‚</p>
<h3 id="å®‰è£…">å®‰è£…</h3><ol>
<li>é¦–å…ˆä½ è¦å®‰è£…Rè¯­è¨€çš„ç¯å¢ƒ <a href="https://cran.r-project.org/" target="_blank" rel="external">å®‰è£…ç‚¹æˆ‘</a></li>
<li>å¯é€‰ï¼šå®‰è£…RStudioï¼ˆç±»ä¼¼äºMatlabï¼‰ï¼Œå®‰è£…ä¹‹å‰å¿…é¡»å·²ç»å®‰è£…äº†R <a href="https://www.rstudio.com/" target="_blank" rel="external">å®‰è£…ç‚¹æˆ‘</a></li>
</ol>
<h3 id="åŸºç¡€çŸ¥è¯†">åŸºç¡€çŸ¥è¯†</h3><h4 id="Ré‡Œé¢çš„åŸºç¡€ç±»å‹">Ré‡Œé¢çš„åŸºç¡€ç±»å‹</h4><ul>
<li>Characterï¼Œå¦‚ â€œaâ€ï¼Œâ€hahaâ€</li>
<li>Numberï¼ˆå®æ•°ï¼‰ï¼Œå¦‚ 5ï¼Œ 5.5</li>
<li><p>Integerï¼ˆæ•´æ•°ï¼‰ï¼Œå¦‚ 5ï¼Œ6</p>
<p>  <strong>è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤æƒ…å†µï¼Œæ‰€æœ‰çš„æ•´æ•°ç±»å‹éƒ½ä¸ºå®æ•°ï¼Œå¦‚æœè¦ç‰¹å®šä¸ºæ•´æ•°ï¼Œéœ€è¦åŠ Lï¼Œå¦‚5L</strong></p>
</li>
<li><p>Logicalï¼Œå¦‚TRUE, FALSE</p>
<p>  <strong>FALSE = 0ï¼ŒTRUEä¸ºä¸€åˆ‡é0æ•°ï¼Œå¯ä»¥ç®€å†™ä¸ºF/T</strong></p>
</li>
<li><p>Complexï¼ˆå¤æ•°ï¼‰ï¼Œå¦‚ 5 + 7i</p>
</li>
</ul>
<h4 id="æ“ä½œ">æ“ä½œ</h4><p><code>x &lt;- 5</code> è¡¨ç¤ºå°†5èµ‹å€¼ç»™x<br><code>x</code>      è¡¨ç¤ºè¾“å‡ºxï¼Œæ•ˆæœç­‰åŒäº<code>print(x)</code></p>
<h4 id="å‘é‡">å‘é‡</h4><p>è™½ç„¶å‘é‡ä¸æ˜¯ä¸€ä¸ªåŸºæœ¬ç±»å‹ï¼Œä½†æ˜¯å´æ˜¯Rè¯­è¨€ä¸­éå¸¸å…³é”®çš„ä¸€ç§æ•°æ®ç»“æ„</p>
<p><code>x &lt;- 5</code> è¿™å¥è¯­å¥è™½ç„¶è¡¨é¢ä¸Šçœ‹èµ·æ¥æ˜¯å®šä¹‰äº†ä¸€ä¸ª<strong>Number</strong>ç±»å‹çš„xï¼Œå€¼ä¸º5ã€‚ä½†æ˜¯å®è´¨ä¸Šå´æ˜¯æ„å»ºäº†ä¸€ä¸ªå¤§å°ä¸º1çš„å‘é‡ï¼Œé€šè¿‡<code>x</code>è¯­å¥æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸‹ç»“æœï¼š</p>
<pre><code>&gt; x
[<span class="number">1</span>] <span class="number">5</span>
</code></pre><p>æ‰€ä»¥<code>x</code> ç­‰åŒäºè¯­å¥ <code>x[1]</code>ï¼Œä¼šè¾“å‡º5ã€‚</p>
<p><strong>æ³¨æ„ï¼šRè¯­è¨€é‡Œé¢çš„æ•°æ®ç´¢å¼•ä»1å¼€å§‹</strong></p>
<p>é™¤äº†é»˜è®¤æ„é€ çš„å‘é‡ä»¥å¤–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>vector(class, size)</code>æ¥æ„å»ºæŒ‡å®šç±»å‹å’Œå¤§å°çš„å‘é‡ï¼Œå¦‚ï¼š</p>
<pre><code>&gt; k &lt;- <span class="function"><span class="title">vector</span><span class="params">(<span class="string">'logical'</span>, <span class="number">5</span>L)</span></span>
&gt; z &lt;- <span class="function"><span class="title">vector</span><span class="params">(<span class="string">"complex"</span>, <span class="number">7</span>)</span></span>
</code></pre><p>ä»¥ä¸Šä¸¤å¥æˆ‘ä»¬åˆ†åˆ«æ„å»ºäº†ä¸€ä¸ªåä¸ºkçš„logicalå‘é‡ï¼Œå¤§å°5ä»¥åŠä¸€ä¸ªå¤æ•°å‘é‡ï¼Œå¤§å°ä¸º7ã€‚</p>
<p><strong>æ³¨æ„ï¼šåœ¨Rçš„å‘é‡é‡Œï¼ŒåŒä¸€ä¸ªå‘é‡åªèƒ½åŒ…å«ç›¸åŒç±»å‹çš„å¯¹è±¡ï¼Œå¦‚æœåŒ…å«äº†ä¸ç›¸åŒï¼Œä¼šè¿›è¡Œéšå¼è½¬æ¢ï¼Œå¦‚æœä¸èƒ½è½¬æ¢å°±ä¼šæŠ¥é”™ã€‚</strong></p>
<p>å¦‚ï¼š</p>
<pre><code>&gt; k &lt;- <span class="function"><span class="title">c</span><span class="params">(T, <span class="string">"a"</span>)</span></span>
&gt; k
[<span class="number">1</span>] <span class="string">"TRUE"</span> <span class="string">"a"</span> 
</code></pre><p>å½“ç„¶ä¹Ÿå¯ä»¥å¼ºåˆ¶è½¬æ¢ï¼š</p>
<p><code>as.character</code>ï¼Œ <code>as.logical</code>ï¼Œ <code>as.numeric</code>ï¼Œ<code>as.complex</code>ï¼Œ<code>as.integer</code></p>
<h4 id="list">list</h4><p>listæ˜¯ä¸€ç§å¯ä»¥åŒæ—¶ä¿å­˜å¤šä¸ªç±»å‹å¯¹è±¡çš„æ•°æ®ç»“æ„ï¼Œé€šè¿‡<code>list(a, b, c, d)</code>è¿›è¡Œæ„å»ºã€‚</p>
<h4 id="Matrix">Matrix</h4><p>matrixå°±æ˜¯å¤šç»´å‘é‡ï¼Œé€šè¿‡å‡½æ•°<code>matrix(data, nrows, ncols)</code> æ„å»ºï¼Œé»˜è®¤æ˜¯æŒ‰åˆ—æ’åˆ—æ•°æ®ï¼Œå¯ä»¥é€šè¿‡æ›´æ”¹byrow=Tæ¥æŒ‰ç…§è¡Œæ¥æ„å»ºã€‚</p>
<h4 id="Factor">Factor</h4><p>ç®€å•ç†è§£ï¼Œå°±æ˜¯åˆ†ç±»å®šä¹‰çš„æ•°ç»„ï¼Œæ¯”å¦‚ï¼Œ<code>x &lt;- factor(c(&#39;yes&#39;, &#39;no&#39;, &#39;yes&#39;, &#39;no&#39;, &#39;yes&#39;))</code>  ï¼Œè™½ç„¶çœ‹èµ·æ¥æ„å»ºäº†ä¸€ä¸ªå’ŒCharacterç±»å‹çš„å‘é‡å·®ä¸å¤šï¼Œä½†æ˜¯å®è´¨ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡</p>
<pre><code>&gt; x &lt;- <span class="function"><span class="title">factor</span><span class="params">(c(<span class="string">'yes'</span>, <span class="string">'no'</span>, <span class="string">'yes'</span>)</span></span>)
&gt; <span class="function"><span class="title">levels</span><span class="params">(x)</span></span>
[<span class="number">1</span>] <span class="string">"no"</span>  <span class="string">"yes"</span>
</code></pre><p>è¿™ä¸ªå‘é‡ä»£è¡¨äº†å‡ ç§åˆ†ç±»ã€‚</p>
<h4 id="Missing_Values">Missing Values</h4><p>Naå’ŒNaN, <strong>NaNä»…ä»£è¡¨æ•°å€¼è®¡ç®—çš„ä¸å­˜åœ¨ï¼Œè€ŒNaæ˜¯ä»£è¡¨ä¸€åˆ‡çš„ä¸å­˜åœ¨ï¼Œå³NaåŒ…å«NaN</strong><br>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>is.Na</code>å’Œ<code>is.NaN</code>æ¥è¿›è¡Œåˆ¤æ–­ã€‚</p>
<h4 id="Data_Frames">Data Frames</h4><p>Data Framesç®€å•ç†è§£å°±æ˜¯ä¸€ä¸ªè¡¨æ ¼ï¼Œä½†æ˜¯ä¸Matrixä¸åŒçš„æ˜¯ï¼Œå¥¹å¯ä»¥åŒ…å«ä¸åŒç±»å‹çš„dataï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>DataFramesçš„æ¯ä¸€åˆ—éƒ½æ˜¯ä¸€ä¸ªlist</strong>ã€‚</p>
<pre><code>&gt; k &lt;- data.<span class="function"><span class="title">frame</span><span class="params">(foo = <span class="number">1</span>:<span class="number">3</span>, w = c(T, F, F)</span></span>, row<span class="class">.names</span> = <span class="function"><span class="title">c</span><span class="params">(<span class="string">'1'</span>, <span class="string">'a'</span>, <span class="string">'k'</span>)</span></span>)
&gt; k
  foo     w
<span class="number">1</span>   <span class="number">1</span>  TRUE
<span class="tag">a</span>   <span class="number">2</span> FALSE
k   <span class="number">3</span> FALSE
</code></pre><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯ä¸€ä¸ªlistçš„é•¿åº¦ï¼Œéƒ½å¿…é¡»å®Œå…¨ä¸€æ ·</strong>ã€‚</p>
<h4 id="Namesï¼ˆåˆ«åï¼‰">Namesï¼ˆåˆ«åï¼‰</h4><p>å¯¹äºä¸€ä¸ªå‘é‡ã€listæˆ–è€…matrixç­‰ç­‰ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ä¸ºé‡Œé¢çš„å…ƒç´ åŠ ä¸Šåˆ«åï¼Œå¦‚:</p>
<pre><code>&gt; x &lt;- <span class="number">1</span>:<span class="number">3</span>
&gt; <span class="function"><span class="title">names</span><span class="params">(x)</span></span> &lt;- <span class="function"><span class="title">c</span><span class="params">(T, F, <span class="string">"ha"</span>)</span></span>
&gt; x
 TRUE FALSE    ha 
    <span class="number">1</span>     <span class="number">2</span>     <span class="number">3</span> 
</code></pre><p>å…¶ä¸­ï¼Œè¿™äº›åˆ«åéƒ½ä¼šä»¥å­—ç¬¦ä¸²çš„å½¢å¼å­˜åœ¨ï¼Œå› æ­¤ï¼Œä½ å¯ä»¥é€šè¿‡x[â€œTRUEâ€]æ¥è®¿é—®å…ƒç´ 1ã€‚</p>
<hr>
<h3 id="è¿›é˜¶çš„R_å“ˆå“ˆå“ˆ">è¿›é˜¶çš„R å“ˆå“ˆå“ˆ</h3><h4 id="Partical_Matching">Partical Matching</h4><p>Ré‡Œé¢æœ‰ä¸ªå¾ˆé…·çš„ç‰¹æ€§å«åšPartial Matchingã€‚æ¯”å¦‚ä½ å®šä¹‰äº†å¦‚ä¸‹çš„listï¼š<code>x &lt;- list(caonikljslkdfj = 5)</code>ï¼Œæ¯æ¬¡éƒ½è¦è¾“å…¥<code>caonikljslkdfj</code>åŠ¿å¿…å¾ˆéº»çƒ¦ï¼Œå› æ­¤ä½ å¯ä»¥ä½¿ç”¨<strong>$</strong>æ¥è·å–ï¼Œå¦‚<code>x$c</code> å³å¯ä»¥å¾—åˆ°5äº†ã€‚</p>
<h4 id="Subset">Subset</h4><p>åœ¨Ré‡Œé¢ï¼Œè·å–æ•°æ®æˆ–è€…æ„å»ºæ•°æ®ç®€ç›´å°±æ˜¯a piece of cakeã€‚(å“ˆå“ˆå“ˆï¼Œè‹±è¯­å¥½å°±æ˜¯å±Œå•Š)</p>
<p>æ¯”å¦‚æœ‰è¿™æ ·ä¸€ä¸ªå‘é‡<code>x &lt;- c(1, 2, 3, 4, 5)</code>ï¼Œ</p>
<p>ä½ å¯ä»¥<code>x[1]</code> æ¥è·å–å…ƒç´ 1ï¼Œä¹Ÿå¯ä»¥é€šè¿‡<code>x[1:3]</code>æ¥è·å–å…ƒç´ 1åˆ°å…ƒç´ 3ã€‚åŒæ ·ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡<code>x[x &gt; 2]</code> æ¥è·å–å…ƒç´ ä¸­å€¼æ¯”2å¤§çš„å…ƒç´ ã€‚</p>
<p>ä½ ä¹Ÿå¯ä»¥é€šè¿‡logicalæ¥æ„å»ºå¦å¤–çš„å‘é‡ï¼Œå¦‚ï¼š</p>
<pre><code>&gt; u &lt;- x &gt; <span class="number">2</span>
&gt; u
[<span class="number">1</span>] <span class="literal">FALSE</span> <span class="literal">FALSE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span>  <span class="literal">TRUE</span>
</code></pre><p>è€Œå¯¹äºMatrixç±»å‹æ¥è¯´ï¼Œ<code>c &lt;- matrix(1:3, nrows = 3, ncols = 1)</code>ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>c[1, ]</code>æ¥è·å–ç¬¬ä¸€è¡Œæ‰€æœ‰åˆ—çš„æ•°æ®ï¼Œæˆ–è€…<code>c[,1]</code>æ¥è·å–ç¬¬ä¸€åˆ—æ‰€æœ‰è¡Œçš„æ•°æ®ã€‚</p>
<h4 id="[]_vs_[[]]_vs_$">[] vs [[]] vs $</h4><p>é¦–å…ˆï¼Œè¿™ä¸‰ä¸ªç¬¦å·éƒ½å¯ä»¥è·å–å…ƒç´ ï¼Œä½†æ˜¯åŒºåˆ«åœ¨äºï¼š</p>
<ul>
<li>[]è¿”å›çš„æ˜¯å’Œå˜é‡æœ¬èº«ç±»å‹ç›¸åŒçš„ä¸œè¥¿ï¼Œå¦‚æœå¯¹listä½¿ç”¨[]ï¼Œé‚£ä¹ˆè¿”å›çš„å°±æ˜¯listï¼Œå¦‚æœå¯¹å‘é‡ä½¿ç”¨ï¼Œè¿”å›çš„å°±æ˜¯å‘é‡ï¼Œæ— å…³å–å‡ºçš„å…ƒç´ æœ¬èº«çš„ç±»å‹ã€‚</li>
<li>[]å¯ä»¥è·å–å¤šä¸ªå…ƒç´ ï¼Œè€Œ[[]]å’Œ$ä¸è¡Œã€‚</li>
<li>$å¯ä»¥æ¨¡ç³ŠåŒ¹é…ï¼ˆPartial Matchingï¼‰ï¼Œè€Œ[[]]ä¸è¡Œï¼Œå¦‚æœè¦å¯ç”¨æ¨¡ç³ŠåŒ¹é…ï¼Œå¾—ä½¿ç”¨[[name, exact = F]]</li>
<li>$ä¸å¯ä»¥ä½¿ç”¨è®¡ç®—å€¼ï¼Œ[[]]å¯ä»¥</li>
</ul>
<p>æ˜¯ä¸æ˜¯å¾ˆæ‹—å£ï¼Ÿè®©æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªä¾‹å­ï¼Œåœ¨çœ‹ä¾‹å­ä¹‹å‰å¼ºè°ƒä¸€ç‚¹ï¼Œ</p>
<p><strong>å…ƒç´ å¹¶éç‰¹æŒ‡ä¸€ä¸ªï¼Œè€Œæ˜¯ä¸€ä¸ªåŸºæœ¬çš„æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚å¯¹äºå‘é‡ <code>x &lt;- 1:5</code>æ¥è¯´ï¼Œé‡Œé¢çš„å…ƒç´ 1åˆ°å…ƒç´ 5åˆ†åˆ«éƒ½æ˜¯ä¸€ä¸ªå…ƒç´ ã€‚è€Œå¯¹äº<code>c&lt;- list(foo = 1:3, bar = 0.5)</code>æ¥è¯´ï¼Œfooå’Œbaréƒ½åˆ†åˆ«æ˜¯ä¸€ä¸ªå…ƒç´ ï¼Œå°½ç®¡fooæœ¬èº«ä»ç„¶æ˜¯ä¸ªå‘é‡ã€‚</strong></p>
<h5 id="ä¾‹å­">ä¾‹å­</h5><p>å¯¹äº<code>c &lt;- list(foo = 1:3, bar = 0.6)</code>å®šä¹‰çš„ä¸€ä¸ªlistï¼Œæˆ‘ä»¬åˆ†åˆ«ä½¿ç”¨ï¼š</p>
<pre><code>&gt; c[<span class="string">"foo"</span>]
$foo
[<span class="number">1</span>] <span class="number">1</span> <span class="number">2</span> <span class="number">3</span>

&gt; c[[<span class="string">"foo"</span>]]
[<span class="number">1</span>] <span class="number">1</span> <span class="number">2</span> <span class="number">3</span>
&gt; c$foo
[<span class="number">1</span>] <span class="number">1</span> <span class="number">2</span> <span class="number">3</span>
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ï¼»ï¼½å–å‡ºçš„fooå…ƒç´ ä»ç„¶æ˜¯listï¼Œè€Œ[[]]å’Œ$å–å‡ºçš„éƒ½æ˜¯å‘é‡å…ƒç´ æœ¬èº«äº†ã€‚</p>
<p>å†æ¯”å¦‚è®¡ç®—å˜é‡çš„å·®åˆ«ï¼š</p>
<pre><code>&gt; name &lt;- <span class="string">"foo"</span>
&gt; c[[name]]
[<span class="number">1</span>] <span class="number">1</span> <span class="number">2</span> <span class="number">3</span>
&gt; c$name
<span class="literal">NULL</span>
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œ[[]]å¯ä»¥ä½¿ç”¨è®¡ç®—å˜é‡ï¼Œè€Œ$ä¸å¯ä»¥ã€‚<strong>è¿™ç‚¹å…¶å®å’ŒJavaScripté‡Œé¢çš„dotå’Œ[]æ“ä½œç¬¦å¾ˆç±»ä¼¼çš„</strong></p>
<p>æ¨¡ç³ŠåŒ¹é…å·®åˆ«ï¼š</p>
<pre><code>&gt; c$f
[<span class="number">1</span>] <span class="number">1</span> <span class="number">2</span> <span class="number">3</span>
&gt; c[[<span class="string">"f"</span>]]
<span class="literal">NULL</span>
&gt; c[[<span class="string">"f"</span>, exact = F]]
[<span class="number">1</span>] <span class="number">1</span> <span class="number">2</span> <span class="number">3</span>
</code></pre><h4 id="å‘é‡åŒ–æ“ä½œ">å‘é‡åŒ–æ“ä½œ</h4><p><strong>Ré‡Œé¢çš„æ‰€æœ‰è®¡ç®—æ“ä½œéƒ½æ˜¯å¹¶è¡Œçš„</strong>ã€‚</p>
<p>å› æ­¤ï¼Œå¦‚æœè¦è®¡ç®—ä¸¤ä¸ªMatrixçš„ä¹˜ç§¯ï¼Œéœ€è¦ä½¿ç”¨<code>%*%</code>ï¼Œå¦åˆ™å¦‚æœç›´æ¥ä½¿ç”¨<code>*</code>å°±æ˜¯å¯¹åº”ä½ç½®çš„å…ƒç´ ç›¸ä¹˜è€Œå·²ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/12/13/Learn-R-1/" data-id="cjqdxq20n002gmxi1mo6fqtmg" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/12/13/Learn-R-1/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/R/">R</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-LLDB-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/11/LLDB-1/" class="article-date">
  <time datetime="2015-12-11T08:50:04.000Z" itemprop="datePublished">2015-12-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/11/LLDB-1/">æµ…å…¥æµ…å‡ºLLDBï¼ˆ1ï¼‰</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>è¿™å‘¨å¼€å§‹å¥½å¥½é’»ç ”ä¸€ä¸‹LLDBç›¸å…³çš„çŸ¥è¯†ï¼Œè¿™æ˜¯ä¸€ç³»åˆ—çš„æ–‡ç« ã€‚æœ‰äº›åˆçº§çŸ¥è¯†å¯èƒ½å¤§å®¶éƒ½æœ‰æ‰€æ¶‰çŒï¼Œå˜¿å˜¿ï¼Œæ‡‚å¾—è‡ªç„¶æ‡‚ï¼Œçœ‹æˆ‘çš„åšå®¢ï¼Œä»€ä¹ˆæ—¶å€™ä¼šæ”¶è·å°ã€‚</p>
<h3 id="åŸºç¡€è¯­æ³•">åŸºç¡€è¯­æ³•</h3><p>1.<code>help</code> æœ‰å•¥ä¸ä¼šï¼Œå°±ç›´æ¥è¾“å…¥helpï¼Œä½ ä¼šå¾—åˆ°å¦‚ä¸‹çš„ä¸€ç³»åˆ—ä¿¡æ¯ï¼Œ</p>
<pre><code>command           -- A <span class="keyword">set</span> <span class="keyword">of</span> commands <span class="keyword">for</span> managing <span class="keyword">or</span> customizing the
                   debugger commands.
disassemble       -- Disassemble bytes <span class="keyword">in</span> the current <span class="keyword">function</span>, <span class="keyword">or</span> elsewhere
                   <span class="keyword">in</span> the executable program <span class="keyword">as</span> specified <span class="keyword">by</span> the user.
</code></pre><p>2.<code>print</code> è¾“å‡ºå˜é‡å€¼<br>æ¯”å¦‚ï¼Œå¯¹äºå¦‚ä¸‹çš„ç¨‹åºè¯­å¥ <code>let haha = 5;</code> ä½ åªè¦åœ¨LLDBé‡Œé¢è¾“å…¥ <code>print haha</code> å°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹è¾“å‡ºç»“æœã€‚</p>
<pre><code>(lldb) p haha
(Int) <span class="variable">$R0</span> = <span class="number">5</span>
</code></pre><p><strong>è¯·æ³¨æ„</strong>ï¼Œåœ¨<a href="http://objccn.io/issue-19-2/" target="_blank" rel="external">ä¸è°ƒè¯•å™¨å…±èˆ- LLDB çš„åå°”å…¹</a>ä¸€æ–‡ä¸­æ›¾ç»æå‡ºä¼šè¾“å‡ºç±»ä¼¼äº <code>$0 = 5</code>ï¼Œå¹¶æŒ‡å‡º<strong>$0æ˜¯å½“å‰çš„è¾“å‡ºå€¼</strong>ã€‚è¿™ä¸ªè¯´è¯å…¶å®æ˜¯ä¸ä¸¥è°¨çš„ï¼Œæ­£ç¡®çš„è¯´æ³•æ˜¯ï¼Œåº”è¯¥æ˜¯<strong>å½“å‰çš„hahaçš„å€¼5å­˜åœ¨äº†R0å¯„å­˜å™¨é‡Œã€‚</strong></p>
<p>æ¯”å¦‚ï¼Œå½“æˆ‘ä»¬æ„å»ºå¦‚ä¸‹çš„ç¨‹åºè¯­å¥æ—¶ï¼Œ</p>
<pre><code><span class="keyword">let</span> haha = <span class="number">5</span>;
<span class="keyword">let</span> <span class="keyword">object</span> = <span class="string">"jkjksdjf"</span>;
</code></pre><p>æˆ‘ä»¬åœ¨åˆ†åˆ«<code>print haha</code>ä»¥åŠ    <code>print object</code>å°±ä¼šåˆ†åˆ«å¾—åˆ°<code>(Int) $R0 = 5</code>å’Œ<code>(String) $R1 = &quot;jkjksdjf&quot;</code></p>
<p>è¿™è¯´æ˜hahaçš„å€¼å’Œobjectçš„å€¼åˆ†åˆ«ä»¥intå‹å’Œstringå‹å­˜åœ¨äº†R0å’ŒR1å¯„å­˜å™¨ä¹‹ä¸­ã€‚</p>
<p><strong>å½“ç„¶ï¼Œå›¾å¿«é€Ÿçš„è¯</strong>ï¼Œå¯ä»¥åƒæˆ‘ä¸Šé¢ä¸€æ ·å°†printç®€å†™æˆpã€‚</p>
<p>3.<code>po</code><br>è¾“å‡ºå˜é‡å€¼  </p>
<p>å“ï¼Œæœ‰äººå¥‡æ€ªäº†ï¼Œpoä¹Ÿæ˜¯è¾“å‡ºå˜é‡å€¼ï¼Œé‚£å’Œpæœ‰å•¥åŒºåˆ«å•Šï¼Ÿæœ¬è´¨ä¸Šæ²¡å•¥åŒºåˆ«ï¼Œå¦‚æœçœŸè¦è¯´ï¼Œå°±æ˜¯<strong>po = e -O â€“</strong>ï¼Œå…·ä½“æˆ‘ä»¬åç»­å†è¯´å•¦ã€‚</p>
<p>4.<code>breakpoubt l</code> è¾“å‡ºæ‰€æœ‰çš„æ–­ç‚¹ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„ç»“æœ</p>
<pre><code>Current breakpoints:
<span class="number">1</span>: file = <span class="string">'xxx/ViewController.swift'</span>, line = <span class="number">19</span>, locations = <span class="number">1</span>, resolved = <span class="number">1</span>, hit count = <span class="number">1</span>

<span class="number">1.1</span>: where = xxx<span class="class">.ViewController</span><span class="class">.viewDidLoad</span> (xxx.ViewController)() -&gt; () + <span class="number">131</span> at ViewController<span class="class">.swift</span>:<span class="number">19</span>, <span class="tag">address</span> = <span class="number">0</span>x0000000108d0a443, resolved, hit count = <span class="number">1</span> 
</code></pre><p>å…¶ä¸­ <strong>1: file</strong>çš„è¿™ä¸ª1å°±æ˜¯IDå·ã€‚<br>é‚£è¿™é‡Œçš„1.1æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿ<strong>å˜¿å˜¿ï¼Œå½“é‡Œä½¿ç”¨Symbolic Breakpointçš„æ—¶å€™ï¼Œä½ ä¸€ä¸ªæ–­ç‚¹å¾ˆæœ‰å¯èƒ½æˆªè·äº†å¤šä¸ªåœ°æ–¹ï¼Œæ¯”å¦‚AViewControllerå’ŒBViewControllerçš„viewDidLoadéƒ½è¢«åŠ ä¸Šäº†æ–­ç‚¹ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦é è¯¸å¦‚1.1å’Œ1.2ä¹‹ç±»çš„ç»†åˆ†IDæ¥è¿›è¡ŒåŒºåˆ«äº†ã€‚</strong></p>
<p>å½“ç„¶ï¼Œæœ‰äººä¼šé—®ï¼Œè¾“å‡ºè¿™ä¸ªæ–­ç‚¹æœ‰ä»€ä¹ˆç”¨å•Šã€‚å˜¿å˜¿ï¼Œå½“ä½ ä½¿ç”¨<strong>Xcode Symbolic Breakpoint</strong>çš„æ—¶å€™ï¼Œä½ å°±ä¼šå‘ç°ç©¶ç«Ÿåœ¨å¤šå°‘ä¸ªåœ°æ–¹ä¸‹äº†æ–­ç‚¹äº†ã€‚</p>
<p><strong>åŒæ ·çš„</strong>ï¼Œä½ å¯ä»¥å°†breakpointç®€å†™æˆbrã€‚</p>
<p>5.<code>br delete ID</code> è¿™é‡Œçš„IDå°±æ˜¯ä¹‹å‰çš„æ–­ç‚¹çš„IDå·<br>é€šè¿‡è¿™ä¸ªå‘½ä»¤ï¼Œå¯ä»¥åˆ é™¤IDå¯¹åº”çš„æ–­ç‚¹</p>
<p>6.<code>br e ID</code> å¯ç”¨ä¸€ä¸ªIDå·å¯¹åº”çš„æ–­ç‚¹</p>
<p>7.<code>br di ID</code> ç¦ç”¨ä¸€ä¸ªIDå·å¯¹åº”çš„æ–­ç‚¹</p>
<p>8.<code>b xxx.swift:lineY</code> åœ¨xxxæ–‡ä»¶çš„ç¬¬lineYè¡Œè®¾ç½®ä¸€ä¸ªæ–­ç‚¹<br>å¦‚ <code>b ViewController.swift:10</code> å°±æ˜¯åœ¨ViewControllerçš„ç¬¬10å·ä¸‹äº†ä¸€ä¸ªæ–­ç‚¹ã€‚</p>
<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ</strong>é€šè¿‡bå‘½ä»¤è®¾ç½®çš„æ–­ç‚¹ï¼Œæ— æ³•ç›´è§‚çš„åœ¨Xcodeç•Œé¢ä¸Šæ˜¾ç¤ºå‡ºæ¥ï¼Œè€Œ<code>br delete</code>åˆ é™¤ä¸€ä¸ªæ–­ç‚¹å¯ä»¥ç›´æ¥åœ¨Xcodeä¸Šçœ‹å‡ºæ•ˆæœã€‚</p>
<p>9.<code>br set -n functionName</code> å¯¹functionNameè®¾ç½®Symbolic Breakpoint<br>å¦‚<code>br set -n viewDidLoad</code> å°±æ˜¯å¯¹æ‰€æœ‰çš„viewDidLoadè®¾ç½®äº†Symboloc Breakpoint</p>
<p>10.<code>br mod -C &quot;Condition&quot; ID</code> å¯¹IDå·å¯¹åº”çš„breakpointæ·»åŠ æ¡ä»¶è§¦å‘<br>å‡è®¾æˆ‘ä»¬æœ‰ä¸‹é¢è¿™æ ·çš„ä¸€æ®µä»£ç </p>
<pre><code><span class="number">1.</span> <span class="comment">//ViewController.swift</span>
<span class="number">2.</span> <span class="keyword">for</span> var value in money {
<span class="number">3.</span>     totalValue += value
<span class="number">4.</span> }
</code></pre><p>æˆ‘ä»¬é¦–å…ˆå…ˆä½¿ç”¨<code>b ViewController.swift:3</code>è®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œç„¶åä½¿ç”¨<code>br l</code>æŸ¥è¯¢åˆ°å¯¹åº”çš„IDä¸º3ã€‚<br>ç„¶åæˆ‘ä»¬ä½¿ç”¨<code>br mod -C &quot;totalValue &gt; 50&quot; 3</code>å¯¹è¿™ä¸ªæ–­ç‚¹è®¾ç½®æ¡ä»¶è§¦å‘ï¼Œæ¡ä»¶ä¸º<strong>å½“totalValue å¤§äº50æ—¶å€™æ‰è§¦å‘</strong>ã€‚</p>
<p>å½“ç„¶ï¼Œå¯èƒ½æœ‰äº›äººä¼šé—®ï¼Œå¦‚æœæˆ‘ä¸æƒ³åˆ é™¤æ–­ç‚¹ï¼Œåªæ˜¯æƒ³ç§»é™¤æ¡ä»¶è§¦å‘æ€ä¹ˆåŠï¼Ÿå¾ˆç®€å•ï¼Œåªè¦è¾“å…¥<code>br mod -C &quot;&quot; ID</code>ï¼Œå°†å…¶ä¸­çš„Conditionéƒ¨åˆ†è®¾ç½®ä¸ºç©ºå³å¯ã€‚</p>
<p>11.<code>continue</code> ç»§ç»­è¿è¡Œç¨‹åº<br>12.<code>n</code>        step overå•æ­¥è°ƒè¯•<br>13.<code>s</code>        step inè¿›è¡Œå‡½æ•°<br>14.<code>finish</code>   step outé€€å‡ºå‡½æ•°</p>
<h3 id="å¤§æ€å™¨">å¤§æ€å™¨</h3><p>ä¸Šé¢çš„å‘½ä»¤æ˜¯ä¸æ˜¯å¾ˆå¤šï¼Œä¸€ä¸ªä¸ªæ•²å®åœ¨æ˜¯å¤ªéº»çƒ¦ï¼Œé‚£å¦‚æœæˆ‘æƒ³å¯¹ä¸€ä¸ªæ–­ç‚¹æ‰§è¡Œå¤šæ¡è¯­å¥æ€ä¹ˆåŠï¼Ÿ<br>å˜¿å˜¿ï¼Œå¤§æ€å™¨æ¥äº†ã€‚</p>
<p><code>br com add ID</code> å¯¹IDå¯¹åº”çš„æ–­ç‚¹è¿›å…¥äº¤äº’å¼æŒ‡å®šã€‚å¦‚ï¼š</p>
<pre><code><span class="keyword">br</span> <span class="keyword">com</span> <span class="built_in">add</span> <span class="number">2</span>
&gt; bt
&gt; <span class="keyword">continue</span>
&gt; DONE
</code></pre><p> ä¸Šé¢çš„è¯­å¥æŒ‡çš„æ˜¯ï¼Œå¯¹2å·æ–­ç‚¹è¿›è¡Œäº¤äº’å¼æŒ‡å®šï¼Œå½“è¿™ä¸ªæ–­ç‚¹è§¦å‘çš„æ—¶å€™ï¼Œé¦–å…ˆæ‰§è¡Œ<code>bt</code>(å…·ä½“btå‘½ä»¤çš„æ„æ€æˆ‘ä»¬åç»­å†è¯´ï¼Œç²—ç•¥ç†è§£å°±æ˜¯backtraceè¾“å‡ºè°ƒç”¨æ ˆï¼Œå¯ä»¥ç®€å•çœ‹ä¸‹é¢çš„ä¾‹å­)ï¼Œç„¶åæ‰§è¡Œ<code>continue</code>ï¼Œæœ€åé€šè¿‡å…³é”®å­—<strong>Done</strong>é€€å‡ºæŒ‡å®šï¼Œè¿™é‡Œçš„Doneç±»ä¼¼äºshellé‡Œé¢çš„exitã€‚</p>
<pre><code>frame <span class="preprocessor">#<span class="number">0</span>: xxx`xxx.ViewController.viewDidLoad (self=<span class="number">0x00007faf52439c20</span>)() -&gt; () + <span class="number">470</span> at ViewController.swift:<span class="number">27</span></span>
frame <span class="preprocessor">#<span class="number">1</span>: xxx`@objc xxx.ViewController.viewDidLoad (xxx.ViewController)() -&gt; () + <span class="number">34</span> at ViewController.swift:<span class="number">0</span></span>
frame <span class="preprocessor">#<span class="number">2</span>: UIKit`-[UIViewController loadViewIfRequired] + <span class="number">1198</span></span>
frame <span class="preprocessor">#<span class="number">3</span>: UIKit`-[UIViewController view] + <span class="number">27</span></span>
frame <span class="preprocessor">#<span class="number">4</span>: UIKit`-[UIWindow addRootViewControllerViewIfPossible] + <span class="number">61</span></span>
frame <span class="preprocessor">#<span class="number">5</span>: UIKit`-[UIWindow _setHidden:forced:] + <span class="number">282</span></span>
frame <span class="preprocessor">#<span class="number">6</span>: UIKit`-[UIWindow makeKeyAndVisible] + <span class="number">42</span></span>
frame <span class="preprocessor">#<span class="number">7</span>: UIKit`-[UIApplication _callInitializationDelegatesForMainScene:transitionContext:] + <span class="number">4131</span></span>
frame <span class="preprocessor">#<span class="number">8</span>: UIKit`-[UIApplication _runWithMainScene:transitionContext:completion:] + <span class="number">1760</span></span>
frame <span class="preprocessor">#<span class="number">9</span>: UIKit`-[UIApplication workspaceDidEndTransaction:] + <span class="number">188</span></span>
frame <span class="preprocessor">#<span class="number">10</span>: FrontBoardServices`-[FBSSerialQueue _performNext] + <span class="number">192</span></span>
frame <span class="preprocessor">#<span class="number">11</span>: FrontBoardServices`-[FBSSerialQueue _performNextFromRunLoopSource] + <span class="number">45</span></span>
frame <span class="preprocessor">#<span class="number">12</span>: CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + <span class="number">17</span></span>
frame <span class="preprocessor">#<span class="number">13</span>: CoreFoundation`__CFRunLoopDoSources0 + <span class="number">556</span></span>
frame <span class="preprocessor">#<span class="number">14</span>: CoreFoundation`__CFRunLoopRun + <span class="number">867</span></span>
frame <span class="preprocessor">#<span class="number">15</span>: CoreFoundation`CFRunLoopRunSpecific + <span class="number">488</span></span>
frame <span class="preprocessor">#<span class="number">16</span>: UIKit`-[UIApplication _run] + <span class="number">402</span></span>
frame <span class="preprocessor">#<span class="number">17</span>: UIKit`UIApplicationMain + <span class="number">171</span></span>
frame <span class="preprocessor">#<span class="number">18</span>: xxx`main + <span class="number">109</span> at AppDelegate.swift:<span class="number">12</span></span>
frame <span class="preprocessor">#<span class="number">19</span>: libdyld.dylib`start + <span class="number">1</span></span>
frame <span class="preprocessor">#<span class="number">20</span>: libdyld.dylib`start + <span class="number">1</span></span>
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/12/11/LLDB-1/" data-id="cjqdxq20u002lmxi1x9eed74u" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/12/11/LLDB-1/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-TBAnnotationClustering" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/11/TBAnnotationClustering/" class="article-date">
  <time datetime="2015-12-10T16:56:04.000Z" itemprop="datePublished">2015-12-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/11/TBAnnotationClustering/">TBAnnotationClusteringæºç è§£æ</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>æ¯•è®¾è¿™ä¸¤å¤©é£ä¸€èˆ¬çš„åŠ é€Ÿï¼Œç»ˆäºå¯ä»¥å†™å†™æºç è§£æäº†ï¼Œå˜¿å˜¿ï¼Œè¿™å‘¨è¯»ä¸¤ä¸ªè·Ÿæ€§èƒ½ç›¸å…³çš„æºç ï¼Œé¦–å…ˆæ˜¯ä¸€ä¸ªè·Ÿåœ°å›¾ç›¸å…³çš„ï¼Œä»Šå¤©æ¥çœ‹çœ‹ä¸€ä¸ªæ•°æ®ç»“æ„åœ¨iOSå¼€å‘ä¸­çš„å¦™ç”¨ã€‚</p>
<h3 id="TBAnnotationClustering">TBAnnotationClustering</h3><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒMapViewçš„å®ç°æœºåˆ¶å…¶å®å’ŒUITableViewç±»ä¼¼ï¼Œé¦–å…ˆä»–ä»¬éƒ½æ˜¯åŸºäºUIScrollViewæ”¯æŒæ»‘åŠ¨çš„ï¼Œæ­¤å¤–ï¼Œä»–ä»¬éƒ½é‡‡ç”¨äº†å¾ªç¯æœç”¨çš„æœºåˆ¶äº†æ¥ä¿æŒå†…å­˜çš„å¼€é”€ã€‚</p>
<p><strong>ä½†æ˜¯</strong>ï¼Œä¸¤è€…ä¹‹é—´æœ‰ä¸ªå¾ˆå¤§çš„åŒºåˆ«å°±æ˜¯æ•°é‡çº§çš„å·®è·ï¼ŒUITableViewå°±ç®—å……æ»¡æ•´ä¸ªå±å¹•ï¼Œå……å…¶é‡ä¹Ÿå°±æ˜¯10å¤šä¸ªåŒæ—¶å¯è§çš„VisibleCellï¼Œå› æ­¤å°±å¤šç»´æŠ¤ä¸€ä¸ªå¤§å°æ˜¯VisibleCellsæ•°é‡ ï¼‹ 2çš„è¿™æ ·ä¸€ä¸ªå¾ªç¯é˜Ÿåˆ—ï¼Œè¿›è¡Œå¤ç”¨ã€‚ä½†æ˜¯MapViewå°±ä¸ä¸€æ ·äº†ï¼Œåœ°å›¾ä¸ŠåŒæ—¶å±•ç¤ºä¸€æ®µèŒƒå›´å†…å‡ åƒä¸ªPoint of Interestæ˜¯éå¸¸æœ‰å¯èƒ½çš„ï¼Œè¿™ä¸€ä¸‹å­çš„å†…å­˜å¼€é”€å’Œæ€§èƒ½å¡é¡¿å°±éå¸¸ä¸å¾—äº†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ç§åˆç†çš„æ‰‹æ®µæ¥é¿å…ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦è®²è§£çš„TBAnnotationClusteringçš„ç”±æ¥ã€‚</p>
<p><a href="https://github.com/thoughtbot/TBAnnotationClustering" target="_blank" rel="external">Githubåœ°å€</a></p>
<h3 id="Level_of_Detail">Level of Detail</h3><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸‹ç›¸å…³èƒŒæ™¯çŸ¥è¯†ã€‚</p>
<p>æ ¹æ®å›¾åƒæ¸²æŸ“çš„ç†è®ºæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œäººçš„è§†é‡å­˜åœ¨ç„¦ç‚¹åŒºåŸŸå’Œç›²ç‚¹åŒºåŸŸï¼Œæ€»æ˜¯æ›´å€¾å‘äºå…³æ³¨å¤„äºè§†çº¿å·¦ä¸Šè§’åˆ°è§†çº¿ä¸­å¿ƒéƒ¨åˆ†çš„ã€‚å› æ­¤ï¼Œåœ¨ç°å®åº”ç”¨ä¸­ï¼Œå¦‚æ¸¸æˆåœºæ™¯ï¼Œå½“åœºæ™¯éœ€è¦å±•ç°çš„æ¨¡å‹è·ç¦»è§†çº¿ç„¦ç‚¹éå¸¸è¿‘æ—¶ï¼Œå°±é‡‡ç”¨é«˜ç²¾åº¦çš„æ¨¡å‹æ¥è¿›è¡Œå±•ç¤ºï¼›è€Œåˆ°æ¨¡å‹å¤„äºè¾ƒè¿œä½ç½®æ—¶ï¼Œæ¯”å¦‚ä½“è‚²æ¸¸æˆçš„åœºå¤–è§‚ä¼—ï¼Œå°±å¯ä»¥é‡‡ç”¨ä½ç²¾åº¦æ¨¡å‹è¿›è¡Œæ›¿æ¢ï¼Œå‡å°‘æ¸²æŸ“æ—¶å€™çš„è®¡ç®—é‡ï¼›è€Œåˆ°æ¨¡å‹æ‰€å¤„ä½ç½®åŸºæœ¬å¯ä»¥è€ƒè™‘æˆä¸ºèƒŒæ™¯æ—¶ï¼Œåˆ™ä¼šé‡‡ç”¨åŸºæœ¬å›¾å…ƒè¿›è¡Œå±•ç¤ºã€‚é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œå³ä¿è¯äº†åœºæ™¯çš„çœŸå®è§‚æ„Ÿï¼ŒåŒæ—¶åˆå¤§å¤§å‡å°‘äº†ä¸å¿…è¦çš„è®¡ç®—é‡ã€‚è¿™ä¹Ÿå°±æ˜¯é€šå¸¸è®¡ç®—æœºå›¾å½¢å­¦é¢†åŸŸæ‰€è°“çš„Level Of DetailæŠ€æœ¯ã€‚</p>
<h3 id="QuadTree">QuadTree</h3><p>QuadTreeå¯èƒ½å¾ˆå¤šäººä¼šæ¯”è¾ƒé™Œç”Ÿï¼Œä½†æ˜¯ä¸€æåˆ°ä»–çš„å“¥å“¥ ï¼ äºŒå‰æ ‘ï¼Œæƒ³å¿…å¤§å®¶ä¸ä¼šé™Œç”Ÿï¼Œæ‰€ä»¥QuadTreeåˆè¢«ç§°ä¸ºå››å‰æ ‘ï¼Œå…³äºå››å‰æ ‘çš„å®šä¹‰ï¼Œ</p>
<blockquote><br>A quadtree is a tree data structure in which each internal node has exactly four children.<br></blockquote>

<p>å››å‰æ ‘è¢«å¹¿æ³›çš„è¿ç”¨äºç©ºé—´åˆ’åˆ†ã€‚é€šè¿‡å°†ç©ºé—´é€’å½’åˆ’åˆ†ä¸åŒå±‚æ¬¡çš„å­ç»“æ„ï¼Œå¯ä»¥è¾¾åˆ°è¾ƒé«˜çš„ç©ºé—´æ•°æ®æ’å…¥å’ŒæŸ¥è¯¢æ•ˆæœã€‚</p>
<p>ä¸‹é¢å°±æ˜¯ä¸€å¼ æ¯”è¾ƒç»å…¸çš„å››å‰æ ‘æ„é€ ï¼Œé¦–å…ˆå…ˆå°†ä¸€ä¸ªå¤§ç©ºé—´åˆ’åˆ†ä¸ºå››ä¸ªå­—ç©ºé—´ a b c dã€‚ç„¶åæ ¹æ®æ¯ä¸€ä¸ªå­ç©ºé—´å†…çš„èŠ‚ç‚¹ä¸ªæ•°å†è¿›è¡Œç»†åˆ†ã€‚<strong>è¿™é‡Œè¦å¼ºè°ƒä¸€ç‚¹ï¼Œå››å‰æ ‘çš„ç»†åˆ†æ²¡æœ‰å…·ä½“è¦æ±‚ï¼Œä½ å¯ä»¥æŒ‰ä½ çš„éœ€æ±‚åˆ’åˆ†æˆæ¯ä¸ªèŠ‚ç‚¹èƒ½åªåŒ…å«ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥æ ¹æ®å¹³è¡¡å‡å°‘åˆ’åˆ†æ¬¡æ•°ã€‚</strong></p>
<p><img src="http://img.blog.csdn.net/20131005154434687?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvemhvdXh1Z3VhbmcyMzY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast"></p>
<h3 id="TBAnnotationClusteringæºç è®²è§£">TBAnnotationClusteringæºç è®²è§£</h3><p>æ‰“å¼€è¿™ä¸ªé¡¹ç›®ï¼Œç²—ç•¥è¿‡ä¸€ä¸‹é¡¹ç›®ç»“æ„ï¼Œå¤§è‡´éœ€è¦å…³æ³¨çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<ul>
<li>TBQuadTree.h/.m</li>
<li>TBCoordinateQuadTree.h/.m</li>
</ul>
<p>è®©æˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥åˆ†æ</p>
<h4 id="TBQuadTree">TBQuadTree</h4><p>æ¯«æ— ç–‘é—®ï¼Œä»æ–‡ä»¶åç§°æ¥çœ‹ï¼Œæˆ‘ä»¬å°±çŸ¥é“ï¼Œè¿™ä¸ªç±»å°±ä»£è¡¨åŸºç¡€çš„å››å‰æ ‘æ•°æ®ç»“æ„ï¼Œé¦–å…ˆè®©æˆ‘ä»¬æ¥çœ‹çœ‹æ•°æ®ç»“æ„çš„å®šä¹‰</p>
<pre><code><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">TBQuadTreeNodeData</span> </span>{
    <span class="built_in">double</span> x;
    <span class="built_in">double</span> y;
    <span class="keyword">void</span>* data;
} TBQuadTreeNodeData;
TBQuadTreeNodeData TBQuadTreeNodeDataMake(<span class="built_in">double</span> x, <span class="built_in">double</span> y, <span class="keyword">void</span>* data);
</code></pre><p>è¿™ä¸ªæ¯«æ— ç–‘é—®ï¼Œå°±æ˜¯ä»£è¡¨çš„åæ ‡ç³»çš„<strong>æ•°æ®èŠ‚ç‚¹</strong>ã€‚ (x, y)è¡¨å¾åæ ‡ç‚¹ï¼Œvoid *dataè‡ªç”±çš„æŒ‡å‘é™„åŠ çš„æ•°æ®ã€‚</p>
<pre><code><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">TBBoundingBox</span> </span>{
    <span class="built_in">double</span> x0; <span class="built_in">double</span> y0;
    <span class="built_in">double</span> xf; <span class="built_in">double</span> yf;
} TBBoundingBox;
TBBoundingBox TBBoundingBoxMake(<span class="built_in">double</span> x0, <span class="built_in">double</span> y0, <span class="built_in">double</span> xf, <span class="built_in">double</span> yf);
</code></pre><p>è¿™ä¸ªåŒæ ·å¾ˆç®€å•ï¼Œç”¨ä¸¤ä¸ªå¯¹è§’ç‚¹é™å®šäº†ä¸€ä¸ªé•¿æ–¹å½¢åŒºåŸŸï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå››å‰æ ‘çš„èŠ‚ç‚¹ç©¶ç«ŸåŒ…å«å“ªäº›èŒƒå›´ã€‚</p>
<pre><code><span class="label">typedef</span> <span class="keyword">struct </span>quadTreeNode {
    <span class="keyword">struct </span>quadTreeNode* northWest<span class="comment">;</span>
    <span class="keyword">struct </span>quadTreeNode* northEast<span class="comment">;</span>
    <span class="keyword">struct </span>quadTreeNode* southWest<span class="comment">;</span>
    <span class="keyword">struct </span>quadTreeNode* southEast<span class="comment">;</span>
    <span class="keyword">TBBoundingBox </span><span class="keyword">boundingBox;
</span>    int <span class="keyword">bucketCapacity;
</span>    TBQuadTreeNodeData *points<span class="comment">;</span>
    int count<span class="comment">;</span>
} TBQuadTreeNode<span class="comment">;</span>
<span class="label">TBQuadTreeNode</span>* TBQuadTreeNodeMake(<span class="keyword">TBBoundingBox </span><span class="keyword">boundary, </span>int <span class="keyword">bucketCapacity);</span>
</code></pre><p>è¿™ä¸ªç¨å¾®å¤æ‚ç‚¹ï¼Œæ˜¯å››å‰æ ‘çš„æ ‘èŠ‚ç‚¹ï¼Œå…¶ä¸­</p>
<ul>
<li>northWest, northEast, southWest, southEaståˆ†åˆ«ä»£è¡¨å››å‰æ ‘çš„å››ä¸ªå­ç»†åˆ†åŒºåŸŸã€‚</li>
<li>bondingBoxä»£è¡¨çš„å½“å‰è¿™ä¸ªæ ‘èŠ‚ç‚¹çš„æ¶µç›–åŒºåŸŸã€‚</li>
<li>bucketCapacityè¡¨ç¤ºè¿™ä¸ªæ ‘èŠ‚ç‚¹æœ€å¤§å®¹çº³çš„æ•°æ®èŠ‚ç‚¹ä¸ªæ•°</li>
<li>points æ•°æ®èŠ‚ç‚¹æ•°ç»„</li>
<li>count å½“å‰åŒ…å«äº†æ•°æ®èŠ‚ç‚¹ã€‚</li>
</ul>
<p><strong>å†æ¬¡å¼ºè°ƒï¼Œåƒä¸‡ä¸è¦æŠŠæ ‘èŠ‚ç‚¹å’Œæ•°æ®èŠ‚ç‚¹ææ··ã€‚æ ‘èŠ‚ç‚¹æŒ‡çš„æ˜¯å››å‰æ ‘ä¸Šçš„æ•°æ®ç»“æ„ï¼Œæ¯ä¸ªæ ‘èŠ‚ç‚¹æœ€å¤šæœ‰å››ä¸ªå­æ ‘èŠ‚ç‚¹ï¼Œä½†æ˜¯å¯ä»¥æœ‰bucketCapacityå¤§å°çš„æ•°æ®èŠ‚ç‚¹ï¼Œæ•°æ®èŠ‚ç‚¹ä»…ä»…æ˜¯ç”¨æ¥å°è£…åæ ‡ç³»å’Œå…¶ç›¸å…³çš„æ•°æ®çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œéå››å‰æ ‘ç‰¹æœ‰ã€‚</strong></p>
<p>çœ‹å®Œäº†æ•°æ®å®šä¹‰ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å…¶å®ç°éƒ¨åˆ†ã€‚</p>
<pre><code><span class="preprocessor">#<span class="keyword">pragma</span> mark - Constructors</span>

<span class="function">TBQuadTreeNodeData <span class="title">TBQuadTreeNodeDataMake</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y, <span class="keyword">void</span>* data)</span>
</span>{
    TBQuadTreeNodeData d; d.x = x; d.y = y; d.data = data;
    <span class="keyword">return</span> d;
}

<span class="function">TBBoundingBox <span class="title">TBBoundingBoxMake</span><span class="params">(<span class="keyword">double</span> x0, <span class="keyword">double</span> y0, <span class="keyword">double</span> xf, <span class="keyword">double</span> yf)</span>
</span>{
    TBBoundingBox bb; bb.x0 = x0; bb.y0 = y0; bb.xf = xf; bb.yf = yf;
    <span class="keyword">return</span> bb;
}

<span class="function">TBQuadTreeNode* <span class="title">TBQuadTreeNodeMake</span><span class="params">(TBBoundingBox boundary, <span class="keyword">int</span> bucketCapacity)</span>
</span>{
    TBQuadTreeNode* node = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(TBQuadTreeNode));
    node-&gt;northWest = <span class="literal">NULL</span>;
    node-&gt;northEast = <span class="literal">NULL</span>;
    node-&gt;southWest = <span class="literal">NULL</span>;
    node-&gt;southEast = <span class="literal">NULL</span>;

    node-&gt;boundingBox = boundary;
    node-&gt;bucketCapacity = bucketCapacity;
    node-&gt;count = <span class="number">0</span>;
    node-&gt;points = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(TBQuadTreeNodeData) * bucketCapacity);

    <span class="keyword">return</span> node;
}
</code></pre><p>è¿™ä¸‰ä¸ªæ„é€ å‡½æ•°ï¼Œåˆ†åˆ«æ˜¯æ„é€ <span style="color:red">æ•°æ®èŠ‚ç‚¹</span>ã€é•¿æ–¹å½¢ä»¥åŠ<span style="color:blue">å››å‰æ ‘èŠ‚ç‚¹</span>ï¼Œé»˜è®¤æƒ…å†µä¸‹å››å‰æ ‘çš„èŠ‚ç‚¹<strong>å¹¶éæ»¡æ„é€ </strong>ï¼Œè€Œæ˜¯åˆå§‹åŒ–ä¸ºç©ºï¼Œæ ¹æ®éœ€è¦æ’å…¥æ–°èŠ‚ç‚¹ã€‚</p>
<pre><code><span class="label">#pragma</span> <span class="keyword">mark </span>- <span class="keyword">Bounding </span><span class="keyword">Box </span>Functions

<span class="keyword">bool </span><span class="keyword">TBBoundingBoxContainsData(TBBoundingBox </span><span class="keyword">box, </span>TBQuadTreeNodeData <span class="preprocessor">data</span>)
{
    <span class="keyword">bool </span>containsX = <span class="keyword">box.x0 </span>&lt;= <span class="preprocessor">data</span>.x &amp;&amp; <span class="preprocessor">data</span>.x &lt;= <span class="keyword">box.xf;
</span>    <span class="keyword">bool </span>containsY = <span class="keyword">box.y0 </span>&lt;= <span class="preprocessor">data</span>.y &amp;&amp; <span class="preprocessor">data</span>.y &lt;= <span class="keyword">box.yf;
</span>
    return containsX &amp;&amp; containsY<span class="comment">;</span>
}

<span class="keyword">bool </span><span class="keyword">TBBoundingBoxIntersectsBoundingBox(TBBoundingBox </span><span class="keyword">b1, </span><span class="keyword">TBBoundingBox </span><span class="keyword">b2)
</span>{
    return (<span class="keyword">b1.x0 </span>&lt;= <span class="keyword">b2.xf </span>&amp;&amp; <span class="keyword">b1.xf </span>&gt;= <span class="keyword">b2.x0 </span>&amp;&amp; <span class="keyword">b1.y0 </span>&lt;= <span class="keyword">b2.yf </span>&amp;&amp; <span class="keyword">b1.yf </span>&gt;= <span class="keyword">b2.y0);
</span>}
</code></pre><p>éšåå°±æ˜¯ä¸Šé¢ä¸¤ä¸ªåˆ¤æ–­é•¿æ–¹å½¢åŒ…å«å’Œç›¸äº¤çš„æ–¹æ³•äº†ï¼ŒåŒ…å«è‡ªç„¶æ˜¯æ•´ä¸ªåŒ…å›´ã€‚è€Œç›¸äº¤çš„è¡¥é›†æ˜¯ä¸ç›¸äº¤ï¼Œå³åœ¨æ¨ªåæ ‡ä¸Šä¸€ä¸ªé•¿æ–¹å½¢çš„xfå¦ä¸€ä¸ªé•¿æ–¹å½¢çš„x0æŠ‘æˆ–æ˜¯ä¸€ä¸ªé•¿æ–¹å½¢çš„x0å®Œå…¨å¤§äºå¦ä¸€ä¸ªé•¿æ–¹å½¢çš„xfï¼Œå½“ç„¶åœ¨yè½´ä¸Šä¹Ÿæ˜¯åŒç†ï¼Œå› æ­¤é€šè¿‡è¡¥é›†å¾ˆå®¹æ˜“å°±ç†è§£TBBoundingBoxIntersectsBoundingBoxçš„å®ç°äº†ã€‚</p>
<p>ç„¶åæ¥çœ‹çœ‹éå¸¸é‡è¦çš„å‡ ä¸ªå‡½æ•°ï¼Œé¦–å…ˆæ˜¯<strong>TBQuadTreeNodeSubdivide</strong></p>
<pre><code><span class="label">void</span> TBQuadTreeNodeSubdivide(TBQuadTreeNode* node)
{
    <span class="keyword">TBBoundingBox </span><span class="keyword">box </span>= node-&gt;<span class="keyword">boundingBox;
</span>
    double xMid = (<span class="keyword">box.xf </span>+ <span class="keyword">box.x0) </span>/ <span class="number">2</span>.<span class="number">0</span><span class="comment">;</span>
    double yMid = (<span class="keyword">box.yf </span>+ <span class="keyword">box.y0) </span>/ <span class="number">2</span>.<span class="number">0</span><span class="comment">;</span>

    <span class="keyword">TBBoundingBox </span>northWest = <span class="keyword">TBBoundingBoxMake(box.x0, </span><span class="keyword">box.y0, </span>xMid, yMid)<span class="comment">;</span>
    node-&gt;northWest = TBQuadTreeNodeMake(northWest, node-&gt;<span class="keyword">bucketCapacity);
</span>
    <span class="keyword">TBBoundingBox </span>northEast = <span class="keyword">TBBoundingBoxMake(xMid, </span><span class="keyword">box.y0, </span><span class="keyword">box.xf, </span>yMid)<span class="comment">;</span>
    node-&gt;northEast = TBQuadTreeNodeMake(northEast, node-&gt;<span class="keyword">bucketCapacity);
</span>
    <span class="keyword">TBBoundingBox </span>southWest = <span class="keyword">TBBoundingBoxMake(box.x0, </span>yMid, xMid, <span class="keyword">box.yf);
</span>    node-&gt;southWest = TBQuadTreeNodeMake(southWest, node-&gt;<span class="keyword">bucketCapacity);
</span>
    <span class="keyword">TBBoundingBox </span>southEast = <span class="keyword">TBBoundingBoxMake(xMid, </span>yMid, <span class="keyword">box.xf, </span><span class="keyword">box.yf);
</span>    node-&gt;southEast = TBQuadTreeNodeMake(southEast, node-&gt;<span class="keyword">bucketCapacity);
</span>}
</code></pre><p>è¿™ä¸ªå‡½æ•°è´Ÿè´£å°†å››å‰æ ‘èŠ‚ç‚¹è¿›è¡Œç»†åˆ†ã€‚é¦–å…ˆè·å–å½“å‰èŠ‚ç‚¹è´Ÿè´£çš„é•¿æ–¹å½¢åŒºåŸŸçš„ä¸­ç‚¹ï¼Œç„¶åæ ¹æ®ä¸­ç‚¹åˆ°åŸæœ‰é•¿æ–¹å½¢çš„å››ä¸ªé¡¶ç‚¹ï¼Œåˆ†æˆå››ä¸ªè±¡é™ï¼Œè¿›è¡Œåˆ’åˆ†ã€‚<strong>è¿™ä¸ªæ—¶å€™è¯·æ³¨æ„</strong>ï¼Œè¿˜åªæ˜¯è¿›è¡Œå››å‰æ ‘èŠ‚ç‚¹çš„ç»†åˆ†ï¼Œè¿˜æ²¡é‡æ–°æ›´æ”¹æ•°æ®èŠ‚ç‚¹çš„åˆ†å¸ƒã€‚</p>
<pre><code><span class="keyword">bool</span> TBQuadTreeNodeInsertData(TBQuadTreeNode* node, TBQuadTreeNodeData data)
{
    <span class="keyword">if</span> (!TBBoundingBoxContainsData(node-&gt;boundingBox, data)) {
        <span class="keyword">return</span> <span class="keyword">false</span>;
    }

    <span class="keyword">if</span> (node-&gt;count &lt; node-&gt;bucketCapacity) {
        node-&gt;points[node-&gt;count++] = data;
        <span class="keyword">return</span> <span class="keyword">true</span>;
    }

    <span class="keyword">if</span> (node-&gt;northWest == <span class="keyword">NULL</span>) {
        TBQuadTreeNodeSubdivide(node);
    }

    <span class="keyword">if</span> (TBQuadTreeNodeInsertData(node-&gt;northWest, data)) <span class="keyword">return</span> <span class="keyword">true</span>;
    <span class="keyword">if</span> (TBQuadTreeNodeInsertData(node-&gt;northEast, data)) <span class="keyword">return</span> <span class="keyword">true</span>;
    <span class="keyword">if</span> (TBQuadTreeNodeInsertData(node-&gt;southWest, data)) <span class="keyword">return</span> <span class="keyword">true</span>;
    <span class="keyword">if</span> (TBQuadTreeNodeInsertData(node-&gt;southEast, data)) <span class="keyword">return</span> <span class="keyword">true</span>;

    <span class="keyword">return</span> <span class="keyword">false</span>;
}
</code></pre><p>è¿™ä¸ªå‡½æ•°åˆ™æ˜¯çœŸæ­£çš„å°†æ•°æ®æ’å…¥åˆ°èŠ‚ç‚¹ä¸­ã€‚</p>
<ul>
<li>é¦–å…ˆå…ˆåˆ¤æ–­è¿™ä¸ªæ•°æ®æ˜¯å¦è½åœ¨è¯¥é•¿æ–¹å½¢ä¸­ï¼Œä¸æ˜¯ç›´æ¥æ»šè›‹ã€‚</li>
<li>å¦‚æœå½“å‰åŒ…å«çš„æ•°æ®èŠ‚ç‚¹ä¸ªæ•°æ²¡æœ‰è¶…è¿‡æœ€å¤§æ•°ç›®ï¼Œç›´æ¥åº”ç”¨åœ¨å…¶ä¸­ã€‚</li>
<li>å¦‚æœå››ä¸ªå­èŠ‚ç‚¹ä¸ºç©ºï¼Œå°±å…ˆåˆ›å»º</li>
<li>ç„¶åå†é€’å½’æ’å…¥</li>
</ul>
<pre><code><span class="type">void</span> <span class="type">TBQuadTreeGatherDataInRange</span>(<span class="type">TBQuadTreeNode</span>* node, <span class="type">TBBoundingBox</span> <span class="type">range</span>, <span class="type">TBDataReturnBlock</span> <span class="keyword">block</span>)
{
    <span class="keyword">if</span> (!<span class="type">TBBoundingBoxIntersectsBoundingBox</span>(node-&gt;boundingBox, <span class="type">range</span>)) {
        <span class="keyword">return</span>;
    }

    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; node-&gt;count; i++) {
        <span class="keyword">if</span> (<span class="type">TBBoundingBoxContainsData</span>(<span class="type">range</span>, node-&gt;points[i])) {
            <span class="keyword">block</span>(node-&gt;points[i]);
        }
    }

    <span class="keyword">if</span> (node-&gt;northWest == <span class="type">NULL</span>) {
        <span class="keyword">return</span>;
    }

    <span class="type">TBQuadTreeGatherDataInRange</span>(node-&gt;northWest, <span class="type">range</span>, <span class="keyword">block</span>);
    <span class="type">TBQuadTreeGatherDataInRange</span>(node-&gt;northEast, <span class="type">range</span>, <span class="keyword">block</span>);
    <span class="type">TBQuadTreeGatherDataInRange</span>(node-&gt;southWest, <span class="type">range</span>, <span class="keyword">block</span>);
    <span class="type">TBQuadTreeGatherDataInRange</span>(node-&gt;southEast, <span class="type">range</span>, <span class="keyword">block</span>);
}
</code></pre><p>è¿™ä¸ªå°±æ˜¯é€šè¿‡DFSè¿›è¡ŒèŠ‚ç‚¹çš„éå†ï¼Œä¸€æ—¦æœ‰è½åœ¨rangeå†…çš„æ•°æ®èŠ‚ç‚¹ï¼Œå°±è¿›è¡Œå›è°ƒã€‚</p>
<p><strong>ç»¼ä¸Šæ‰€è¿°ï¼Œå°±æ˜¯ä¸€ä¸ªåŸºæœ¬çš„å››å‰æ ‘ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ï¼Œåœ¨å››å‰æ ‘çš„æ„å»ºã€éå†ä¸­ï¼Œéƒ½ç”¨äº†æ ‘çš„é€’å½’ï¼Œä¹Ÿå°±æ˜¯ä¿—ç§°çš„DFSç®—æ³•ã€‚</strong></p>
<h4 id="TBCoordinateQuadTree">TBCoordinateQuadTree</h4><p>è¿™ä¸ªç±»å‘¢ï¼Œå’Œå®è´¨ä¸Šçš„å››å‰æ ‘æˆ–è€…æ€§èƒ½ä¼˜åŒ–å¹¶æ— å¤ªå¤§å…³ç³»ï¼Œåªæ˜¯ä¸€å±‚ç®€å•çš„å°è£…ï¼Œæˆ‘ä»¬å¤§è‡´æ¥äº†è§£ä¸€ä¸‹å°±å¥½ã€‚</p>
<pre><code><span class="keyword">TBBoundingBox </span><span class="keyword">TBBoundingBoxForMapRect(MKMapRect </span>mapRect)
{
    CLLocationCoordinate2D topLeft = MKCoordinateForMapPoint(mapRect.origin)<span class="comment">;</span>
    CLLocationCoordinate2D <span class="keyword">botRight </span>= MKCoordinateForMapPoint(MKMapPointMake(MKMapRectGetMaxX(mapRect), MKMapRectGetMaxY(mapRect)))<span class="comment">;</span>

    CLLocationDegrees minLat = <span class="keyword">botRight.latitude;
</span>    CLLocationDegrees maxLat = topLeft.latitude<span class="comment">;</span>

    CLLocationDegrees minLon = topLeft.longitude<span class="comment">;</span>
    CLLocationDegrees maxLon = <span class="keyword">botRight.longitude;
</span>
    return <span class="keyword">TBBoundingBoxMake(minLat, </span>minLon, maxLat, maxLon)<span class="comment">;</span>
}

<span class="label">MKMapRect</span> TBMapRectForBoundingBox(<span class="keyword">TBBoundingBox </span><span class="keyword">boundingBox)
</span>{
    MKMapPoint topLeft = MKMapPointForCoordinate(CLLocationCoordinate2DMake(<span class="keyword">boundingBox.x0, </span><span class="keyword">boundingBox.y0));
</span>    MKMapPoint <span class="keyword">botRight </span>= MKMapPointForCoordinate(CLLocationCoordinate2DMake(<span class="keyword">boundingBox.xf, </span><span class="keyword">boundingBox.yf));
</span>
    return MKMapRectMake(topLeft.x, <span class="keyword">botRight.y, </span>fabs(<span class="keyword">botRight.x </span>- topLeft.x), fabs(<span class="keyword">botRight.y </span>- topLeft.y))<span class="comment">;</span>
}
</code></pre><p>è¿™ä¸¤ä¸ªå‡½æ•°å°±æ˜¯MKMapRectå’Œæˆ‘ä»¬çš„BoundingBoxä¹‹é—´çš„è½¬æ¢ï¼Œéš¾åº¦å¾ˆå°ï¼Œä½†æ˜¯å¾ˆæœ‰æ„æ€å•Šã€‚ä»ä¸­æˆ‘ä»¬å¯ä»¥ä¸€çª¥MapViewçš„ä¸€äº›å®ç°ã€‚æ¯”å¦‚MapViewä¸ä»…ä»…æ˜¯ä¼ ç»Ÿçš„ContentViewå’ŒContainerViewï¼Œæ›´é‡è¦çš„å…¶åæ ‡ç³»å’Œä¼ ç»Ÿçš„CGRectä¹‹é—´çš„æ— æ³•æ¢ç®—ï¼Œ<strong>ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯ï¼Œåœ¨MapViewä¸­ï¼Œæ‰€æœ‰çš„ä¸œè¥¿éƒ½è¦æ‹¿ç»åº¦çº¬åº¦æ¥è°ˆã€‚</strong></p>
<pre><code>- (<span class="built_in">NSArray</span> *)clusteredAnnotationsWithinMapRect:(<span class="built_in">MKMapRect</span>)rect withZoomScale:(<span class="keyword">double</span>)zoomScale
{
     <span class="comment">// 1.</span>
    <span class="keyword">double</span> TBCellSize = TBCellSizeForZoomScale(zoomScale);
    <span class="keyword">double</span> scaleFactor = zoomScale / TBCellSize;

     <span class="comment">// 2.</span>
    <span class="built_in">NSInteger</span> minX = floor(<span class="built_in">MKMapRectGetMinX</span>(rect) * scaleFactor);
    <span class="built_in">NSInteger</span> maxX = floor(<span class="built_in">MKMapRectGetMaxX</span>(rect) * scaleFactor);
    <span class="built_in">NSInteger</span> minY = floor(<span class="built_in">MKMapRectGetMinY</span>(rect) * scaleFactor);
    <span class="built_in">NSInteger</span> maxY = floor(<span class="built_in">MKMapRectGetMaxY</span>(rect) * scaleFactor);

    <span class="built_in">NSMutableArray</span> *clusteredAnnotations = [[<span class="built_in">NSMutableArray</span> alloc] init];
    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> x = minX; x &lt;= maxX; x++) {
        <span class="keyword">for</span> (<span class="built_in">NSInteger</span> y = minY; y &lt;= maxY; y++) {
            <span class="built_in">MKMapRect</span> mapRect = <span class="built_in">MKMapRectMake</span>(x / scaleFactor, y / scaleFactor, <span class="number">1.0</span> / scaleFactor, <span class="number">1.0</span> / scaleFactor);

            __block <span class="keyword">double</span> totalX = <span class="number">0</span>;
            __block <span class="keyword">double</span> totalY = <span class="number">0</span>;
            __block <span class="keyword">int</span> count = <span class="number">0</span>;

            <span class="built_in">NSMutableArray</span> *names = [[<span class="built_in">NSMutableArray</span> alloc] init];
            <span class="built_in">NSMutableArray</span> *phoneNumbers = [[<span class="built_in">NSMutableArray</span> alloc] init];

              <span class="comment">// 3.</span>
            TBQuadTreeGatherDataInRange(<span class="keyword">self</span><span class="variable">.root</span>, TBBoundingBoxForMapRect(mapRect), ^(TBQuadTreeNodeData data) {
                totalX += data<span class="variable">.x</span>;
                totalY += data<span class="variable">.y</span>;
                count++;

                TBHotelInfo hotelInfo = *(TBHotelInfo *)data<span class="variable">.data</span>;
                [names addObject:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%s"</span>, hotelInfo<span class="variable">.hotelName</span>]];
                [phoneNumbers addObject:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%s"</span>, hotelInfo<span class="variable">.hotelPhoneNumber</span>]];
            });

              <span class="comment">// 4.</span>
            <span class="keyword">if</span> (count == <span class="number">1</span>) {
                CLLocationCoordinate2D coordinate = CLLocationCoordinate2DMake(totalX, totalY);
                TBClusterAnnotation *annotation = [[TBClusterAnnotation alloc] initWithCoordinate:coordinate count:count];
                annotation<span class="variable">.title</span> = [names lastObject];
                annotation<span class="variable">.subtitle</span> = [phoneNumbers lastObject];
                [clusteredAnnotations addObject:annotation];
            }

           <span class="comment">// 5.</span>
            <span class="keyword">if</span> (count &gt; <span class="number">1</span>) {
                CLLocationCoordinate2D coordinate = CLLocationCoordinate2DMake(totalX / count, totalY / count);
                TBClusterAnnotation *annotation = [[TBClusterAnnotation alloc] initWithCoordinate:coordinate count:count];
                [clusteredAnnotations addObject:annotation];
            }
        }
    }

    <span class="keyword">return</span> [<span class="built_in">NSArray</span> arrayWithArray:clusteredAnnotations];
}
</code></pre><p>è€Œä¸Šè¿°çš„æœ€åä¸€ä¸ªå‡½æ•°ï¼Œå°±æ˜¯æ ¹æ®ä¼ å…¥çš„MKMapRectï¼Œè¿”å›ç°‡ç±»æ•°ç»„çš„ã€‚</p>
<ul>
<li>1.é¦–å…ˆæ ¹æ®æ”¾ç¼©æ¯”ä¾‹ï¼Œæˆ–è€…Cellå¤§å°ã€‚</li>
<li>2.æ ¹æ®cellå¤§å°è®¡ç®—å½“å‰åœ°å›¾åŒºåŸŸçš„èŒƒå›´æ‰€å¯¹åº”çš„minX - maxXï¼ŒminY - maxYå¯¹åº”çš„ç½‘æ ¼ã€‚</li>
</ul>
<p>ä»€ä¹ˆæ˜¯ç½‘æ ¼ï¼Ÿå°±æ˜¯æ ¹æ®Cellå¤§å°å°†åœ°å›¾åˆ’åˆ†æˆäº†ä¸€å—å—åŒºåŸŸï¼Œé€šè¿‡minXï¼Œ maxX, minY - maxYæ‰¾åˆ°å¯¹åº”çš„ç½‘æ ¼ã€‚ç±»ä¼¼äºarray[1][2]æ‰¾åˆ°ç¬¬äºŒè¡Œç¬¬ä¸‰åˆ—çš„ç½‘æ ¼ï¼ˆä»0å¼€å§‹ç´¢å¼•ï¼‰ã€‚</p>
<ul>
<li>3.éå†æ¯ä¸€ä¸ªç½‘æ ¼ï¼Œè·å–å½“å‰ç½‘æ ¼å¯¹åº”çš„å››å‰æ ‘èŠ‚ç‚¹ä¸­çš„æ•°æ®ä¿¡æ¯ï¼Œå¹¶è®°å½•ä¸ªæ•°ã€‚</li>
<li>4.å¦‚æœä¸ªæ•°æ˜¯1ï¼Œé‚£ä¹ˆç›´æ¥æ˜¾ç¤ºï¼ŒåŒ…å«æ•°æ®èŠ‚ç‚¹çš„é™„åŠ ä¿¡æ¯ï¼Œæ¯”å¦‚åœ¨è¿™é‡Œå°±æ˜¯é…’åº—åç§°å’Œé…’åº—ç”µè¯ã€‚</li>
<li>5.å¦‚æœä¸ªæ•°å¤§äº1çš„è¯ï¼Œåˆ©ç”¨å‡å€¼è®¡ç®—ä¸­å¿ƒç‚¹ï¼Œä¸­å¿ƒç‚¹æ˜¯æ‰€æœ‰åŒ…å«çš„æ•°æ®èŠ‚ç‚¹å¹³å‡å€¼ï¼ŒåŒæ—¶ä¿¡æ¯åªç®€å•çš„æ˜¾ç¤ºä¸ªæ•°ã€‚</li>
</ul>
<p>è‡³æ­¤ï¼Œæ•´ä¸ªä»£ç å°±è§£è¯»å®Œæ•´å•¦ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/12/11/TBAnnotationClustering/" data-id="cjqdxq1yk001gmxi16v3on9tg" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/12/11/TBAnnotationClustering/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-FDFullScreenPopGesture-Source-Code" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/26/FDFullScreenPopGesture-Source-Code/" class="article-date">
  <time datetime="2015-11-26T03:38:42.000Z" itemprop="datePublished">2015-11-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/26/FDFullScreenPopGesture-Source-Code/">FDFullScreenPopGestureæºç è§£æ</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><em>å˜¿å˜¿ï¼ŒèŠ±äº†ä¸‰å¤©æ—¶é—´æŠŠè‡ªå·±çš„ä»£ç ä»700è¡Œç¼©å‡æˆäº†200è¡Œï¼Œç»ˆäºæœ‰æ—¶é—´å¯ä»¥æ‹œè¯»æ–°æºç äº†ï¼Œå¥½å¼€å¿ƒã€‚</em></p>
<p>å¥½äº†ï¼ŒåºŸè¯ä¸å¤šè¯ï¼Œä»Šå¤©æˆ‘ä»¬è¦è¯»äº†ç™¾åº¦å‡ºå“çš„ä¸€ä¸ªå¼€æºé¡¹ç›®FDFullScreenPopGestureã€‚</p>
<h2 id="é¡¹ç›®ä»‹ç»">é¡¹ç›®ä»‹ç»</h2><p><a href="https://github.com/forkingdog/FDFullscreenPopGesture" target="_blank" rel="external">FDFullScreenPopGesture</a>æ˜¯ä¸€æ¬¾æ— éœ€æ”¹åŠ¨å³å¯æ•´åˆè¿›å…¥ç°æœ‰é¡¹ç›®çš„å…¨å±€æ‰‹åŠ¿æ“ä½œï¼Œä½¿ç”¨è¿™ä¸ªå³å¯ä»¥åœ¨å·¦ä¾§è¾¹ç¼˜æ‹–æ‹½çš„æ—¶å€™è¿”å›ä¸Šä¸€çº§çš„æ•ˆæœã€‚</p>
<p>çœ‹åˆ°è¿™ï¼Œæœ‰äººä¼šé—®ï¼Œæˆ‘ä»¬è¿™ä¸ªç›´æ¥ç”¨UIPanGestureRecognizerä¸ä¹Ÿèƒ½è¾¾åˆ°å—ï¼Ÿ<br>æ²¡é”™ï¼Œä»…ä»…æ˜¯è¿”å›ä¸Šä¸€çº§è¿™ä¸ªéœ€æ±‚ç¡®å®å¾ˆç®€å•ã€‚ä½†æ˜¯iOS7ä¸Šè¿”å›ä¸Šä¸€çº§æ—¶å€™ï¼ŒUINavigationBarçš„åˆ‡æ¢æ•ˆæœä½ èƒ½å®ç°å—ï¼Ÿ</p>
<p>è€Œä¸”ï¼Œæˆ‘è¦è¯´çš„é‡ç‚¹æ˜¯<strong>FDFullscreenPopGesture</strong>å®ç°æ€è·¯å¾ˆèµï¼ï¼ï¼</p>
<h2 id="æºç åˆ†æ">æºç åˆ†æ</h2><h3 id="ç»“æ„åˆ†æ">ç»“æ„åˆ†æ</h3><p>æ•´ä¸ªFDFullscreenPopGestureå…¶å®å¯ä»¥ä¸»è¦æ‹†åˆ†æˆä¸‰å—ï¼š</p>
<pre><code>-<span class="ruby">- _FDFullscreenPopGestureRecognizerDelegate
</span>-<span class="ruby">- <span class="constant">UIViewController</span> (<span class="constant">FDFullscreenPopGesturePrivate</span>)
</span>-<span class="ruby">- <span class="constant">UINavigationController</span> (<span class="constant">FDFullscreenPopGesture</span>)</span>
</code></pre><ul>
<li><p>_FDFullscreenPopGestureRecognizerDelegateè™½ç„¶åå­—çœ‹èµ·æ¥åƒä¸€ä¸ªProtocolï¼Œä½†æ˜¯å®ƒå®è´¨ä¸Šæ˜¯ä¸€ä¸ª<strong>NSObject</strong>å­ç±»ï¼ŒåŒæ—¶å®ç°äº†<strong>UIGestureRecognizerDelegate</strong>ã€‚è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰ç»å†è¿‡ViewControlleré‡æ„ï¼Œä»¥å‰å¾ˆå¤šæ—¶å€™ï¼Œæ¯”å¦‚æˆ‘ä»¬å†™UIScrollViewï¼ŒUITableViewï¼Œä»–ä»¬çš„Delegateï¼ŒDataSourceéƒ½è€¦åˆè¿›äº†ViewControllerï¼Œå¸¸å¸¸å¯¼è‡´MassViewControllerç¾éš¾çš„å‘ç”Ÿã€‚<strong>å•ç‹¬æ„å»ºä¸€ä¸ªä¸“é—¨è´Ÿè´£çš„Delgeateâ€œå¤„ç†å™¨â€æ˜¯éå¸¸æœ‰æ•ˆçš„æ‰‹æ®µ</strong></p>
</li>
<li><p>UIViewController (FDFullscreenPopGesturePrivate)æ˜¯ä¸€ä¸ªCategoryï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªåˆ†ç±»é‡Œé¢ä¸»è¦è¿›è¡Œ<strong>viewWillAppear</strong>çš„Hookï¼Œå…·ä½“åšä»€ä¹ˆï¼Œåé¢ç« èŠ‚æˆ‘ä»¬ç»†ç»†é“æ¥ã€‚</p>
</li>
<li><p>UINavigationController (FDFullscreenPopGesture)ä¹Ÿæ˜¯ä¸€ä¸ªåˆ†ç±»ï¼Œæ˜¯è¿›è¡Œ<strong>pushViewController:animated:</strong>æ–¹æ³•çš„hookï¼Œå®ç°éƒ¨åˆ†æˆ‘ä»¬åç»­å†çœ‹ã€‚</p>
</li>
</ul>
<h3 id="æºç åˆ†æ-1">æºç åˆ†æ</h3><h4 id="_FDFullscreenPopGestureRecognizerDelegate">_FDFullscreenPopGestureRecognizerDelegate</h4><pre><code>- (<span class="built_in">BOOL</span>)gestureRecognizerShouldBegin:(<span class="built_in">UIPanGestureRecognizer</span> *)gestureRecognizer
{
    <span class="comment">// 1.</span>
    <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.navigationController</span><span class="variable">.viewControllers</span><span class="variable">.count</span> &lt;= <span class="number">1</span>) {
        <span class="keyword">return</span> <span class="literal">NO</span>;
    }

    <span class="comment">// 2.</span>
    <span class="built_in">UIViewController</span> *topViewController = <span class="keyword">self</span><span class="variable">.navigationController</span><span class="variable">.viewControllers</span><span class="variable">.lastObject</span>;
    <span class="keyword">if</span> (topViewController<span class="variable">.fd_interactivePopDisabled</span>) {
        <span class="keyword">return</span> <span class="literal">NO</span>;
    }

    <span class="comment">// 3. </span>
    <span class="built_in">CGPoint</span> beginningLocation = [gestureRecognizer locationInView:gestureRecognizer<span class="variable">.view</span>];
    <span class="built_in">CGFloat</span> maxAllowedInitialDistance = topViewController<span class="variable">.fd_interactivePopMaxAllowedInitialDistanceToLeftEdge</span>;
    <span class="keyword">if</span> (maxAllowedInitialDistance &gt; <span class="number">0</span> &amp;&amp; beginningLocation<span class="variable">.x</span> &gt; maxAllowedInitialDistance) {
        <span class="keyword">return</span> <span class="literal">NO</span>;
    }

    <span class="comment">// 4.</span>
    <span class="keyword">if</span> ([[<span class="keyword">self</span><span class="variable">.navigationController</span> valueForKey:<span class="string">@"_isTransitioning"</span>] boolValue]) {
        <span class="keyword">return</span> <span class="literal">NO</span>;
    }

    <span class="comment">// 5.</span>
    <span class="built_in">CGPoint</span> translation = [gestureRecognizer translationInView:gestureRecognizer<span class="variable">.view</span>];
    <span class="keyword">if</span> (translation<span class="variable">.x</span> &lt;= <span class="number">0</span>) {
        <span class="keyword">return</span> <span class="literal">NO</span>;
    }

    <span class="keyword">return</span> <span class="literal">YES</span>;
}
</code></pre><p>æ•´ä¸ªç±»ç‰¹åˆ«ç²¾ç®€ï¼Œå®ƒçš„èŒè´£å°±æ˜¯ç»´æŠ¤ä¸€ä¸ªUINavigationControllerç„¶åæ ¹æ®ä¸€ç³»åˆ—çš„çŠ¶æ€åˆ¤æ–­è¯¥æ‰‹åŠ¿æ˜¯å¦ç”Ÿæ•ˆã€‚è¿™äº›çŠ¶æ€åŒ…æ‹¬</p>
<ol>
<li>å½“å‰UINavigationControllerçš„æ ˆæ˜¯å¦åªå‰©æœ€åä¸€ä¸ªViewControlleräº†</li>
<li>å½“å‰å³å°†å‡ºæ ˆçš„topViewControlleræ˜¯å¦ç¦ç”¨äº†<strong>fd_interactivePopDisabled</strong>ï¼Œè¯¥å˜é‡æˆ‘ä»¬ç¨åä¼šè¯´</li>
<li>å½“å‰æ‰‹åŠ¿çš„å¯åŠ¨ç‚¹æ˜¯ä¸æ˜¯ç¦»å·¦ä¾§è¾¹ç¼˜å¤ªè¿œäº†ï¼Œæ¯•ç«Ÿæˆ‘ä»¬æ˜¯è¦æ¨¡æ‹ŸiOSåŸç”Ÿçš„æ‰‹åŠ¿æ“ä½œï¼ŒåŸç”Ÿçš„ä¸æ”¯æŒå…¨å±ï¼Œæˆ‘ä»¬ä¸ºå•¥è¦æ”¯æŒï¼</li>
<li>å½“å‰æ˜¯å¦å·²ç»å¤„åœ¨è½¬åœºè¿‡ç¨‹ä¸­ã€‚åœ¨è¿™é‡Œï¼Œå¯ä»¥çœ‹åˆ°å®ƒä½¿ç”¨äº†valueForKeyè¿™ä¸€<strong>Key-Value-Coding</strong>æŠ€æœ¯ï¼Œå®ƒå¯ä»¥è®¿é—®ç§æœ‰å˜é‡<strong>_isTransitioning</strong>å“¦ï¼</li>
<li>æ–¹å‘ç›¸åçš„æ»‘åŠ¨æ»šç²—ã€‚</li>
</ol>
<h4 id="UIViewController_(FDFullscreenPopGesturePrivate)">UIViewController (FDFullscreenPopGesturePrivate)</h4><p>æ•´ä¸ªè¿™ä¸ªç±»ä¹Ÿéå¸¸ç®€å•ï¼Œå°±æ˜¯é€šè¿‡ <strong>fd_viewWillAppear</strong> hookäº† <strong>viewWillAppear</strong> è¿™ä¸ªæ–¹æ³•ï¼Œç„¶åæ’å…¥äº†è‡ªå·±ä¸€æ®µå›è°ƒçš„blockã€‚</p>
<pre><code>- (<span class="keyword">void</span>)fd_viewWillAppear:(<span class="built_in">BOOL</span>)animated
{
    <span class="comment">// Forward to primary implementation.</span>
    [<span class="keyword">self</span> fd_viewWillAppear:animated];

    <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.fd_willAppearInjectBlock</span>) {
        <span class="keyword">self</span><span class="variable">.fd_willAppearInjectBlock</span>(<span class="keyword">self</span>, animated);
    }
}
</code></pre><h4 id="UINavigationController_(FDFullscreenPopGesture)">UINavigationController (FDFullscreenPopGesture)</h4><p>è¿™ä¸ªåˆ†ç±»æ˜¯æ•´ä¸ªé¡¹ç›®çš„é€»è¾‘æ§åˆ¶æ ¸å¿ƒã€‚å®ƒå¹²äº†è¿™ä¹ˆå‡ ä»¶äº‹ï¼š</p>
<ul>
<li>ç”¨ <strong>fd_pushViewController:animated:</strong> hook <strong>pushViewController:animated:</strong></li>
<li><strong>ç¦ç”¨</strong>UINavgationControllerçš„<strong>interactivePopGestureRecognizer</strong></li>
<li>æ„å»ºäº†å±äºè‡ªå·±UIPanGestureRecognizeræ›¿æ¢interactivePopGestureRecognizerï¼ŒåŒæ—¶æŠŠæ‰‹åŠ¿çš„delegateèµ‹å€¼ç»™äº†_FDFullscreenPopGestureRecognizerDelegate</li>
</ul>
<p>å®ƒçš„ä¸»è¦æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>- (<span class="keyword">void</span>)fd_pushViewController:(<span class="built_in">UIViewController</span> *)viewController animated:(<span class="built_in">BOOL</span>)animated
{
    <span class="keyword">if</span> (![<span class="keyword">self</span><span class="variable">.interactivePopGestureRecognizer</span><span class="variable">.view</span><span class="variable">.gestureRecognizers</span> containsObject:<span class="keyword">self</span><span class="variable">.fd_fullscreenPopGestureRecognizer</span>]) {

        <span class="comment">// 1.</span>
        [<span class="keyword">self</span><span class="variable">.interactivePopGestureRecognizer</span><span class="variable">.view</span> addGestureRecognizer:<span class="keyword">self</span><span class="variable">.fd_fullscreenPopGestureRecognizer</span>];

        <span class="comment">// 2.</span>
        <span class="built_in">NSArray</span> *internalTargets = [<span class="keyword">self</span><span class="variable">.interactivePopGestureRecognizer</span> valueForKey:<span class="string">@"targets"</span>];
        <span class="keyword">id</span> internalTarget = [internalTargets<span class="variable">.firstObject</span> valueForKey:<span class="string">@"target"</span>];
        SEL internalAction = <span class="built_in">NSSelectorFromString</span>(<span class="string">@"handleNavigationTransition:"</span>);
        <span class="keyword">self</span><span class="variable">.fd_fullscreenPopGestureRecognizer</span><span class="variable">.delegate</span> = <span class="keyword">self</span><span class="variable">.fd_popGestureRecognizerDelegate</span>;
        [<span class="keyword">self</span><span class="variable">.fd_fullscreenPopGestureRecognizer</span> addTarget:internalTarget action:internalAction];

        <span class="comment">// 3.</span>
        <span class="keyword">self</span><span class="variable">.interactivePopGestureRecognizer</span><span class="variable">.enabled</span> = <span class="literal">NO</span>;
    }

    <span class="comment">// 4.</span>
    [<span class="keyword">self</span> fd_setupViewControllerBasedNavigationBarAppearanceIfNeeded:viewController];

    <span class="comment">// Forward to primary implementation.</span>
    <span class="keyword">if</span> (![<span class="keyword">self</span><span class="variable">.viewControllers</span> containsObject:viewController]) {
        [<span class="keyword">self</span> fd_pushViewController:viewController animated:animated];
    }
}
</code></pre><p>æ•´ä½“æ¥çœ‹è¿™æ®µæºç ï¼Œæ— éåšäº†å¦‚ä¸‹è¿™äº›äº‹ï¼š</p>
<ol>
<li>å°†UIPanGestureRecognizeræ·»åŠ åˆ°æœ¬æ¥interactivePopGestureRecognizeræ‰€åœ¨çš„viewä¸Š</li>
<li><div style="color:red"><strong>è¿™æ®µæ˜¯é‡ç‚¹çš„é‡ç‚¹</strong>ï¼Œä¸€å®šè¦å¾€ä¸‹çœ‹ï¼ï¼ï¼</div><br>å°†PanGestureçš„targetè®¾ç½®ä¸º<strong>internalTarget</strong>ï¼Œactionè®¾ç½®ä¸º<br><strong>handleNavigationTransition</strong>.</li>
<li>ç¦ç”¨interactivePopGestureRecognizer</li>
<li><p>æ ¹æ®æ˜¯å¦éœ€è¦éšè—UINavigationBaræ¥è°ƒç”¨fd_setupViewControllerBasedNavigationBarAppearanceIfNeeded:viewControllerè¿›è¡Œä¹‹å‰æåˆ°è¿‡çš„<strong>fdwillAppearInjectBlock</strong>è®¾ç½®ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>- (void)fd_setupViewControllerBasedNavigationBarAppearanceIfNeeded:(UIViewController *)appearingViewController
{
    <span class="preprocessor">if</span> (!<span class="keyword">self.fd_viewControllerBasedNavigationBarAppearanceEnabled) </span>{
        return<span class="comment">;</span>
    }

    __weak typeof(<span class="keyword">self) </span>weakSelf = <span class="keyword">self;
</span>    _FDViewControllerWillAppearInjectBlock <span class="keyword">block </span>= ^(UIViewController *viewController, <span class="keyword">BOOL </span>animated) {
        __strong typeof(weakSelf) <span class="keyword">strongSelf </span>= weakSelf<span class="comment">;</span>
        <span class="preprocessor">if</span> (<span class="keyword">strongSelf) </span>{
            [<span class="keyword">strongSelf </span>setNavigationBarHidden:viewController.fd_prefersNavigationBarHidden animated:animated]<span class="comment">;</span>
        }
    }<span class="comment">;</span>

    // Setup will appear inject <span class="keyword">block </span>to appearing view controller.
    // Setup disappearing view controller as well, <span class="keyword">because </span>not every view controller is <span class="keyword">added </span>into
    // stack <span class="keyword">by </span><span class="keyword">pushing, </span>maybe <span class="keyword">by </span><span class="string">"-setViewControllers:"</span>.
    appearingViewController.fd_willAppearInjectBlock = <span class="keyword">block;
</span>    UIViewController *disappearingViewController = <span class="keyword">self.viewControllers.lastObject;
</span>    <span class="preprocessor">if</span> (disappearingViewController &amp;&amp; !disappearingViewController.fd_willAppearInjectBlock) {
        disappearingViewController.fd_willAppearInjectBlock = <span class="keyword">block;
</span>    }
}
</code></pre></li>
</ol>
<p>è¿™æ®µä»£ç å°±æ˜¯å°†å³å°†æ¶ˆå¤±å’Œå±•ç°çš„ViewControlleråœ¨viewWillAppearè®¾ç½®äº†ä¸€ä¸ªè‡ªå®šä¹‰UINavigationBarçš„å›è°ƒï¼Œç”¨ä»¥æ ¹æ®è¿›å…¥çš„æ–¹å¼æ¥å±•ç°NaviagtionBarï¼Œè€Œä¸ä¼šå‡ºç°çªå…€çš„â€œé•‚ç©ºâ€ã€‚</p>
<p>åˆ°è¿™ï¼Œæºç å°±ç»“æŸäº†ï¼Œå¯ä»¥å›å®¶æ”¶è¡£æœå–½ï¼</p>
<h3 id="é‡ç‚¹">é‡ç‚¹</h3><p>æºç æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿæœ‰ä»€ä¹ˆå¥½åˆ†æçš„å‘¢ï¼Ÿ<br>å¦‚æœä½ è¯»åˆ°è¿™ï¼Œå“ˆå“ˆï¼Œæ­å–œå•¦ï¼Œé‡ç‚¹åˆ†ææ¥å•¦ã€‚</p>
<p>é¦–å…ˆæ„Ÿè°¢@J_é›¨çš„å¤©æ‰æ€è·¯ï¼Œå¤§å®¶å¯ä»¥é˜…è¯»<a href="http://www.jianshu.com/p/d39f7d22db6c" target="_blank" rel="external">è½»æ¾å­¦ä¹ ä¹‹äºŒâ€”â€”iOSåˆ©ç”¨Runtimeè‡ªå®šä¹‰æ§åˆ¶å™¨POPæ‰‹åŠ¿åŠ¨ç”»</a>è¿™ç¯‡æ–‡ç« ï¼ŒçœŸçš„å¾ˆèµ</p>
<p>ä¹‹å‰æˆ‘ä»¬åœ¨ä¸Šæ–‡ç”¨çº¢è‰²æ ‡æ³¨äº†ä¸€æ®µå†…å®¹ï¼š</p>
<div style="color:red"><br>å°†PanGestureçš„targetè®¾ç½®ä¸º<strong>internalTarget</strong>ï¼Œactionè®¾ç½®ä¸º<br><strong>handleNavigationTransition</strong>ã€‚</div>

<p>çœ‹èµ·æ¥å¾ˆå®¹æ˜“ç†è§£ï¼Œå¯æ˜¯å¤§å®¶æœ‰æ²¡æœ‰æƒ³è¿‡ä¸ºä»€ä¹ˆactionçš„åç§°æ˜¯handleNavigationTransitionå‘¢ï¼Ÿ</p>
<p>é¦–å…ˆæˆ‘ä»¬å…ˆæ‰“å°çœ‹çœ‹NavigationControllerçš„interactivePopGestureRecognizerç©¶ç«Ÿæ˜¯ä¸ªä»€ä¹ˆç©æ„ï¼Ÿ</p>
<pre><code>&lt;<span class="built_in">UIScreenEdgePanGestureRecognizer</span>: <span class="number">0x7fea78ec5950</span>; state = Possible; delaysTouchesBegan = <span class="literal">YES</span>; view = &lt;<span class="built_in">UILayoutContainerView</span> <span class="number">0x7fea78f77960</span>&gt;; target= &lt;(action=handleNavigationTransition:, target=&lt;_<span class="built_in">UINavigationInteractiveTransition</span> <span class="number">0x7fea78c1c640</span>&gt;)&gt;
</code></pre><p>è¿™æ˜¯ä»€ä¹ˆç©æ„ï¼Ÿè®©æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹çœ‹å®ƒç­”åº”å‡ºæ¥çš„è¿™äº›å±æ€§ã€‚</p>
<ol>
<li>state = Possibleï¼Œå¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªUIGestureRecognizerState = UIGestureRecognizerStatePossibleã€‚</li>
<li>view = UILayoutContainerViewï¼Œä¸å¤ªæ‡‚ï¼Œæš‚æ—¶ä¹Ÿæ²¡è§‰å¾—æœ‰éœ€è¦ï¼Œä¸ç®¡ä»–ã€‚</li>
<li>target =&lt;(action=handleNavigationTransition:, target=<_uinavigationinteractivetransition 0x7fea78c1c640="">)ï¼Œè¿™ä¸ªçœ‹èµ·æ¥å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºæˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒGestureå°±æ˜¯é€šè¿‡<strong>Target-Action</strong>çš„æ–¹å¼è¿›è¡ŒåŠ¨ä½œè§¦å‘çš„ã€‚</_uinavigationinteractivetransition></li>
</ol>
<p>æ‰€ä»¥æˆ‘ä»¬èµ¶ç´§çœ‹çœ‹è¿™ä¸ª<strong>target</strong>æ˜¯ä¸ªå•¥ç©æ„ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š</p>
<pre><code><span class="collection">[self.navigationController.interactivePopGestureRecognizer valueForKey:@<span class="string">"target"</span>]</span><span class="comment">;</span>
</code></pre><p>å§æ§½ï¼Œä¸€è¿è¡Œï¼ŒCrashäº†ï¼ŒæŠ¥æ‰¾ä¸åˆ°è¿™ä¸ªKeyã€‚å’‹å›äº‹ï¼Œéš¾é“æˆ‘è®°é”™äº†KVCçš„ç”¨æˆ·ï¼Œèµ¶ç´§æ¢æˆvalueForKey:@â€Viewâ€è¯•è¯•ã€‚</p>
<p>å“ï¼æ²¡é”™å•Šï¼æˆåŠŸå¾—åˆ°äº†å¦‚ä¸‹è¾“å‡ºï¼š</p>
<pre><code>-<span class="string">[UILayoutContainerView objectAtIndexedSubscript:]</span>
</code></pre><p>é‚£å’‹å›äº‹ï¼Œçœ‹æ¥å¿…é¡»ç¥­å‡ºå± é¾™åˆ€Runtimeäº†ï¼Œå˜¿å˜¿ï¼ŒObjective-Cé¢å‰ï¼Œä¸€åˆ‡ç§æœ‰å˜é‡éƒ½æ˜¯çº¸è€è™ã€‚</p>
<pre><code><span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;
Ivar *var = class_copyIvarList([UIGestureRecognizer <span class="keyword">class</span>], &amp;count);
<span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) {
     Ivar _var = *(var + i);
     NSLog(@<span class="string">"%s"</span>, ivar_getTypeEncoding(_var));
     NSLog(@<span class="string">"%s"</span>, ivar_getName(_var));
}
</code></pre><p>è¾“å‡ºå¤ªé•¿äº†ï¼Œæˆ‘ä»¬æ‰¾æˆ‘ä»¬æƒ³çœ‹çš„ï¼Œ</p>
<pre><code><span class="number">2015</span>-<span class="number">11</span>-<span class="number">27</span> <span class="number">02</span>:<span class="number">10</span>:<span class="number">03.873</span> SamplePhotosApp[<span class="number">85305</span>:<span class="number">2664323</span>] _targets
<span class="number">2015</span>-<span class="number">11</span>-<span class="number">27</span> <span class="number">02</span>:<span class="number">10</span>:<span class="number">03.873</span> SamplePhotosApp[<span class="number">85305</span>:<span class="number">2664323</span>] @<span class="string">"NSMutableArray"</span>
</code></pre><p>å§æ§½ï¼Œè¿™ä¸«å«_targetsï¼Œå¥½å§ï¼Œèµ¶ç´§æ”¹æˆvalueForKey:@â€targetsâ€å†è¯•è¯•ã€‚<br>å“ï¼Œç­‰ç­‰ï¼Œä¸æ˜¯_targetså—ï¼Œæ€ä¹ˆèƒ½ç”¨targetså‘¢ï¼Ÿ</p>
<p><strong>å’³å’³ï¼Œå´è€å¸ˆåˆè¦æ¥è®²è¯¾äº†ï¼å¯¹äºKVCæ¥è¯´ï¼Œå®ƒçš„æŸ¥æ‰¾é¡ºåºæ˜¯key -&gt; property -&gt; ivarï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä¼šå…ˆæŒ‰ç…§æ˜¯å¦æœ‰targetsè¿™ä¸ªåç§°çš„keyï¼Œç„¶åtargetsè¿™ä¸ªpropertyï¼Œæœ€åå†æ‰¾_targetsè¿™ä¸ªivarã€‚</strong></p>
<p>é€šè¿‡è¾“å‡ºlogï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°_targetsæ˜¯ä¸ªæ•°ç»„ï¼Œç»´æŠ¤äº†ä¸€ä¸ªä¸ªè‡ªå®šä¹‰ç»“æ„ç»´æŠ¤çš„target-actioné…å¯¹ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬ç°åœ¨åªè¦æ‰¾åˆ°è¿™ä¸ªè‡ªå®šä¹‰ç»“æ„æ˜¯å•¥ï¼Œé‡Œé¢åŒ…å«äº†å•¥å°±å¯ä»¥äº†æ˜¯å§ã€‚</p>
<p><strong>å½“å¤´ä¸€æ£’</strong>ï¼Œå¾ˆé—æ†¾ï¼Œè‹¹æœå¤ªé˜´äº†ï¼Œç›´æ¥é‡è½½äº†è¿™ä¸ªè‡ªå®šä¹‰ç»“æ„çš„debugDescriptionï¼Œç‰¹å–µçš„ä»€ä¹ˆéƒ½çœ‹ä¸åˆ°ã€‚</p>
<p>äº‹æƒ…åˆ°äº†è¿™å’‹åŠå‘¢ï¼Ÿå…¶å®æˆ‘ä¹Ÿæ²¡æƒ³åˆ°ï¼Œè¿˜å¥½ä¸Šè¿°çš„å‚è€ƒæ–‡ç« å‘Šè¯‰äº†æˆ‘ä»¬å¯ä»¥ä¾é æ–­ç‚¹ï¼Œé€šè¿‡æ–­ç‚¹ï¼Œæˆ‘ä»¬å‘å‘ç°äº†è¯¥è‡ªå®šä¹‰ç»“æ„å«<strong>UIGestureRecognizerTarget</strong>ï¼Œæˆ‘ä»¬é€šè¿‡KVCè·å–å…¶targetå’Œactionå³å¯ã€‚</p>
<h3 id="è¡¥å……ï¼šå…³äºMethod_Swizzling">è¡¥å……ï¼šå…³äºMethod Swizzling</h3><pre><code><span class="keyword">Class</span> <span class="keyword">class</span> = [<span class="keyword">self</span> <span class="keyword">class</span>];

SEL originalSelector = @<span class="keyword">selector</span>(pushViewController:animated:);
SEL swizzledSelector = @<span class="keyword">selector</span>(fd_pushViewController:animated:);

<span class="function"><span class="keyword">Method</span> <span class="title">originalMethod</span> = <span class="title">class_getInstanceMethod</span><span class="params">(<span class="keyword">class</span>, originalSelector)</span>;</span>
<span class="function"><span class="keyword">Method</span> <span class="title">swizzledMethod</span> = <span class="title">class_getInstanceMethod</span><span class="params">(<span class="keyword">class</span>, swizzledSelector)</span>;</span>

BOOL success = class_addMethod(<span class="keyword">class</span>, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod));
<span class="keyword">if</span> (success) <span class="comment">{
    class_replaceMethod(class, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod));
}</span> <span class="keyword">else</span> <span class="comment">{
    method_exchangeImplementations(originalMethod, swizzledMethod);
}</span>
</code></pre><p>æœ‰å¾ˆå¤šäººéƒ½äº†è§£Method Swizzlingï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿™é‡Œéœ€è¦è¿›è¡Œ<strong>BOOL success = class_addMethod</strong>åˆ¤æ–­ã€‚</p>
<p>å…¶ä¸»è¦åŸå› å°±æ˜¯å¦‚æœç›´æ¥é€šè¿‡method_exchangeImplementationsæ¥è¿›è¡Œçš„è¯ï¼Œå¯èƒ½å­ç±»é‡Œå¹¶æ²¡æœ‰originalSelectoræ‰€ä»£è¡¨çš„æ–¹æ³•ï¼Œä½ ç›´æ¥å’Œçˆ¶ç±»è¿›è¡Œäº†äº¤æ¢ï¼Œè¿™æ˜¯æˆ‘ä»¬ä¸å¸Œæœ›çœ‹åˆ°çš„ã€‚</p>
<p>å› æ­¤é€šè¿‡addMethodæ¥åˆ¤æ–­ï¼Œå¦‚æœåŠ æˆåŠŸäº†ï¼Œè¯´æ˜åŸå…ˆè¿™ä¸ªå‡½æ•°åœ¨å­ç±»ä¸­å¹¶ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬ç°åœ¨æ·»åŠ äº†ï¼Œåªè¦å†æŠŠswizzleSelectoræŒ‡å‘æ—§å‡½æ•°å³å¯ï¼›è€Œå¦‚æœæ²¡æˆåŠŸï¼Œè¯´æ˜è¿™ä¸ªå‡½æ•°åœ¨å­ç±»ä¸­å­˜åœ¨äº†ï¼Œæˆ‘ä»¬ç›´æ¥æ›¿æ¢ä¹Ÿä¸ä¼šå½±å“çˆ¶ç±»ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/11/26/FDFullScreenPopGesture-Source-Code/" data-id="cjqdxq21g0032mxi1m0xf3jka" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/11/26/FDFullScreenPopGesture-Source-Code/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-Fun-of-CAReplicationLayer" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/17/Fun-of-CAReplicationLayer/" class="article-date">
  <time datetime="2015-11-16T17:54:05.000Z" itemprop="datePublished">2015-11-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/17/Fun-of-CAReplicationLayer/">Swiftæ¯æ—¥ä¸€ç»ƒï¼šå¦™ç”¨CAReplicationLayer</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ä»Šå¤©æˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸‹ä¸€ä¸ªåœ¨iOSå¸¸å¸¸è¢«å¿½è§†çš„ç±» - CAReplicationLayerã€‚æˆ‘ä»¬è¦ä½¿ç”¨è¿™ä¸ªç±»æ¥å®Œæˆä¸¤ä¸ªå¼€èµ·æ¥å¾ˆç‚«é…·çš„åŠ è½½æ•ˆæœã€‚</p>
<p>è€æ ·å­ï¼Œå…ˆä¸Šå…·ä½“çš„æ•ˆæœä¸€çœ‹<br><img src="http://7lrzqz.com1.z0.glb.clouddn.com/LearnCAReplicationLayer.gif"></p>
<p>æ€ä¹ˆæ ·ï¼Œæ•ˆæœè¿˜ä¸é”™å§ã€‚ä¸€ä¸ªæ˜¯çœ‹èµ·æ¥æœ‰æ¸å˜æ•ˆæœçš„åœ†å½¢åŠ è½½ï¼Œå¦å¤–ä¸€ä¸ªåˆ™æ˜¯æ¨¡ä»¿Apple Musicçš„æŸ±çŠ¶å›¾åŠ è½½ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œå°±è®©æˆ‘ä»¬ä¸€èµ·æ­å¼€å®ç°çš„é¢çº±å§ï¼</p>
<h3 id="CAReplicationLayer">CAReplicationLayer</h3><p>CAReplicationLayeræ˜¯CALayerçš„å­ç±»ï¼Œå®ƒä¸ä¼ ç»Ÿçš„CALayerç³»åˆ—ä¸åŒï¼Œå®ƒåŸºæœ¬ä¸ç›´æ¥æ‰¿æ‹…è¯¸å¤šæ•ˆæœï¼Œè€Œæ˜¯æ›´å¤šçš„æ‰¿æ‹…ä¸€ç§â€œå®¹å™¨â€çš„èŒè´£ã€‚</p>
<p>æ€ä¹ˆç†è§£å‘¢ï¼Ÿå¤§å®¶å¯ä»¥æŠŠCAReplicationLayerçœ‹æˆä¸€ä¸ªå·¥å‚ï¼Œä½ æä¾›ç»™ä»–ä¸€ä¸ªäº§å“çš„æ¨¡å‹ï¼Œå®ƒå°±å¯ä»¥ä¸ºäº†æºæºä¸æ–­çš„å¤åˆ¶å‡ºçººç»‡å“ã€‚å›åˆ°iOSä¸­æ¥è¯´å°±æ˜¯ï¼Œä½ æä¾›ä¸€ä¸ªCALayerç»™CAReplicationLayerï¼Œå¹¶å‘Šè¯‰å®ƒä½ å¸Œæœ›å®ƒå¤åˆ¶å‡ ä»½ï¼Œå°±æ‰“é€ å‡ºå¤šä¸ªå…·æœ‰æ•ˆæœæ ·å¼çš„Layerã€‚<strong>ä¸ä»…å¦‚æ­¤ï¼ŒåŠ¨ç”»æ•ˆæœä¹Ÿä¼šè¢«ä¸€åŒå¤åˆ¶</strong></p>
<p>å› æ­¤ï¼Œå¯¹äºCAReplicationLayerï¼Œæˆ‘ä»¬æœ‰å‡ ä¸ªç‰¹åˆ«éœ€è¦å…³æ³¨çš„å‚æ•°ã€‚</p>
<ul>
<li>instanceCountï¼š ä»£è¡¨ä½ å¸Œæœ›å°†ä½ æä¾›å®ƒçš„Layerå¤åˆ¶å‡ ä»½</li>
<li>instanceDelayï¼š è¿™ä¸ªå‚æ•°åœ¨ç¼–å†™åŠ¨ç”»çš„å‰æä¸‹ç‰¹åˆ«æœ‰ç”¨ï¼Œå®ƒè¡¨æ˜å¯¹æ¯ä¸€ä¸ªå¤åˆ¶(æˆ–è€…åŸç”Ÿ)å‡ºæ¥çš„Layerï¼Œå¯åŠ¨åŠ¨ç”»ä¹‹é—´çš„æ—¶é—´å·®åœ¨å¤šå°‘ã€‚</li>
<li>instanceTransformï¼š è¿™ä¸ªå‚æ•°è¡¨ç¤ºå¯¹äºæ¯ä¸€ä¸ªLayerï¼Œå®ƒä»¬ä¹‹é—´çš„<strong>å½¢å˜</strong>å·®è·æ˜¯å¤šå°‘ã€‚æ¯”å¦‚ï¼Œæ¯ä¸ªLayeréœ€è¦æœ‰ç›¸åŒçš„é—´éš”ã€‚</li>
</ul>
<h3 id="æ¸å˜æ•ˆæœçš„åœ†å½¢åŠ è½½">æ¸å˜æ•ˆæœçš„åœ†å½¢åŠ è½½</h3><p>äº†è§£å®ŒCAReplicationLayerçš„åŸºæœ¬çŸ¥è¯†ä»¥åï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çœ‹çœ‹åœ†å½¢åŠ è½½æ•ˆæœæ€ä¹ˆå®ç°ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼Œæ¯«æ— ç–‘é—®çš„ï¼Œéœ€è¦æ„å»ºä¸€ä¸ªCAReplicationLayerã€‚</p>
<pre><code>let replicationLayer2 = <span class="function"><span class="title">CAReplicatorLayer</span><span class="params">()</span></span>
</code></pre><p>ç¬¬äºŒéƒ¨ï¼Œéœ€è¦ä¸€ä¸ªæ ·å“ï¼Œè®©æˆ‘ä»¬çš„CAReplicationLayerå¤åˆ¶ç”Ÿäº§</p>
<pre><code>let circle = <span class="function"><span class="title">CAShapeLayer</span><span class="params">()</span></span>
circle<span class="class">.path</span> = <span class="function"><span class="title">UIBezierPath</span><span class="params">(ovalInRect: CGRect(x: <span class="number">0</span>, y: <span class="number">0</span>, width: <span class="number">10</span>, height: <span class="number">10</span>)</span></span>)<span class="class">.CGPath</span>
circle<span class="class">.lineWidth</span> = <span class="number">1</span>
circle<span class="class">.fillColor</span> = UIColor.<span class="function"><span class="title">whiteColor</span><span class="params">()</span></span><span class="class">.CGColor</span>
circle<span class="class">.transform</span> = <span class="function"><span class="title">CATransform3DMakeScale</span><span class="params">(<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.1</span>)</span></span>
</code></pre><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªç™½è‰²å°çƒï¼ŒæŠŠåˆå§‹å¤§å°è®¾ç½®ä¸ºäº†0.1ã€‚</p>
<p>æ¥ä¸‹å»ï¼Œæˆ‘ä»¬éœ€è¦ç„¶CAReplicationLayerå¼€å§‹å¤åˆ¶äº†ï¼Œ</p>
<pre><code>replicationLayer2<span class="class">.instanceCount</span> = <span class="number">12</span>
replicationLayer2<span class="class">.instanceTransform</span> = <span class="function"><span class="title">CATransform3DMakeRotation</span><span class="params">(CGFloat(<span class="number">2</span> * M_PI/<span class="number">12.0</span>)</span></span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>)
</code></pre><p>ä»ä¸Šè¿°ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬é¦–å…ˆæ„å»ºäº†<strong>12</strong>ä¸ªå¤åˆ¶ä½“ï¼Œç„¶åå°†è¿™12ä¸ªå°çƒé€šè¿‡instanceTransformç»•<strong>Z</strong>è½´å‡åŒ€çš„åˆ†åº¦åœ¨åœ†å‘¨ä¸Šã€‚</p>
<p>ç°åœ¨èµ¶å¿«runä¸€ä¸‹ä½ çš„appï¼Œçœ‹çœ‹æ•ˆæœæ˜¯ä¸æ˜¯æ­£å¦‚æˆ‘æ‰€è¯´çš„ï¼</p>
<p>ç°åœ¨ä¸‡äº‹å…·å¤‡ï¼Œåªæ¬ åŠ¨ç”»äº†ï¼</p>
<p>é¦–å…ˆæˆ‘ä»¬æ¥å®šä¹‰å¦‚ä¾‹å­ä¸­çš„æ”¾ç¼©åŠ¨ç”»</p>
<pre><code><span class="component">func scaleAnimation() -&gt; CABasicAnimation {
    let animation = CABasicAnimation(keyPath: "transform<span class="string">.scale")</span>
    animation<span class="string">.duration</span> = 1.5
    animation<span class="string">.fromValue</span> = 1.0
    animation<span class="string">.toValue</span> = 0.1
    animation<span class="string">.repeatCount</span> = Float<span class="string">.infinity</span>

    return animation
}</span>
</code></pre><p>æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªé’ˆå¯¹scaleå±æ€§ã€æ—¶å¸¸1.5sçš„åŠ¨ç”»ï¼Œç„¶åæˆ‘ä»¬å°†è¿™ä¸ªåŠ¨ç”»æ·»åŠ åˆ°å°çƒä¸Šã€‚</p>
<pre><code>circle.<span class="function"><span class="title">addAnimation</span><span class="params">(scaleAnimation()</span></span>, forKey: <span class="string">"scale"</span>)
</code></pre><p>ç°åœ¨å¦‚æœä½ è·‘ä¸€ä¸‹ä»£ç çš„è¯ï¼Œä½ ä¼šå‘ç°ï¼Œæ‰€æœ‰çš„å°çƒéƒ½åŒæ—¶å¯åŠ¨äº†åŠ¨ç”»ï¼Œå’Œä¾‹å­çš„æ•ˆæœä¸ä¸€è‡´ï¼Œæ€ä¹ˆå›äº‹å‘¢ï¼Ÿ</p>
<p>å˜¿å˜¿ï¼Œè¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰æåŠçš„å±æ€§<strong>instanceDelay</strong>å—ï¼Ÿæ²¡é”™ï¼Œæˆ‘ä»¬éœ€è¦å€ŸåŠ©å®ƒçš„åŠ›é‡ã€‚</p>
<pre><code>replicationLayer2.instanceDelay = <span class="number">1.5</span>/<span class="number">12</span>
</code></pre><p>ç°åœ¨å†çœ‹çœ‹ï¼Ÿå“ˆå“ˆï¼Œæ•ˆæœæ‹”ç¾¤ï¼</p>
<h3 id="Apple_MusicåŠ è½½æ•ˆæœ">Apple MusicåŠ è½½æ•ˆæœ</h3><p>ä¸‹é¢çš„ä»£ç ï¼Œå¾ˆæ¸…æ™°æ˜“æ‡‚ï¼Œæˆ‘å°±ä¸é€æ¡è§£æå•¦ï¼Œæœ‰é—®é¢˜æ¬¢è¿å¤§å®¶åœ¨ä¸‹æ–¹è¯„è®ºï¼</p>
<pre><code><span class="comment">// 1. åˆ›å»ºå®¹å™¨ReplicationLayer</span>
let replicationLayer = CAReplicatorLayer()

<span class="comment">// 2. åˆ›å»ºæŸ±çŠ¶å›¾</span>
let bar = CALayer()
bar.frame = CGRect(<span class="string">x:</span> <span class="number">0</span>, <span class="string">y:</span> <span class="number">0</span>, <span class="string">width:</span> <span class="number">8</span>, <span class="string">height:</span> <span class="number">40</span>)
bar.position = CGPoint(<span class="string">x:</span> <span class="number">10</span>, <span class="string">y:</span> <span class="number">75</span>)
bar.backgroundColor = UIColor.purpleColor().CGColor

<span class="comment">// 3. å¤åˆ¶ç”Ÿäº§3ä¸ªï¼Œå¹¶æ·»åŠ æ°´å¹³é—´éš”</span>
replicationLayer.addSublayer(bar)
replicationLayer.instanceCount = <span class="number">3</span>
replicationLayer.instanceTransform = CATransform3DMakeTranslation(<span class="number">20</span>, <span class="number">0</span>, <span class="number">0</span>)

<span class="comment">// 4. åˆ›å»ºåŠ¨ç”»ï¼Œæ„é€ æ—¶é—´å·®</span>
func jumpAnimation(<span class="string">bar:</span>CALayer) -&gt; CABasicAnimation {
    let animation = CABasicAnimation(<span class="string">keyPath:</span> <span class="string">"position.y"</span>)
    animation.toValue = bar.position.y - <span class="number">35.0</span>
    animation.duration = <span class="number">0.45</span>
    animation.autoreverses = <span class="literal">true</span>
    animation.repeatCount = Float.infinity

    <span class="keyword">return</span> animation
}

bar.addAnimation(jumpAnimation(bar), <span class="string">forKey:</span> <span class="string">"jump"</span>)
replicationLayer.instanceDelay = <span class="number">0.3</span>
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/11/17/Fun-of-CAReplicationLayer/" data-id="cjqdxq21d0030mxi143a71d8f" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/11/17/Fun-of-CAReplicationLayer/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swift/">Swift</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-Swift-UITransition-iOS8" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/12/Swift-UITransition-iOS8/" class="article-date">
  <time datetime="2015-11-11T18:33:50.000Z" itemprop="datePublished">2015-11-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/12/Swift-UITransition-iOS8/">Swiftæ¯æ—¥ä¸€ç»ƒï¼šè‡ªå®šä¹‰è½¬åœºåœ¨iOS8ä¸­çš„é‚£äº›å‘</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ä¹‹å‰å› ä¸ºé¢è¯•çš„ç¼˜æ•…å‘ç°äº†è‡ªå·±åœ¨è‡ªå®šä¹‰è½¬åœºè¿™å—æœ‰ç‚¹æ¬ ç¼ºï¼Œä»Šå¤©æ‹¿Swiftç»ƒä¸‹æ‰‹ï¼Œå®ç°ä¸€ä¸ªè‡ªå®šä¹‰è½¬åœºçš„æ•ˆæœã€‚<em>æ²¡è€å¿ƒçš„è¯è¯·ç›´æ¥ç¿»åˆ°æœ€åå§ï¼Œæˆ‘å‰é¢éƒ½æ˜¯é“ºå«å‘¢ã€‚</em></p>
<p>é¦–å…ˆè®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æœ€åå®ç°çš„æ•ˆæœï¼š<br><img src="http://7lrzqz.com1.z0.glb.clouddn.com/WZCustomTransition.gif"></p>
<p>ä¸‹é¢å°±è®©æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥çœ‹çœ‹æ˜¯å¦‚ä½•å®ç°è¿™ä¸ªæ•ˆæœçš„ã€‚</p>
<h3 id="è‡ªå®šä¹‰è½¬åœº">è‡ªå®šä¹‰è½¬åœº</h3><p>è¦å®ç°è‡ªå®šä¹‰è½¬åœºåŠ¨ç”»ï¼Œæ¯”è¾ƒé‡è¦çš„å°±æ˜¯ä¸‰ä¸ªéƒ¨åˆ†ã€‚</p>
<ul>
<li><p>UIViewControllerContextTransition</p>
<p>è¿™ä¸ªæ¥å£ä¸»è¦ç”¨æ¥æä¾›åˆ‡æ¢ä¸Šä¸‹æ–‡ç»™å¼€å‘è€…ä½¿ç”¨ï¼ŒåŒ…å«äº†ä»å“ªä¸ªVCåˆ°å“ªä¸ªVCç­‰å„ç±»ä¿¡æ¯ï¼Œä¸€èˆ¬ä¸éœ€è¦å¼€å‘è€…è‡ªå·±å®ç°ã€‚</p>
<p>æœ¬æ–‡å…³æ³¨çš„åŒ…å«äº†å¦‚ä¸‹ä¸€äº›å†…å®¹ï¼š</p>
<pre><code><span class="number">1.</span> - (<span class="built_in">UIView</span> *)containerView; 
<span class="comment">// VCåˆ‡æ¢æ‰€å‘ç”Ÿçš„viewå®¹å™¨    </span>

<span class="number">2.</span> - (<span class="built_in">UIViewController</span> *)viewControllerForKey:(<span class="built_in">NSString</span> *)key;
<span class="comment">// æ ¹æ®UITransitionContextFromViewControllerKeyå’ŒUITransitionContextToViewControllerKeyä¸¤ç§ï¼Œåˆ†åˆ«è¿”å›å°†è¦åˆ‡å‡ºå’Œåˆ‡å…¥çš„ViewControllerã€‚</span>

<span class="number">3.</span> - (<span class="keyword">void</span>)completeTransition:(<span class="built_in">BOOL</span>)didComplete; 
<span class="comment">// æŠ¥å‘Šåˆ‡æ¢å·²ç»å®Œæˆã€‚</span>
</code></pre></li>
<li><p>UIViewControllerAnimatedTransition</p>
<p>è¿™ä¸ªæ¥å£ä¸»è¦ç”¨æ¥å®šä¹‰å¦‚ä½•å®Œæˆè½¬åœºåŠ¨ç”»ï¼ŒåŒæ—¶å®šä¹‰è½¬åœºåŠ¨ç”»çš„æŒç»­æ—¶é—´ã€‚ï¼ˆåœ¨æœ¬æ–‡ä¸­æˆ‘ä»¬ä¸è€ƒè™‘äº¤äº’å¼çš„è½¬åœºï¼‰</p>
<pre><code><span class="number">1.</span> - (<span class="built_in">NSTimeInterval</span>)transitionDuration:(<span class="keyword">id</span> &lt; <span class="built_in">UIViewControllerContextTransitioning</span> &gt;)transitionContext; 
<span class="comment">// è¿”å›è½¬åœºåŠ¨ç”»æŒç»­çš„æ—¶é—´</span>

<span class="number">2.</span> - (<span class="keyword">void</span>)animateTransition:(<span class="keyword">id</span> &lt; <span class="built_in">UIViewControllerContextTransitioning</span> &gt;)transitionContext; 
<span class="comment">// æˆ‘ä»¬è‡ªå®šä¹‰çš„è½¬åœºè¦åœ¨è¿™é‡Œå®Œæˆ</span>
</code></pre></li>
<li><p>UIViewControllerTransitionDelegate    </p>
<p>è¿™ä¸ªæ¥å£ä¸»è¦ç”¨äºæŒ‡å®šï¼Œæˆ‘ä»¬å¸Œæœ›é‡‡ç”¨å“ªç§è½¬åœºæ•ˆæœï¼ˆæ¯”å¦‚ä½ å¯ä»¥æ ¹æ®ä¸åŒçš„çŠ¶æ€ï¼Œåˆ‡æ¢ä¸åŒçš„è‡ªå®šä¹‰ä¸“åœºæ•ˆæœï¼‰</p>
<pre><code><span class="number">1.</span> - (<span class="keyword">id</span>&lt; <span class="built_in">UIViewControllerAnimatedTransitioning</span> &gt;)animationControllerForPresentedController:(<span class="built_in">UIViewController</span> *)presented presentingController:(<span class="built_in">UIViewController</span> *)presenting sourceController:(<span class="built_in">UIViewController</span> *)source;
<span class="comment">// å½“å¼¹å‡ºæ¨¡æ€çª—å£çš„æ—¶å€™ï¼Œä½¿ç”¨ä»€ä¹ˆè½¬åœºæ•ˆæœ</span>

<span class="number">2.</span> - (<span class="keyword">id</span>&lt; <span class="built_in">UIViewControllerAnimatedTransitioning</span> &gt;)animationControllerForDismissedController:(<span class="built_in">UIViewController</span> *)dismissed;
<span class="comment">// å½“å…³é—­æ¨¡æ€çª—å£çš„æ—¶å€™ï¼Œä½¿ç”¨ä»€ä¹ˆè½¬åœºæ•ˆæœ</span>
</code></pre></li>
</ul>
<h3 id="å®ç°">å®ç°</h3><p>çŸ¥é“äº†è½¬åœºåŠ¨ç”»éœ€è¦çš„å¿…è¦æ¡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ¾åˆ†åˆ«å®ç°ä¸‰ä¸ªéƒ¨åˆ†ã€‚</p>
<p>ç¬¬ä¸€éƒ¨åˆ†UIViewControllerContextTransitionåœ¨æœ¬æ–‡ä¸­å¹¶æ²¡æœ‰ç‰¹æ®Šå®šåˆ¶åŒ–çš„åœ°æ–¹ï¼Œç›´æ¥å®Œæˆã€‚</p>
<p>ç¬¬äºŒéƒ¨åˆ†å…³äºUIViewControllerAnimatedTransitionçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>class SwipeAnimator: <span class="built_in">NSObject</span>, <span class="built_in">UIViewControllerAnimatedTransitioning</span> {
    <span class="keyword">enum</span> SwipeTo {
        <span class="keyword">case</span> Main
        <span class="keyword">case</span> Modal
    };

    var transitonTo:SwipeTo = <span class="variable">.Main</span>

    <span class="comment">// 0. è¿”å›åŠ¨ç”»æ—¶é—´</span>
    func transitionDuration(transitionContext: <span class="built_in">UIViewControllerContextTransitioning</span>) -&gt; <span class="built_in">NSTimeInterval</span> {
        <span class="keyword">return</span> <span class="number">1.0</span>
    }

    func animateTransition(transitionContext: <span class="built_in">UIViewControllerContextTransitioning</span>) {
        <span class="comment">// 1. è·å–ç›¸å…³èµ„æº</span>
        let fromVC = transitionContext<span class="variable">.viewControllerForKey</span>(<span class="built_in">UITransitionContextFromViewControllerKey</span>)!

        let toView = transitionContext<span class="variable">.viewForKey</span>(<span class="built_in">UITransitionContextToViewKey</span>)

        <span class="comment">// 2. å¼¹å‡ºæ¨¡æ€</span>
        <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.transitonTo</span> == <span class="variable">.Modal</span>) {
            <span class="keyword">if</span> toView != <span class="literal">nil</span> {
                transitionContext<span class="variable">.containerView</span>()<span class="variable">.addSubview</span>(toView!)

                toView!<span class="variable">.alpha</span> = <span class="number">0.0</span>

                <span class="comment">// 2.1 ä»¥å·¦ä¸Šè§’ä¸ºé”šç‚¹æ—‹è½¬</span>
                fromVC<span class="variable">.view</span><span class="variable">.layer</span><span class="variable">.anchorPoint</span> = <span class="built_in">CGPoint</span>(x: <span class="number">0</span>, y: <span class="number">0</span>)
                fromVC<span class="variable">.view</span><span class="variable">.layer</span><span class="variable">.position</span> = <span class="built_in">CGPointMake</span>(<span class="number">0</span>, <span class="number">0</span>)

                <span class="built_in">UIView</span><span class="variable">.animateWithDuration</span>(<span class="number">1.0</span>, animations: { () -&gt; Void <span class="keyword">in</span>
                    fromVC<span class="variable">.view</span><span class="variable">.transform</span> = <span class="built_in">CGAffineTransformMakeRotation</span>(<span class="built_in">CGFloat</span>(-M_PI/<span class="number">2</span>))
                    toView!<span class="variable">.alpha</span> = <span class="number">1.0</span>
                }, completion: { (completion:Bool) -&gt; Void <span class="keyword">in</span>
                    <span class="comment">// 2.2 æŠ¥å‘Šè½¬åœºåŠ¨ç”»å®Œæˆ</span>
                    transitionContext<span class="variable">.completeTransition</span>(!transitionContext<span class="variable">.transitionWasCancelled</span>())
                })
            }
        } <span class="keyword">else</span> {
            <span class="comment">// 3. å…³é—­æ¨¡æ€</span>
            <span class="keyword">if</span> fromView != <span class="literal">nil</span> {
                fromView!<span class="variable">.alpha</span> = <span class="number">1.0</span>
                <span class="built_in">UIView</span><span class="variable">.animateWithDuration</span>(<span class="number">1.0</span>, animations: { () -&gt; Void <span class="keyword">in</span>
                    toVC<span class="variable">.view</span><span class="variable">.transform</span> = <span class="built_in">CGAffineTransformMakeRotation</span>(<span class="number">0</span>)
                    fromView!<span class="variable">.alpha</span> = <span class="number">0.0</span>
                }, completion: { (completion:Bool) -&gt; Void <span class="keyword">in</span>
                    transitionContext<span class="variable">.completeTransition</span>(!transitionContext<span class="variable">.transitionWasCancelled</span>())
                })
            }
        }
    }
}
</code></pre><p>å®ç°éå¸¸ç®€å•ï¼Œæˆ‘ä»¬æ¥ä¸€æ­¥æ­¥çœ‹ä¸‹ã€‚</p>
<ul>
<li><ol>
<li>æ ¹æ®UIViewControllerAnimatedTransitionåè®®è¿”å›åŠ¨ç”»æ—¶é—´</li>
</ol>
</li>
<li><ol>
<li>æ ¹æ®UIViewControllerContextTransitionè·å–æˆ‘ä»¬éœ€è¦æ“ä½œçš„å³å°†åˆ‡å‡ºçš„ViewController(fromVC)ä»¥åŠå³å°†åˆ‡å…¥çš„é¡µé¢(toView)ï¼Œ<strong>ä¸ºä»€ä¹ˆè¦ç”¨è¿™ç§è·å–æ–¹å¼ï¼Œç¨å¾®åœ¨é‡ç‚¹åˆ†æä¼šæŒ‡å‡º</strong></li>
</ol>
</li>
<li><ol>
<li>å½“é‡åˆ°æ˜¯å¼¹å‡ºæ¨¡æ€çª—å£è½¬åœºçš„æ—¶å€™ï¼Œæˆ‘ä»¬é¦–å…ˆå°†toViewåŠ å…¥åˆ°è½¬åœºè¿‡ç¨‹æä¾›çš„ä¸€ä¸ªcontainViewä¸­ï¼Œç„¶åæ”¹å˜fromVCçš„é”šç‚¹ï¼Œè¿›è¡Œæ—‹è½¬ï¼ŒåŒæ—¶æˆ‘ä»¬å¯¹toViewè¿›è¡Œäº†ä¸€ä¸ªæ·¡å…¥æ·¡å‡ºã€‚å½“è½¬åœºåŠ¨ç”»å®Œæˆä»¥åï¼Œ<strong>åœ¨å›è°ƒçš„closureä¸­æŠ¥å‘Šè½¬åœºåŠ¨ç”»å·²ç»å®Œæˆ</strong>ã€‚</li>
</ol>
</li>
<li><ol>
<li>å½“å…³é—­æ¨¡æ€è½¬åœºçš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™è½¬åœºçš„å‡ºå’Œå…¥å°±æ­£å¥½å’Œå¼¹å‡ºçš„æ—¶å€™æˆªç„¶ç›¸åã€‚åŸå…ˆçš„fromVCæˆäº†ç°åœ¨çš„toVCï¼Œå› æ­¤æˆ‘ä»¬åœ¨è¿™é‡Œå°†toVCæ—‹è½¬å›åŸæ¥çš„ä½ç½®ã€‚å½“ç„¶åˆ«å¿˜äº†æˆ‘ä»¬çš„æ·¡å…¥æ·¡å‡ºå•¦ï¼ŒåŸç†æ˜¯ä¸€æ ·çš„ï¼Œåªè¦æ”¹å˜fromViewçš„alphaå³å¯ã€‚åŠ¨ç”»å®Œæˆåï¼Œä¾ç„¶è¦æŠ¥å‘Šæˆ‘ä»¬çš„è½¬åœºå®Œæˆäº†ã€‚</li>
</ol>
</li>
</ul>
<p>ç¬¬ä¸‰éƒ¨åˆ†ï¼ŒUIViewControllerTransitionDelegateçš„å®ç°ä¾ç„¶éå¸¸ç®€å•ï¼Œæˆ‘ä»¬ä»…ä»…éœ€è¦å‘ŠçŸ¥è½¬åœºå‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬å…·ä½“è¦é‡‡ç”¨å“ªç§è½¬åœºæ•ˆæœå°±å¥½äº†ã€‚</p>
<pre><code><span class="func"><span class="keyword">func</span> <span class="title">animationControllerForPresentedController</span><span class="params">(presented: UIViewController, presentingController presenting: UIViewController, sourceController source: UIViewController)</span></span> -&gt; <span class="type">UIViewControllerAnimatedTransitioning</span>? {
    <span class="keyword">self</span>.animator.transitonTo = .<span class="type">Modal</span>
    <span class="keyword">return</span> <span class="keyword">self</span>.animator
}

<span class="func"><span class="keyword">func</span> <span class="title">animationControllerForDismissedController</span><span class="params">(dismissed: UIViewController)</span></span> -&gt; <span class="type">UIViewControllerAnimatedTransitioning</span>? {
    <span class="keyword">self</span>.animator.transitonTo = .<span class="type">Main</span>
    <span class="keyword">return</span> <span class="keyword">self</span>.animator
}
</code></pre><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¤ç”¨äº†åŒä¸€ä¸ªè½¬åœºæ•ˆæœï¼Œé€šè¿‡ä¸åŒçš„transitionToå‚æ•°è¿›è¡Œæ§åˆ¶ã€‚ä½ å½“ç„¶ä¹Ÿå¯ä»¥ç»™ä¸¤ä¸ªè½¬åœºåˆ†åˆ«ç”Ÿæˆå¯¹åº”ä¸åŒçš„è½¬åœºæ•ˆæœã€‚</p>
<h3 id="iOS8çš„å‘">iOS8çš„å‘</h3><p>å˜¿å˜¿ï¼Œé‡å¤´æˆæ¥äº†ï¼Œåƒä¸‡åˆ«é”™è¿‡ã€‚</p>
<p>ä¸€å¼€å§‹å®ç°è¿™ä¸ªè½¬åœºæ•ˆæœçš„æ—¶å€™ï¼Œå‹æ ¹æ²¡æƒ³åˆ°è¿™ä¹ˆå¤æ‚ï¼Œä½†æ˜¯ï¼Œçªç„¶å‘ç°äº†ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼š</p>
<p><strong>å½“å¼¹å‡ºæ¨¡æ€çª—å£çš„æ—¶å€™ï¼Œè½¬åœºæ•ˆæœæ­£å¸¸ï¼Œæœ€åæˆåŠŸæ˜¾ç¤ºæ¨¡æ€ç•Œé¢ã€‚ä½†æ˜¯å½“å…³é—­æ¨¡æ€çª—å£çš„æ—¶å€™ï¼Œè½¬åœºæ•ˆæœä¾ç„¶æ­£ç¡®ï¼Œä½†æ˜¯è½¬åœºç»“æŸåï¼Œæ•´ä¸ªå±å¹•éƒ½é»‘äº†ã€‚</strong></p>
<p><em>What the F*ck!!!</em></p>
<p>æˆ‘ä»¥ä¸ºæ˜¯æˆ‘è‡ªå·±å®ç°æœ‰é—®é¢˜ï¼Œä½†æ˜¯æˆ‘å»Githubä¸Šæ‰¾äº†å‡ ä¸ªè‘—åçš„è½¬åœºæ•ˆæœè·‘äº†ä¸‹ï¼Œéƒ½å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œé‚£æˆ‘å°±ç™¾æ€ä¸å¾—å…¶è§£äº†å‘€ï¼ï¼ï¼</p>
<h4 id="è¯¯æ‰“è¯¯æ’">è¯¯æ‰“è¯¯æ’</h4><p>ä»ç½‘ä¸Šæœå¯»äº†å¾ˆä¹…ä¹‹åï¼Œæˆ‘è¿˜æ˜¯æ²¡æœ‰å¤´ç»ªï¼Œäºæ˜¯æˆ‘é¦–å…ˆå°è¯•å°†å¦‚ä¸‹ä»£ç ä¸­</p>
<pre><code><span class="tag">var</span> modalVC = <span class="function"><span class="title">UIStoryboard</span><span class="params">(name: <span class="string">"Main"</span>, bundle: nil)</span></span>.<span class="function"><span class="title">instantiateViewControllerWithIdentifier</span><span class="params">(<span class="string">"ModalViewController"</span>)</span></span> as! UIViewController
modalVC<span class="class">.transitioningDelegate</span> = self
modalVC<span class="class">.modalPresentationStyle</span> = <span class="class">.Custom</span>
<span class="function"><span class="title">presentViewController</span><span class="params">(modalVC, animated: true, completion: nil)</span></span>
</code></pre><p><strong>modalVC.modalPresentationStyle = .Custom</strong>ä¸­çš„.Customæ”¹æˆäº†.FullScreenã€‚<br>è¿™ä¸€ä¸‹å­å°±ç»™æˆ‘æ•´å¥½äº†ï¼</p>
<p>æ‰€ä»¥ï¼Œç»™å¤§å®¶æä¸ªé†’ï¼Œå¦‚æœé‡åˆ°ç›¸ä¼¼çš„é—®é¢˜ï¼Œè§£å†³æ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯.FullScreenå³å¯ã€‚</p>
<h4 id="æ·±å±‚åŸå› ">æ·±å±‚åŸå› </h4><p>ä½œä¸ºä¸€ä¸ªç«™åœ¨çº¢æ——ä¸‹çš„ä¸‰å¥½å­¦ç”Ÿï¼Œå¼„æ‡‚é—®é¢˜çš„æ·±å±‚åŸå› æ‰æ˜¯æœ€ä¸»è¦çš„ï¼Œé€šè¿‡ä¸è¿‡çš„debugï¼Œæˆ‘ç»ˆäºå¼„æ‡‚äº†ã€‚</p>
<p><strong>é¦–å…ˆï¼Œæˆ‘ä»¬è¦å¼ºè°ƒä¸€ä¸ªåŸºæœ¬çŸ¥è¯†ã€‚ä¸€ä¸ªUIViewçš„superviewæœ€å¤šåªèƒ½ç”±ä¸€ä¸ªã€‚å½“ä¸€ä¸ªæœ¬èº«å¤„äºåˆ«çš„UIViewä¸‹çš„subViewè¢«æ·»åŠ åˆ°å¦ä¸€ä¸ªUIViewä¸Šçš„æ—¶å€™ï¼Œå®ƒå°±è‡ªåŠ¨è¢«ä»å‰ä¸€ä¸ªUIViewçš„Hierarchyä¸­ç§»é™¤äº†ã€‚</strong></p>
<p>è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„å†™æ³•å—ï¼Ÿ<br>æ ¹æ®UIViewControllerContextTransitionè·å–æˆ‘ä»¬éœ€è¦æ“ä½œçš„å³å°†åˆ‡å‡ºçš„ViewController(fromVC)ä»¥åŠå³å°†åˆ‡å…¥çš„é¡µé¢(toView)</p>
<p>æˆ‘ä»¬è¿™ä¹ˆå†™çš„åŸå› å°±æ˜¯å› ä¸ºæˆ‘ä»¬åˆšåˆšå¼ºè°ƒçš„åŸºæœ¬çŸ¥è¯†ï¼Œåˆ«æ€¥ï¼Œè®©æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥è§£æã€‚</p>
<p>åœ¨iOS8ä¸­ï¼Œè‹¹æœæä¾›äº†ä¸€ä¸ªæ–°çš„APIï¼š</p>
<pre><code><span class="constant">@availability</span>(iOS, introduced=<span class="number">8.0</span>)
<span class="function"><span class="keyword">func</span> <span class="title">viewForKey</span><span class="params">(key: String)</span> -&gt; <span class="title">UIView</span>?</span>
</code></pre><p>å¹¶ä¸”åœ¨æ–‡æ¡£ä¸­æ˜ç¡®å¼ºè°ƒäº†ä¸€ç‚¹ï¼š</p>
<pre><code><span class="comment">// Currently only two keys are defined by the</span>
<span class="comment">// system - UITransitionContextToViewControllerKey, and</span>
<span class="comment">// UITransitionContextFromViewControllerKey. </span>
<span class="comment">// Animators should not directly manipulate a view controller's views and should</span>
<span class="comment">// use viewForKey: to get views instead.</span>
<span class="func"><span class="keyword">func</span> <span class="title">viewControllerForKey</span><span class="params">(key: String)</span></span> -&gt; <span class="type">UIViewController</span>?
</code></pre><p>ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ<br>ä¹‹å‰åœ¨iOS7ä¸­ï¼Œå¼€å‘è€…éœ€è¦é€šè¿‡<strong>viewControllerForKey</strong>è¿™ä¸ªæ–¹æ³•è·å–åˆ‡å…¥åˆ‡å‡ºçš„ViewControllerï¼Œå¹¶ç›´æ¥æ“ä½œViewControllerå¯¹åº”çš„Viewæ¥ç¼–å†™è½¬åœºåŠ¨ç”»ã€‚è€Œåœ¨iOS8ä»¥åï¼Œè‹¹æœè§„å®šå¿…é¡»ä½¿ç”¨<strong>viewForKey</strong>æ¥è·å–fromViewå’ŒtoViewæ¥è¿›è¡Œè½¬åœºåŠ¨ç”»çš„æ“ä½œã€‚</p>
<p>é‚£è¿™ä¸ªAPIçš„æ›´æ”¹å’Œé»‘å±æœ‰ä»€ä¹ˆå…³è”å‘¢ï¼Ÿ</p>
<ul>
<li>åœ¨æ•´ä¸ªè½¬åœºè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éƒ½ä¾èµ–äºè½¬åœºä¸Šä¸‹æ–‡transitonContextæä¾›çš„containerViewå®¹å™¨è¿›è¡ŒviewåŠ¨ç”»çš„æ“ä½œã€‚è¿™æ˜¯å› ä¸ºåœ¨è½¬åœºå®Œæˆå‰ï¼Œå³å°†<strong>åˆ‡å…¥</strong>çš„viewcontrolleréƒ½ä¸å­˜åœ¨äºå½“å‰çš„å¯è§†ç•Œé¢çš„è§†å›¾å±‚çº§å†…(View Hierarchy)ã€‚å› æ­¤ï¼Œè‹¹æœæä¾›äº†ä¸€ä¸ªè¿‡æ¸¡çš„å®¹å™¨ç»™æˆ‘ä»¬ä½¿ç”¨ï¼ˆå¦‚æœå¤§å®¶debugä¸‹çš„è¯ï¼Œå°±ä¼šå‘ç°åœ¨è½¬åœºè¿‡ç¨‹ä¹‹ä¸­ï¼ŒUIWindowä¸Šå¤šäº†ä¸€ä¸ªUITransitionViewï¼Œå°±æ˜¯åˆ‡æ¢ä¸Šä¸‹æ–‡çš„containerViewï¼‰ã€‚</li>
<li>åœ¨iOS7çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†fromVC.viewå’ŒtoVC.viewéƒ½é€šè¿‡addSubViewçš„æ–¹å¼æ·»åŠ åˆ°å®¹å™¨Viewä¸Šè¿›è¡ŒåŠ¨ç”»å±•ç¤ºã€‚<strong>ç”±äºæ˜¯ç›´æ¥æ“ä½œäº†ViewControllerçš„viewï¼Œå› æ­¤ï¼ŒfromVCçš„viewä¼šè¢«ä»å½“å‰çš„è§†å›¾å±‚çº§ä¸­ç§»é™¤</strong></li>
<li><strong>ä½†æ˜¯ï¼ŒiOS7ä¸­ï¼Œä¼šåœ¨è½¬åœºåŠ¨ç”»å®Œæˆåï¼Œè‡ªåŠ¨å°†fromVCçš„viewæ·»åŠ å›åŸå…ˆfromVCä»å±çš„çˆ¶è§†å›¾ä¸­</strong></li>
<li>iOS8ä¸­ä¸ä¼š</li>
<li>åœ¨æœ¬æ–‡çš„åˆç‰ˆå®ç°ä¸­ï¼Œåœ¨è½¬åœºè¿‡ç¨‹ä¸­å½“åˆ¤æ–­transitionTo == .Mainçš„æ—¶å€™ï¼Œå°†æ­¤æ—¶toViewController.view (ä¹Ÿå°±æ˜¯åŸå…ˆçš„ä¸»çª—å£) æ·»åŠ åˆ°äº†containerViewä¸Šã€‚å› æ­¤ï¼Œå½“è½¬åœºç»“æŸçš„æ—¶å€™ï¼ŒcontainerViewä»windowå¯è§è§†å›¾å±‚çº§ä¸­ç§»é™¤äº†ï¼Œå› æ­¤å°±å˜å¾—ä¸å¯è§ï¼Œä»è€Œå˜æˆé»‘å±äº†ã€‚</li>
</ul>
<p>é‚£ä¹ˆä¸ºä»€ä¹ˆæ¨¡æ€çª—å£åœ¨è½¬åœºè¿‡ç¨‹åå¯è§å‘¢ï¼Ÿ</p>
<ul>
<li>å› ä¸ºè¿™ä¸ªç‰¹æ€§ä¾ç„¶æ­£ç¡®ã€‚</li>
</ul>
<p>containerViewåˆ°åº•æ˜¯å•¥?</p>
<ul>
<li>å°±æ˜¯ä¸€ä¸ªè¿‡æ¸¡çš„UITransitionViewï¼Œä¸€ä¸ªè½¬åœºæ•ˆæœå¯¹åº”ç”Ÿæˆä¸€ä¸ªï¼ˆä¼šå¤ç”¨ï¼‰ã€‚</li>
<li>åœ¨è½¬åœºç»“æŸåè‡ªåŠ¨ä»è§†å›¾å±‚çº§ä¸­ç§»é™¤ï¼Œå› æ­¤ä¸éœ€è¦å¤§å®¶æ‰‹åŠ¨è¿›è¡ŒremoveFromSuperViewã€‚</li>
</ul>
<p>é‚£ä¹ˆviewForKeyå’ŒviewControlelrForKeyç›´æ¥æ“çºµviewçš„åŒºåˆ«å‘¢ï¼Ÿ</p>
<ul>
<li>viewForKeyå¾ˆå¯èƒ½è¿”å›çš„æ˜¯ä¸€ä¸ªå®Œå…¨å…‹éš†VCçš„viewçš„å¯¹è±¡ã€‚</li>
</ul>
<p>åˆ°è¿™ï¼Œç›¸ä¿¡å¤§å®¶éƒ½å¼„æ‡‚äº†å§ï¼Œæˆ‘çœŸæ˜¯å¤ªä½©æœæˆ‘è‡ªå·±äº†ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/11/12/Swift-UITransition-iOS8/" data-id="cjqdxq1yp001kmxi1wmuhlgf2" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/11/12/Swift-UITransition-iOS8/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swift/">Swift</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-Understand-Viper" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/05/Understand-Viper/" class="article-date">
  <time datetime="2015-11-04T17:01:51.000Z" itemprop="datePublished">2015-11-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/05/Understand-Viper/">æµ…å…¥æµ…å‡ºVIPERè®¾è®¡æ¶æ„(1)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ä¹‹å‰å’Œè±Œè±†èšçš„åŒå­¦èŠå¤©ï¼Œå‘ç°ä»–ä»¬çš„Appä»MVVMåˆ‡æ¢åˆ°VIPERè®¾è®¡æ¶æ„ï¼Œäºæ˜¯è¿™ä¸¤å¤©èŠ±äº†ç‚¹æ—¶é—´ç ”è¯»äº†ä¸€ä¸‹ ç›¸å…³èµ„æ–™ï¼Œæµ…è°ˆä¸€ä¸‹ã€‚</p>
<h3 id="VIPERæ˜¯ä»€ä¹ˆ">VIPERæ˜¯ä»€ä¹ˆ</h3><p>VIPERæ˜¯<b>View, Interactor, Presenter, Entity, Routing</b>5ä¸ªè¯è¯­çš„ç¼©å†™ï¼Œè¿™5ä¸ªè¯è¯­ä¹Ÿæ˜¯VIPERæ¶æ„çš„æ ¸å¿ƒã€‚</p>
<p>View - è§†å›¾ï¼Œæ¥æ”¶ä¼ é€’çš„å†…å®¹ï¼Œç„¶åè¿›è¡Œå†…å®¹å±•ç¤ºã€‚</p>
<p>Presenter - è§†å›¾é€»è¾‘æ§åˆ¶å™¨ï¼Œè¿™ä¸ªæ¨¡å—åªç”¨æ¥æ‰§è¡Œå’ŒUIç›¸å…³çš„é€»è¾‘ã€‚ä»€ä¹ˆå«å’ŒUIç›¸å…³çš„é€»è¾‘å‘¢ï¼Ÿæ¯”å¦‚ï¼šæ¥æ”¶ç”¨æˆ·äº¤äº’ã€å°†å±•ç¤ºçš„å†…å®¹åˆ†å‘ç»™ä¸åŒçš„UIç•Œé¢è¿›è¡Œå±•ç¤ºã€‚</p>
<p>Interactor - <b>çº¯ä¸šåŠ¡é€»è¾‘æ§åˆ¶å™¨</b>ï¼Œè¿™ä¸ªæ¨¡å—å®Œå…¨è„±ç¦»äºUIï¼Œåªç”¨æ¥åšä¸šåŠ¡ç›¸å…³çš„é€»è¾‘æ§åˆ¶ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œæ¯”å¦‚ä¸‹è½½é€»è¾‘ã€è®¡ç®—é€»è¾‘ç­‰ç­‰å¯ä»¥åˆ’åˆ†ä¸ºå•ä¸€Use Caseçš„é€»è¾‘ã€‚</p>
<p>Entity - åŸºç¡€çš„æ•°æ®æ¨¡å‹ï¼Œæ¯”æ–¹è¯´å¤§å®¶ç»å¸¸å®šä¹‰çš„XXXModelä¹‹ç±»çš„ï¼Œä½†æ˜¯ï¼Œè¿™é‡Œçš„XXXModelå¯ä»¥è®¤ä¸ºåŸºæœ¬å°±æ˜¯<b>çº¯æ•°æ®ç»“æ„äº†</b>ï¼Œä¸åŒ…å«è½»é‡çº§ä¸šåŠ¡å¤„ç†é€»è¾‘</p>
<p>Routing - è·¯ç”±å™¨ï¼Œè§†å›¾åˆ‡æ¢çš„é€»è¾‘ã€‚æ¯”å¦‚åŒ…å«å¦‚ä½•ä»ä¸€ä¸ªç•Œé¢åˆ‡æ¢åˆ°å¦ä¸€ä¸ªç•Œé¢ï¼Œåˆ‡æ¢çš„é¡ºåºæ˜¯å¦‚ä½•ç­‰ç­‰ã€‚</p>
<p>é™¤äº†äº”å¤§æ ¸å¿ƒä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜ç»å¸¸ä½¿ç”¨äº†<strong>Data Store</strong>è¿™ä¸ªæ¨¡å—ã€‚å› ä¸ºæˆ‘ä»¬ä¹‹å‰æè¿‡ï¼Œæˆ‘ä»¬çš„EntityåŸºæœ¬å°±æ˜¯çº¯æ•°æ®ç»“æ„ï¼Œä¸åŒ…å«è½»é‡çº§çš„ä¸šåŠ¡é€»è¾‘ï¼Œå› æ­¤ï¼ŒEntityè¿›è¡ŒæŒä¹…åŒ–è¿™ä¸ªèŒè´£æ˜¯è¦å•ç‹¬åˆ’åˆ†å‡ºæ¥ï¼Œè€Œè¿™ä¸ªèŒèƒ½å°±è½åˆ°äº†Data Storeèº«ä¸Šã€‚</p>
<p>ä¸‹é¢æ˜¯ç½‘ä¸Šä¸€å¼ æ¯”è¾ƒç»å…¸çš„æ¶æ„è®¾è®¡å›¾ï¼š</p>
<p><img src="https://www.objc.io/images/issue-13/2014-06-07-viper-wireframe-76305b6d.png"></p>
<h3 id="ä¸ºä»€ä¹ˆè¦ç”¨VIPER">ä¸ºä»€ä¹ˆè¦ç”¨VIPER</h3><p><strong>åœ¨è½¯ä»¶å·¥ç¨‹é¢†åŸŸï¼Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„è§‚ç‚¹ï¼Œå°±æ˜¯æµ‹è¯•ã€æµ‹è¯•ã€æµ‹è¯•ã€‚ï¼ˆé‡è¦çš„è¯è¯´ä¸‰éï¼ï¼‰</strong></p>
<p>ä¹‹å‰åœ¨BMW Groupå®ä¹ çš„æ—¶å€™ä»äº‹Javaå¼€å‘ï¼Œæ¯ä¸€ä¸ªå‡½æ•°éƒ½è¦ç»è¿‡JUnitçš„æµ‹è¯•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è°“çš„Test-Driven Developmentã€‚ä½†æ˜¯iOSå¼€å‘ç”±äºå…¶é€»è¾‘å’Œè§†å›¾çš„å¼ºè€¦åˆå…³ç³»ï¼Œå¸¸å¸¸å¯¼è‡´ä¸šåŠ¡é€»è¾‘ä¸èƒ½å®Œå…¨ç‹¬ç«‹äºç•Œé¢ï¼Œè¿›è¡Œå•å…ƒæµ‹è¯•ååˆ†å›°éš¾ã€‚æ¯”å¦‚ï¼Œè‡­åæ˜­è‘—çš„â€Massive View Controllerâ€ å°±æ˜¯å› ä¸ºå°†å¤§é‡çš„ä¸šåŠ¡é€»è¾‘å’Œè§†å›¾é€»è¾‘è€¦åˆè¿›äº†Controllerï¼Œå¯¼è‡´Controlleréå¸¸è‡ƒè‚¿ï¼Œä¹Ÿä¸å®¹æ˜“å‰¥ç¦»è¿›è¡Œæµ‹è¯•ã€‚</p>
<p>è€ŒVIPERæ¶æ„å¼•å…¥äº†Interactorå’ŒPresentatorä¸¤ä¸ªæ¦‚å¿µï¼Œå°†ä¸šåŠ¡é€»è¾‘å’Œè§†å›¾é€»è¾‘ç‹¬ç«‹å¼€æ¥ï¼Œä»è€Œå¯ä»¥å•ç‹¬æµ‹è¯•ä¸šåŠ¡é€»è¾‘çš„ä»£ç ã€‚</p>
<h3 id="ä¾‹å­åˆ†æ">ä¾‹å­åˆ†æ</h3><p>è¯´äº†å¥½å¤šè™šçš„æ¦‚å¿µï¼Œæœ‰äº›äººä¸€å®šå·²ç»è¢«å¼„æ™•äº†ï¼Œè¿˜æ˜¯èµ¶ç´§çœ‹ä¸¤ä¸ªå…¸å‹çš„ä¾‹å­çœ‹æ·±å…¥äº†è§£ä¸‹å§.</p>
<h4 id="1-_Counter">1. Counter</h4><p>ç¬¬ä¸€ä¸ªä¾‹å­æ¥æºäº<a href="https://github.com/mutualmobile/Counter" target="_blank" rel="external">Counter</a>ï¼Œæ˜¯ä¸€ä¸ªéå¸¸ç®€å•äº†è®¡æ•°åº”ç”¨ã€‚éº»é›€è™½å°ï¼Œå´äº”è„ä¿±å…¨ã€‚</p>
<p>æ‰“å¼€é¡¹ç›®ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿçš„è¿‡ä¸€ä¸‹é¡¹ç›®ç»“æ„ï¼š</p>
<pre><code>-<span class="ruby">- <span class="constant">CNTAppDelegate</span>.h/.m
</span>-<span class="ruby">- <span class="constant">CNTCountInteractorIO</span>.h
</span>-<span class="ruby">- <span class="constant">CNTCountInteractor</span>.h/.m
</span>-<span class="ruby">- <span class="constant">CNTCountPresenter</span>.h/.m
</span>-<span class="ruby">- <span class="constant">CNTCountView</span>.h
</span>-<span class="ruby">- <span class="constant">CNTCountViewController</span>.h/.m/.xib</span>
</code></pre><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æœ€ç®€å•çš„æ¨¡å—ï¼šCNTCountView</p>
<pre><code><span class="comment">// CNTCountView.h</span>
<span class="class"><span class="keyword">@protocol</span> <span class="title">CNTCountView</span> &lt;<span class="title">NSObject</span>&gt;</span>
- (<span class="keyword">void</span>)setCountText:(<span class="built_in">NSString</span>*)countText;
- (<span class="keyword">void</span>)setDecrementEnabled:(<span class="built_in">BOOL</span>)enabled;
<span class="keyword">@end</span>
</code></pre><p>å’¦ï¼Ÿä¸ºä»€ä¹ˆè¿™ä¸ªViewåªåŒ…å«ä¸€ä¸ªProtocolå‘¢ï¼Ÿè¯´å¥½çš„Viewç”¨æ¥æ¥æ”¶ä¼ é€’çš„å†…å®¹ç„¶åè¿›è¡Œå†…å®¹å±•ç¤ºå‘¢ï¼Ÿ</p>
<p>åŸå› æ˜¯è¿™æ ·ï¼šåœ¨iOSåº”ç”¨ä¸­ï¼Œä¸€ä¸ªæ— æ³•é¿å…çš„æ¨¡å—å°±æ˜¯ViewControllerï¼ˆ<strong>æ— è®ºå¦‚ä½•æ¯ä¸ªåº”ç”¨éƒ½å¿…é¡»å­˜åœ¨ä¸€ä¸ªRootViewController</strong>ï¼‰ã€‚æ¯ä¸ªViewControlleråŒ…å«ä¸€ä¸ªæ ¹Viewç”¨æ¥è¿›è¡Œè§†å›¾å±•ç¤ºã€‚å› æ­¤ï¼Œåœ¨å°†VIPERæ¶æ„åº”ç”¨åˆ°iOSé¢†åŸŸçš„è¿‡ç¨‹ä¸­ï¼Œå®é™…ä¸Šèµ·åˆ°Viewä½œç”¨çš„æ˜¯ViewControllerï¼(<b>å½“ç„¶ï¼ŒViewControllerä¸ä»…ä»…èµ·åˆ°äº†è§†å›¾å±•ç¤ºçš„ä½œç”¨</b>)</p>
<p><em>é¢˜å¤–è¯ï¼šæˆ‘ä¸ªäººè®¤ä¸ºè¿™ä¸ªä¾‹å­çš„å–åä¸å¤ªå¥½ï¼Œè®©äººè¿·æƒ‘ï¼Œå¦‚æœæ¢ä¸ªåå­—ï¼Œå¦‚CNTCountViewOperationå°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜äº†</em></p>
<p>æ—¢ç„¶å¦‚æ­¤ï¼Œè®©æˆ‘ä»¬èµ¶å¿«å»çœ‹çœ‹ç›¸å…³çš„ViewControllerï¼šCNTCountViewControllerä¸­çš„å®ç°ã€‚</p>
<pre><code><span class="comment">// CNTCountViewController.h</span>
<span class="class"><span class="keyword">@interface</span> <span class="title">CNTCountViewController</span> : <span class="title">UIViewController</span> &lt;<span class="title">CNTCountView</span>&gt;</span>
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">IBOutlet</span>    <span class="built_in">UILabel</span>*    countLabel;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">IBOutlet</span>    <span class="built_in">UIButton</span>*   decrementButton;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">IBOutlet</span>    <span class="built_in">UIButton</span>*   incrementButton;

<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)   CNTCountPresenter*  presenter;
<span class="keyword">@end</span>
</code></pre><p>åœ¨ä¸Šè¿°CNTCountViewControllerçš„å¤´æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥ç±»éµä»äº†CNTCountViewåè®®ã€‚å…¶æ¬¡ï¼Œä»–åŒ…å«äº†çœŸæ­£çš„Viewï¼šä¸¤ä¸ªUIButtonå’Œä¸€ä¸ªUILabelã€‚è¯´æ˜è¿™å’Œæˆ‘ä»¬ä¹‹å‰è¯´çš„ViewControllerèµ·åˆ°äº†çœŸæ­£çš„è§†å›¾å±•ç¤ºä½œç”¨æ˜¯å»åˆçš„ã€‚</p>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜çœ‹åˆ°äº†ä¸€ä¸ªéå¸¸æ˜¾çœ¼çš„ç±»ï¼š<strong>CNTCountPresenter</strong>ã€‚å¦‚æœè¿™ä¸ªç±»çš„å‘½åæ²¡é”™ï¼Œé‚£è¿™ä¸ªç±»å°±æ˜¯æ‰€è°“çš„Presenteräº†ï¼Œç”¨æ¥è¿›è¡Œç•Œé¢é€»è¾‘æ§åˆ¶çš„ç±»ã€‚é‚£ä¹ˆæ˜¯ä¸æ˜¯è¿™æ ·å‘¢ï¼Ÿæˆ‘ä»¬<em>Command + å·¦å‡»</em>è¿™ä¸ªç±»ä¸€æ¢ç©¶ç«Ÿï¼</p>
<pre><code><span class="comment">// CNTCountPresenter.h</span>
<span class="class"><span class="keyword">@interface</span> <span class="title">CNTCountPresenter</span> : <span class="title">NSObject</span> &lt;<span class="title">CNTCountInteractorOutput</span>&gt;</span>
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>)     <span class="keyword">id</span>&lt;CNTCountView&gt;            view;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)   <span class="keyword">id</span>&lt;CNTCountInteractorInput&gt; interactor;

- (<span class="keyword">void</span>)updateView;
- (<span class="keyword">void</span>)increment;
- (<span class="keyword">void</span>)decrement;
<span class="keyword">@end</span>
</code></pre><p>ä»CNTCountPresenterçš„å¤´æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬èƒ½çœ‹å‡ºå¾ˆå¤šé€»è¾‘å…³ç³»ã€‚PresenteråŒ…å«äº†ä¸€ä¸ªViewå’Œä¸€ä¸ªInteractorã€‚è¿™å’Œæ–‡é¦–æˆ‘ä»¬å¯¹äºVIPERçš„ä»‹ç»ç›¸å»åˆï¼šPresenterä»Interactorè·å–æ•°æ®ï¼Œç»è¿‡ç•Œé¢é€»è¾‘å¤„ç†åï¼Œå°†æ•°æ®å‘é€ç»™Viewè¿›è¡Œå±•ç¤ºã€‚</p>
<p>ä»Interactorè¯·æ±‚è·å–æ•°æ®çš„éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code><span class="comment">// CNTCountPresenter.m</span>
<span class="tag">-</span> (void)<span class="tag">updateView</span>
{
    <span class="attr_selector">[self.interactor requestCount]</span>;
}

<span class="tag">-</span> (void)<span class="tag">increment</span>
{
    <span class="attr_selector">[self.interactor increment]</span>;
}

<span class="tag">-</span> (void)<span class="tag">decrement</span>
{
    <span class="attr_selector">[self.interactor decrement]</span>;
}
</code></pre><p>ç”±äºPresenterä»Interactorè·å–æ•°æ®ï¼Œé‚£ä¹ˆåŠ¿å¿…Presenteræ˜¯Interactorçš„ä¸€ä¸ªè¾“å‡ºï¼Œè€ŒInteractoræ˜¯Presenterçš„ä¸€ä¸ªè¾“å…¥ã€‚</p>
<pre><code><span class="comment">// CNTCountInteractorIO.h</span>
<span class="class"><span class="keyword">@protocol</span> <span class="title">CNTCountInteractorInput</span> &lt;<span class="title">NSObject</span>&gt;</span>
- (<span class="keyword">void</span>)requestCount;
- (<span class="keyword">void</span>)increment;
- (<span class="keyword">void</span>)decrement;
<span class="keyword">@end</span>

<span class="class"><span class="keyword">@protocol</span> <span class="title">CNTCountInteractorOutput</span> &lt;<span class="title">NSObject</span>&gt;</span>
- (<span class="keyword">void</span>)updateCount:(<span class="built_in">NSUInteger</span>)count;
<span class="keyword">@end</span>
</code></pre><p><em><b>è¿™é‡Œå„ä½å¯ä»¥å…ˆä¸å…³æ³¨Protocolåè®®çš„è®¾è®¡æœ¬èº«ï¼Œåªè¦ç†è§£é€»è¾‘å…³ç³»å³å¯ã€‚</b></em></p>
<p>é€šè¿‡è¿™æ ·çš„èŒè´£åˆ’åˆ†ï¼Œè½å…¥åˆ°Interactorç±»ä¸­çš„èŒè´£å°±æ˜¯æœ€åŸºæœ¬çš„ä¸šåŠ¡é€»è¾‘ï¼šè®¡æ•°çš„å¢åŠ å’Œå‡å°‘ã€‚</p>
<pre><code><span class="comment">// CNTCountInteractor.h</span>
- (<span class="keyword">void</span>)requestCount
{
    [<span class="keyword">self</span> sendCount];
}

- (<span class="keyword">void</span>)increment
{
    ++<span class="keyword">self</span><span class="variable">.count</span>;
    [<span class="keyword">self</span> sendCount];
}

- (<span class="keyword">void</span>)decrement
{
    <span class="keyword">if</span> ([<span class="keyword">self</span> canDecrement])
    {
        --<span class="keyword">self</span><span class="variable">.count</span>;
        [<span class="keyword">self</span> sendCount];
    }
}
</code></pre><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†Counterçš„é¡¹ç›®æ¶æ„è¿›è¡Œå¦‚ä¸‹è¡¨ç¤ºï¼š</p>
<p>Interactor &lt;â€”â€”â€“&gt; Presenter</p>
<ul>
<li><strong>Interactor</strong> æ˜¯ <strong>Presenter</strong>  çš„ <b>è¾“å…¥</b></li>
<li><strong>Presenter</strong>  æ˜¯ <strong>Interactor</strong> çš„ <b>è¾“å‡º</b></li>
<li><strong>Presenter</strong> é€šè¿‡æŸäº›äº‹ä»¶è§¦å‘ï¼Œå»å‘å…¶è¾“å…¥<strong>Interactor</strong>è¯·æ±‚æ•°æ®</li>
</ul>
<p>Presenter &lt;â€”â€”â€“&gt; View(ViewController)</p>
<ul>
<li><strong>View</strong>       æ˜¯ <strong>Presenter</strong>  çš„ <b>è¾“å‡º</b></li>
<li><strong>ViewController</strong> è§¦å‘äº† <strong>Presenter</strong> å»<strong>Interactor</strong>ä¸­è¯·æ±‚æ–°çš„ä¸šåŠ¡ç»“æœï¼Œä»è€Œæ›´æ–°<strong>View</strong></li>
</ul>
<p>Presenteræ›´æ–°Viewçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code><span class="comment">// CNTCountPresenter.m</span>
<span class="tag">-</span> (void)<span class="tag">updateCount</span>:(NSUInteger)<span class="tag">count</span>
{
    <span class="attr_selector">[self.view setCountText:[self formattedCount:count]</span>];
    <span class="attr_selector">[self.view setDecrementEnabled:[self canDecrementCount:count]</span>];
}
</code></pre><p>åˆ°è¿™é‡Œï¼ŒCounterè¿™ä¸ªä¾‹å­çš„è§£è¯»åŸºæœ¬å°±å®Œæˆäº†ã€‚ç»†å¿ƒçš„è¯»è€…ä¸€å®šä¼šå‘ç°ï¼Œ<strong>Entity</strong>å’Œ<strong>Route</strong>åˆ°å“ªé‡Œå»äº†ï¼Ÿ</p>
<p>æ˜¯çš„ï¼Œè¿™ä¸ªä¾‹å­ç”±äºè¿‡äºç®€å•ï¼Œå‹æ ¹ä¸éœ€è¦Entityã€‚å¹¶ä¸”ç”±äºå®ƒæ˜¯å•è§†å›¾åº”ç”¨ï¼Œå‹æ ¹ä¸æ¶‰åŠåˆ°é¡µé¢åˆ‡æ¢ï¼Œå› æ­¤ä¹Ÿæ— é¡»RouteåŠŸèƒ½ã€‚ä¸è¿‡æˆ‘ä»¬åœ¨åç»­çš„æµ…å…¥æµ…å‡ºVIPERæ¶æ„ï¼ˆ2ï¼‰ä¸­è§£è¯»ä¸€ä¸ªæ›´ç»†è‡´æ›´è´Ÿè´£çš„ä¾‹å­ï¼Œæ•¬è¯·æœŸå¾…ï¼</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/11/05/Understand-Viper/" data-id="cjqdxq1ye001bmxi1ch6ar9rk" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/11/05/Understand-Viper/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-Object-Path-Source-Code" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/05/Object-Path-Source-Code/" class="article-date">
  <time datetime="2015-11-04T16:18:02.000Z" itemprop="datePublished">2015-11-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/05/Object-Path-Source-Code/">Object-Path æºç è§£è¯»</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Object-Path">Object-Path</h3><p>ä»Šå¤©çœ‹åˆ°äº†ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„JavaScriptåº“ï¼Œä¹ä¸€çœ‹æœ‰ç‚¹iOS keypath chainçš„æ„æ€ï¼Œåå­—å«Object-Pathï¼Œ<a href="https://github.com/mariocasciaro/object-path" target="_blank" rel="external">åœ°å€ç‚¹æˆ‘</a>ï¼Œä¸»è¦çš„åŠŸèƒ½åŒ…å«äº†ï¼š</p>
<ul>
<li>Set</li>
<li>Get</li>
<li>Del</li>
<li>Empty </li>
<li>Insert </li>
<li>EnsureExist</li>
<li>Push</li>
</ul>
<p>ä»å®ƒçš„Exampleä¸­æˆ‘ä»¬å¯ä»¥å…ˆä¸€è§ˆå®ƒçš„åŠŸèƒ½ï¼š</p>
<pre><code><span class="keyword">var</span> obj = {
  a: {
    b: <span class="string">"d"</span>,
    c: [<span class="string">"e"</span>, <span class="string">"f"</span>],
    <span class="string">'\u1200'</span>: <span class="string">'unicode key'</span>,
    <span class="string">'dot.dot'</span>: <span class="string">'key'</span>
  }
};

<span class="keyword">var</span> objectPath = require(<span class="string">"object-path"</span>);

<span class="comment">//get deep property</span>
objectPath.<span class="keyword">get</span>(obj, <span class="string">"a.b"</span>);  <span class="comment">//returns "d"</span>
objectPath.<span class="keyword">get</span>(obj, [<span class="string">"a"</span>, <span class="string">"dot.dot"</span>]);  <span class="comment">//returns "key"</span>
objectPath.<span class="keyword">get</span>(obj, <span class="string">'a.\u1200'</span>);  <span class="comment">//returns "unicode key"</span>
</code></pre><p>ä»è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å¯¹äºä¸€ä¸ªObject <strong>obc</strong>ï¼Œé™¤äº†é»˜è®¤çš„ç›´æ¥é€šè¿‡ç‚¹ <strong>.</strong>æ–¹å¼è®¿é—®ä¸€ä¸ªå±æ€§å¤–ï¼Œ å¦‚obj.aã€‚æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ç‚¹ <strong>.</strong> æ¥è¿›è¡Œ<strong>â€œé“¾å¼â€</strong>è®¿é—®å…¶å±æ€§çš„å±æ€§ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰ï¼Œå¦‚obj.a.bã€‚è¿™çœ‹èµ·æ¥çœŸçš„å’ŒiOSä¸­çš„keypath codingéå¸¸ç›¸ä¼¼ï¼Œæ‰€ä»¥ï¼Œä»Šå¤©å°±è®©æˆ‘ä»¬æ¥åˆ†æä¸‹å…¶å®ç°å§ï¼</p>
<h3 id="æºç è§£æ">æºç è§£æ</h3><h4 id="Setæ–¹æ³•">Setæ–¹æ³•</h4><pre><code>ä¾‹å­ï¼šobjectPath.<span class="keyword">set</span>(obj, <span class="string">"a.h"</span>, <span class="string">"m"</span>); 
</code></pre><p>Setæ–¹æ³•æ˜¯ç”¨æ¥ç»™objçš„æŸä¸ª<strong>â€œé“¾å¼â€</strong>å±æ€§è¿›è¡Œèµ‹å€¼çš„ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<pre><code><span class="function">function <span class="title">set</span><span class="params">(obj, path, value, doNotReplace)</span></span>{
     <span class="comment">// 1. </span>
    <span class="keyword">if</span> (isNumber(path)) {
      path = [path];
    }

    <span class="comment">// 2.</span>
    <span class="keyword">if</span> (isEmpty(path)) {
      <span class="keyword">return</span> obj;
    }

    <span class="comment">// 3.</span>
    <span class="keyword">if</span> (isString(path)) {
      <span class="keyword">return</span> <span class="built_in">set</span>(obj, path.split(<span class="string">'.'</span>).<span class="built_in">map</span>(getKey), value, doNotReplace);
    }

    <span class="comment">// 4.</span>
    var currentPath = path[<span class="number">0</span>];

    <span class="keyword">if</span> (path.length === <span class="number">1</span>) {
      var oldVal = obj[currentPath];
      <span class="keyword">if</span> (oldVal === <span class="keyword">void</span> <span class="number">0</span> || !doNotReplace) {
        obj[currentPath] = value;
      }
      <span class="keyword">return</span> oldVal;
    }

     <span class="comment">// 5.</span>
    <span class="keyword">if</span> (obj[currentPath] === <span class="keyword">void</span> <span class="number">0</span>) {
      <span class="comment">//check if we assume an array</span>
      <span class="keyword">if</span>(isNumber(path[<span class="number">1</span>])) {
        obj[currentPath] = [];
      } <span class="keyword">else</span> {
        obj[currentPath] = {};
      }
    }

    <span class="keyword">return</span> <span class="built_in">set</span>(obj[currentPath], path.slice(<span class="number">1</span>), value, doNotReplace);
  }
</code></pre><ul>
<li><ol>
<li>åˆ¤æ–­ä¼ å…¥çš„pathæ˜¯å¦æ˜¯Numberç±»å‹ï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼Œæ„å»ºä¸€ä¸ªåŒ…å«è¿™ä¸ªpathdeæ•°ç»„ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¦è¿™æ ·å¤„ç†ï¼Œåœ¨ä¸‹æ–‡è§£é‡Šã€‚<strong>æ³¨ï¼šJavaScriptä¸­ä¸å­˜åœ¨æµ®ç‚¹æ•°ã€æ•´æ•°ç­‰ç­‰ä¸åŒæ•°å€¼ç±»å‹ï¼Œç»Ÿä¸€ä¸ºNumber</strong></li>
</ol>
</li>
<li><ol>
<li>åˆ¤æ–­ä¼ å…¥çš„pathæ˜¯ä¸æ˜¯â€œç©ºâ€ï¼Œç©ºçš„æƒ…å†µåŒ…å«ï¼šundefinedï¼Œç©ºæ•°ç»„ï¼Œæ²¡æœ‰ä»»ä½•è‡ªèº«å±æ€§çš„å¯¹è±¡ã€‚ä¸‹æ–‡æˆ‘ä»¬ä¼šè¯¦ç»†æŸ¥çœ‹<strong>isEmpty</strong>çš„å®ç°ã€‚</li>
</ol>
</li>
<li><ol>
<li>åˆ¤æ–­æ˜¯å¦æ˜¯å­—ç¬¦ä¸²ï¼Œå¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°±é€šè¿‡<strong>â€œ.â€</strong>è¿›è¡Œåˆ†å‰²ï¼Œåˆ†å‰²å®Œæˆæ„å»ºæ•°ç»„ï¼Œç„¶åè¿›è¡Œsetæ–¹æ³•çš„é‡æ–°è°ƒç”¨ã€‚</li>
</ol>
</li>
<li><ol>
<li>åˆ¤æ–­æ˜¯å¦å½“å‰pathæ·±åº¦åªä¸ºä¸€å±‚ï¼Œ<em>var currentPath = path[0]</em>ï¼Œå¦‚æœæ˜¯ä¸€å±‚çš„è¯ï¼Œæ ¹æ®æ˜¯å¦è¦doNotReplaceè¿›è¡Œå€¼çš„æ›¿æ¢ã€‚</li>
</ol>
</li>
</ul>
<p>è¿™é‡Œæœ‰ä¸ªå¾ˆæœ‰æ„æ€çš„å®ç° <strong>oldVal === void 0</strong>ï¼Œvoid 0æ˜¯ä»€ä¹ˆé¬¼ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šçœ‹è§<strong>JavaScript::void(0)ä»£è¡¨ç½‘é¡µçš„æ­»é“¾æ¥</strong>ï¼Œé‚£ä¹ˆoldVal == void 0åˆæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p>
<p><strong>å…¶å®ï¼Œvoid 0å°±æ˜¯undefinedï¼</strong>åœ¨ç°ä»£çš„æµè§ˆå™¨ä¸­ï¼Œå®ƒä»¬ä¸¤å·²ç»å®Œå…¨çš„ç­‰åŒäº†ã€‚è€Œå†™æˆvoid 0çš„å½¢å¼ï¼Œæ˜¯ä¸ºäº†å…¼å®¹ã€‚åœ¨è¿‡å»çš„æµè§ˆå™¨ä¸­ï¼Œundefinedä¸æ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œå®ƒæ˜¯ä¸ªå…¨å±€å˜é‡ã€‚å› æ­¤ï¼Œä½ å®Œå…¨å¯ä»¥å¾’æ‰‹æ”¹å˜å®ƒçš„å«ä¹‰ï¼Œ</p>
<pre><code><span class="keyword">var</span> <span class="literal">undefined</span> = <span class="number">1</span>;
<span class="built_in">console</span>.log(<span class="literal">undefined</span>);
</code></pre><p>è¿™æ ·çš„æ”¹å˜ï¼Œå°±ä¼šundefinedåŸæœ¬çš„å«ä¹‰é”™ä¹±ã€‚è€Œ<strong>ç”±äºvoidæ˜¯ä¸€ä¸ªæ“ä½œç¬¦ï¼Œä½ æ— æ³•æ”¹å†™å®ƒçš„å«ä¹‰ï¼Œå› æ­¤void 0æ˜¯ä¸€ç§æ›´å®‰å…¨çš„å†™æ³•ï¼</strong></p>
<p>åœ¨è¿™é‡Œçš„å«ä¹‰å°±æ˜¯ï¼Œåˆ¤æ–­<strong>oldVal === void 0</strong>æ˜¯ä¸æ˜¯æœªå®šä¹‰ç½¢äº†ã€‚</p>
<ul>
<li><ol>
<li>å¦‚æœä¸æ˜¯ä¸€å±‚æ·±åº¦çš„pathï¼Œå¹¶ä¸”å½“å‰çš„obj[currentPath]æ˜¯æœªå®šä¹‰çš„ã€‚é‚£ä¹ˆå°±éœ€è¦åˆ¤æ–­path[1]ï¼Œä¹Ÿå°±æ˜¯pathæ•°ç»„ä¸­çš„ç¬¬äºŒä¸ªå±æ€§æ˜¯ä»€ä¹ˆäº†ã€‚<strong>å¦‚æœæ˜¯æ•°å­—ï¼Œå°±å°†obj[currentPath]æ„å»ºä¸ºæ•°ç»„ï¼»ï¼½ï¼Œå¦åˆ™æ„å»ºä¸€ä¸ªå¯¹è±¡ï½›ï½ã€‚</strong></li>
</ol>
</li>
</ul>
<p>ä¸ºä»€ä¹ˆè¦åˆ†å¼€å¤„ç†å‘¢ï¼Ÿè¿™é‡Œå°±éœ€è¦æåŠJavaScriptè®¿é—®å±æ€§çš„ä¸€ä¸ªç‰¹åˆ«çš„åœ°æ–¹ã€‚å¯¹äºå¦‚ä¸‹è¿™æ ·ä¸€ä¸ªå¯¹è±¡ï¼Œ</p>
<pre><code><span class="keyword">var</span> obj = <span class="comment">{a:5}</span>
</code></pre><p>æ¥è¯´ï¼Œæˆ‘ä»¬å®ç°<strong>obj.a æˆ–è€… obj[â€œaâ€]</strong>éƒ½å¯ä»¥è·å¾—æ­£ç¡®çš„ç»“æœ5ï¼Œä½†æ˜¯å¯¹äºå¦ä¸€ä¸ªå¯¹è±¡ï¼Œ</p>
<pre><code>var obj = {<span class="number">1</span>: <span class="number">5</span>}
</code></pre><p>æˆ‘ä»¬åªèƒ½ä½¿ç”¨obj[â€œ1â€]çš„æ–¹å¼æ¥è®¿é—®ç»“æœ5ï¼Œè€Œä¸èƒ½ä½¿ç”¨obj.1ã€‚å¦‚æœä½¿ç”¨obj.1ï¼Œå°±èƒ½æŠ¥é”™è¯¯ï¼š<div style="color:red">Uncaught SyntaxError: Unexpected number(â€¦)</div></p>
<p>ç©¶å…¶åŸå› ï¼Œå°±åœ¨äºJavaScriptåœ¨å¤„ç†å¯¹è±¡çš„keyçš„æ—¶å€™ï¼Œéƒ½æ˜¯å°†keyå½“æˆå­—ç¬¦ä¸²å¤„ç†çš„ã€‚</p>
<p>æ‰€ä»¥ï¼Œåœ¨è¿™é‡Œæ„å»ºå®Œç›¸å¯¹åº”çš„ä¸‹ä¸€å±‚çº§obj[currrentPath]ï¼Œé€’å½’è°ƒç”¨setæ–¹æ³•å³å¯ã€‚</p>
<h4 id="Delæ–¹æ³•">Delæ–¹æ³•</h4><pre><code><span class="function">function <span class="title">del</span><span class="params">(obj, path)</span> </span>{
    <span class="keyword">if</span> (isNumber(path)) {
     path = [path];
    }

    <span class="keyword">if</span> (isEmpty(obj)) {
     <span class="keyword">return</span> <span class="keyword">void</span> <span class="number">0</span>;
    }

    <span class="keyword">if</span> (isEmpty(path)) {
     <span class="keyword">return</span> obj;
    }

    <span class="keyword">if</span>(isString(path)) {
     <span class="keyword">return</span> del(obj, path.split(<span class="string">'.'</span>));
    }

    <span class="comment">// é‡ç‚¹</span>
    var currentPath = getKey(path[<span class="number">0</span>]);
    var oldVal = obj[currentPath];

    <span class="keyword">if</span>(path.length === <span class="number">1</span>) {
     <span class="keyword">if</span> (oldVal !== <span class="keyword">void</span> <span class="number">0</span>) {
       <span class="keyword">if</span> (isArray(obj)) {
         obj.splice(currentPath, <span class="number">1</span>);
       } <span class="keyword">else</span> {
         <span class="keyword">delete</span> obj[currentPath];
       }
     }
    } <span class="keyword">else</span> {
     <span class="keyword">if</span> (obj[currentPath] !== <span class="keyword">void</span> <span class="number">0</span>) {
       <span class="keyword">return</span> del(obj[currentPath], path.slice(<span class="number">1</span>));
     }
    }

    <span class="keyword">return</span> obj;
}
</code></pre><p>è®©æˆ‘ä»¬å†æ¥çœ‹çœ‹Delæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨äºâ€œé“¾å¼â€åˆ é™¤ä¸€äº›å±æ€§å¯¹åº”çš„å€¼ã€‚ç”±äºä¹‹å‰çš„é€»è¾‘å’ŒSetç±»ä¼¼ï¼Œæˆ‘ä»¬ç›´æ¥ä»é‡ç‚¹å¼€å§‹çœ‹èµ·ã€‚</p>
<ul>
<li>é¦–å…ˆå…ˆä»path[0]ä¸­è·å–keyï¼Œç„¶åå–å‡ºå¯¹åº”çš„oldValã€‚</li>
<li><p>å¦‚æœpathæ·±åº¦ä¸º1ï¼Œå¹¶ä¸”oldValä¸æ˜¯æœªå®šä¹‰çš„è¯ï¼Œç©¶è¿›è¡Œåˆ é™¤ï¼Œåˆ é™¤åˆ†ä¸ºä¸¤ç§ï¼š</p>
<p>ï¼ˆ1ï¼‰å¦‚æœæ˜¯æ•°ç»„çš„è¯,é€šè¿‡spliceåˆ é™¤æ•°ç»„ä¸­currentPathä½ç½®ä¸Šçš„å±æ€§å€¼<br>ï¼ˆ2ï¼‰å¦‚æœæ˜¯objectï¼Œç›´æ¥è¿›è¡Œåˆ é™¤å³å¯</p>
</li>
<li><p>å¦‚æœæ·±åº¦ä¸ä¸º1ï¼Œå¹¶ä¸”oldValueä¸æ˜¯æœªå®šä¹‰ï¼Œé€’å½’è°ƒç”¨delå‡½æ•°å³å¯ã€‚</p>
</li>
</ul>
<p>è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬çœ‹åˆ°åœ¨è·å–currentPathçš„è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨äº†getKeyè¿™ä¸ªå‡½æ•°ï¼Œè®©æˆ‘ä»¬èµ¶ç´§å»çœ‹çœ‹è¿™ä¸ªgetKeyçš„å®ç°ã€‚</p>
<pre><code><span class="function"><span class="keyword">function</span> <span class="title">getKey</span>(<span class="params">key</span>)</span>{
    <span class="keyword">var</span> intKey = <span class="built_in">parseInt</span>(key);
    <span class="keyword">if</span> (intKey.toString() === key) {
      <span class="keyword">return</span> intKey;
    }
    <span class="keyword">return</span> key;
} 
</code></pre><p>è¿™é‡Œçš„é€»è¾‘ä¸éš¾ç†è§£ï¼Œé€šè¿‡parseIntå°†keyè½¬æˆæ•´å‹ï¼Œå¦‚æœè½¬æ¢åçš„ç»“æœé€šè¿‡toStringå‡½æ•°å’ŒåŸæœ‰çš„keyä¸€è‡´ï¼Œå°±ç›´æ¥è¿”å›æ•´å½¢ï¼Œå¦åˆ™è¿”å›åŸæœ‰çš„keyã€‚<strong>é€šè¿‡===(å¼ºç­‰äºå·)ä¸éš¾ç†è§£ï¼Œè¿™é‡Œifçš„æ»¡è¶³æ¡ä»¶å½“ä¸”ä»…å½“keyæœ¬èº«æ˜¯stringç±»å‹ï¼ŒåŒæ—¶å…¶å€¼æ˜¯ä¸ªæ•´æ•°æ‰å¯ä»¥æ»¡è¶³ï¼Œå¦‚â€5â€ç­‰ï¼Œåƒç±»ä¼¼â€a.2â€, â€œ5.5â€å°±ä¸ä¼šæ»¡è¶³ã€‚</strong></p>
<p>å‰©ä¸‹çš„è¯¸å¦‚Get, Hasæ–¹æ³•ï¼Œå®ç°éƒ½å¤§åŒå°å¼‚ï¼Œæˆ‘ä»¬å°±ä¸å†ä¸€ä¸€è§£è¯»äº†ï¼Œå¤§å®¶æœ‰å…´è¶£å¯ä»¥è‡ªè¡Œé˜…è¯»ã€‚</p>
<h3 id="è¡¥å……çŸ¥è¯†ï¼šJavaScriptç±»å‹åˆ¤æ–­">è¡¥å……çŸ¥è¯†ï¼šJavaScriptç±»å‹åˆ¤æ–­</h3><pre><code><span class="function"><span class="keyword">function</span> <span class="title">isNumber</span><span class="params">(value)</span></span>{
  <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">'number'</span> || toString(value) === <span class="string">"[object Number]"</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">isString</span><span class="params">(obj)</span></span>{
  <span class="keyword">return</span> <span class="keyword">typeof</span> obj === <span class="string">'string'</span> || toString(obj) === <span class="string">"[object String]"</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">isObject</span><span class="params">(obj)</span></span>{
  <span class="keyword">return</span> <span class="keyword">typeof</span> obj === <span class="string">'object'</span> &amp;&amp; toString(obj) === <span class="string">"[object Object]"</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">isArray</span><span class="params">(obj)</span></span>{
  <span class="keyword">return</span> <span class="keyword">typeof</span> obj === <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> obj.length === <span class="string">'number'</span> &amp;&amp; toString(obj) === <span class="string">'[object Array]'</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">isBoolean</span><span class="params">(obj)</span></span>{
  <span class="keyword">return</span> <span class="keyword">typeof</span> obj === <span class="string">'boolean'</span> || toString(obj) === <span class="string">'[object Boolean]'</span>;
}
</code></pre><p>åœ¨Object-Pathçš„å®ç°ä¸­ï¼Œå¤§é‡çš„ç±»å‹åˆ¤æ–­å·¥ä½œéƒ½æ˜¯é€šè¿‡å¦‚ä¸Šä¸€äº›å‡½æ•°æ¥æå®šçš„ã€‚æœ‰äººä¼šé—®äº†ï¼Œåˆ¤æ–­ä¸€ä¸ªç±»å‹ä¸ºå•¥è¦è¿™ä¹ˆéº»çƒ¦ï¼Œç›´æ¥ç”¨instanceOfæˆ–è€…typeofä¸å¯ä»¥å—ï¼Ÿ</p>
<ul>
<li>ç”¨instanceOfæ˜¯è‚¯å®šé”™è¯¯çš„ï¼Œå¦‚æœè¢«åˆ¤æ–­çš„å¯¹è±¡ä¸å¤„äºåŒä¸€ä¸ªé¡µé¢ï¼Œé‚£ä¹ˆinstanceOfå°±è‚¯å®šå¤±æ•ˆäº†ã€‚</li>
</ul>
<blockquote><br>æ¯”å¦‚ï¼Œä¸€ä¸ªé¡µé¢ï¼ˆçˆ¶é¡µé¢ï¼‰æœ‰ä¸€ä¸ªæ¡†æ¶ï¼Œæ¡†æ¶ä¸­å¼•ç”¨äº†ä¸€ä¸ªé¡µé¢ï¼ˆå­é¡µé¢ï¼‰ï¼Œåœ¨å­é¡µé¢ä¸­å£°æ˜äº†ä¸€ä¸ªarrayï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™çˆ¶é¡µé¢çš„ä¸€ä¸ªå˜é‡ï¼Œè¿™æ—¶åˆ¤æ–­è¯¥å˜é‡æ˜¯å¦æ˜¯arrayç±»å‹ï¼Œå°±æ˜¯å¤±è´¥<br></blockquote>

<ul>
<li>ç”¨typeofçš„ç¼ºé™·åœ¨äºï¼ŒJavaScriptä¸­å­˜åœ¨åŸºæœ¬ç±»å‹å’ŒåŒ…è£…ç±»å‹ï¼Œå¯¹äºæ•°å€¼5æ¥è¯´ï¼Œå®ƒæ˜¯åŸºæœ¬ç±»å‹Numberï¼Œé€šè¿‡typeofå¯ä»¥å‡†å¤‡çš„åˆ¤æ–­å‡ºã€‚ä½†æ˜¯å¦‚æœæ˜¯åŒ…è£…å¯¹è±¡<b>var k = new Number(5)</b>ï¼Œåœ¨æ„ä¹‰ä¸Šå…¶ä»ç„¶åº”è¯¥æ˜¯å±äºæ•°å€¼ç±»å‹ï¼Œä½†æ˜¯é€šè¿‡typeofè·å¾—çš„ç»“æœæ˜¯objectï¼Œå› æ­¤å°±ä¸æ­£ç¡®ã€‚</li>
</ul>
<p><strong>æ‰€ä»¥ï¼Œåœ¨è¿™é‡Œçš„å®ç°ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†Object.prototype.toString.call(obj)çš„æ–¹å¼æ¥è·å–æ­£ç¡®çš„ç±»å‹ã€‚</strong></p>
<p>å˜¿å˜¿ï¼Œä»Šå¤©å°±åˆ°è¿™é‡Œå•¦ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/11/05/Object-Path-Source-Code/" data-id="cjqdxq2020024mxi1iql80cxg" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/11/05/Object-Path-Source-Code/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-Learn-Android-Day-by-Day" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/29/Learn-Android-Day-by-Day/" class="article-date">
  <time datetime="2015-10-29T11:52:44.000Z" itemprop="datePublished">2015-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/29/Learn-Android-Day-by-Day/">å¤§èœæ¯”å­¦å®‰å“</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>æœ¬äººæ–°æ‰‹ï¼Œå­¦ä¹ å®‰å“ï¼Œè¿™é‡Œç”¨æ¥è®°å½•ä¸€ä¸‹é˜…è¯»ã€Šç¬¬ä¸€è¡Œä»£ç ã€‹çš„ç¬”è¯•å’Œä½“ä¼šã€‚</p>
<ol>
<li>åœ¨XMLå¼•å…¥ä¸€ä¸ªidï¼Œå°±ä½¿ç”¨@id/id_nameï¼Œå¦‚æœè¦æ·»åŠ ä¸€ä¸ªidï¼Œå°±ä½¿ç”¨@+id/id_name</li>
<li>ç»™ä¸»æ´»åŠ¨æŒ‡å®šçš„Labelä¸ä»…ä¼šæˆä¸ºæ ‡é¢˜æ ä¸­çš„å†…å®¹ï¼Œè¿˜ä¼šæˆä¸ºLauncherä¸­åº”ç”¨ç¨‹åºæ˜¾ç¤ºçš„åç§°ã€‚</li>
<li>Intent è°ƒç”¨StartActivityForResultç”¨æ¥ç»™ä¸Šä¸€å±‚Activityè¿”å›æ•°æ®</li>
<li>æ´»åŠ¨çš„ç”Ÿå­˜æœŸ</li>
</ol>
<ul>
<li>è¿è¡ŒçŠ¶æ€ï¼Œå½“ä¸€ä¸ªæ´»åŠ¨å¤„äºè¿”å›æ ˆçš„æ ˆé¡¶æ—¶ï¼Œå°±å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œç³»ç»Ÿæœ€ä¸æ„¿æ„å›æ”¶çš„å°±æ˜¯å¤„äºè¿è¡ŒçŠ¶æ€çš„æ´»åŠ¨ã€‚</li>
<li>æš‚åœçŠ¶æ€ï¼Œå½“ä¸€ä¸ªæ´»åŠ¨ä¸å¤„äºæ ˆé¡¶ä½ç½®ï¼Œä½†æ˜¯ä»ç„¶å¯è§çš„æ—¶å€™ï¼Œå°±è¿›å…¥äº†æš‚åœçŠ¶æ€ï¼ˆå› ä¸ºæœ‰äº›æ´»åŠ¨ï¼Œå¦‚å¯¹è¯æ¡†ç­‰ï¼Œå°±ä¸ä¼šå æ®æ•´ä¸ªå±å¹•ï¼Œå› æ­¤å…¶ä»–æ´»åŠ¨ä»ç„¶å¯è§ï¼‰</li>
<li>åœæ­¢çŠ¶æ€ï¼Œå½“ä¸€ä¸ªæ´»åŠ¨ä¸å†å¤„äºæ ˆé¡¶ä½ç½®ï¼Œå¹¶ä¸”å®Œå…¨ä¸å¯è§çš„æ—¶å€™ï¼Œå°±è¿›å…¥äº†åœæ­¢çŠ¶æ€ã€‚</li>
<li>é”€æ¯çŠ¶æ€ï¼Œå½“ä¸€ä¸ªæ´»åŠ¨ä»è¿”å›æ ˆä¸­è¢«ç§»é™¤åï¼Œå°±è¿›å…¥äº†é”€æ¯çŠ¶æ€ã€‚</li>
</ul>
<ol>
<li>æ´»åŠ¨ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°</li>
</ol>
<ul>
<li>onCreateåœ¨æ´»åŠ¨ç¬¬ä¸€æ¬¡åˆ›å»ºçš„æ—¶å€™è°ƒç”¨</li>
<li>onStartåœ¨æ´»åŠ¨ç”±ä¸å¯è§å˜æˆå¯è§çš„æ—¶å€™è°ƒç”¨</li>
<li>onResumeåœ¨æ´»åŠ¨å‡†å¤‡å¥½å’Œç”¨æˆ·è¿›è¡Œäº¤äº’çš„æ—¶å€™è°ƒç”¨ï¼Œæ­¤æ—¶çš„æ´»åŠ¨ä¸€å®šä½äºæ ˆçš„æ ˆé¡¶ï¼Œä¸”å¤„äºè¿è¡ŒçŠ¶æ€ã€‚</li>
<li>onPauseåœ¨ç³»ç»Ÿå‡†å¤‡å»å¯åŠ¨æˆ–è€…æ¢å¤å¦ä¸€ä¸ªæ´»åŠ¨çš„æ—¶å€™è°ƒç”¨ã€‚</li>
<li>onStopåœ¨æ´»åŠ¨å®Œå…¨ä¸å¯è§çš„æ—¶å€™è°ƒç”¨ã€‚</li>
<li>onDestoryåœ¨æ´»åŠ¨è¢«é”€æ¯ä¹‹å‰è°ƒç”¨ï¼Œä¹‹åçš„æ´»åŠ¨å˜ä¸ºé”€æ¯çŠ¶æ€ã€‚</li>
<li>onRestartåœ¨æ´»åŠ¨ç”±åœæ­¢çŠ¶æ€å˜ä¸ºè¿è¡ŒçŠ¶æ€ä¹‹å‰è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯æ´»åŠ¨è¢«é‡æ–°å¯åŠ¨äº†ã€‚</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/10/29/Learn-Android-Day-by-Day/" data-id="cjqdxq20r002imxi1xdk2999o" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/10/29/Learn-Android-Day-by-Day/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-Swift-Count-Down-Label" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/29/Swift-Count-Down-Label/" class="article-date">
  <time datetime="2015-10-28T18:54:23.000Z" itemprop="datePublished">2015-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/29/Swift-Count-Down-Label/">Swiftæ¯æ—¥ä¸€ç»ƒï¼šé‡å†™UICountingLabel</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ä»Šå¤©Swiftç»ƒä¹ çš„æ˜¯å‡†å¤‡å°è¯•æŠŠ<a href="https://github.com/dataxpress/UICountingLabel/blob/master/UICountingLabel.m" target="_blank" rel="external">UICountingLabel</a>è¿™ä¸ªGithub Staræ•°è¶…è¿‡500çš„åº“ç”¨Swifté‡å†™ä¸€éã€‚</p>
<h3 id="UICountingLabelæºç è§£æ">UICountingLabelæºç è§£æ</h3><p>æ•´ä¸ªuICountingLabelçš„æœ¬è´¨å°±æ˜¯åŸºäºä¸€ä¸ªNSTimeræ¥è®¡ç®—å½“å‰æ—¶é—´å†…åº”è¯¥æ˜¾ç¤ºä»€ä¹ˆå€¼ï¼Œ</p>
<pre><code>- (<span class="built_in">CGFloat</span>)currentValue {

    <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.progress</span> &gt;= <span class="keyword">self</span><span class="variable">.totalTime</span>) {
        <span class="keyword">return</span> <span class="keyword">self</span><span class="variable">.destinationValue</span>;
    }

    <span class="built_in">CGFloat</span> percent = <span class="keyword">self</span><span class="variable">.progress</span> / <span class="keyword">self</span><span class="variable">.totalTime</span>;
    <span class="built_in">CGFloat</span> updateVal = [<span class="keyword">self</span><span class="variable">.counter</span> update:percent];
    <span class="keyword">return</span> <span class="keyword">self</span><span class="variable">.startingValue</span> + (updateVal * (<span class="keyword">self</span><span class="variable">.destinationValue</span> - <span class="keyword">self</span><span class="variable">.startingValue</span>));
}
</code></pre><p>è¿™ä¸ªå€¼é€šè¿‡ä¸åŒçš„æ’å€¼æ–¹å¼å¾—åˆ°ï¼Œè¿™ä¸ªæ’å€¼æ–¹å¼çš„å…·ä½“å®ç°æ—¶é€šè¿‡<strong>self.counter</strong>çš„ä¸åŒå­ç±»è¿›è¡Œå®ç°ã€‚</p>
<pre><code><span class="class"><span class="keyword">@implementation</span> <span class="title">UILabelCounterLinear</span></span>

-(<span class="built_in">CGFloat</span>)update:(<span class="built_in">CGFloat</span>)t
{
    <span class="keyword">return</span> t;
}

<span class="keyword">@end</span>

<span class="class"><span class="keyword">@implementation</span> <span class="title">UILabelCounterEaseIn</span></span>

-(<span class="built_in">CGFloat</span>)update:(<span class="built_in">CGFloat</span>)t
{
    <span class="keyword">return</span> powf(t, k<span class="built_in">UILabelCounterRate</span>);
}

<span class="keyword">@end</span>

<span class="class"><span class="keyword">@implementation</span> <span class="title">UILabelCounterEaseOut</span></span>

-(<span class="built_in">CGFloat</span>)update:(<span class="built_in">CGFloat</span>)t{
    <span class="keyword">return</span> <span class="number">1.0</span>-powf((<span class="number">1.0</span>-t), k<span class="built_in">UILabelCounterRate</span>);
}

<span class="keyword">@end</span>

<span class="class"><span class="keyword">@implementation</span> <span class="title">UILabelCounterEaseInOut</span></span>

-(<span class="built_in">CGFloat</span>) update: (<span class="built_in">CGFloat</span>) t
{
    <span class="keyword">int</span> sign =<span class="number">1</span>;
    <span class="keyword">int</span> r = (<span class="keyword">int</span>) k<span class="built_in">UILabelCounterRate</span>;
    <span class="keyword">if</span> (r % <span class="number">2</span> == <span class="number">0</span>)
        sign = -<span class="number">1</span>;
    t *= <span class="number">2</span>;
    <span class="keyword">if</span> (t &lt; <span class="number">1</span>)
        <span class="keyword">return</span> <span class="number">0.5</span>f * powf(t, k<span class="built_in">UILabelCounterRate</span>);
    <span class="keyword">else</span>
        <span class="keyword">return</span> sign * <span class="number">0.5</span>f * (powf(t-<span class="number">2</span>, k<span class="built_in">UILabelCounterRate</span>) + sign * <span class="number">2</span>);
}
</code></pre><p>è¿™é‡Œç”¨å­ç±»åŒ–è¿™ä¹ˆè¯´æ˜¯ä¸ä¸¥è°¨çš„ï¼Œå› ä¸ºè¿™å…¶å®å°±ç±»ä¼¼äºJavaæˆ–è€…C#æ˜¯é¢å‘äº†æ¥å£ç¼–ç¨‹äº†è€Œå·²ï¼Œå› ä¸ºè¿™é‡Œçš„æ¯ä¸ªç±»éƒ½åªæ˜¯å®ç°äº†updateè¿™ä¸ªå‡½æ•°æ¥å£è€Œå·²ã€‚</p>
<p>ç„¶åå®ç°é‡Œç›¸å¯¹æ¯”è¾ƒç›´è§‚ï¼Œ</p>
<pre><code>-(<span class="keyword">void</span>)countFrom:(<span class="built_in">CGFloat</span>)startValue to:(<span class="built_in">CGFloat</span>)endValue withDuration:(<span class="built_in">NSTimeInterval</span>)duration {
    <span class="keyword">if</span> (duration == <span class="number">0.0</span>) {
        <span class="comment">// No animation</span>
        [<span class="keyword">self</span> setTextValue:endValue];
        [<span class="keyword">self</span> runCompletionBlock];
        <span class="keyword">return</span>;
    }

    <span class="keyword">self</span><span class="variable">.lastUpdate</span> = [<span class="built_in">NSDate</span> timeIntervalSinceReferenceDate];

    <span class="keyword">switch</span>(<span class="keyword">self</span><span class="variable">.method</span>)
    {
        <span class="keyword">case</span> <span class="built_in">UILabelCountingMethodLinear</span>:
            <span class="keyword">self</span><span class="variable">.counter</span> = [[<span class="built_in">UILabelCounterLinear</span> alloc] init];
            <span class="keyword">break</span>;
        <span class="keyword">case</span> <span class="built_in">UILabelCountingMethodEaseIn</span>:
            <span class="keyword">self</span><span class="variable">.counter</span> = [[<span class="built_in">UILabelCounterEaseIn</span> alloc] init];
            <span class="keyword">break</span>;
        <span class="keyword">case</span> <span class="built_in">UILabelCountingMethodEaseOut</span>:
            <span class="keyword">self</span><span class="variable">.counter</span> = [[<span class="built_in">UILabelCounterEaseOut</span> alloc] init];
            <span class="keyword">break</span>;
        <span class="keyword">case</span> <span class="built_in">UILabelCountingMethodEaseInOut</span>:
            <span class="keyword">self</span><span class="variable">.counter</span> = [[<span class="built_in">UILabelCounterEaseInOut</span> alloc] init];
            <span class="keyword">break</span>;
    }

    <span class="built_in">NSTimer</span> *timer = [<span class="built_in">NSTimer</span> timerWithTimeInterval:(<span class="number">1.0</span>f/<span class="number">30.0</span>f) target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(updateValue:) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];
    [[<span class="built_in">NSRunLoop</span> mainRunLoop] addTimer:timer forMode:<span class="built_in">NSRunLoopCommonModes</span>];
    [[<span class="built_in">NSRunLoop</span> mainRunLoop] addTimer:timer forMode:<span class="built_in">UITrackingRunLoopMode</span>];
    <span class="keyword">self</span><span class="variable">.timer</span> = timer;
}
</code></pre><p>é¦–å…ˆå¦‚æœåŠ¨ç”»çš„æ—¶é—´æ˜¯0ï¼Œå°±é»˜è®¤ç›´æ¥å›è°ƒã€‚ä½†æ˜¯ï¼Œæˆ‘æƒ³è¯´<b>duration == 0.0ï¼Œæµ®ç‚¹æ•°è¿™ä¹ˆåˆ¤æ–­ï¼ŒçœŸçš„æ²¡é—®é¢˜å—ï¼Ÿ</b></p>
<p>ç”±äºNSTimeræ— æ³•å¾—çŸ¥ç¡®åˆ‡å¾—çŸ¥é“æ‰§è¡Œäº†å¤šå°‘ï¼Œæ‰€ä»¥è¿™é‡Œè¦è®°å½•ä¸Šä¸€æ­¥å›è°ƒçš„lastUpdateã€‚<br>æ ¹æ®ä¸åŒçš„æ–¹æ³•é€‰æ‹©ä¸åŒçš„Counterè¿›è¡Œæ’å€¼ï¼Œç„¶ååˆ›å»ºNSTimerï¼Œè¿™é‡Œæˆ‘ä»¬è¦ç‰¹åˆ«æ³¨æ„ä¸¤å¥è¯ï¼š</p>
<pre><code><span class="attr_selector">[[NSRunLoop mainRunLoop]</span> <span class="rule"><span class="attribute">addTimer</span>:<span class="value">timer forMode:NSRunLoopCommonModes]</span></span>;
<span class="attr_selector">[[NSRunLoop mainRunLoop]</span> <span class="rule"><span class="attribute">addTimer</span>:<span class="value">timer forMode:UITrackingRunLoopMode]</span></span>;
</code></pre><p>è¿™è¡¨ç¤ºNSTimeré»˜è®¤åŠ å…¥çš„æ˜¯RunLoopçš„Default Modeï¼Œä½†æ˜¯Default Modeåœ¨è¿›å…¥Tracking Modeçš„æ—¶å€™ï¼ˆä¹Ÿå°±æ˜¯å½“ç”¨æˆ·æ»‘åŠ¨çš„æ—¶å€™ï¼‰ä¼šè¢«é˜»å¡ï¼Œå½±å“åŠ¨ç”»çš„æ‰§è¡Œã€‚å› æ­¤è¦ç‰¹åˆ«åŠ å…¥TrackingModeã€‚</p>
<p>ä½†æ˜¯æˆ‘åˆæƒ³è¯´äº†ï¼Œ<b>NSRunLoopCommonModeséš¾é“ä¸æ˜¯åŒ…å«UITrackingRunLoopModeå—ï¼Ÿå¤©å‘ï¼Œè¿˜æ˜¯æˆ‘ç†è§£çš„ä¸å¯¹ï¼Œé‡å¤æ·»åŠ çš„æ„ä¹‰å‘¢ï¼ï¼ï¼ï¼</b></p>
<p>ç„¶ååœ¨NSTimerçš„å›è°ƒå‡½æ•°ä¸­,</p>
<pre><code><span class="built_in">NSTimeInterval</span> now = [<span class="built_in">NSDate</span> timeIntervalSinceReferenceDate];
<span class="keyword">self</span><span class="variable">.progress</span> += now - <span class="keyword">self</span><span class="variable">.lastUpdate</span>;
<span class="keyword">self</span><span class="variable">.lastUpdate</span> = now;

<span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.progress</span> &gt;= <span class="keyword">self</span><span class="variable">.totalTime</span>) {
    [<span class="keyword">self</span><span class="variable">.timer</span> invalidate];
    <span class="keyword">self</span><span class="variable">.timer</span> = <span class="literal">nil</span>;
    <span class="keyword">self</span><span class="variable">.progress</span> = <span class="keyword">self</span><span class="variable">.totalTime</span>;
}

[<span class="keyword">self</span> setTextValue:[<span class="keyword">self</span> currentValue]];

<span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.progress</span> == <span class="keyword">self</span><span class="variable">.totalTime</span>) {
    [<span class="keyword">self</span> runCompletionBlock];
}
</code></pre><p>å°±æ˜¯è®¡ç®—å½“å‰çš„progressè¿›åº¦ï¼Œæ›´æ–°ç›¸åº”çš„å€¼è€Œå·²ï¼Œæ²¡æœ‰éš¾åº¦ã€‚</p>
<h3 id="Swift_é‡å†™">Swift é‡å†™</h3><p>å…ˆæ¥æ•ˆæœ:</p>
<p><img src="http://7lrzqz.com1.z0.glb.clouddn.com/CountDownLabel.gif"></p>
<h4 id="CADisplayLink_vs_NSTimer">CADisplayLink vs NSTimer</h4><p>é¦–å…ˆæˆ‘ä»¬æ¥å›å¿†ä¸‹Objective-Cç‰ˆæœ¬ä¸­çš„ä¸€äº›é€»è¾‘ï¼Œä½¿ç”¨NSTimeråŠ¨æ€æ ¹æ®è¿›åº¦æ›´æ–°æ—¶é—´ã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“ï¼ŒNSTimeræœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜å°±æ˜¯ä»–çš„â€œåˆ·æ–°ç‡â€ä¸å¤Ÿå‡†ç¡®ã€‚å¦‚æœNSTimerè®¾ç½®äº†æ¯ä¸¤ç§’æ›´æ–°ä¸€æ¬¡ï¼Œé‚£ä¹ˆå¦‚æœRunLoopä¸­æœ‰ä¸ªè€—æ—¶çš„ä»»åŠ¡ï¼Œå°±ä¼šè®²è¿™ä¸ªæ›´æ–°ä»»åŠ¡æ¨è¿Ÿï¼Œç”¨æ—¶é—´è½´æ¥ç†è§£ï¼š</p>
<pre><code><span class="number">0</span><span class="function"> -&gt;</span> <span class="number">2s</span> <span class="function"><span class="params">(NSTimerå›è°ƒ)</span> -&gt;</span> <span class="number">3s</span> ï¼ˆè€—æ—¶çš„ä»»åŠ¡ï¼‰<span class="function"> -&gt;</span> <span class="number">2s</span> (NSTimerå›è°ƒ)ã€‚
</code></pre><p>é‚£ä¹ˆè¿™ä¸ªä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜å‘¢ï¼ŸNSTimerçš„å›è°ƒå’Œå±å¹•åˆ·æ–°ä¸æ˜¯åŒæ­¥çš„ã€‚å› æ­¤ï¼Œåœ¨Swiftç‰ˆæœ¬çš„é‡å†™ä¸­ï¼Œæˆ‘é‡‡ç”¨äº†CADisplayLinkæ¥æ”¹å†™ï¼Œå®ƒçš„å¥½å¤„æˆ‘ä»¬åŒæ ·ç”¨æ—¶é—´è½´æ¥ç†è§£ï¼š</p>
<pre><code><span class="number">0</span> -&gt; <span class="number">2</span>sï¼ˆCADisplayLinkå›è°ƒï¼‰ -&gt; <span class="number">3</span>sï¼ˆè€—æ—¶çš„ä»»åŠ¡ï¼‰ -&gt; <span class="number">1</span>sï¼ˆç©ºé—²ï¼‰ -&gt; <span class="number">2</span>sï¼ˆCADisplayLinkå›è°ƒï¼‰
</code></pre><p>å¯ä»¥çœ‹å‡ºï¼ŒCADisplayLinkå§‹ç»ˆæ˜¯ä¿æŒå’Œå±å¹•åˆ·æ–°ç‡ä¸€æ ·ã€‚</p>
<p><b>è¿™é‡Œå¼ºè°ƒä¸€ä¸‹ï¼Œä¸è®ºæ˜¯NSTimeræŠ‘æˆ–æ˜¯CADisplayLinkï¼Œæ—¢ç„¶ä»–ä»¬éƒ½æ˜¯åŸºäºRunLoopçš„ï¼Œå°±æ— æ³•è„±ç¦»è¢«æ‰€å¤„åŒä¸€ä¸ªRunLoopé‡Œçš„å…¶ä»–ä»»åŠ¡æ‰€å½±å“çš„å®¿å‘½ï¼Œæ‰€ä»¥ç½‘ä¸Šé‚£äº›è¯´CADisplayLinkä¸ä¼šè¢«é˜»å¡çš„è¯´æ³•éƒ½æ˜¯é”™è¯¯çš„ã€‚</b></p>
<h4 id="Swift_é¢å‘æ¥å£ç¼–ç¨‹">Swift é¢å‘æ¥å£ç¼–ç¨‹</h4><p>ä¹‹å‰æˆ‘ä»¬æè¿‡â€œå­ç±»åŒ–â€œè¿™ä¸ªè¯´æ³•æ˜¯ä¸å‡†ç¡®çš„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬åœ¨Swiftä¸­ï¼Œå¯ä»¥åŸºäºprotocol-orientedè¿›è¡Œç¼–ç¨‹ã€‚</p>
<pre><code><span class="keyword">let</span> <span class="type">WZCountRate</span>:<span class="type">Float</span> = <span class="number">3.0</span>

<span class="class"><span class="keyword">protocol</span> <span class="title">Interpolation</span> </span>{
    <span class="func"><span class="keyword">func</span> <span class="title">update</span><span class="params">(val:Float)</span></span> -&gt; <span class="type">Float</span>;
}

<span class="class"><span class="keyword">struct</span> <span class="title">Linear</span>:<span class="title">Interpolation</span> </span>{
    <span class="func"><span class="keyword">func</span> <span class="title">update</span><span class="params">(val: Float)</span></span> -&gt; <span class="type">Float</span> {
        <span class="keyword">return</span> val
    }
}

<span class="class"><span class="keyword">struct</span> <span class="title">EaseIn</span>:<span class="title">Interpolation</span> </span>{
    <span class="func"><span class="keyword">func</span> <span class="title">update</span><span class="params">(val: Float)</span></span> -&gt; <span class="type">Float</span> {
        <span class="keyword">return</span> powf(val, <span class="type">WZCountRate</span>)
    }
}

<span class="class"><span class="keyword">struct</span> <span class="title">EaseOut</span>:<span class="title">Interpolation</span> </span>{
    <span class="func"><span class="keyword">func</span> <span class="title">update</span><span class="params">(val: Float)</span></span> -&gt; <span class="type">Float</span> {
        <span class="keyword">return</span> <span class="number">1</span> - powf((<span class="number">1</span> - val), <span class="type">WZCountRate</span>)
    }
}

<span class="class"><span class="keyword">struct</span> <span class="title">EaseInOut</span>:<span class="title">Interpolation</span> </span>{
    <span class="func"><span class="keyword">func</span> <span class="title">update</span><span class="params">(val: Float)</span></span> -&gt; <span class="type">Float</span> {
        <span class="keyword">var</span> sign:<span class="type">Float</span> = <span class="number">1</span>
        <span class="keyword">let</span> r = <span class="type">Int</span>(<span class="type">WZCountRate</span>)

        <span class="keyword">if</span> (r % <span class="number">2</span> == <span class="number">0</span>) {
           sign = -<span class="number">1</span>
        }

        <span class="keyword">var</span> t = val * <span class="number">2</span>
        <span class="keyword">if</span> (t &lt; <span class="number">1</span>) {
            <span class="keyword">return</span> <span class="number">0.5</span> * powf(t, <span class="type">WZCountRate</span>)
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> <span class="number">0.5</span> * (powf(t - <span class="number">2.0</span>, <span class="type">WZCountRate</span>) + sign * <span class="number">2</span>) * sign
        }
    }
}
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ç”¨å››ä¸ª<b>Struct</b>ç»“æ„ä½“éµä»äº†<b>Interpolation</b>è¿™ä¸ªæ¥å£ï¼Œå®ç°äº†å››ç§ä¸åŒçš„æ’å€¼æ–¹æ³•ã€‚</p>
<p>åˆ«çš„æ–¹é¢æ²¡ä»€ä¹ˆç‰¹åˆ«éš¾çš„ï¼Œ</p>
<h4 id="Access_Control_å¯¹Selector_Callbackçš„å½±å“">Access Control å¯¹Selector Callbackçš„å½±å“</h4><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒSwiftå¯¹ç±»å¼•å…¥äº†Access Controlè¿™ä¸€æœºåˆ¶ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯internalçš„æƒé™ã€‚ç”±äºCADisplayLinkè¿˜æ˜¯åŸºäºSelectorè®¾ç½®å›è°ƒçš„ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code><span class="keyword">let</span> displayLink = CADisplayLink(
   target: <span class="built_in">self</span>,
   <span class="keyword">select</span><span class="subst">or</span>: <span class="keyword">Select</span><span class="subst">or</span>(<span class="string">"displayTick:"</span>)
)
</code></pre><p>å½“è¿™ä¸ªdisplayTickå‡½æ•°å¤„äº<b>publicæˆ–è€…internal</b>æƒé™çš„æ—¶å€™ï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚è€Œå½“ä½ æƒ³å£°æ˜å¦‚</p>
<p><em>private func displayTick()</em></p>
<p>çš„æ—¶å€™ï¼Œå°±ä¼šäº§ç”Ÿdoesnâ€™t recognize selectorçš„runtime errorã€‚</p>
<p>åŸå› å¦‚ä¸‹ï¼š<br><b>åŸºäºSelectorçš„å›è°ƒæ–¹å¼è¿˜æ˜¯é‡‡ç”¨äº†Objective-Cä¼ ç»Ÿçš„runtime æŸ¥å‡½æ•°è¡¨çš„æ–¹å¼ï¼Œä½†æ˜¯åœ¨Swiftä¸­å£°æ˜ä¸ºprivateçš„å‡½æ•°ï¼Œå¯¹äºObjective-C Runtimeæ˜¯ä¸å¯è§çš„ã€‚å› æ­¤ï¼Œå¦‚æœä½ éœ€è¦è®©ç§æœ‰å‡½æ•°å¯ä»¥è¢«æŸ¥è¯¢åˆ°ï¼Œä½ éœ€è¦æ·»åŠ @objcå…³é”®è¯ã€‚</b></p>
<p>@objc private func displayTick()</p>
<p>å½“ç„¶å•¦ï¼Œ å¯¹äºIBOutlets, IBActions ä»¥åŠ Core Data ç›¸å…³å±æ€§æ¥è¯´ï¼Œé»˜è®¤æ˜¯å¯ä»¥è¢«Objective-C RuntimeæŸ¥è¯¢åˆ°çš„ã€‚</p>
<p></p>
<p>æœ€åï¼Œé™„ä¸Š<a href="https://github.com/SatanWoo/WZCountDownLabel" target="_blank" rel="external">é¡¹ç›®åœ°å€</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/10/29/Swift-Count-Down-Label/" data-id="cjqdxq1yx001mmxi1ceoc30rk" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/10/29/Swift-Count-Down-Label/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swift/">Swift</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-Swift-Circle-Slider" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/27/Swift-Circle-Slider/" class="article-date">
  <time datetime="2015-10-27T07:24:11.000Z" itemprop="datePublished">2015-10-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/27/Swift-Circle-Slider/">Swiftæ¯æ—¥ä¸€ç»ƒï¼šåœ†å½¢æ»‘åŠ¨æ¡</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>æœ€è¿‘é‡åˆ°äº†å¥½å¤šäººé—®æˆ‘ä¼šä¸ä¼šSwiftï¼Œè™½ç„¶æˆ‘å¾ˆæ—©å°±è¿›è¡Œäº†Swiftçš„å­¦ä¹ ï¼Œä½†æ˜¯è‹¹æœå¯¹äºSwiftçš„æ›´æ–°çœŸæ˜¯æ—¥æ–°æœˆå¼‚ï¼Œå’Œæˆ‘å½“æ—¶betaç‰ˆæœ¬å­¦ä¹ çš„æ—¶å€™å¤§å¤§ä¸åŒäº†ï¼Œæ‰€ä»¥ï¼Œä»ä»Šå¤©èµ·å‡†å¤‡ç£ä¿ƒè‡ªå·±è¿›è¡Œæ¯æ—¥ä¸€ç»ƒã€‚</p>
<p>ä»Šå¤©æƒ³è¦åšçš„æ˜¯ä¸€ä¸ª360åº¦çš„åœ†å‹æ»‘åŠ¨æ¡ã€‚</p>
<h3 id="é¢„è§ˆæ•ˆæœ">é¢„è§ˆæ•ˆæœ</h3><p><img src="http://7lrzqz.com1.z0.glb.clouddn.com/RotationSlider.gif"></p>
<p>ç»†èŠ‚æ–¹é¢è¿˜æœ‰æ¬ ç¼ºï¼Œæ¯”å¦‚ï¼Œæ²¡æœ‰è¿›è¡Œæ—‹è½¬åœˆæ•°çš„æ§åˆ¶ï¼ŒåŒæ—¶ä¹Ÿæ²¡æœ‰è¿›è¡Œæ‹–æ‹½èŒƒå›´çš„æ§åˆ¶ã€‚</p>
<h3 id="æ•ˆæœå®ç°">æ•ˆæœå®ç°</h3><p>æˆ‘ä»¬é¦–å…ˆæ¥å¤§è‡´çœ‹çœ‹æ€ä¹ˆåšåˆ†è§£ï¼š</p>
<pre><code>-<span class="ruby"> ä¸€ä¸ªåœ†ç¯
</span>-<span class="ruby"> ä¸€ä¸ªæ¸å˜è‰²
</span>-<span class="ruby"> ä¸€ä¸ªæ§åˆ¶çƒ
</span>-<span class="ruby"> ä¸€ä¸ªæ˜¾ç¤ºæ–‡å­—</span>
</code></pre><p>é¦–å…ˆçœ‹çœ‹åœ†ç¯æ€ä¹ˆå®ç°çš„ï¼Œå¾ˆç®€å•ï¼Œæˆ‘ä»¬åˆ©ç”¨Core Graphicä½¿ç”¨å¦‚ä¸‹ä»£ç å³å¯ä»¥ç”»å‡ºä¸€ä¸ªåœ†åœˆï¼Œåªè¦åŠ ä¸Šæè¾¹å®½åº¦ï¼Œå°±å¯ä»¥å½¢æˆåœ†ç¯æ•ˆæœã€‚</p>
<pre><code>CGContextAddArc(
    ctx,
    self.frame.size.width/<span class="number">2</span>,
    self.frame.size.height/<span class="number">2</span>,
    self.radius,
    <span class="number">0</span>,
    <span class="number">2.0</span> * M_PI,
    <span class="number">0</span>
)
UIColor(red: <span class="number">0</span>, green: <span class="number">0</span>, blue: <span class="number">0</span>, alpha: <span class="number">1.0</span>).<span class="built_in">set</span>()
CGContextSetLineWidth(ctx, <span class="number">72</span>)
CGContextSetLineCap(ctx, kCGLineCapButt)
CGContextDrawPath(ctx, kCGPathStroke)
</code></pre><p>ç„¶åæˆ‘ä»¬çš„åœ†ç¯èƒŒæ™¯è‰²æ˜¯æ¸å˜çš„ï¼Œè¿™å¯æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬ç›´æ¥ä½¿ç”¨CAGradientLayerå—ï¼Ÿå½“ç„¶é‚£æ˜¯å…¶ä¸­ä¹‹ä¸€çš„æ–¹æ³•ï¼Œä¸è¿‡è¿™æ¬¡æˆ‘ä»¬è¯•è¯•ç”¨Mask ï¼‹ èƒŒæ™¯è‰²çš„æ–¹å¼å®ç°ã€‚ä»€ä¹ˆæ˜¯Maskå‘¢ï¼Ÿç®€å•æ¥ç†è§£å°±æ˜¯ï¼Œå¦‚æœä½ æƒ³åšå‡ºéå¸¸å¤æ‚çš„å½¢çŠ¶ï¼Œä½ å¯ä»¥å°†æ„é€ ä¸€ä¸ªåŒ…å«è¿™ç§å½¢çŠ¶çš„å›¾ç‰‡ï¼Œéœ€è¦æ˜¾ç¤ºå½¢çŠ¶çš„åœ°æ–¹ç”¨<strong>éç™½è‰²</strong>çš„é¢œè‰²æ¥å¡«å……ï¼Œä¸æ˜¾ç¤ºçš„åœ°æ–¹ç”¨<strong>ç™½è‰²</strong>å¡«å……ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æ„å»ºä¸€ä¸ªä»ä¸Šåˆ°ä¸‹çš„æ¸å˜è‰²èƒŒæ™¯ï¼Œç„¶åé…åˆé»‘è‰²çš„åœ†ç¯è¿›è¡ŒMaskï¼Œå°±å¯ä»¥å¾—åˆ°å¸¦æœ‰æ¸å˜è‰²èƒŒæ™¯çš„ã€‚</p>
<pre><code><span class="built_in">CGContextSaveGState</span>(ctx)     
<span class="built_in">CGContextClipToMask</span>(ctx, <span class="keyword">self</span><span class="variable">.bounds</span>, mask)

let startColorComponents = <span class="built_in">CGColorGetComponents</span>(startColor<span class="variable">.CGColor</span>)
let endColorComponents = <span class="built_in">CGColorGetComponents</span>(endColor<span class="variable">.CGColor</span>)
let components = [
  startColorComponents[<span class="number">0</span>], startColorComponents[<span class="number">1</span>], startColorComponents[<span class="number">2</span>], <span class="number">1.0</span>,
  endColorComponents[<span class="number">0</span>], endColorComponents[<span class="number">1</span>], endColorComponents[<span class="number">2</span>], <span class="number">1.0</span>
]
let gradient = <span class="built_in">CGGradientCreateWithColorComponents</span>(<span class="built_in">CGColorSpaceCreateDeviceRGB</span>(), components, <span class="literal">nil</span>, <span class="number">2</span>)

<span class="built_in">CGContextDrawLinearGradient</span>(
    ctx,
    gradient,
    <span class="built_in">CGPointMake</span>(<span class="built_in">CGRectGetMidX</span>(rect), <span class="built_in">CGRectGetMinY</span>(rect)),
    <span class="built_in">CGPointMake</span>(<span class="built_in">CGRectGetMidX</span>(rect), <span class="built_in">CGRectGetMaxY</span>(rect)),
    <span class="number">0</span>
);

<span class="built_in">CGContextRestoreGState</span>(ctx);
</code></pre><p>åˆ°æ­¤ï¼Œç»˜ç”»çš„å·¥ä½œåŸºæœ¬å°±ç»“æŸäº†ï¼Œç”»ç™½è‰²å°çƒçš„åŸç†å¾ˆç®€å•ï¼Œä¹Ÿä¸èµ˜è¿°äº†ã€‚æˆ‘ä»¬ä¸‹é¢æ¥è¯´ä¸€ä¸‹æ ¹æ®æ‰‹åŠ¿æ¥æ§åˆ¶ç™½è‰²å°çƒæ—‹è½¬ä½ç½®ï¼Œä¸»è¦çš„æ€è·¯è¿˜æ˜¯æ§åˆ¶ä½ç½®æ¥è®¡ç®—å¼§åº¦ã€‚</p>
<pre><code>override func touchesMoved(touches: <span class="type">Set</span>&lt;<span class="type">NSObject</span>&gt;, withEvent event: <span class="type">UIEvent</span>)     {    
    //println(<span class="string">"Touches Moved"</span>)

    <span class="keyword">if</span> <span class="keyword">let</span> touch = touches.first <span class="keyword">as</span>? <span class="type">UITouch</span> {
        <span class="keyword">var</span> location = touch.locationInView(self)
        moveHandle(location)
    }
}

func computeAngle(p1:<span class="type">CGPoint</span> , p2:<span class="type">CGPoint</span>) -&gt; <span class="type">Double</span> {
    <span class="keyword">var</span> delta = <span class="type">CGPoint</span>(x: p2.x - p1.x, y: p1.y - p2.y)

    <span class="keyword">let</span> radians = <span class="type">Double</span>(atan2(delta.y, delta.x))
    <span class="keyword">let</span> <span class="literal">result</span> = toDegree(radians)
    <span class="keyword">return</span> <span class="literal">result</span> &gt;= <span class="number">0</span> ? <span class="literal">result</span> : <span class="literal">result</span> + <span class="number">360</span>
}
</code></pre><p>å…¶ä¸­ï¼Œæœ‰ä¸€ç‚¹æˆ‘ä»¬è¦ç‰¹åˆ«æ³¨æ„<br><b>var delta = CGPoint(x: p2.x - p1.x, y: p1.y - p2.y)</b>ï¼Œåœ¨Yè½´çš„è®¡ç®—ä¸Šï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œä¸Šä¸‹ç¿»è½¬çš„è®¡ç®—ï¼ŒåŸå› å°±åœ¨äºæˆ‘ä»¬é€šè¿‡UITouchæ‹¿åˆ°çš„locationçš„Yåæ ‡ï¼Œæ˜¯UIKitç³»çš„åæ ‡ä½“ç³»ï¼ŒYè½´åŸç‚¹åœ¨ä¸Šæ–¹ï¼Œè€Œæˆ‘ä»¬é€šè¿‡ç»˜å›¾çš„æ—¶å€™éœ€è¦è¿›è¡Œè¿›è¡ŒYè½´çš„ä¸Šä¸‹é¢ å€’ã€‚</p>
<p>æ­¤å¤–ï¼Œæ ¹æ®è®¡ç®—çš„å¼§åº¦ï¼Œæ¥æ›´æ–°å°çƒçš„ä½ç½®ï¼Œç”±äºæˆ‘ä»¬æ˜¯é€†æ—¶é’ˆçš„sliderï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨ 360 å‡å»æˆ‘ä»¬å®é™…è®¡ç®—å¾—åˆ°çš„å¼§åº¦ã€‚</p>
<h3 id="ä¸€äº›æ„Ÿå—">ä¸€äº›æ„Ÿå—</h3><p>çœŸçš„ï¼ŒSwiftä¸­çš„ç±»å‹å®‰å…¨å¤ªæ¶å¿ƒäº†ï¼Œä¸èƒ½å¿ï¼Œäºæ˜¯åªå¥½ç©èµ·äº†æ“ä½œç¬¦é‡è½½</p>
<pre><code><span class="func"><span class="keyword">func</span> -<span class="params">(lhs:CGFloat, rhs:Double)</span></span> -&gt; <span class="type">CGFloat</span> {
    <span class="keyword">return</span> lhs - <span class="type">CGFloat</span>(rhs)
}

<span class="func"><span class="keyword">func</span> +<span class="params">(lhs:Double, rhs:CGFloat)</span></span> -&gt; <span class="type">CGFloat</span> {
    <span class="keyword">return</span> <span class="type">CGFloat</span>(lhs) + rhs
}

<span class="func"><span class="keyword">func</span> +<span class="params">(lhs:CGFloat, rhs:Double)</span></span> -&gt; <span class="type">CGFloat</span> {
    <span class="keyword">return</span> lhs + <span class="type">CGFloat</span>(rhs)
}

<span class="func"><span class="keyword">func</span> *<span class="params">(lhs:Double, rhs:CGFloat)</span></span> -&gt; <span class="type">CGFloat</span> {
    <span class="keyword">return</span> <span class="type">CGFloat</span>(lhs) * rhs
}

<span class="func"><span class="keyword">func</span> *<span class="params">(lhs:CGFloat, rhs:Double)</span></span> -&gt; <span class="type">CGFloat</span> {
    <span class="keyword">return</span> lhs * <span class="type">CGFloat</span>(rhs)
}

<span class="func"><span class="keyword">func</span> /<span class="params">(lhs:Double, rhs:CGFloat)</span></span> -&gt; <span class="type">CGFloat</span> {
    <span class="keyword">return</span> <span class="type">CGFloat</span>(lhs) / rhs
}

<span class="func"><span class="keyword">func</span> /<span class="params">(lhs:CGFloat, rhs:Double)</span></span> -&gt; <span class="type">CGFloat</span> {
    <span class="keyword">return</span> lhs / <span class="type">CGFloat</span>(rhs)
}
</code></pre><p>æœ€åé™„ä¸Š<a href="https://github.com/SatanWoo/SwiftRotateSlider" target="_blank" rel="external">é¡¹ç›®åœ°å€</a></p>
<p>å¥½äº†ï¼Œä¸å¤šè¯´äº†ï¼Œæˆ‘è¦å‡çº§El Captainäº†ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/10/27/Swift-Circle-Slider/" data-id="cjqdxq1z0001omxi1e3d8hvll" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/10/27/Swift-Circle-Slider/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swift/">Swift</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-GLCalendarView" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/14/GLCalendarView/" class="article-date">
  <time datetime="2015-10-14T01:15:52.000Z" itemprop="datePublished">2015-10-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/14/GLCalendarView/">GLCaledarView æºç è§£è¯» &amp; Glowé¢ç»</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ä»Šå¤©é€‰æ‹©äº†GLCalendarViewæ¥è¿›è¡Œæºç è§£è¯»ï¼Œä¸€æ–¹é¢æ˜¯å› ä¸ºå®ƒçš„å®ç°æ•ˆæœç®€å•æ¸…æ™°ï¼Œç¬¬äºŒæ–¹é¢ï¼Œæ˜¯æˆ‘åŒå­¦è®©æˆ‘æŠŠGlowçš„é¢ç»ç»™å†™äº†ã€‚</p>
<h2 id="Glowé¢ç»">Glowé¢ç»</h2><p>å¯èƒ½å¯¹äºå¤§å¤šæ•°æ¥è¯´ï¼ŒGlowç›¸å¯¹æ¥è¯´è¿˜ç®—ä¸€ä¸ªæ¯”è¾ƒç¥ç§˜çš„å…¬å¸ï¼Œå®ƒä¸»è¦è‡´åŠ›äºåŸºäºå¤§æ•°æ®åˆ†æå¥³æ€§å¥åº·çš„appçš„ç ”å‘ã€‚</p>
<p><em>å¥½å§ï¼Œå…¶å®æˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ‡‚ï¼Œä½†æ˜¯æˆ‘è§‰å¾—æ‡‚ä¸€ç‚¹ä¹ŸæŒºå¥½ï¼Œæ¯•ç«Ÿæˆ‘æ˜¯æœ‰å¥³æœ‹å‹çš„äººã€‚</em></p>
<p>å…ˆè¯´è¯´æˆ‘ä¸ºä»€ä¹ˆä¼šæŠ•Glowï¼Œä¸¤ç‚¹åŸå› ï¼š</p>
<ul>
<li>ä¸»è¦åŸå› æˆ‘æ˜¯æƒ³å»å‚åŠ ä»–ä»¬çš„å¼€æ”¾æ—¥åƒä¸œè¥¿ï¼Œç„¶åä»–ä»¬çš„ç™»è®°é¡µé¢æœ‰ä¸ªæŠ•ç®€å†çš„é€‰é¡¹ï¼Œæˆ‘å°±æŠ•äº†ï¼Œä½†æ˜¯åæ¥å¼€æ”¾æ—¥é‚£å¤©æˆ‘è¢«å¯¼å¸ˆæ‹‰å‡ºå»å¼€é¡¹ç›®ä¼šè®®äº†ç»“æœå°±æ²¡å»æˆã€‚</li>
<li>ä»–ä»¬çš„å›¢é˜Ÿå¾ˆå‰å®³ï¼Œå­¦å†ä¸Šéƒ½æ˜¯æ¸…åã€å¤æ—¦ã€äº¤å¤§ã€åŒæµï¼ˆå…¶ä¸­äº¤å¤§å’Œå¤æ—¦æ’åä¸åˆ†å…ˆåï¼Œä½ ä»¬åˆ«å–·æˆ‘ï¼‰ã€‚ åˆåˆ›å›¢é˜Ÿéƒ½æ˜¯Googleå‡ºèº«ï¼Œè‘£äº‹è¿˜æ˜¯Paypalçš„åˆ›å§‹äººä¹‹ä¸€ã€‚</li>
</ul>
<p>åæ¥9æœˆä¸­ä¸‹æ—¬ï¼ŒGlowç»™æˆ‘å®‰æ’äº†ä¸€æ¬¡ç”µé¢ï¼Œå•†é‡äº†ä¸€ä¸ªæ—¶é—´ï¼Œç”µè¯å¦‚çº¦è€Œè‡³ã€‚</p>
<h4 id="ç”µé¢">ç”µé¢</h4><p>ç”µé¢çš„å†…å®¹æˆ‘ä¸è®°å¾—äº†ï¼Œæœ‰ä¸€ä¸ªé—®é¢˜æ˜¯å›´ç»•Core Dataå±•å¼€çš„ï¼Œé—®æˆ‘å¤šçº¿ç¨‹ä¹‹é—´çš„Core Dataæè¿‡æ²¡ï¼Œæˆ‘è¯´æˆ‘æè¿‡ã€‚åæ¥è¯´åˆ°åœ¨å¤šä¸ªContextä¹‹é—´ä¼ è¾“objectçš„é—®é¢˜ï¼Œä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯ç›´æ¥<b>mergeChangeFromNotificationå°±å¯ä»¥äº†ï¼Œç„¶åä½ å°±å¯ä»¥åœ¨private contextè¿›è¡Œæ•°æ®è·å–</b>ï¼Œå½“æ—¶é¢è¯•å®˜é—®çš„ä¸€ä¸ªé—®é¢˜æ˜¯ä½ æ˜¯ç›´æ¥mergeå®Œäº†å°±ä½¿ç”¨äº†ï¼Œè¿˜æ˜¯[context save]æäº¤åˆ°persistentStoreCoordinatorä»¥åé€šè¿‡objectIDå»å–å‘¢ã€‚å½“æ—¶æˆ‘è¯´äº†ä¸€ä¸ªæˆ‘çš„åšæ³•ï¼Œåæ¥æˆ‘å†æ‰“å¼€æˆ‘è‡ªå·±ä»£ç çš„æ—¶å€™ï¼Œå‘ç°æ˜¯å› ä¸ºæˆ‘çš„appæ”¯æŒåˆ åä¿å­˜æ•°æ®ï¼Œé€ æˆäº†objectIDä¸ä¸€è‡´ï¼Œæ‰€ä»¥æˆ‘å½“æ—¶æå‡ºäº†åˆšå¯åŠ¨çš„æ—¶å€™ä¸€å®šè¦æ‹‰å»objectIDï¼Œç°åœ¨æƒ³æƒ³å¥½åƒåº”è¯¥æ˜¯ç­”é”™äº†ã€‚</p>
<h4 id="ç°åœºé¢è¯•">ç°åœºé¢è¯•</h4><p>åœ°ç‹±èˆ¬çš„6å°æ—¶è¿ç»­é¢è¯•ï¼Œç´¯æ™•äº†ã€‚</p>
<h5 id="ç¬¬ä¸€è½®_iOSé¢è¯•">ç¬¬ä¸€è½® iOSé¢è¯•</h5><p>ç¬¬ä¸€è½®æ˜¯iOSé¢è¯•ï¼ŒåŒæ—¶æ¥äº†ä¸¤ä½iOSé¢è¯•å®˜, å…ˆä¸Šæ¥è®©è‡ªæˆ‘ä»‹ç»ä¸‹ã€‚æˆ‘æ¯æ¬¡è‡ªæˆ‘ä»‹ç»éƒ½æ¯”è¾ƒå–œæ¬¢èŠ‚çº¦æ—¶é—´ï¼ŒæŠŠè‡ªå·±åšè¿‡çš„æ‰€æœ‰appéƒ½è£…åœ¨æ‰‹æœºä¸Šå¸¦åˆ°ç°åœºæ¼”ç¤ºã€‚äºæ˜¯ç¬¬ä¸€è½®çš„å¾ˆå¤šé—®é¢˜éƒ½æ˜¯ç©¿æ’ç€æˆ‘çš„é¡¹ç›®æé—®ï¼Œå…·ä½“é—®é¢˜æˆ‘å°±ä¸è¯´äº†ï¼Œå› äººè€Œå¼‚çš„ï¼Œæ‰€ä»¥æˆ‘å°±è¯´ä¸‹æˆ‘æ²¡ç­”ä¸Šæ¥çš„çŸ¥è¯†é¢ï¼š</p>
<ol>
<li>UITransition</li>
<li>UIViewçš„ä»¿å°„å˜æ¢å¯¹äºç•Œé¢å±‚çº§æ˜¾ç¤ºçš„ä¸€ä¸ªæ•ˆæœ</li>
<li>ä»–ä»¬è‡ªå®¶appä¸­ä¸€ä¸ªåŠ¨ç”»æ•ˆæœåˆ¶ä½œæ–¹å¼ï¼Œæˆ‘åº”è¯¥æ˜¯ç­”é”™äº†</li>
</ol>
<p>è¿™ä¸€è½®ç»™è‡ªå·±æ‰“ä¸ª70åˆ†å§ã€‚</p>
<h5 id="ç¬¬äºŒè½®_æ•°å­¦">ç¬¬äºŒè½® æ•°å­¦</h5><p>ç¬¬äºŒè½®ä¸€ä¸Šæ¥æˆ‘ä»¥ä¸ºæ˜¯äº§å“é¢ï¼Œç»“æœæ˜¯æœåŠ¡å™¨ç«¯çš„ä¸€ä½é¢è¯•å®˜ï¼Œå…ˆèŠäº†èŠè‡ªå·±å¯¹äºåšappæœ‰æ²¡æœ‰ä»€ä¹ˆä¿ƒè¿›appå¢é•¿çš„æ–¹å¼ã€‚ç„¶åï¼Œå°±å¼€å§‹åšä¸€é“å¾ˆå¥‡æ€ªçš„ç®—æ³•é¢˜ï¼Œä¸ºä»€ä¹ˆè¯´å¥‡æ€ªï¼Œæ˜¯å› ä¸ºè¿™é¢˜æ²¡æœ‰æ­£ç¡®ç­”æ¡ˆã€‚ç„¶åè¯´å®Œæ€è·¯ä»¥åå°±åœ¨ç™½çº¸ä¸Šå†™ä¸‹æ¥ï¼Œæˆ‘ç”¨C++å†™äº†ã€‚é¢è¯•å®˜é—®æˆ‘ä¸ºå•¥ä¸ç”¨Objective-Cå†™ï¼Œæˆ‘è¯´Objective-Cæ‰‹å†™ä»£ç å¤ªé•¿äº†ï¼Œé¡ºä¾¿æˆ‘è¿˜æƒ³è¯æ˜ä¸‹æˆ‘è¿˜ä¼šåˆ«çš„æŠ€æœ¯ã€‚</p>
<p>è¿™ä¸€è½®ç»™è‡ªå·±æ‰“ä¸ª80åˆ†ã€‚</p>
<h5 id="ç¬¬ä¸‰è½®_è‹±è¯­é¢è¯•">ç¬¬ä¸‰è½® è‹±è¯­é¢è¯•</h5><p>ç¬¬ä¸‰è½®æ˜¯ä»–ä»¬çš„äº§å“çš„åˆ›å§‹äººæ¥é¢æˆ‘ï¼Œä»–ä¸€ä¸Šæ¥é—®è¯´ä»–ä¸­æ–‡ä¸å¥½ï¼Œæˆ‘é€‰æ‹©è‹±è¯­é¢è¯•è¿˜æ˜¯ä¸­æ–‡é¢è¯•ï¼Œæˆ‘è¯´çš„è‹±è¯­æ²¡é—®é¢˜ï¼Œäºæ˜¯æˆ‘ä»¬å°±å¼€å§‹äº†è‡³å°‘50åˆ†é’Ÿäº†å…¨è‹±è¯­é¢è¯•ã€‚</p>
<p>è¿™ä¸€è½®å¯ä»¥æ‰“ä¸ª95åˆ†ã€‚</p>
<h5 id="ç¬¬å››è½®_CTOé¢">ç¬¬å››è½® CTOé¢</h5><p>é¢è¯•çš„æ—¶å€™æˆ‘ä¸çŸ¥é“ä»–å°±æ˜¯CTOï¼Œä»–è¿˜å¸¦æˆ‘å»å¤–å‡ºåƒäº†é¡¿ä¸­é¥­ï¼Œåƒå®Œå›æ¥å°±å¼€å§‹äº†é¢è¯•ã€‚<br>è¿™è½®ä¸€å¼€å§‹å…ˆé—®äº†æˆ‘æ€ä¹ˆä¿®ä¸€äº›å…³äºå¤šçº¿ç¨‹çš„Bugã€‚ç„¶åé—®äº†æˆ‘é“ç®—æ³•é¢˜ï¼Œå°±æ˜¯æ±‚çŸ©å½¢ç›¸äº¤ã€‚å½“æ—¶å¤ªè¯šå®äº†ï¼Œç›´æ¥è¯´äº†æˆ‘åšè¿‡è¿™é¢˜ï¼Œç„¶åç»™å‡ºäº†æˆ‘è‡ªå·±éæŠ•å½±çš„è§£æ³•ï¼Œäºæ˜¯ï¼Œæ‚²å‰§å°±ä»è¿™é‡Œå¼€å§‹äº†ã€‚</p>
<p>ç„¶åCTOå°±ç»™æˆ‘å‡ºäº†ä¸€é“åœ¨æˆ‘çœ‹æ¥æ¯”è¾ƒå¥‡ç‰¹çš„é¢˜ç›®ï¼Œå…·ä½“é¢˜ç›®ä¿å¯†æˆ‘ä¸è¯´äº†ï¼Œåæ­£å°±æ˜¯ä¸€å¼€å§‹ä»–å‡ºéš¾çš„ï¼Œæˆ‘æ²¡ç­”ä¸Šæ¥ï¼Œä»–è¯´ä½ å…ˆç®€åŒ–ä¸‹ï¼Œåšç®€å•ç‰ˆæœ¬çš„ã€‚æˆ‘åšå‡ºæ¥äº†ï¼Œç„¶ååˆåˆ‡æ¢æˆäº†å¤æ‚çš„ï¼Œåœ¨ä»–çš„æç¤ºä¸‹æˆ‘è¿˜æ˜¯æ²¡åšå‡ºæ¥ã€‚</p>
<p>è¿™è½®åªèƒ½æ‰“30åˆ†ã€‚</p>
<h5 id="ç¬¬äº”è½®_CEOé¢">ç¬¬äº”è½® CEOé¢</h5><p>CEOè¿›æ¥çš„æ—¶å€™æˆ‘è¿˜åœ¨æƒ³ä¸Šä¸€è½®çš„é¢˜ç›®ï¼Œäºæ˜¯æ‚²å‰§åˆæ¥äº†ã€‚æˆ‘åœ¨ä¸€è¾¹æƒ³é¢˜ç›®ä¸€è¾¹å’ŒCEOè¿›è¡Œäº†æ¡æ‰‹ï¼Œç„¶åå°±è¢«xxäº†ã€‚ç„¶åCEOæäº†ä¸€ä¸ªè®©æˆ‘è‡³ä»Šéå¸¸éš¾å¿˜çš„é¢è¯•é¢˜ï¼šå‰é¢é¢ä½ çš„æ‰€æœ‰é¢è¯•å®˜ä»–ä»¬å«ä»€ä¹ˆï¼Ÿè¿™ä¸‹æ˜¯çœŸå‚»çœ¼äº†ã€‚<br>å¯èƒ½æœ€åæ¯”è¾ƒå¥½çš„æ˜¯æˆ‘ç”¨çº¯è‹±æ–‡è·ŸCEOèŠäº†ä¸€æ®µæ—¶é—´ï¼Œä¼°è®¡æŒ½å›äº†ä¸€ç‚¹åˆ†æ•°ã€‚</p>
<p>è¿™è½®æ‰“ä¸ª50åˆ†ã€‚</p>
<p>åæ­£é¢è¯•æ„Ÿè§‰æœ‰ç‚¹æ™•ï¼Œå°¤å…¶æ˜¯ä¸‹åˆï¼Œæˆ˜çº¿æ‹–çš„å¤ªé•¿äº†ï¼Œè‡ªå·±è¡¨ç°çš„ä¸æ˜¯å¾ˆç†æƒ³ã€‚å…·ä½“æŠ€æœ¯é¢˜ç›®ä¸è¯´äº†ï¼Œè¯´å‡ºæ¥æˆ‘è®¤ä¸ºæ˜¯å¯¹ä»¥åé¢è¯•è€…çš„ä¸€ç§ä¸å°Šé‡ï¼Œæ‰€ä»¥å°±ç•¥è¿‡äº†ã€‚æ€»ä½“é¢è¯•çš„ä½“éªŒæ˜¯ç¡…è°·é£æ ¼ï¼Œè‹±è¯­ ï¼‹ æŠ€æœ¯ ï¼‹ æ™ºåŠ›ã€‚</p>
<h2 id="GLCalendarView_æºç è§£æ">GLCalendarView æºç è§£æ</h2><p>å…ˆæ¥å¼ æ•ˆæœå›¾</p>
<!--img src="https://raw.githubusercontent.com/Glow-Inc/GLCalendarView/master/demo.gif" alt="GLCalendarView" style="max-width:100%;"-->
<p>æ•ˆæœè¿˜æŒºé…·ç‚«çš„ï¼Œè¿™é‡Œæ˜¯å®ƒçš„<a href="https://github.com/Glow-Inc/GLCalendarView" target="_blank" rel="external">Githubåœ°å€</a></p>
<p>ä»Githubä¸Šçš„ä»‹ç»æ¥è¯´ï¼Œè¿™æ¬¾Calendarå’Œåˆ«çš„åŒç±»åº“ä¹‹é—´æœ‰ä¸ªæ¯”è¾ƒå¤§çš„åŒºåˆ«å°±æ˜¯å¯ä»¥é€‰æ‹©Date Rangeã€‚ä»ä¸Šé¢çš„æ•ˆæœæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æ‰‹åŠ¿é€‰æ‹©ä¸€æ®µè¿ç»­æ—¥æœŸã€‚</p>
<h2 id="æºç è§£æ">æºç è§£æ</h2><h3 id="å›¾å±‚åˆ†è§£">å›¾å±‚åˆ†è§£</h3><p>æ—¢ç„¶æ˜¯ä¸ªUIçš„å¼€æºåº“ï¼ŒæŠ›å¼€å†…éƒ¨é€»è¾‘å®ç°æ¥çœ‹ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å‰–æå®ƒçš„å›¾å±‚ç»“æ„ï¼Œè¿™æ ·æ‰æœ‰åŠ©äºæˆ‘ä»¬ç†è§£æ•´ä¸ªè®¾è®¡æ€è·¯ã€‚</p>
<p>åœ¨çœ‹çœŸæ­£çš„æºä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çŒœæµ‹ä¸‹è¿™ç©æ„æ€ä¹ˆå®ç°çš„ã€‚ä»æˆ‘ä¸ªäººè§’åº¦å‡ºå‘ï¼Œæˆ‘ä¸€å¼€å§‹æ˜¯è¿™ä¹ˆçŒœæµ‹çš„ï¼š</p>
<ul>
<li>æ•´ä½“çš„ç»“æ„åº”è¯¥æ˜¯ä¸ªUICollectionViewï¼Œæ¯ä¸ªæ—¥æœŸéƒ½æ˜¯ä¸€ä¸ªUICollectionViewCellã€‚</li>
<li>æ¯ä¸ªCellåŒ…å«ä¸€ä¸ªåœ†çš„èƒŒæ™¯è‰²ï¼ˆå¦‚æœæ˜¯ä»Šå¤©ï¼‰ï¼ŒåŒ…å«ä¸€ä¸ªæ–¹å½¢çš„èƒŒæ™¯è‰²(è¿ç»­)ï¼Œå·¦å³å°½å¤´æ˜¯ä¸¤ä¸ªåŠåœ†çš„ï¼ŒåŸºäºè¿™ä¸ªï¼ŒçŒœæµ‹åœ¨æ¯ä¸ªæ—¥æœŸCellé‡Œé¢åŒ…å«ä¸€ä¸ªèƒŒæ™¯Viewï¼Œå¡«å……é¢œè‰²ï¼Œè®¾ç½®åœ†è§’ã€‚</li>
<li>æœ€ä¸Šé¢æœ‰ä¸ªæ‚¬æµ®çš„sunday - saturdayçš„è¡¨ç¤ºæ˜ŸæœŸå‡ çš„UIViewï¼Œåº”è¯¥æ˜¯ä¸ªç‹¬ç«‹å›¾å±‚ï¼Œæ·»åŠ äº†é˜´å½±ã€‚<b>å›½å¤–äººä¸ºä»€ä¹ˆå–œæ¬¢æŠŠæ˜ŸæœŸæ—¥å½“æˆä¸€å‘¨çš„å¼€å§‹å‘¢ï¼ŒçœŸè›‹ç–¼ã€‚</b></li>
<li>æ»šåŠ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¼šå‡ºç°ä¸€ä¸ªæ˜¾ç¤ºå¯¹åº”æœˆä»½çš„Viewï¼Œå¯èƒ½æ˜¯ä¸ªç‹¬ç«‹çš„UIViewã€‚</li>
<li><b>æ‹–åŠ¨è¿‡ç¨‹ä¸­å‡ºç°çš„æ”¾å¤§é•œæ•ˆæœï¼Œæ²¡çŒœå‡ºæ¥ã€‚è¿™ä¸ªæ”¾å¤§é•œæ€ä¹ˆåšçš„ï¼Ÿ</b></li>
</ul>
<p>å¸¦ç€è¿™äº›ç–‘é—®æˆ‘ä»¬ä¸‹é¢è¿›å…¥å›¾å±‚åˆ†è§£ï¼Œæ¥ä¸€ä¸ªä¸ªéªŒè¯æˆ‘ä»¬çš„çŒœæµ‹æ­£ç¡®ä¸æ­£ç¡®ã€‚</p>
<p>å½“ç„¶ï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆå¤§è‡´æµè§ˆä¸‹ç»“æ„ï¼Œæ•´ä¸ªé¡¹ç›®çš„æ–‡ä»¶ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š</p>
<pre><code>-<span class="ruby">- <span class="constant">GLCalendarDateRange</span>.h/.m
</span>-<span class="ruby">- <span class="constant">GLCalendarDayCell</span>
</span>   -<span class="ruby">- <span class="constant">GLCalendarDayCell</span>.h/.m/.xib
</span>   -<span class="ruby">- <span class="constant">GLCalendarDayCellBackgroundCover</span>.h/.m
</span>-<span class="ruby">- <span class="constant">GLCalendarMonthCoverView</span>.h/.m
</span>-<span class="ruby">- <span class="constant">GLCalendarView</span>.h/.m/.xib
</span>-<span class="ruby">- <span class="constant">GLDateUtils</span>.h/.m</span>
</code></pre><h4 id="GLCalendarDayCell">GLCalendarDayCell</h4><p>å…¨å±€æœç´¢ä¸‹CollectionViewCellå…³é”®å­—ï¼Œæˆ‘ä»¬å‘ç°ï¼Œæœç„¶åœ¨GLCalendarDayCellè¿™ä¸ªç±»é‡Œé¢ï¼ŒåŒ…å«äº†ä¸€ä¸ªUICollectionViewæˆå‘˜ã€‚</p>
<p><b> GLCalendarDayCellé‡‡ç”¨xibå¼çš„å›¾å½¢åŒ–å¼€å‘ï¼Œåªè¦æ‰¾åˆ°å¯¹åº”çš„xibæ–‡ä»¶ï¼Œå¯¹äºä¸€ä¸ªç•Œé¢çš„å¸ƒå±€å¾ˆè½»æ¾å¾—å°±äº†ç„¶äºèƒ¸äº†.</b></p>
<p>ç„¶åæˆ‘ä»¬æ‰“å¼€è¿™ä¸ªå¯¹åº”çš„xibæ–‡ä»¶ï¼Œå‘ç°è¿™ä¸ªcellçš„å¸ƒå±€åŒ…æ‹¬äº†ï¼š</p>
<ul>
<li>åº•å±‚çš„Cell</li>
<li>backgroundCover çš„UIView</li>
<li>æ˜¾ç¤ºæ—¥æœŸçš„UILabel</li>
<li>æ˜¾ç¤ºæœˆä»½çš„UILabel</li>
</ul>
<p>è¿™ä¸ªç±»å¾ˆç®€å•ï¼Œå…·ä½“å°±æ˜¯åšäº†ä¸€å¤§å †ç»†èŠ‚é…ç½®çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬æ¥è¯´ä¸€ä¸ªæœ‰æ„æ€çš„åœ°æ–¹ï¼Œåœ¨GLCalendarDayCell.hé‡Œé¢ï¼Œæœ‰è¿™ä¸ªä¸€æ®µå®šä¹‰ï¼š</p>
<pre><code><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *evenMonthBackgroundColor <span class="built_in">UI_APPEARANCE_SELECTOR</span>;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *oddMonthBackgroundColor <span class="built_in">UI_APPEARANCE_SELECTOR</span>;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSDictionary</span> *dayLabelAttributes <span class="built_in">UI_APPEARANCE_SELECTOR</span>;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSDictionary</span> *futureDayLabelAttributes <span class="built_in">UI_APPEARANCE_SELECTOR</span>;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSDictionary</span> *todayLabelAttributes <span class="built_in">UI_APPEARANCE_SELECTOR</span>;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSDictionary</span> *monthLabelAttributes <span class="built_in">UI_APPEARANCE_SELECTOR</span>;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *todayBackgroundColor <span class="built_in">UI_APPEARANCE_SELECTOR</span>;
</code></pre><p>å…¶ä¸­<b>UIAPPEARANCESELECTOR</b>å¯èƒ½å¯¹äºå¾ˆå¤šäººä¸ç†Ÿæ‚‰ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹çš„å®šä¹‰ï¼Œ</p>
<pre><code><span class="hexcolor">#def</span>ine UI_APPEARANCE_SELECTOR __attribute__((<span class="function"><span class="title">annotate</span><span class="params">(<span class="string">"ui_appearance_selector"</span>)</span></span>))
</code></pre><p>è¿™ä¸ªå…¶å®æ˜¯ä¸€ä¸ªå®ï¼Œé‚£ä¹ˆè¿™ä¸ªä¸œè¥¿çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<b>æ˜¯ä¸ºäº†å…¨å±€é…ç½®æ ·å¼ï¼</b></p>
<p>ä¸çŸ¥é“å¤§å®¶æ˜¯å¦è¿˜è®°å¾—æˆ‘ä»¬ç»å¸¸ä¼šå†™[UINavigationBar appearance].tintColoræ¥ä¿®æ”¹å¯¼èˆªæ çš„é¢œè‰²ï¼Œé‚£ä¹ˆè¿™ä¸ªå®çš„ä½œç”¨ç®€å•æ¥ç†è§£å°±æ˜¯è®©ä½ çš„ç±»æ‹¥æœ‰å¯ä»¥å…¨å±€ä¿®æ”¹æ ·å¼çš„èƒ½åŠ›ï¼Œå¦‚ï¼š</p>
<pre><code><span class="string">[GLCalendarDayCell appearance]</span>.todayBackgroundColor = <span class="string">[UIColol redColor]</span>;
</code></pre><p>è¿™ä¸ªç±»ä»£ç è™½ç„¶ç®€å•ï¼Œå´åœ¨å®ç°ä¸Šæœ‰ä¸ªå¾ˆå¥½çš„åœ°æ–¹ï¼Œä»–æŠŠè¿™ä¸ªCellçš„æ ·å¼ï¼ˆç®€å•æ¥è¯´çš„å°±æ˜¯é¢œè‰²ï¼Œè¾¹ç•Œï¼‰äº¤ç”±äº†ä¸‹é¢æˆ‘ä»¬è¦æåˆ°çš„GLCalendarDayCellBackgroundCoverç±»å»åšï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªCellä»…ä»…ç»´æŠ¤çŠ¶æ€å˜æ›´çš„é€»è¾‘ï¼Œæ ·å¼æœ‰å•ç‹¬çš„æ ·å¼ç±»å®Œæˆç»˜åˆ¶ã€‚</p>
<h4 id="GLCalendarDayCellBackgroundCover">GLCalendarDayCellBackgroundCover</h4><p>è¿™ä¸ªç±»çš„ä½œç”¨ï¼Œæ— å®ƒï¼Œå°±æ˜¯ç”»ã€‚çœ‹ä¸‹ä»–çš„å¤´æ–‡ä»¶å®šä¹‰ï¼Œå¤§å®¶å°±èƒ½ç¬é—´æ˜ç™½ï¼š</p>
<pre><code><span class="class"><span class="keyword">@interface</span> <span class="title">GLCalendarDayCellBackgroundCover</span> : <span class="title">UIView</span></span>
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) RANGE_POSITION rangePosition;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> paddingLeft;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> paddingRight;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> paddingTop;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *fillColor;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *strokeColor;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIImage</span> *backgroundImage;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> borderWidth;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> inEdit;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> isToday;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> continuousRangeDisplay;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> pointSize;
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> pointScale;
- (<span class="keyword">void</span>)enlargeBeginPoint:(<span class="built_in">BOOL</span>)enlarge;
- (<span class="keyword">void</span>)enlargeEndPoint:(<span class="built_in">BOOL</span>)enlarge;
<span class="keyword">@end</span>
</code></pre><p>å½“ç„¶ï¼Œè¿™é‡Œè¦æä¸€ç‚¹ï¼Œç”»åœ†çš„å‡ ç§æ–¹æ³•ï¼š</p>
<ul>
<li>cornerRadius -&gt; GPU offscreen rendering ä½æ€§èƒ½</li>
<li>CAShaperLayer å½“æˆmask -&gt; GPU offscreen rendering ä½æ€§èƒ½</li>
<li>drawRect + UIBeizerPath -&gt; CPU offerscreen renderingï¼Œå¿«ï¼Œä½†æ˜¯å†…å­˜å¼€é”€å¤§</li>
</ul>
<p>è¿™é‡Œåœ¨å®ç°åœ†è§’çš„æ—¶å€™ï¼Œå°±ç”¨äº†ç¬¬ä¸‰ç§ï¼š</p>
<pre><code><span class="setting">path = <span class="value">[UIBezierPath bezierPathWithOvalInRect:rect];</span></span>
<span class="title">[path closePath]</span><span class="comment">;</span>
<span class="title">[self.fillColor setFill]</span><span class="comment">;</span>
<span class="title">[path fill]</span><span class="comment">;</span>
</code></pre><p>åˆ«çš„ä¹Ÿæ²¡ä»€ä¹ˆï¼Œéƒ½æ˜¯å…·ä½“çš„æ•°å­¦æ±‚ç”»çš„ä½ç½®ã€‚ä»¥å¦‚ä¸‹ä»£ç ä¸ºä¾‹å­è¯´æ˜ä¸‹</p>
<pre><code><span class="tag">if</span> (self.rangePosition == RANGE_POSITION_BEGIN) {
    <span class="attr_selector">[path moveToPoint:CGPointMake(radius + borderWidth + paddingLeft, paddingTop + borderWidth)]</span>;
    <span class="attr_selector">[path addArcWithCenter:CGPointMake(radius + borderWidth + paddingLeft, midY) radius:radius startAngle: - M_PI / 2 endAngle: M_PI / 2 clockwise:NO]</span>;

    <span class="attr_selector">[path addLineToPoint:CGPointMake(width, height - borderWidth - paddingTop)]</span>;
    <span class="attr_selector">[path addLineToPoint:CGPointMake(width, borderWidth + paddingTop)]</span>;

    <span class="attr_selector">[path closePath]</span>;
}
</code></pre><p><b>RANGEPOSITIONBEGIN</b>è¡¨ç¤ºä¸ºå·¦ä¾§å¼€å¤´çš„cellï¼Œæ‰€ä»¥æœ‰ä¸ªå·¦å¼§åº¦ã€‚ç”»æ³•è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å·¦å¼§åº¦çš„ä¸Šéƒ¨é¡¶ç‚¹ä½œä¸ºè´å¡å°”æ›²çº¿çš„åˆå§‹ç‚¹</li>
<li>ç”»å·¦å¼§åº¦</li>
<li>ç”»å·¦å¼§åº¦ä¸‹æ–¹çš„ä¸€æ¡æ°´å¹³æ¨ªçº¿</li>
<li>ç”»æ°´å¹³æ¨ªçº¿å³ç«¯é¡¶ç‚¹å‘ä¸Šçš„ç«–ç›´çº¿</li>
<li>å°é—­ï¼Œè‡ªåŠ¨ä¼šåœ¨ç«–ç›´çº¿å’Œä¸Šéƒ¨åˆå§‹é¡¶ç‚¹é—´æ·»åŠ ä¸€æ¡æ°´å¹³æ¨ªçº¿ã€‚</li>
</ul>
<h4 id="GLCalendarView">GLCalendarView</h4><p>æœ€åæ¥è¯´ä¸‹å¯¹å¤–æš´éœ²çš„ç±»ï¼ŒGLCalendarViewã€‚<br>è¿™ä¸ªç±»çš„å®ç°å°±æ˜¯ä¸€å¯¹æ§åˆ¶é€»è¾‘ï¼Œä¸»è¦è¯´ä¸‹æˆ‘ç‰¹åˆ«æ„Ÿå…´è¶£çš„æ‹–åŠ¨rangeçš„è¿‡ç¨‹ä¸­æ”¾å¤§é•œçš„å®ç°ã€‚</p>
<ul>
<li>é¦–å…ˆè¿™ä¸ªæ”¾å¤§é•œï¼Œæ˜¯ä¸ªä¸­å¿ƒåŒºåŸŸé€æ˜çš„å›¾ç‰‡ã€‚æˆ‘ä¸€å¼€å§‹æ˜¯çº¯ä»£ç ç¼–ç¨‹çš„ï¼ŒçœŸè›‹ç–¼ã€‚</li>
<li>è¿™ä¸ªæ”¾å¤§é•œåº•ä¸‹å·å·åŸ‹äº†ä¸ªUIImageViewï¼Œæ¯æ¬¡æ‹–åŠ¨çš„æ›´æ–°çš„æ—¶å€™ï¼Œéƒ½è‡ªåŠ¨å»æˆªå›¾ï¼ŒæŠŠæˆªå›¾æ”¾åˆ°è¿™ä¸ªUIImageViewé‡Œé¢ï¼Œå°±å®Œæˆäº†æ”¾å¤§é•œçš„æ•ˆæœã€‚</li>
</ul>
<p>å…·ä½“çš„å®ç°å¦‚ä¸‹ï¼š</p>
<pre><code>- (<span class="keyword">void</span>)showMagnifierAboveDate:(<span class="built_in">NSDate</span> *)date
{
    <span class="keyword">if</span> (!<span class="keyword">self</span><span class="variable">.showMagnifier</span>) {
        <span class="keyword">return</span>;
    }
    GLCalendarDayCell *cell = (GLCalendarDayCell *)[<span class="keyword">self</span> collectionView:<span class="keyword">self</span><span class="variable">.collectionView</span> cellForItemAtIndexPath:[<span class="keyword">self</span> indexPathForDate:date]];
    <span class="built_in">CGFloat</span> delta = <span class="keyword">self</span><span class="variable">.cellWidth</span> / <span class="number">2</span>;
    <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.draggingBeginDate</span>) {
        delta = delta;
    } <span class="keyword">else</span> {
        delta = -delta;
    }
    <span class="built_in">UIGraphicsBeginImageContextWithOptions</span>(<span class="keyword">self</span><span class="variable">.maginifierContentView</span><span class="variable">.frame</span><span class="variable">.size</span>, <span class="literal">YES</span>, <span class="number">0.0</span>);
    <span class="built_in">CGContextRef</span> context = <span class="built_in">UIGraphicsGetCurrentContext</span>();
    <span class="built_in">CGContextFillRect</span>(context, <span class="keyword">self</span><span class="variable">.maginifierContentView</span><span class="variable">.bounds</span>);
    <span class="built_in">CGContextTranslateCTM</span>(context, -cell<span class="variable">.center</span><span class="variable">.x</span> + delta, -cell<span class="variable">.center</span><span class="variable">.y</span>);
    <span class="built_in">CGContextTranslateCTM</span>(context, <span class="keyword">self</span><span class="variable">.maginifierContentView</span><span class="variable">.frame</span><span class="variable">.size</span><span class="variable">.width</span> / <span class="number">2</span>, <span class="keyword">self</span><span class="variable">.maginifierContentView</span><span class="variable">.frame</span><span class="variable">.size</span><span class="variable">.height</span> / <span class="number">2</span>);
    [<span class="keyword">self</span><span class="variable">.collectionView</span><span class="variable">.layer</span> renderInContext:context];
    <span class="built_in">UIImage</span> *image = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();
    <span class="built_in">UIGraphicsEndImageContext</span>();

    <span class="keyword">self</span><span class="variable">.maginifierContentView</span><span class="variable">.image</span> = image;
    <span class="keyword">self</span><span class="variable">.magnifierContainer</span><span class="variable">.center</span> = [<span class="keyword">self</span> convertPoint:<span class="built_in">CGPointMake</span>(cell<span class="variable">.center</span><span class="variable">.x</span> - delta - <span class="number">58</span>, cell<span class="variable">.center</span><span class="variable">.y</span> - <span class="number">90</span>) fromView:<span class="keyword">self</span><span class="variable">.collectionView</span>];
    <span class="keyword">self</span><span class="variable">.magnifierContainer</span><span class="variable">.hidden</span> = <span class="literal">NO</span>;
}
</code></pre><p>ä¸»è¦è¯´ä¸‹CGContexté‚£å—ï¼Œå› ä¸ºå‘ç°å¥½å¤šäººè¿˜ä¸æ˜¯ç‰¹åˆ«èƒ½ç†è§£ã€‚</p>
<p><b>é¦–å…ˆï¼Œåæ ‡ç³»å’ŒUIKitæ˜¯åè¿‡æ¥çš„ï¼</b><br>ç„¶åè¿™æ®µä»£ç åšäº†å•¥å‘¢ï¼Ÿ</p>
<ul>
<li><p>è·å–å½“å‰æ‹–æ‹½æ—¥æœŸçš„å¯¹åº”çš„Cellã€‚</p>
</li>
<li><p>åˆ›å»ºä¸€ä¸ªç”»å¸ƒï¼Œç”»å¸ƒå¤§å°å°±æ˜¯æ”¾å¤§é•œçš„å¤§å°ã€‚</p>
<pre><code><span class="tag">UIGraphicsBeginImageContextWithOptions</span>(<span class="tag">self</span><span class="class">.maginifierContentView</span><span class="class">.frame</span><span class="class">.size</span>, <span class="tag">YES</span>, 0<span class="class">.0</span>);
</code></pre></li>
<li><p>ä½ç§»åˆ°cellçš„ä½ç½®å¤„è¿›è¡Œæˆªå›¾ï¼Œå› ä¸ºæ˜¯CGContextç”»å›¾ï¼Œæ‰€ä»¥å‘ä¸Šæ˜¯æ­£çš„ï¼Œå‘ä¸‹è´Ÿçš„ã€‚</p>
<pre><code><span class="tag">CGContextTranslateCTM</span>(<span class="tag">context</span>, <span class="tag">-cell</span><span class="class">.center</span><span class="class">.x</span> + <span class="tag">delta</span>, <span class="tag">-cell</span><span class="class">.center</span><span class="class">.y</span>);
</code></pre></li>
<li><p>å‘ä¸Šç§»åˆ°æ”¾å¤§é•œçš„ä¸­å¿ƒæˆªå›¾ï¼Œå¦åˆ™å› ä¸ºæ”¾å¤§é•œçš„å¤§å°æ˜¯cellçš„é«˜åº¦ï¼Œä¼šåŒ…å«ä¸Šcellçš„ä¸‹åŠéƒ¨åˆ†ï¼Œå’Œä¸‹cellçš„ä¸ŠåŠéƒ¨åˆ†ã€‚</p>
<pre><code>CGContextTranslateCTM(context, self.maginifierContentView.frame.<span class="built_in">size</span>.<span class="variable">width</span> / <span class="number">2</span>, self.maginifierContentView.frame.<span class="built_in">size</span>.<span class="variable">height</span> / <span class="number">2</span>);
</code></pre></li>
</ul>
<h4 id="Thread_Local_å˜é‡">Thread Local å˜é‡</h4><p>åœ¨GLCalendarViewé‡Œé¢ï¼Œæœ‰ä¸€ä¸ªæ¯”è¾ƒæœ‰äº®ç‚¹çš„å®ç°ï¼š</p>
<pre><code>+ (<span class="built_in">NSCalendar</span> *)calendar {
    <span class="built_in">NSMutableDictionary</span> *threadDictionary = [[<span class="built_in">NSThread</span> currentThread] threadDictionary];

    <span class="built_in">NSCalendar</span> *cal = [threadDictionary objectForKey:<span class="string">@"GLCalendar"</span>];
    <span class="keyword">if</span> (!cal) {
        cal = [[<span class="built_in">NSCalendar</span> alloc] initWithCalendarIdentifier:<span class="built_in">NSCalendarIdentifierGregorian</span>];
        cal<span class="variable">.locale</span> = [<span class="built_in">NSLocale</span> currentLocale];
        [threadDictionary setObject:cal forKey:<span class="string">@"GLCalendar"</span>];
    }
    <span class="keyword">return</span> cal;
}
</code></pre><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒNSCalendarçš„åˆå§‹åŒ–æ˜¯æ¯”è¾ƒè€—æ—¶çš„ï¼Œæ‰€ä»¥ç»éªŒä¸Šæ¥è¯´ä¸€èˆ¬ä¼šæ„å»ºä¸€ä¸ªå•ä¾‹å­ä½¿ç”¨ã€‚ä½†æ˜¯åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œç”¨äº†threadDictionaryå»è·å–thread local variableã€‚ç›¸å½“äºåœ¨æ¯ä¸ªä½¿ç”¨åˆ°è¿™ä¸ªå‡½æ•°çš„çº¿ç¨‹é‡Œéƒ½æ„å»ºä¸€ä¸ªthread localçš„å•ä¾‹å­ï¼Œé‚£ä¹ˆthread localçš„å¥½å¤„æœ‰å•¥å‘¢ï¼Ÿ</p>
<ul>
<li>çº¿ç¨‹å®‰å…¨</li>
<li>thread local cacheï¼Œè®¿é—®å¿«ï¼Œé¿å…flush cache lineã€‚</li>
</ul>
<p>ä½†æ˜¯å…¶å®æˆ‘ä¸ªäººä¸æ˜¯å¾ˆç†è§£è¿™ä¹ˆåšçš„ä¼˜åŠ¿ç©¶ç«Ÿæœ‰å¤šå¤§ï¼Œè¯·å¤§å®¶æŒ‡ç‚¹ä¸€ä¸‹ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/10/14/GLCalendarView/" data-id="cjqdxq21a002ymxi16bzq1brq" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/10/14/GLCalendarView/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-Debounce-and-Throttle-in-iOS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/09/30/Debounce-and-Throttle-in-iOS/" class="article-date">
  <time datetime="2015-09-30T10:44:45.000Z" itemprop="datePublished">2015-09-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/09/30/Debounce-and-Throttle-in-iOS/">å®ç°iOSä¸­çš„å‡½æ•°èŠ‚æµå’Œå‡½æ•°é˜²æŠ–</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="å‡½æ•°é˜²æŠ–ä¸èŠ‚æµ">å‡½æ•°é˜²æŠ–ä¸èŠ‚æµ</h3><p>ä»Šå¤©æ¥å’Œå¤§å®¶è°ˆè®ºä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„è¯é¢˜ï¼Œå°±æ˜¯å‡½æ•°èŠ‚æµå’Œå‡½æ•°é˜²æŠ–ã€‚<br>å¯èƒ½å¤§å®¶è¿˜ä¸æ˜¯éå¸¸äº†è§£è¿™ä¸¤ä¸ªæœ¯è¯­çš„æ„æ€ï¼Œè®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ä»–ä»¬çš„å«ä¹‰å§ã€‚</p>
<blockquote><br>Throttling enforces a maximum number of times a function can be called over time. As in â€œexecute this function at most once every 100 milliseconds.â€<br></blockquote>

<p>é¦–å…ˆæ˜¯å‡½æ•°èŠ‚æµï¼ˆThrottlingï¼‰ï¼Œæ„æ€å°±æ˜¯è¯´ä¸€ä¸ªå‡½æ•°åœ¨ä¸€å®šæ—¶é—´å†…ï¼Œåªèƒ½æ‰§è¡Œæœ‰é™æ¬¡æ•°ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªå‡½æ•°åœ¨100æ¯«ç§’å‘¢ï¼Œæœ€å¤šåªèƒ½æ‰§è¡Œä¸€æ¬¡ã€‚<b>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä¸æ‰§è¡Œï¼</b></p>
<p>çœ‹å®Œäº†èŠ‚æµï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å‡½æ•°é˜²æŠ–ï¼ˆDebouncingï¼‰ã€‚</p>
<blockquote><br>Debouncing enforces that a function not be called again until a certain amount of time has passed without it being called. As in â€œexecute this function only if 100 milliseconds have passed without it being called.â€<br></blockquote>

<p>å‡½æ•°é˜²æŠ–çš„æ„æ€å°±æ˜¯ï¼Œä¸€ä¸ªå‡½æ•°è¢«æ‰§è¡Œè¿‡ä¸€æ¬¡ä»¥åï¼Œåœ¨ä¸€æ®µæ—¶é—´å†…ä¸èƒ½å†æ¬¡æ‰§è¡Œã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªå‡½æ•°æ‰§è¡Œå®Œäº†ä¹‹åï¼Œ100æ¯«ç§’ä¹‹å†…ä¸èƒ½ç¬¬äºŒæ¬¡æ‰§è¡Œã€‚</p>
<p>å’¦ï¼Ÿæœ‰äººçœ‹åˆ°è¿™ï¼Œè‚¯å®šå°±æœ‰ç–‘æƒ‘äº†ï¼Œè¿™ä¸¤ç©æ„æœ‰å•¥åŒºåˆ«å•Šï¼Ÿè¿™ä¹ˆè§£é‡Šå§ï¼Œå‡½æ•°é˜²æŠ–å¯èƒ½ä¼šè¢«æ— é™å»¶è¿Ÿã€‚ç”¨ç°å®ä¹˜åå…¬äº¤è½¦ä¸­çš„ä¾‹å­æ¥è¯´ï¼ŒThrottleå°±æ˜¯å‡†ç‚¹å°±å‘è½¦ï¼ˆæ¯”å¦‚15åˆ†é’Ÿä¸€ç­å…¬äº¤è½¦ï¼‰ï¼›Debounceå°±æ˜¯é»‘è½¦ï¼Œä¸Šäº†ä¸€ä¸ªäººä»¥åï¼Œå¸æœºè¯´ï¼Œå†ç­‰ä¸€ä¸ªäººï¼Œç­‰ä¸åˆ°ï¼Œå’±ä¹ˆ10åˆ†é’Ÿåå‡ºå‘ã€‚ä½†æ˜¯å‘¢ï¼Œå¦‚æœåœ¨10åˆ†é’Ÿå†…åˆæœ‰ä¸€ä¸ªäººä¸Šè½¦ï¼Œè¿™ä¸ª10åˆ†é’Ÿè‡ªåŠ¨å»¶åç›´åˆ°ç­‰å¾…çš„10åˆ†é’Ÿå†…æ²¡äººä¸Šè½¦äº†ã€‚æ¢å¥è¯è¯´ï¼ŒDebounceå¯ä»¥ç†è§£æˆmergeä¸€æ®µæ—¶é—´çš„ä¸€ç³»åˆ—ç›¸åŒå‡½æ•°è°ƒç”¨ã€‚</p>
<p>å¦‚æœè¿˜ä¸èƒ½ç†è§£ï¼Œè¿™é‡Œæœ‰ä¸ªå¾ˆå¥½ç©çš„<a href="http://demo.nimius.net/debounce_throttle/" target="_blank" rel="external">åœ¨çº¿æ¼”ç¤º</a> (PS:ä½ å¿…é¡»ç”¨ç”µè„‘ä¸Š)</p>
<h3 id="JavaScriptä¸­çš„å‡½æ•°èŠ‚æµå’Œé˜²æŠ–">JavaScriptä¸­çš„å‡½æ•°èŠ‚æµå’Œé˜²æŠ–</h3><p>è¯´åˆ°é˜²æŠ–å’ŒèŠ‚æµï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸å…ˆæ¥æä¸€æJavaScriptä¸­å‘çˆ¹çš„DOMæ“ä½œã€‚æˆ‘ä»¬ç›´æ¥çœ‹underscore.jsä¸­çš„æºç ï¼š<br>é¦–å…ˆæ˜¯Throttleï¼š</p>
<pre><code>_.throttle = function(func, wait) {
  <span class="keyword">var</span> context, args, <span class="literal">result</span>;
  <span class="keyword">var</span> timeout = null;

  <span class="keyword">var</span> previous = <span class="number">0</span>;
  <span class="keyword">var</span> later = function() {
    // è‹¥è®¾å®šäº†å¼€å§‹è¾¹ç•Œä¸æ‰§è¡Œé€‰é¡¹ï¼Œä¸Šæ¬¡æ‰§è¡Œæ—¶é—´å§‹ç»ˆä¸º<span class="number">0</span>
    previous = options.leading === <span class="literal">false</span> ? <span class="number">0</span> : _.now();
    timeout = null;
    <span class="literal">result</span> = func.apply(context, args);
    <span class="keyword">if</span> (!timeout) context = args = null;
  };
  <span class="keyword">return</span> function() {
    <span class="keyword">var</span> now = _.now();
    // é¦–æ¬¡æ‰§è¡Œæ—¶ï¼Œå¦‚æœè®¾å®šäº†å¼€å§‹è¾¹ç•Œä¸æ‰§è¡Œé€‰é¡¹ï¼Œå°†ä¸Šæ¬¡æ‰§è¡Œæ—¶é—´è®¾å®šä¸ºå½“å‰æ—¶é—´ã€‚
    <span class="keyword">if</span> (!previous &amp;&amp; options.leading === <span class="literal">false</span>) previous = now;
    // å»¶è¿Ÿæ‰§è¡Œæ—¶é—´é—´éš”
    <span class="keyword">var</span> remaining = wait - (now - previous);
    context = this;
    args = arguments;
    // å»¶è¿Ÿæ—¶é—´é—´éš”remainingå°äºç­‰äº<span class="number">0</span>ï¼Œè¡¨ç¤ºä¸Šæ¬¡æ‰§è¡Œè‡³æ­¤æ‰€é—´éš”æ—¶é—´å·²ç»è¶…è¿‡ä¸€ä¸ªæ—¶é—´çª—å£
    // remainingå¤§äºæ—¶é—´çª—å£waitï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯ç³»ç»Ÿæ—¶é—´è¢«è°ƒæ•´è¿‡
    <span class="keyword">if</span> (remaining &lt;= <span class="number">0</span> || remaining &gt; wait) {
      clearTimeout(timeout);
      timeout = null;
      previous = now;
      <span class="literal">result</span> = func.apply(context, args);
      <span class="keyword">if</span> (!timeout) context = args = null;
    //å¦‚æœå»¶è¿Ÿæ‰§è¡Œä¸å­˜åœ¨ï¼Œä¸”æ²¡æœ‰è®¾å®šç»“å°¾è¾¹ç•Œä¸æ‰§è¡Œé€‰é¡¹
    } <span class="keyword">else</span> <span class="keyword">if</span> (!timeout &amp;&amp; options.trailing !== <span class="literal">false</span>) {
      timeout = setTimeout(later, remaining);
    }
    <span class="keyword">return</span> <span class="literal">result</span>;
  };
};
</code></pre><p>ä»£ç é€»è¾‘éå¸¸å¥½ç†è§£ï¼Œ</p>
<pre><code><span class="variable"><span class="keyword">var</span> remaining</span> = wait - (now - previous);
</code></pre><p>å°±æ˜¯è®¡ç®—ä¸‹ä¸Šä¸€æ¬¡è°ƒç”¨çš„æ—¶é—´å’Œç°åœ¨æ‰€å¤„çš„æ—¶é—´é—´éš”æ˜¯ä¸æ˜¯è¶…è¿‡äº†waitçš„æ—¶é—´<b>ï¼ˆè¿™ä¸ªæ—¶é—´åªæœ‰å¯èƒ½ä¼šå¤§äºç­‰äºwaitï¼Œå› ä¸ºrunloopæ˜¯å¾ˆç¹å¿™çš„ï¼Œå‰é¢ä¸€ä¸ªä»»åŠ¡å¾ˆè€—æ—¶ï¼Œé‚£ä½ å°±å¤šç­‰ä¸€ä¼šå‘—ï¼‰</b>ã€‚<br>å¯èƒ½ä¼šæœ‰äººä¸ç†è§£optionæ˜¯å•¥æ„æ€ï¼Œæˆ‘ä»¬çœ‹ä¸‹ä»£ç ä¸­æ¶‰åŠäº†ä»¥ä¸‹ä¸¤ä¸ªå‚æ•°ï¼š</p>
<pre><code><span class="tag">options</span><span class="class">.leading</span>å’Œ<span class="tag">options</span><span class="class">.trailing</span>
</code></pre><p>è¿™ä¸¤ä¸ªå‚æ•°çš„æ„æ€å°±æ˜¯ç¦æ­¢ç¬¬ä¸€æ¬¡è°ƒç”¨å’Œæœ€åä¸€æ¬¡è°ƒç”¨ï¼Œç®€å•å§ã€‚</p>
<p>ç†è§£äº†å‡½æ•°èŠ‚æµï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹é˜²æŠ–æ˜¯æ€ä¹ˆåšçš„ã€‚<br>    _.debounce = function(func, wait, immediate) {<br>      var timeout, args, context, timestamp, result;</p>
<pre><code>  <span class="keyword">var</span> later = function() {
    // æ®ä¸Šä¸€æ¬¡è§¦å‘æ—¶é—´é—´éš”
    <span class="keyword">var</span> last = _.now() - timestamp;

    // ä¸Šæ¬¡è¢«åŒ…è£…å‡½æ•°è¢«è°ƒç”¨æ—¶é—´é—´éš”lastå°äºè®¾å®šæ—¶é—´é—´éš”wait
    <span class="keyword">if</span> (last &lt; wait &amp;&amp; last &gt; <span class="number">0</span>) {
      timeout = setTimeout(later, wait - last);
    } <span class="keyword">else</span> {
      timeout = null;
      // å¦‚æœè®¾å®šä¸ºimmediate===<span class="literal">true</span>ï¼Œå› ä¸ºå¼€å§‹è¾¹ç•Œå·²ç»è°ƒç”¨è¿‡äº†æ­¤å¤„æ— éœ€è°ƒç”¨
      <span class="keyword">if</span> (!immediate) {
        <span class="literal">result</span> = func.apply(context, args);
        <span class="keyword">if</span> (!timeout) context = args = null;
      }
    }
  };

  <span class="keyword">return</span> function() {
    context = this;
    args = arguments;
    timestamp = _.now();
    <span class="keyword">var</span> callNow = immediate &amp;&amp; !timeout;
    // å¦‚æœå»¶æ—¶ä¸å­˜åœ¨ï¼Œé‡æ–°è®¾å®šå»¶æ—¶
    <span class="keyword">if</span> (!timeout) timeout = setTimeout(later, wait);
    <span class="keyword">if</span> (callNow) {
      <span class="literal">result</span> = func.apply(context, args);
      context = args = null;
    }

    <span class="keyword">return</span> <span class="literal">result</span>;
  };
};
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨é˜²æŠ–çš„å‡½æ•°ä¸­åŒ…å«äº†ä¸€ä¸ª<b>timestamp</b>ï¼Œè¿™ä¸ªå‚æ•°ç”¨æ¥è®°å½•äº†å½“å‰è¿™ä¸ªå‡½æ•°æœ€åä¸€æ¬¡è¢«è°ƒç”¨æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Œæ¯æ¬¡è°ƒç”¨çš„æ—¶å€™ï¼Œå°±æ›´æ–°äº†timestampã€‚æœ‰äººå¯èƒ½ä¼šé—®ï¼Œè¿™ä¸ªtimestampåœ¨å¤šæ¬¡è°ƒç”¨çš„è¿‡ç¨‹ä¸­è¿˜èƒ½ä¿ç•™å—ï¼Ÿ<b>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œdebounceå‡½æ•°è¿”å›çš„å®é™…æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œè¿™ä¸ªåŒ¿åå‡½æ•°å°±æ˜¯ä¸€ä¸ªé—­åŒ…ç¯å¢ƒï¼Œå¯ä»¥æ•æ‰timestapè¿›è¡ŒæŒä¹…è¯è®¿é—®ï¼Œæ‰€ä»¥å¤šæ¬¡è°ƒç”¨è¿™ä¸ªåŒ¿åå‡½æ•°å®é™…ä¸Šè®¿é—®çš„éƒ½æ˜¯åŒä¸€ä¸ªtimestampã€‚</b></p>
<h3 id="å®ç°iOSä¸­çš„å‡½æ•°èŠ‚æµ">å®ç°iOSä¸­çš„å‡½æ•°èŠ‚æµ</h3><p>é‡å¤´æˆæ¥å•¦ï¼ï¼ï¼ï¼ã€‚<br>åœ¨iOSä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°è¿™æ ·çš„éœ€æ±‚ï¼Œæ¯”å¦‚è¯´ä½ è¦æ ¹æ®UIScrollViewçš„contentOffsetè¿›è¡ŒæŸäº›è®¡ç®—ã€‚è¿™äº›è®¡ç®—æœ‰çš„å¾ˆç®€å•ä¸è€—æ—¶ï¼Œæ¯”å¦‚æ ¹æ®offsetåŠ¨æ€çš„æ›´æ”¹UINavigationBarçš„alphaå€¼ã€‚ä½†æ˜¯æœ‰äº›å°±å¾ˆå¤æ‚ï¼Œæ¯”å¦‚ä½ è¦æ ¹æ®æŸäº›offsetå¯åŠ¨æŸäº›åŠ¨ç”»ï¼Œæˆ–è€…è¿›è¡Œå¤§è§„æ¨¡çš„è¿ç®—ï¼Œè¿˜æœ‰å¾ˆå¤šæ—¶å€™æ—¶å€™ä¼šå‘é€å¾ˆå¤šå¼‚æ­¥çš„APIè¯·æ±‚ï¼Œç”±äºå¾ˆå¤šç”¨æˆ·ä¼šä¸åœçš„ç”¨æŒ‡å°–åœ¨å®Œç¾çš„iPhoneå±å¹•ä¸Šæ¥å›æ»‘åŠ¨ï¼Œä½ ä¸€å®šä¸æƒ³ä½ çš„Appç”šè‡³æ˜¯æœåŠ¡å™¨è¿™äº›æ“ä½œç»™ç©å´©äº†ï¼Œæ‰€ä»¥ï¼Œå‡½æ•°èŠ‚æµæ˜¯å¿…ä¸å¯å°‘çš„ã€‚</p>
<h4 id="åˆçº§ç‰ˆæœ¬">åˆçº§ç‰ˆæœ¬</h4><p>ç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„å‡½æ•°èŠ‚æµå¦‚ä¸‹ï¼š</p>
<pre><code><span class="preprocessor">#import <span class="title">"PerformSelectorWithDebounce.h"</span></span>
<span class="preprocessor">#import <span class="title">&lt;objc/runtime.h&gt;</span></span>
<span class="preprocessor">#import <span class="title">&lt;objc/message.h&gt;</span></span>

<span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">Throttle</span>)</span>

<span class="keyword">const</span> <span class="keyword">char</span> * WZThrottledSelectorKey;

- (<span class="keyword">void</span>) wz_performSelector:(SEL)aSelector withThrottle:(<span class="built_in">NSTimeInterval</span>)duration
{
    <span class="built_in">NSMutableDictionary</span> *blockedSelectors = objc_getAssociatedObject(<span class="keyword">self</span>, WZThrottledSelectorKey);

    <span class="keyword">if</span>(!blockedSelectors)
    {
        blockedSelectors = [<span class="built_in">NSMutableDictionary</span> dictionary];
        objc_setAssociatedObject(<span class="keyword">self</span>, kDictionaryOfSelectorsToBlock, blockedSelectors, OBJC_ASSO<span class="built_in">CIATION_RETAIN</span>);
    }

    <span class="built_in">NSString</span> * selectorName = <span class="built_in">NSStringFromSelector</span>(aSelector);
    <span class="keyword">if</span>(![blockedSelectors objectForKey:aSelectorAsStr])
    {
        [blockedSelectors setObject:selectorName selectorName];

        objc_msgSend(<span class="keyword">self</span>, aSelector);
        [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(unlockSelector:) withObject:aSelectorAsStr afterDelay:duration];

    }
}

-(<span class="keyword">void</span>)unlockSelector:(<span class="built_in">NSString</span>*)selectorAsString
{
    <span class="built_in">NSMutableDictionary</span> *blockedSelectors = objc_getAssociatedObject(<span class="keyword">self</span>, WZThrottledSelectorKey);
    [blockedSelectors removeObjectForKey:selectorAsString];
}
</code></pre><p>åˆçœ‹è¿™ä¸ªä»£ç é€»è¾‘ï¼Œè¿™ä¸ªä»£ç åŸºæœ¬å®ç°äº†åœ¨ä¸€å®šæ—¶é—´å†…åªè°ƒç”¨æœ‰é™æ¬¡æ•°çš„å‡½æ•°ã€‚ä½†æ˜¯ï¼Œè¿™å“ªæ˜¯å‡½æ•°èŠ‚æµå•Šï¼Œè¿™æ˜¯å‡½æ•°æ–­æµï¼ä¸ä¿¡ä½ ä»¬åœ¨<b>[UIScrollView scrollViewDidScroll]</b>è¯•è¯•çœ‹ï¼Œä½ ä»¬å°±çŸ¥é“å•¥å«æ–­æµäº†ã€‚<b>åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬çš„unlockSelectoræ˜¯åŸºäºperformSelectorè§£é”çš„ï¼Œè€ŒperformSelectoræ˜¯åŸºäºrunloopçš„ï¼Œæˆ‘ä»¬åœ¨ä¸åœçš„æ»šåŠ¨çš„æ—¶å€™å°±ä¼šå¯¼è‡´æ•´ä¸ªä¸»runloopè¢«æˆ‘ä»¬å ç”¨ï¼Œå› æ­¤ï¼Œunlockçš„å‡½æ•°ä¸€ç›´æ²¡æœ‰å¾—åˆ°è°ƒç”¨ï¼Œç»“æœå°±å¯¼è‡´äº†æ–­æµã€‚</b></p>
<h4 id="é«˜çº§ç‰ˆæœ¬">é«˜çº§ç‰ˆæœ¬</h4><p>å› æ­¤ï¼Œæˆ‘åˆå®ç°äº†ä¸€ä¸ªé«˜çº§ç‰ˆæœ¬ï¼Œä»£ç å¦‚ä¸‹ï¼Œéœ€è¦æµ‹è¯•ç”¨ä¾‹å’Œæºç çš„å¯ä»¥ä¸Šæˆ‘çš„githubè‡ªå–ï¼Œ<a href="https://github.com/SatanWoo/iOSThrottle" target="_blank" rel="external">åœ°å€æˆ³æˆ‘</a>ã€‚ä»£ç é€»è¾‘å¾ˆç®€å•åŒæ—¶ä¹Ÿè§£å†³äº†ä¸Šè¿°ç‰ˆæœ¬æ‰€æåŠçš„é—®é¢˜ã€‚</p>
<pre><code><span class="preprocessor">#import <span class="title">"NSObject+Throttle.h"</span></span>
<span class="preprocessor">#import <span class="title">&lt;objc/runtime.h&gt;</span></span>
<span class="preprocessor">#import <span class="title">&lt;objc/message.h&gt;</span></span>

<span class="keyword">static</span> <span class="keyword">char</span> WZThrottledSelectorKey;
<span class="keyword">static</span> <span class="keyword">char</span> WZThrottledSerialQueue;

<span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">Throttle</span>)</span>

- (<span class="keyword">void</span>)wz_performSelector:(SEL)aSelector withThrottle:(<span class="built_in">NSTimeInterval</span>)inteval
{
    <span class="built_in">dispatch_async</span>([<span class="keyword">self</span> getSerialQueue], ^{
        <span class="built_in">NSMutableDictionary</span> *blockedSelectors = [objc_getAssociatedObject(<span class="keyword">self</span>, &amp;WZThrottledSelectorKey) mutableCopy];

        <span class="keyword">if</span> (!blockedSelectors) {
            blockedSelectors = [<span class="built_in">NSMutableDictionary</span> dictionary];
            objc_setAssociatedObject(<span class="keyword">self</span>, &amp;WZThrottledSelectorKey, blockedSelectors, OBJC_ASSO<span class="built_in">CIATION_COPY_NONATOMIC</span>);
        }

        <span class="built_in">NSString</span> *selectorName = <span class="built_in">NSStringFromSelector</span>(aSelector);
        <span class="keyword">if</span> (![blockedSelectors objectForKey:selectorName]) {
            [blockedSelectors setObject:selectorName forKey:selectorName];
            objc_setAssociatedObject(<span class="keyword">self</span>, &amp;WZThrottledSelectorKey, blockedSelectors, OBJC_ASSO<span class="built_in">CIATION_COPY_NONATOMIC</span>);

            <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^{
                objc_msgSend(<span class="keyword">self</span>, aSelector);

                dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(inteval * <span class="built_in">NSEC_PER_SEC</span>)), [<span class="keyword">self</span> getSerialQueue], ^{
                    [<span class="keyword">self</span> unlockSelector:selectorName];
                });
            });
        }
    });
}

<span class="preprocessor">#pragma mark - Private</span>
- (<span class="keyword">void</span>)unlockSelector:(<span class="built_in">NSString</span> *)selectorName
{
    <span class="built_in">dispatch_async</span>([<span class="keyword">self</span> getSerialQueue], ^{
        <span class="built_in">NSMutableDictionary</span> *blockedSelectors = [objc_getAssociatedObject(<span class="keyword">self</span>, &amp;WZThrottledSelectorKey) mutableCopy];

        <span class="keyword">if</span> ([blockedSelectors objectForKey:selectorName]) {
            [blockedSelectors removeObjectForKey:selectorName];
        }

        objc_setAssociatedObject(<span class="keyword">self</span>, &amp;WZThrottledSelectorKey, blockedSelectors, OBJC_ASSO<span class="built_in">CIATION_COPY_NONATOMIC</span>);
    });
}

- (<span class="built_in">dispatch_queue_t</span>)getSerialQueue
{
    <span class="built_in">dispatch_queue_t</span> serialQueur = objc_getAssociatedObject(<span class="keyword">self</span>, &amp;WZThrottledSerialQueue);
    <span class="keyword">if</span> (!serialQueur) {
        serialQueur = dispatch_queue_create(<span class="string">"com.satanwoo.throttle"</span>, <span class="literal">NULL</span>);
        objc_setAssociatedObject(<span class="keyword">self</span>, &amp;WZThrottledSerialQueue, serialQueur, OBJC_ASSO<span class="built_in">CIATION_RETAIN_NONATOMIC</span>);
    }
    <span class="keyword">return</span> serialQueur;
}

<span class="keyword">@end</span>
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/09/30/Debounce-and-Throttle-in-iOS/" data-id="cjqdxq21q003bmxi1kplhra91" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/09/30/Debounce-and-Throttle-in-iOS/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-flux-js-part-one" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/09/23/flux-js-part-one/" class="article-date">
  <time datetime="2015-09-23T10:37:36.000Z" itemprop="datePublished">2015-09-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/09/23/flux-js-part-one/">Fluxæºç è§£æï¼ˆä¸€ï¼‰</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Fluxæºç è§£æ_ç¬¬ä¸€ç« ">Fluxæºç è§£æ ç¬¬ä¸€ç« </h3><p>Fluxæ˜¯Facebookæ¨å‡ºçš„ä¸€ä¸ªæ–°çš„Webæ¶æ„ï¼Œç”¨æ¥æ„å»ºæ–°ä¸€ä»£çš„å®¢æˆ·ç«¯çš„Webç¨‹åºï¼Œä»Šå¤©æˆ‘ä»¬æ¥è§£æä¸‹å…¶ä¸­çš„æºç ï¼šDispatcher.jså’ŒInvariant.js</p>
<h4 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</h4><p>å»ºè®®å¤§å®¶å…ˆäº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯Fluxæ¶æ„ï¼ŒFacebookçš„å®˜ç½‘ä¸Šæœ‰éå¸¸è¯¦ç»†çš„è§£é‡Š:<a href="http://facebook.github.io/flux/docs/overview.html#content" target="_blank" rel="external">é“¾æ¥ç‚¹æˆ‘</a></p>
<h4 id="Invariant-js">Invariant.js</h4><p>é¦–å…ˆè®©æˆ‘ä»¬æ¥çœ‹ä¸‹Invariant.jsçš„ä»£ç å†…å®¹ï¼Œéå¸¸çŸ­ï¼š</p>
<pre><code><span class="pi">"use strict"</span>;

<span class="keyword">var</span> invariant = <span class="function"><span class="keyword">function</span>(<span class="params">condition, format, a, b, c, d, e, f</span>) </span>{
  <span class="number">1.</span> 
  <span class="keyword">if</span> (__DEV__) {
    <span class="keyword">if</span> (format === <span class="literal">undefined</span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'invariant requires an error message argument'</span>);
    }
  }

  <span class="number">2.</span> 
  <span class="keyword">if</span> (!condition) {
    <span class="keyword">var</span> error;
    <span class="keyword">if</span> (format === <span class="literal">undefined</span>) {
      error = <span class="keyword">new</span> <span class="built_in">Error</span>(
        <span class="string">'Minified exception occurred; use the non-minified dev environment '</span> +
        <span class="string">'for the full error message and additional helpful warnings.'</span>
      );
    } <span class="keyword">else</span> {
      <span class="keyword">var</span> args = [a, b, c, d, e, f];
      <span class="keyword">var</span> argIndex = <span class="number">0</span>;
      error = <span class="keyword">new</span> <span class="built_in">Error</span>(
        <span class="string">'Invariant Violation: '</span> +
        format.replace(<span class="regexp">/%s/g</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{ <span class="keyword">return</span> args[argIndex++]; })
      );
    }

    error.framesToPop = <span class="number">1</span>; <span class="comment">// we don't care about invariant's own frame</span>
    <span class="keyword">throw</span> error;
  }
};

<span class="built_in">module</span>.exports = invariant;
</code></pre><p>â€˜use strictâ€™ ä¸å¿…å¤šè¯´ï¼Œå°±æ˜¯æ„å»ºäº†ä¸€ä¸ªä¸¥æ ¼çš„JSçš„æ‰§è¡Œç¯å¢ƒã€‚<br>æ•´ä¸ªInvariant.jså…¶å®å°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°, åå­—å«Invariantï¼Œ ä»–çš„å‚æ•°åŒ…å«ä¸€ä¸ªconditionï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰ï¼Œä¸€ä¸ªè‡ªå®šä¹‰çš„æŠ¥é”™æ ¼å¼ï¼Œä»¥åŠä¸€ç³»åˆ—çš„è‡ªå®šä¹‰å‚æ•°ã€‚</p>
<p><b>ç¬¬ä¸€æ¬¡è¯»Flux.jsæºç çš„æ—¶å€™ï¼Œè¿™é‡Œé‡‡ç”¨çš„è¿˜æ˜¯argumentså¯å˜å‚æ•°çš„å®šä¹‰æ–¹å¼ï¼Œä»Šå¤©å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ç«Ÿç„¶å°±æ”¹å†™äº†ï¼Œæ™•ï¼</b></p>
<p>ç„¶åæˆ‘ä»¬æ¥åˆ†ä¸¤ä¸ªæ®µè½æŸ¥çœ‹ä¸‹å…¶ä¸­çš„ä»£ç å«ä¹‰ã€‚</p>
<p>ç¬¬ä¸€éƒ¨åˆ†ï¼Œå®šä¹‰äº†ä¸€ä¸ª<strong>dev</strong>å˜é‡ï¼Œè¿™ä¸ªå˜é‡å°±æ˜¯ä¸€ç§ç±»ä¼¼äºé…ç½®çš„ç¯å¢ƒå˜é‡ã€‚ç©è¿‡JavaScriptæˆ–è€…rubyçš„äººå¯èƒ½éƒ½æœ‰æ‰€äº†è§£ï¼Œæ¯”å¦‚éå¸¸è‘—åçš„â€™developmentâ€™, â€˜productâ€™, â€˜testâ€™å°±æ˜¯ä¸ä¹‹ç±»ä¼¼çš„ã€‚<br>å¦‚æœæ²¡æœ‰formatæ˜¯ä¸ªæœªå®šä¹‰çš„å˜é‡ï¼ˆåœ¨è¿™é‡Œå°±æ˜¯æ²¡æœ‰ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°ï¼‰ï¼Œé‚£ä¹ˆå°±ä¿ä¸ªé”™ã€‚</p>
<p>ç¬¬äºŒéƒ¨åˆ†ä¹Ÿå¾ˆç®€å•ï¼Œå¦‚æœconditionä¸ºå‡å€¼ï¼Œè¯´æ˜è¿™ä¸ªæ¡ä»¶æ²¡è¢«æ»¡è¶³ï¼Œé‚£ä¹ˆæ‰§è¡ŒæŠ¥é”™çš„åŠŸèƒ½ï¼ŒæŠ¥é”™çš„æ—¶å€™ä½¿ç”¨çš„æç¤ºæ ¼å¼å°±æ˜¯ä¼ å…¥çš„format, å‚æ•°åˆ™ä¸ºè‡ªå®šä¹‰çš„a-fã€‚</p>
<p>æ€»ä¹‹ï¼Œè¿™ä¸ªInvariant.jsçš„ä½œç”¨å°±æ˜¯æ„å»ºäº†ä¸€ä¸ªç±»ä¼¼<b>iOSä¸­NSAssert</b>çš„ä¸œè¥¿ã€‚</p>
<p>å“¦ï¼Œè¿™é‡Œè¦æŒ‡å‡ºä¸€ä¸‹ <b>/%s/g</b>è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œè¿™ç©æ„å•¥æ„æ€å‘¢ã€‚å…¶å®å°±ç±»ä¼¼äºæˆ‘ä»¬å¸¸å¸¸ç”¨çš„printfå‡½æ•°ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºï¼ŒæŠŠformatä¸­æ‰€æœ‰çš„%s, æ›¿æ¢æˆè‡ªå®šä¹‰çš„å‚æ•°ï¼Œgè¡¨ç¤ºä¸ºglobalã€‚</p>
<h4 id="é‡ç‚¹:Dispatcher-js">é‡ç‚¹:Dispatcher.js</h4><p>å†è®©æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹Dispatcher.jsï¼Œé—²è¯ä¸å¤šè¯ï¼Œä¸Šä»£ç ã€‚</p>
<pre><code><span class="pi">'use strict'</span>;

<span class="keyword">var</span> invariant = <span class="built_in">require</span>(<span class="string">'./invariant'</span>);

<span class="keyword">export</span> <span class="keyword">type</span> DispatchToken = <span class="built_in">string</span>;

<span class="keyword">var</span> _prefix = <span class="string">'ID_'</span>;

<span class="keyword">class</span> Dispatcher&lt;TPayload&gt; {
  _callbacks: {[key: DispatchToken]: (payload: TPayload) =&gt; <span class="built_in">void</span>};
  _isDispatching: <span class="built_in">boolean</span>;
  _isHandled: {[key: DispatchToken]: <span class="built_in">boolean</span>};
  _isPending: {[key: DispatchToken]: <span class="built_in">boolean</span>};
  _lastID: <span class="built_in">number</span>;
  _pendingPayload: TPayload;

  <span class="constructor"><span class="keyword">constructor</span>() </span>{
    <span class="keyword">this</span>._callbacks = {};
    <span class="keyword">this</span>._isDispatching = <span class="literal">false</span>;
    <span class="keyword">this</span>._isHandled = {};
    <span class="keyword">this</span>._isPending = {};
    <span class="keyword">this</span>._lastID = <span class="number">1</span>;
  }


  unregister(id: DispatchToken): <span class="built_in">void</span> {
    invariant(
      <span class="keyword">this</span>._callbacks[id],
      <span class="string">'Dispatcher.unregister(...): `%s` does not map to a registered callback.'</span>,
      id
    );
    <span class="keyword">delete</span> <span class="keyword">this</span>._callbacks[id];
  }

  waitFor(ids: <span class="built_in">Array</span>&lt;DispatchToken&gt;): <span class="built_in">void</span> {
    invariant(
      <span class="keyword">this</span>._isDispatching,
      <span class="string">'Dispatcher.waitFor(...): Must be invoked while dispatching.'</span>
    );
    <span class="keyword">for</span> (<span class="keyword">var</span> ii = <span class="number">0</span>; ii &lt; ids.length; ii++) {
      <span class="keyword">var</span> id = ids[ii];
      <span class="keyword">if</span> (<span class="keyword">this</span>._isPending[id]) {
        invariant(
          <span class="keyword">this</span>._isHandled[id],
          <span class="string">'Dispatcher.waitFor(...): Circular dependency detected while '</span> +
          <span class="string">'waiting for `%s`.'</span>,
          id
        );
        <span class="keyword">continue</span>;
      }
      invariant(
        <span class="keyword">this</span>._callbacks[id],
        <span class="string">'Dispatcher.waitFor(...): `%s` does not map to a registered callback.'</span>,
        id
      );
      <span class="keyword">this</span>._invokeCallback(id);
    }
  }

  dispatch(payload: TPayload): <span class="built_in">void</span> {
    invariant(
      !<span class="keyword">this</span>._isDispatching,
      <span class="string">'Dispatch.dispatch(...): Cannot dispatch in the middle of a dispatch.'</span>
    );
    <span class="keyword">this</span>._startDispatching(payload);
    <span class="keyword">try</span> {
      <span class="keyword">for</span> (<span class="keyword">var</span> id <span class="keyword">in</span> <span class="keyword">this</span>._callbacks) {
        <span class="keyword">if</span> (<span class="keyword">this</span>._isPending[id]) {
          <span class="keyword">continue</span>;
        }
        <span class="keyword">this</span>._invokeCallback(id);
      }
    } <span class="keyword">finally</span> {
      <span class="keyword">this</span>._stopDispatching();
    }
  }

  isDispatching(): <span class="built_in">boolean</span> {
    <span class="keyword">return</span> <span class="keyword">this</span>._isDispatching;
  }

  _invokeCallback(id: DispatchToken): <span class="built_in">void</span> {
    <span class="keyword">this</span>._isPending[id] = <span class="literal">true</span>;
    <span class="keyword">this</span>._callbacks[id](<span class="keyword">this</span>._pendingPayload);
    <span class="keyword">this</span>._isHandled[id] = <span class="literal">true</span>;
  }

  _startDispatching(payload: TPayload): <span class="built_in">void</span> {
    <span class="keyword">for</span> (<span class="keyword">var</span> id <span class="keyword">in</span> <span class="keyword">this</span>._callbacks) {
      <span class="keyword">this</span>._isPending[id] = <span class="literal">false</span>;
      <span class="keyword">this</span>._isHandled[id] = <span class="literal">false</span>;
    }
    <span class="keyword">this</span>._pendingPayload = payload;
    <span class="keyword">this</span>._isDispatching = <span class="literal">true</span>;
  }

  _stopDispatching(): <span class="built_in">void</span> {
    <span class="keyword">delete</span> <span class="keyword">this</span>._pendingPayload;
    <span class="keyword">this</span>._isDispatching = <span class="literal">false</span>;
  }
}

<span class="module"><span class="keyword">module</span>.exports = Dispatcher;</span>
</code></pre><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™å¥è¯ï¼š</p>
<pre><code><span class="keyword">export</span> <span class="keyword">type</span> DispatchToken = <span class="built_in">string</span>;
</code></pre><p>è¿™å…¶å®å°±æ˜¯ä¸€ä¸ªtypedefï¼Œé‚£ä¹ˆDispatchTokenæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå¦‚æœä½ æœ¬æ–‡æœ€ä¸Šæ–¹çš„Fluxè§£ç­”çš„è¯ï¼Œä½ å°±å¯ä»¥äº†è§£åˆ°ï¼Œå…¶å®ä¸€ä¸ªFluxçš„å›è°ƒä»£ç å—æœ‰å”¯ä¸€çš„ä¸€ä¸ªtokenï¼Œè¿™ä¸ªtokenå°±æ˜¯ç”¨æ¥è®©åˆ«äººInvokoeä½ ä»£ç çš„ã€‚</p>
<p>é‚£ä¹ˆè¿™ä¸ªDispatchTokenæ€ä¹ˆç¡®ä¿å”¯ä¸€å‘¢ï¼Ÿçœ‹ä¸‹é¢è¿™å¥è¯ï¼š</p>
<pre><code><span class="keyword">var</span> id = _prefix + <span class="keyword">this</span>._lastID++;
</code></pre><p>ç¬¬ä¸€æ„Ÿè§‰æ˜¯ä¸æ˜¯æƒ³ï¼Œæˆ‘äº†ä¸ªæ“¦ï¼Œæ€ä¹ˆé‚£ä¹ˆç®€å•ã€‚åæ¥æƒ³æƒ³ï¼ŒJavaScriptåœ¨æµè§ˆå™¨ä¸­æ‰§è¡Œå°±æ˜¯å•çº¿ç¨‹ï¼Œè¿™ç§è‡ªå¢IDçš„åšæ³•åˆå¿«åˆå®‰å…¨å‘ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥è§£é‡Šä¸€ä¸‹Dispatcherè¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»çš„ç›®çš„å¾ˆç®€å•ï¼Œå…­ä¸ªå­—å½’çº³ä¸€ä¸‹ï¼šå”¯ä¸€ï¼Œä¸­æ§ï¼Œåˆ†é…ã€‚<br>å¯ä»¥æŠŠä»–çœ‹æˆä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼Œæ‰€æœ‰çš„ä»»åŠ¡åˆ†å‘éƒ½å¿…é¡»ç”±è¿™ä¸ªç±»ç»Ÿä¸€æ§åˆ¶ã€‚</p>
<p>é‚£ä¹ˆï¼Œè¿™ä¸ªç±»ä¸­åŒ…å«äº†å“ªäº›ç©æ„å‘¢ï¼Ÿè®©æˆ‘ä»¬èµ¶å¿«æ¥ä¸€æ¢ç©¶ç«Ÿï¼</p>
<pre><code><span class="rule"><span class="attribute">_callbacks</span>:<span class="value"> {[key: DispatchToken]: (payload: TPayload) =&gt; void}</span></span>;
<span class="rule"><span class="attribute">_isDispatching</span>:<span class="value"> boolean</span></span>;
<span class="rule"><span class="attribute">_isHandled</span>:<span class="value"> {[key: DispatchToken]: boolean}</span></span>;
<span class="rule"><span class="attribute">_isPending</span>:<span class="value"> {[key: DispatchToken]: boolean}</span></span>;
<span class="rule"><span class="attribute">_lastID</span>:<span class="value"> number</span></span>;
<span class="rule"><span class="attribute">_pendingPayload</span>:<span class="value"> TPayload</span></span>;
</code></pre><ul>
<li>callbacksï¼Œå°±æ˜¯DispatchTokenå’Œå‡½æ•°å›è°ƒçš„ä¸€ä¸ªDictionaryã€‚</li>
<li>isDispatchingï¼Œä½“ç°å½“å‰Dispatcheræ˜¯å¦å¤„äºdispatchçŠ¶æ€ã€‚</li>
<li>isHandledï¼Œé€šè¿‡tokenå»æ£€æµ‹ä¸€ä¸ªå‡½æ•°æ˜¯å¦è¢«å¤„ç†è¿‡äº†ã€‚</li>
<li>isPendingï¼Œé€šè¿‡tokenå»æ£€æµ‹ä¸€ä¸ªå‡½æ•°æ˜¯å¦è¢«æäº¤Dispatcheräº†ã€‚</li>
<li>lastIDï¼Œæœ€è¿‘ä¸€æ¬¡è¢«åŠ å…¥Dispatcherçš„å‡½æ•°ä½“çš„UniqueIDï¼Œå³DispatchTokenã€‚</li>
<li>pendingPayloadï¼Œéœ€è¦ä¼ é€’ç»™è°ƒç”¨å‡½æ•°çš„å‚æ•°ï¼ŒiOSå¼€å‘è€…å¯ä»¥ç†è§£ä¸º<b>userInfo</b>ã€‚</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬ä¸€ä¸ªä¸ªå‡½æ•°æ¥çœ‹çœ‹ã€‚</p>
<pre><code><span class="keyword">register</span>(callback: (payload: TPayload) =&gt; <span class="keyword">void</span>): DispatchToken {
    var <span class="keyword">id</span> = _prefix + <span class="keyword">this</span><span class="variable">._lastID</span>++;
    <span class="keyword">this</span><span class="variable">._callbacks</span>[<span class="keyword">id</span>] = callback;
    <span class="keyword">return</span> <span class="keyword">id</span>;
}
</code></pre><p>è¿™å‡½æ•°å°±æ˜¯æ³¨å†Œä¸€ä¸ªcallbackè¿›å…¥dispatcherï¼ŒåŒæ—¶ä¸ºè¿™ä¸ªcallbackç”ŸæˆDispatchTokenï¼ŒåŠ å…¥å­—å…¸ã€‚</p>
<pre><code>unregister(<span class="property">id</span>: DispatchToken): void {
    invariant(
      this._callbacks[<span class="property">id</span>],
      'Dispatcher.unregister(...): `%s` <span class="keyword">does</span> <span class="keyword">not</span> map <span class="keyword">to</span> a registered callback.',
      <span class="property">id</span>
    );
    delete this._callbacks[<span class="property">id</span>];
}
</code></pre><p>æœ‰æ³¨å†Œå°±æœ‰å–æ¶ˆæ³¨å†Œï¼Œunregisterå°±æ˜¯é€šè¿‡DispatchTokenå°†æ³¨å†Œçš„callbackä»å­—å…¸ä¸­åˆ é™¤ã€‚å½“ç„¶äº†ï¼Œè¿™é‡Œä½¿ç”¨äº†æˆ‘ä»¬åœ¨ä¸Šæ–‡ä¸­æè¿‡çš„Invariantæ¥è¿›è¡Œä¸€ä¸ªåˆ¤æ–­ï¼šå³å­—å…¸ä¸­å¿…é¡»åŒ…å«å¯¹åº”è¿™ä¸ªDispatchTokençš„å‡½æ•°ã€‚</p>
<p>dispatchå‡½æ•°æ˜¯Dispatcherç”¨æ¥åˆ†å‘payloadçš„å‡½æ•°ã€‚</p>
<pre><code>dispatch(payload: TPayload): <span class="keyword">void</span> {
    invariant(
      !<span class="keyword">this</span>._isDispatching,
      <span class="string">'Dispatch.dispatch(...): Cannot dispatch in the middle of a dispatch.'</span>
    );
    <span class="keyword">this</span>._startDispatching(payload);
    <span class="keyword">try</span> {
      <span class="keyword">for</span> (<span class="keyword">var</span> id <span class="keyword">in</span> <span class="keyword">this</span>._callbacks) {
        <span class="keyword">if</span> (<span class="keyword">this</span>._isPending[id]) {
          <span class="keyword">continue</span>;
        }
        <span class="keyword">this</span>._invokeCallback(id);
      }
    } <span class="keyword">finally</span> {
      <span class="keyword">this</span>._stopDispatching();
    }
  }
</code></pre><p>æ•´ä¸ªå‡½æ•°çš„å«ä¹‰å°±æ˜¯ï¼Œé¦–å…ˆæ˜¯åˆ¤æ–­å½“å‰Dispatcheræ˜¯å¦å·²ç»å¤„äºDispatchingçŠ¶æ€ä¸­äº†ï¼Œå¦‚æœæ˜¯ï¼Œä¸èƒ½æ‰“æ–­ã€‚ç„¶åé€šè¿‡_startDispatchingæ›´æ–°çŠ¶æ€ã€‚æ›´æ–°çŠ¶æ€ç»“æŸä»¥åï¼Œå°†épendingçŠ¶æ€çš„callbackè¿›é€šè¿‡_invokeCallbackæ‰§è¡Œ<b>ï¼ˆpendingåœ¨è¿™é‡Œçš„å«ä¹‰å¯ä»¥ç®€å•ç†è§£ä¸ºï¼Œè¿˜æ²¡å‡†å¤‡å¥½æˆ–è€…è¢«å¡ä½äº†ï¼‰</b>ã€‚æ‰€æœ‰æ‰§è¡Œå®Œäº†ä»¥åï¼Œé€šè¿‡_stopDispatchingæ¢å¤çŠ¶æ€ã€‚</p>
<p>æ¥ä¸‹æ¥ä¾¿è®©æˆ‘ä¸€ä¸€æ¥çœ‹çœ‹å…¶ä¸­æ¶‰åŠçš„å‡ ä¸ªå‡½æ•°ï¼Œé¦–å…ˆæ˜¯_startDispatchingå‡½æ•°ã€‚</p>
<pre><code>_startDispatching(payload: TPayload): <span class="keyword">void</span> {
    <span class="keyword">for</span> (var <span class="keyword">id</span> <span class="keyword">in</span> <span class="keyword">this</span><span class="variable">._callbacks</span>) {
      <span class="keyword">this</span><span class="variable">._isPending</span>[<span class="keyword">id</span>] = <span class="literal">false</span>;
      <span class="keyword">this</span><span class="variable">._isHandled</span>[<span class="keyword">id</span>] = <span class="literal">false</span>;
    }
    <span class="keyword">this</span><span class="variable">._pendingPayload</span> = payload;
    <span class="keyword">this</span><span class="variable">._isDispatching</span> = <span class="literal">true</span>;
  }
</code></pre><p>é¦–å…ˆè¯¥å‡½æ•°å°†æ‰€æœ‰æ³¨å†Œçš„callbackçš„çŠ¶æ€éƒ½æ¸…ç©ºï¼Œå¹¶æ ‡è®°Dispatcherçš„çŠ¶æ€è¿›å…¥dispatchingã€‚</p>
<p>åŒæ ·ï¼Œä¸ä¹‹å¯¹åº”çš„æœ‰çš„_stopDispatchingï¼Œå‡½æ•°å¾ˆç®€å•ï¼Œä¸å…·ä½“è§£é‡Šäº†ã€‚</p>
<pre><code>_stopDispatching(): <span class="keyword">void</span> {
    <span class="keyword">delete</span> <span class="keyword">this</span>._pendingPayload;
    <span class="keyword">this</span>._isDispatching = <span class="literal">false</span>;
}
</code></pre><p>è€Œ_invokeCallbackå‡½æ•°ä¹Ÿå¾ˆç®€å•ï¼Œå½“çœŸæ­£è°ƒç”¨callbackä¹‹å‰å°†å…¶çŠ¶æ€è®¾ç½®ä¸ºpendingï¼Œæ‰§è¡Œå®Œæˆä¹‹åè®¾ç½®ä¸ºhandledã€‚<br>    _invokeCallback(id: DispatchToken): void {<br>        this._isPending[id] = true;<br>        this._callbacks<a href="this._pendingPayload">id</a>;<br>        this._isHandled[id] = true;<br>      }</p>
<p>è¯»åˆ°è¿™é‡Œï¼Œæœ‰äº›äººå¯èƒ½æœ‰äº›ç–‘é—®ï¼Œè¿™ä¸ªpendingåˆ°åº•æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œçœ‹äº†ä¸‹é¢è¿™ä¸ªæœ€é‡è¦çš„å‡½æ•°waitForï¼Œä½ å°±ä¼šäº†è§£ã€‚</p>
<pre><code>waitFor(ids: Array&lt;DispatchToken&gt;): void {
     <span class="number">1.</span> 
    invariant(
      this._isDispatching,
      'Dispatcher.waitFor(...): Must be invoked <span class="keyword">while</span> dispatching.'
    );

     <span class="number">2.</span>
    <span class="keyword">for</span> (var ii = <span class="number">0</span>; ii &lt; ids.<span class="property">length</span>; ii++) {
      var <span class="property">id</span> = ids[ii];
      <span class="keyword">if</span> (this._isPending[<span class="property">id</span>]) {
        <span class="number">3.</span> 
        invariant(
          this._isHandled[<span class="property">id</span>],
          'Dispatcher.waitFor(...): Circular dependency detected <span class="keyword">while</span> ' +
          'waiting <span class="keyword">for</span> `%s`.',
          <span class="property">id</span>
        );
        <span class="keyword">continue</span>;
      }
       <span class="number">4.</span>
      invariant(
        this._callbacks[<span class="property">id</span>],
        'Dispatcher.waitFor(...): `%s` <span class="keyword">does</span> <span class="keyword">not</span> map <span class="keyword">to</span> a registered callback.',
        <span class="property">id</span>
      );

      <span class="number">5.</span>
      this._invokeCallback(<span class="property">id</span>);
    }
  }
</code></pre><p>è¿™ä¸ªwaitForå•¥æ„æ€å‘¢ï¼Ÿæˆ‘ä»¬é¦–å…ˆçœ‹ä¸‹ä»–çš„å‚æ•°ï¼Œä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢å…¨æ˜¯DispatchTokenã€‚å†çœ‹ä¸‹å®ç°ã€‚</p>
<ul>
<li>é¦–å…ˆæ˜¯ä¸€ä¸ªInvariantåˆ¤æ–­å½“å‰å¿…é¡»å¤„äºDispatchingçŠ¶æ€ã€‚ä¸€å¼€å§‹æ¯”è¾ƒéš¾ç†è§£ï¼Œç®€å•æ¥è¯´å°±æ˜¯ï¼Œå¦‚æœä¸å¤„äºDispatchingçŠ¶æ€ä¸­ï¼Œé‚£ä¹ˆè¯´æ˜å‹æ ¹æ²¡æœ‰å‡½æ•°åœ¨æ‰§è¡Œï¼Œé‚£ä½ ç­‰è°å‘¢ï¼Ÿ</li>
<li>ç„¶åè¯¥å‡½æ•°ä»DispatchTokençš„æ•°ç»„ä¸­è¿›è¡Œéå†ï¼Œå¦‚æœéå†åˆ°çš„DispatchTokenå¤„äºpendingçŠ¶æ€ï¼Œå°±æš‚æ—¶è·³è¿‡ä»–ã€‚</li>
<li>ä½†æ˜¯ï¼Œåœ¨è¿™æœ‰ä¸ªå¿…è¦çš„å¾ªç¯ä»¥æ¥çš„æ£€æŸ¥ï¼Œè¯•æƒ³å¦‚ä¸‹æƒ…å†µï¼Œå¦‚æœAå‡½æ•°ä»¥æ¥Bçš„Token, Bå‡½æ•°ä¾èµ–Açš„Tokenï¼Œå°±ä¼šé€ æˆâ€œæ­»é”â€ã€‚<b>æ‰€ä»¥ï¼Œå½“ä¸€ä¸ªå‡½æ•°ä¾èµ–çš„å¯¹è±¡å¤„äºpendingï¼Œè¯´æ˜è¿™ä¸ªå‡½æ•°å·²ç»è¢«å¼€å§‹æ‰§è¡Œäº†ï¼Œä½†æ˜¯å¦‚æœåŒæ—¶è¯¥å‡½æ•°æ²¡æœ‰è¿›å…¥handledçŠ¶æ€ï¼Œè¯´æ˜è¯¥å‡½æ•°ä¹Ÿè¢«å¡æ­»äº†ã€‚</b></li>
<li>æ£€æŸ¥tokenå¯¹åº”çš„callbackæ˜¯å¦å­˜åœ¨</li>
<li>è°ƒç”¨è¿™ä¸ªtokenå¯¹åº”çš„å‡½æ•°ã€‚</li>
</ul>
<p>ä»ä¸Šè¯‰æ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒwaitForå°±æ˜¯ä¸€ä¸ªç­‰å¾…å‡½æ•°ï¼Œå½“Bæ‰§è¡Œï¼Œæ‰§è¡Œåˆ°æŸäº›æ¡ä»¶ä¸æ»¡è¶³çš„æ—¶å€™ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸ºä¾èµ–æ²¡è§£å†³ï¼‰ï¼Œå°±æ˜¯ç­‰å¾…ä¾èµ–å»å®Œæˆï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¦‚ä¸‹å‡½æ•°ä»£è¡¨çš„æ„æ€ï¼š</p>
<pre><code><span class="keyword">while</span> (!satisfied) ; <span class="keyword">do</span>Something
</code></pre><p>åˆ°è¿™é‡Œï¼Œå·®ä¸å¤šDispatcher.jså°±è§£é‡Šå®Œäº†ï¼Œä¸‹æ¬¡ç»§ç»­ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/09/23/flux-js-part-one/" data-id="cjqdxq1wt000tmxi18iv1zvvd" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/09/23/flux-js-part-one/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-code-of-JSONModel" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/09/17/code-of-JSONModel/" class="article-date">
  <time datetime="2015-09-17T12:52:12.000Z" itemprop="datePublished">2015-09-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/09/17/code-of-JSONModel/">JSONModelæºç è§£æ</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="èƒŒæ™¯ä»‹ç»">èƒŒæ™¯ä»‹ç»</h3><p>ç°åœ¨çš„ç§»åŠ¨AppåŸºæœ¬ä¸Šå…ä¸äº†å’Œç½‘ç»œä¼ è¾“æ‰“äº¤é“ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å’ŒæœåŠ¡å™¨è¿›è¡Œæ•°æ®çš„ä¼ è¾“ï¼Œå¸¸ç”¨çš„æ•°æ®æ ¼å¼æ— å¤–ä¹XMLæˆ–è€…JSONã€‚è¿™ä¹Ÿå°±å¼•å‡ºäº†ä¸€ä¸ªæ–°çš„è¯é¢˜ï¼Œå¦‚ä½•å°†è·å¾—çš„æ•°æ®å®é™…åº”ç”¨åˆ°æˆ‘ä»¬çš„Appä¸­ï¼Ÿç­”æ¡ˆå¾ˆç®€å•ï¼Œå»ºç«‹Modelã€‚æˆ‘ä»¬æ‹¿åˆ°çš„ç½‘ç»œä¼ è¾“æ•°æ®ï¼Œæ— éå°±æ˜¯ä¸€ç§ä»¥JSONæ ¼å¼æ ‡å‡†åˆ’åˆ†çš„å­—ç¬¦ä¸²ç½¢äº†ï¼Œæˆ‘ä»¬éœ€è¦å°†å­—ç¬¦ä¸²è§£æåˆ°ç›¸åº”çš„å­—æ®µä¸­æ¥ï¼Œå¦åˆ™å¦‚æœæ¯æ¬¡æˆ‘ä»¬éƒ½éœ€è¦ç›´æ¥å’Œç½‘ç»œå­—ç¬¦ä¸²æ‰“äº¤é“ï¼Œé‚£ä¹Ÿå¤ªå¤æ‚äº†ã€‚åœ¨åˆšå­¦ä¹ iOSå¼€å‘çš„æ—¶å€™ï¼Œé‚£ä¸ªæ—¶å€™çœ‹äº†Stanfordè€çˆ·çˆ·è®²çš„å¼€å‘æ•™ç¨‹ï¼Œé‡Œé¢åœ¨æ¶‰åŠ<b>Core Data</b>çš„ç« èŠ‚æ›¾ç»å†™è¿‡è¿™æ ·çš„ä¸€æ®µä»£ç ï¼š</p>
<pre><code>+ (XXXModel *)insertModelWithDictionary:(<span class="built_in">NSDictionary</span> *)dict inContext:(<span class="built_in">NSManagedObjectContext</span> *)context
{
    <span class="keyword">if</span> (dict == <span class="literal">nil</span> || ![dict isKindOf[<span class="built_in">NSDictionary</span> class]]) <span class="keyword">return</span> <span class="literal">nil</span>;

    XXXModel *model = [XXXModel getByIdentifier:[dict objectForKey:<span class="string">@"id"</span>] inContext:context];
    <span class="keyword">if</span> (!model) {
        model = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"XXXModel"</span> 
                                              inManagedObjectContext:context];
    }

    model<span class="variable">.identifier</span> = [dict objectForKey:<span class="string">@"id"</span>];
    model<span class="variable">.name</span>       = [dict objectForKey:<span class="string">@"name"</span>];
    model<span class="variable">.age</span>        = [dict objectForKey:<span class="string">@"age"</span>];

    <span class="comment">// è®¸å¤šè®¸å¤šå±æ€§ </span>
    ......
    ......
    ......

    <span class="keyword">return</span> model;
}

+ (XXXModel *)getByIdentifier:(<span class="built_in">NSString</span> *)identifier inContext:(<span class="built_in">NSManagedObjectContext</span> *)context
{
    <span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"XXXModel"</span>];
    [request setPredicate:[<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"identifier == %@"</span>, identifier]];

    XXXModel *model = [[context executeFetchRequest:request error:<span class="literal">nil</span>] lastObject];
    <span class="keyword">return</span> model;
}
</code></pre><p>å½“æ—¶ä¸€ç›´ä»¥ä¸ºè¿™ä¸ªæ˜¯<b>åœ£ç»å¼çš„å†™æ³•</b>ï¼Œä¸€ç›´åšæŒç€ï¼Œç›´åˆ°åæ¥æˆ‘æ¥è§¦åˆ°äº†<b>Mantle</b>ã€‚å½“ç„¶ï¼Œä»Šå¤©è¿™ç¯‡æ–‡ç« è¯´çš„ä¸æ˜¯Mantleï¼Œè€Œæ˜¯å¦å¤–ä¸€ä¸ªç±»ä¼¼çš„å¼€æºåº“ï¼š<b>JSONModel</b></p>
<h3 id="JSONModel">JSONModel</h3><p>æ—¢ç„¶è¦è§£æå®ƒï¼Œé¦–å…ˆå…ˆæ”¾ä¸Šä»–çš„ä»£ç åœ°å€ä»¥ç¤ºå°Šé‡ï¼š<a href="https://github.com/icanzilb/JSONModel" target="_blank" rel="external">ç‚¹æˆ‘ç‚¹æˆ‘!</a></p>
<p>ä»Githubä¸Šçš„ä»‹ç»æ¥çœ‹ï¼Œåˆ©ç”¨JSONModelï¼Œæˆ‘ä»¬å¯ä»¥èŠ‚çœå¤§é‡çš„æ—¶é—´ï¼Œå®ƒä¼šåˆ©ç”¨ç±»ä¼¼äºåå°„(Introspect)çš„æœºåˆ¶ï¼Œå¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨å°†JSONçš„æ•°æ®è§£ææˆModelçš„å­—æ®µã€‚</p>
<p>å®ƒçš„ç”¨æ³•ä¹Ÿå¾ˆç®€å•ï¼Œæ¯”å¦‚æœ‰å¦‚ä¸‹è¿™æ ·çš„JSONæ•°æ®ï¼š</p>
<pre><code>{"<span class="attribute">id</span>":<span class="value"><span class="string">"10"</span></span>, "<span class="attribute">country</span>":<span class="value"><span class="string">"Germany"</span></span>, "<span class="attribute">dialCode</span>": <span class="value"><span class="number">49</span></span>, "<span class="attribute">isInEurope</span>":<span class="value"><span class="literal">true</span></span>}
</code></pre><p>ä½ åªéœ€è¦å»ºç«‹å¦‚ä¸‹è¿™æ ·çš„Modelï¼š</p>
<pre><code><span class="preprocessor">#import <span class="title">"JSONModel.h"</span></span>

<span class="class"><span class="keyword">@interface</span> <span class="title">CountryModel</span> : <span class="title">JSONModel</span></span>

<span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="keyword">int</span> <span class="keyword">id</span>;
<span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span>* country;
<span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span>* dialCode;
<span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> isInEurope;

<span class="keyword">@end</span>
</code></pre><p>ç„¶ååƒè¿™æ ·ï¼š</p>
<pre><code>NSString<span class="keyword">*</span> json = (fetch here JSON from Internet) ... 
NSError<span class="keyword">*</span> err = nil;
CountryModel<span class="keyword">*</span> country = [[CountryModel alloc] initWithString:json error:&amp;err];
</code></pre><p>å˜¿å˜¿ï¼ŒJSONçš„æ•°æ®å°±æˆåŠŸå¾—è¢«è§£æåˆ°countryè¿™ä¸ªå˜é‡çš„å¯¹åº”å­—æ®µä¸Šäº†ï¼</p>
<p>æ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ï¼Ÿè®©æˆ‘ä»¬èµ¶å¿«æ¥ä¸€æ¢èƒŒåçš„åŸç†å§ï¼ï¼ï¼</p>
<h3 id="æºç åˆ†æ">æºç åˆ†æ</h3><p>ä¸‹è½½æºä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ ¼å¼çš„åŒ…å†…å®¹ï¼š</p>
<pre>
-- JSONModel
   -- JSONModel.h/.m
   -- JSONModelArray.h/.m
   -- JSONModelClassProperty.h/.m
   -- JSONModelError.h/.m
-- JSONModelCategories
   -- NSArray+JSONModel.h/.m
-- JSONModelNetworking
   -- ç•¥
-- JSONModelTransformations
   -- JSONKeyMapper.h/.m
   -- JSONValueTransformer.h/.m
</pre>

<p>æˆ‘ä»¬æŠŠJSONModelNetworkingä¸­çš„å†…å®¹ç•¥è¿‡ï¼Œå› ä¸ºåŸºæœ¬å°±æ˜¯ç½‘ç»œä¼ è¾“çš„ä¸œè¥¿ï¼Œä¸æ˜¯æˆ‘ä»¬äº†è§£çš„é‡ç‚¹ã€‚</p>
<h4 id="JSONModelæ–‡ä»¶">JSONModelæ–‡ä»¶</h4><p>JSONModelæ˜¯æˆ‘ä»¬è¦è®²è§£çš„é‡ç‚¹ï¼Œæˆ‘ä»¬é¦–å…ˆä»å®ƒçš„åˆå§‹åŒ–æ–¹æ³•è°ˆèµ·ã€‚</p>
<pre><code><span class="pp">-<span class="params">(instancetype)</span>initWithString:<span class="params">(<span class="variable">NSString</span>*)</span>string error:<span class="params">(<span class="variable">JSONModelError</span>**)</span>err;
-<span class="params">(instancetype)</span>initWithString:<span class="params">(<span class="variable">NSString</span> *)</span>string usingEncoding:<span class="params">(<span class="variable">NSStringEncoding</span>)</span>encoding error:<span class="params">(<span class="variable">JSONModelError</span>**)</span>err;
-<span class="params">(instancetype)</span>initWithDictionary:<span class="params">(<span class="variable">NSDictionary</span>*)</span>dict error:<span class="params">(<span class="variable">NSError</span> **)</span>err;
-<span class="params">(instancetype)</span>initWithData:<span class="params">(<span class="variable">NSData</span> *)</span>data error:<span class="params">(<span class="variable">NSError</span> **)</span>error;</span>
</code></pre><p>ç²—ç•¥ä¸€çœ‹ï¼Œå››ä¸ªåˆå§‹åŒ–æ–¹æ³•ï¼Œå¤ªå¯æ€•äº†ã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“åœ¨iOSçš„è®¾è®¡ç†å¿µé‡Œï¼Œæœ‰ä¸€ç§designated initializerçš„è¯´æ³•ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬æŒ‘ä¸€ä¸ª<b>initWithDictionary</b>çœ‹èµ·ã€‚</p>
<h5 id="initWithDictionary">initWithDictionary</h5><pre><code>-(<span class="keyword">id</span>)initWithDictionary:(<span class="built_in">NSDictionary</span>*)dict error:(<span class="built_in">NSError</span>**)err
{
    <span class="number">1.</span> <span class="comment">//check for nil input</span>
    <span class="keyword">if</span> (!dict) {
        <span class="keyword">if</span> (err) *err = [JSONModelError errorInputIsNil];
        <span class="keyword">return</span> <span class="literal">nil</span>;
    }

    <span class="number">2.</span> <span class="comment">//invalid input, just create empty instance</span>
    <span class="keyword">if</span> (![dict isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) {
        <span class="keyword">if</span> (err) *err = [JSONModelError errorInvalidDataWithMessage:<span class="string">@"Attempt to initialize JSONModel object using initWithDictionary:error: but the dictionary parameter was not an 'NSDictionary'."</span>];
        <span class="keyword">return</span> <span class="literal">nil</span>;
    }

    <span class="number">3.</span> <span class="comment">//create a class instance</span>
    <span class="keyword">self</span> = [<span class="keyword">self</span> init];
    <span class="keyword">if</span> (!<span class="keyword">self</span>) {

        <span class="comment">//super init didn't succeed</span>
        <span class="keyword">if</span> (err) *err = [JSONModelError errorModelIsInvalid];
        <span class="keyword">return</span> <span class="literal">nil</span>;
    }
    <span class="comment">// Class infoClass = NSClassFromString([NSString stringWithFormat:@"%@Info", NSStringFromClass(class)]);</span>
    <span class="number">4.</span> <span class="comment">//check incoming data structure</span>
    <span class="keyword">if</span> (![<span class="keyword">self</span> __doesDictionary:dict matchModelWithKeyMapper:<span class="keyword">self</span><span class="variable">.__keyMapper</span> error:err]) {
        <span class="keyword">return</span> <span class="literal">nil</span>;
    }

    <span class="number">5.</span> <span class="comment">//import the data from a dictionary</span>
    <span class="keyword">if</span> (![<span class="keyword">self</span> __importDictionary:dict withKeyMapper:<span class="keyword">self</span><span class="variable">.__keyMapper</span> validation:<span class="literal">YES</span> error:err]) {
        <span class="keyword">return</span> <span class="literal">nil</span>;
    }

    <span class="number">6.</span> <span class="comment">//run any custom model validation</span>
    <span class="keyword">if</span> (![<span class="keyword">self</span> validate:err]) {
        <span class="keyword">return</span> <span class="literal">nil</span>;
    }

    <span class="number">7.</span> <span class="comment">//model is valid! yay!</span>
    <span class="keyword">return</span> <span class="keyword">self</span>;
}
</code></pre><p>æˆ‘ä»¬åˆ†ä¸ƒæ­¥æ¥è§£æè¿™ä¸ªå‡½æ•°ï¼š</p>
<ul>
<li>æ£€æŸ¥å‚æ•°dictæ˜¯ä¸æ˜¯ç©ºï¼Œæ˜¯ç©ºç›´æ¥è§£æå¤±è´¥</li>
<li>æ£€æŸ¥å‚æ•°dictæ˜¯ä¸æ˜¯NSDictionaryæˆ–å…¶å­ç±»çš„å®ä¾‹ï¼Œæ˜¯ç©ºç›´æ¥è§£æå¤±è´¥</li>
<li><b>å…³é”®æ­¥éª¤</b>ï¼šåˆ›å»ºJSONModelï¼Œåˆ›å»ºå¤±è´¥ç›´æ¥æ»šç²—ï¼Œåƒä¸‡åˆ«å°çœ‹è¿™ä¸€æ­¥å“¦ï¼Œå…·ä½“æˆ‘ä»¬ä¸‹æ–‡è¯´</li>
<li><b>å…³é”®æ­¥éª¤</b>ï¼šè¿™æ˜¯ä¸€ä¸ªé€šè¿‡æ£€æŸ¥æ˜¯ä¸æ˜¯æœ‰æ²¡è¢«æ˜ å°„åˆ°çš„propertyçš„è¿‡ç¨‹ï¼Œå¦‚æœæœ‰å­˜åœ¨ç–æ¼çš„propertyï¼Œé‚£ä¹ˆä¼šå¯¼è‡´è§£æå¤±è´¥ï¼Œè§¦å‘Crash</li>
<li><b>å…³é”®æ­¥éª¤</b>ï¼šè¿™æ˜¯çœŸæ­£å°†è§£æçš„å€¼å¯¹åº”çš„èµ‹äºˆModelçš„propertyçš„é˜¶æ®µ</li>
<li>è¿›è¡Œè‡ªå®šä¹‰çš„æ£€æŸ¥å·¥ä½œï¼Œæ¯”å¦‚é¿å…ç›´æ¥è§¦å‘Crashä¹‹ç±»çš„</li>
<li>å¾—åˆ°äº†æ­£ç¡®çš„modelï¼Œè¿”å›ç»™ç¨‹åºä½¿ç”¨ã€‚</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬æ¥ç€é‡åˆ†ææœ€é‡è¦çš„ä¸‰ä¸ªæ­¥éª¤</p>
<h5 id="é‡ç‚¹1:_ç¬¬ä¸‰æ­¥_[self_init]">é‡ç‚¹1: ç¬¬ä¸‰æ­¥ [self init]</h5><p>[self init]çš„ä»£ç è°ƒç”¨äº†initåˆå§‹åŒ–å‡½æ•°ï¼Œå®ç°å¦‚ä¸‹ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨çš„æ˜¯å…¶ä¸­<em>[self <strong>setup</strong>]</em></p>
<pre><code>- (id)init
{
    <span class="keyword">self</span> = [<span class="keyword">super</span> init];
    <span class="keyword">if</span> (<span class="keyword">self</span>) {
        <span class="regexp">//do</span> initial <span class="class"><span class="keyword">class</span> <span class="title">setup</span></span>
        [<span class="keyword">self</span> __setup__];
    }
    <span class="keyword">return</span> <span class="keyword">self</span>;
}
</code></pre><p>æ¥çœ‹çœ‹setupçš„å®ç°ï¼Œ</p>
<pre><code>- (<span class="keyword">void</span>)__setup__
{
    <span class="comment">//if first instance of this model, generate the property list</span>
    <span class="keyword">if</span> (!objc_getAssociatedObject(<span class="keyword">self</span><span class="variable">.class</span>, &amp;kClassPropertiesKey)) {
        [<span class="keyword">self</span> __inspectProperties];
    }

    <span class="comment">//if there's a custom key mapper, store it in the associated object</span>
    <span class="keyword">id</span> mapper = [[<span class="keyword">self</span> class] keyMapper];
    <span class="keyword">if</span> ( mapper &amp;&amp; !objc_getAssociatedObject(<span class="keyword">self</span><span class="variable">.class</span>, &amp;kMapperObjectKey) ) {
        objc_setAssociatedObject(
                                 <span class="keyword">self</span><span class="variable">.class</span>,
                                 &amp;kMapperObjectKey,
                                 mapper,
                                 OBJC_ASSO<span class="built_in">CIATION_RETAIN</span> <span class="comment">// This is atomic</span>
                                 );
    }
}
</code></pre><p>WoW! What are è¿™ä¸ªå‡½æ•°å¼„å•¥ç±»ï¼Ÿçœ‹èµ·æ¥å¾ˆå“äººï¼Ÿåˆ«æ€•ï¼Œè®©æˆ‘æ¥ä¸€ä¸ªä¸ªè§£é‡Šã€‚</p>
<p><b>objc_getAssociatedObjectæƒ³å¿…å¤§å®¶éƒ½ä¸ä¼šé™Œç”Ÿï¼Œè¿™å°±æ˜¯ä¸€ä¸ªAssociate Objectï¼Œæˆ‘ä»¬ç»å¸¸ç”¨è¿™ç§æ–¹æ³•åœ¨Categoryç»™ä¸€ä¸ªç±»æ·»åŠ propertyã€‚</b></p>
<p>æ‰€ä»¥ï¼Œç¬¬ä¸€ä¸ªifçš„æ„æ€å°±æ˜¯ï¼Œæˆ‘æ ¹æ®kClassPropertiesKeyè¿™ä¸ªkeyï¼Œå»å½“å‰ç±»çš„Associate Objectæ‰¾property listï¼Œå¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°±è¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œè§£æï¼Œæ‰€ä»¥æˆ‘è¦è‡ªå·±å»ºç«‹ä¸€ä¸ªã€‚æ‰€ä»¥æˆ‘ä»¬èµ¶ç´§è¿›å…¥<br>__inspectPropertiesä¸€æ¢ç©¶ç«Ÿï¼</p>
<pre><code>- (<span class="keyword">void</span>)__inspectProperties
{
    <span class="comment">//JMLog(@"Inspect class: %@", [self class]);</span>

    <span class="built_in">NSMutableDictionary</span>* propertyIndex = [<span class="built_in">NSMutableDictionary</span> dictionary];

    <span class="comment">//temp variables for the loops</span>
    Class class = [<span class="keyword">self</span> class];
    <span class="built_in">NSScanner</span>* scanner = <span class="literal">nil</span>;
    <span class="built_in">NSString</span>* propertyType = <span class="literal">nil</span>;

    <span class="comment">// inspect inherited properties up to the JSONModel class</span>
    <span class="keyword">while</span> (class != [JSONModel class]) {
        <span class="comment">//JMLog(@"inspecting: %@", NSStringFromClass(class));</span>

        <span class="keyword">unsigned</span> <span class="keyword">int</span> propertyCount;
        objc_property_t *properties = class_copyPropertyList(class, &amp;propertyCount);

        <span class="comment">//loop over the class properties</span>
        <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; propertyCount; i++) {

            JSONModelClassProperty* p = [[JSONModelClassProperty alloc] init];
            <span class="comment">//get property name</span>
            objc_property_t property = properties[i];
            <span class="keyword">const</span> <span class="keyword">char</span> *propertyName = property_getName(property);
            p<span class="variable">.name</span> = @(propertyName);

            <span class="comment">//JMLog(@"property: %@", p.name);</span>

            <span class="comment">//get property attributes</span>
            <span class="keyword">const</span> <span class="keyword">char</span> *attrs = property_getAttributes(property);
            <span class="built_in">NSString</span>* propertyAttributes = @(attrs);
            <span class="built_in">NSArray</span>* attributeItems = [propertyAttributes componentsSeparatedByString:<span class="string">@","</span>];

            <span class="comment">//ignore read-only properties</span>
            <span class="keyword">if</span> ([attributeItems containsObject:<span class="string">@"R"</span>]) {
                <span class="keyword">continue</span>; <span class="comment">//to next property</span>
            }

            <span class="comment">//check for 64b BOOLs</span>
            <span class="keyword">if</span> ([propertyAttributes hasPrefix:<span class="string">@"Tc,"</span>]) {
                <span class="comment">//mask BOOLs as structs so they can have custom convertors</span>
                p<span class="variable">.structName</span> = <span class="string">@"BOOL"</span>;
            }

            scanner = [<span class="built_in">NSScanner</span> scannerWithString: propertyAttributes];

            <span class="comment">//JMLog(@"attr: %@", [NSString stringWithCString:attrs encoding:NSUTF8StringEncoding]);</span>
            [scanner scanUpToString:<span class="string">@"T"</span> intoString: <span class="literal">nil</span>];
            [scanner scanString:<span class="string">@"T"</span> intoString:<span class="literal">nil</span>];

            <span class="comment">//check if the property is an instance of a class</span>
            <span class="keyword">if</span> ([scanner scanString:<span class="string">@"@\""</span> intoString: &amp;propertyType]) {

                [scanner scanUpToCharactersFromSet:[<span class="built_in">NSCharacterSet</span> characterSetWithCharactersInString:<span class="string">@"\"&lt;"</span>]
                                        intoString:&amp;propertyType];

                <span class="comment">//JMLog(@"type: %@", propertyClassName);</span>
                p<span class="variable">.type</span> = <span class="built_in">NSClassFromString</span>(propertyType);
                p<span class="variable">.isMutable</span> = ([propertyType rangeOfString:<span class="string">@"Mutable"</span>]<span class="variable">.location</span> != <span class="built_in">NSNotFound</span>);
                p<span class="variable">.isStandardJSONType</span> = [allowedJSONTypes containsObject:p<span class="variable">.type</span>];

                <span class="comment">//read through the property protocols</span>
                <span class="keyword">while</span> ([scanner scanString:<span class="string">@"&lt;"</span> intoString:<span class="literal">NULL</span>]) {

                    <span class="built_in">NSString</span>* protocolName = <span class="literal">nil</span>;

                    [scanner scanUpToString:<span class="string">@"&gt;"</span> intoString: &amp;protocolName];

                    <span class="keyword">if</span> ([protocolName isEqualToString:<span class="string">@"Optional"</span>]) {
                        p<span class="variable">.isOptional</span> = <span class="literal">YES</span>;
                    } <span class="keyword">else</span> <span class="keyword">if</span>([protocolName isEqualToString:<span class="string">@"Index"</span>]) {
                        p<span class="variable">.isIndex</span> = <span class="literal">YES</span>;
                        objc_setAssociatedObject(
                                                 <span class="keyword">self</span><span class="variable">.class</span>,
                                                 &amp;kIndexPropertyNameKey,
                                                 p<span class="variable">.name</span>,
                                                 OBJC_ASSO<span class="built_in">CIATION_RETAIN</span> <span class="comment">// This is atomic</span>
                                                 );
                    } <span class="keyword">else</span> <span class="keyword">if</span>([protocolName isEqualToString:<span class="string">@"ConvertOnDemand"</span>]) {
                        p<span class="variable">.convertsOnDemand</span> = <span class="literal">YES</span>;
                    } <span class="keyword">else</span> <span class="keyword">if</span>([protocolName isEqualToString:<span class="string">@"Ignore"</span>]) {
                        p = <span class="literal">nil</span>;
                    } <span class="keyword">else</span> {
                        p<span class="variable">.protocol</span> = protocolName;
                    }

                    [scanner scanString:<span class="string">@"&gt;"</span> intoString:<span class="literal">NULL</span>];
                }

            }
            <span class="comment">//check if the property is a structure</span>
            <span class="keyword">else</span> <span class="keyword">if</span> ([scanner scanString:<span class="string">@"{"</span> intoString: &amp;propertyType]) {
                [scanner scanCharactersFromSet:[<span class="built_in">NSCharacterSet</span> alphanumericCharacterSet]
                                    intoString:&amp;propertyType];

                p<span class="variable">.isStandardJSONType</span> = <span class="literal">NO</span>;
                p<span class="variable">.structName</span> = propertyType;

            }
            <span class="comment">//the property must be a primitive</span>
            <span class="keyword">else</span> {

                <span class="comment">//the property contains a primitive data type</span>
                [scanner scanUpToCharactersFromSet:[<span class="built_in">NSCharacterSet</span> characterSetWithCharactersInString:<span class="string">@","</span>]
                                        intoString:&amp;propertyType];

                <span class="comment">//get the full name of the primitive type</span>
                propertyType = valueTransformer<span class="variable">.primitivesNames</span>[propertyType];

                <span class="keyword">if</span> (![allowedPrimitiveTypes containsObject:propertyType]) {

                    <span class="comment">//type not allowed - programmer mistaked -&gt; exception</span>
                    <span class="keyword">@throw</span> [<span class="built_in">NSException</span> exceptionWithName:<span class="string">@"JSONModelProperty type not allowed"</span>
                                                   reason:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"Property type of %@.%@ is not supported by JSONModel."</span>, <span class="keyword">self</span><span class="variable">.class</span>, p<span class="variable">.name</span>]
                                                 userInfo:<span class="literal">nil</span>];
                }

            }

            <span class="built_in">NSString</span> *nsPropertyName = @(propertyName);
            <span class="keyword">if</span>([[<span class="keyword">self</span> class] propertyIsOptional:nsPropertyName]){
                p<span class="variable">.isOptional</span> = <span class="literal">YES</span>;
            }

            <span class="keyword">if</span>([[<span class="keyword">self</span> class] propertyIsIgnored:nsPropertyName]){
                p = <span class="literal">nil</span>;
            }

            <span class="comment">//few cases where JSONModel will ignore properties automatically</span>
            <span class="keyword">if</span> ([propertyType isEqualToString:<span class="string">@"Block"</span>]) {
                p = <span class="literal">nil</span>;
            }

            <span class="comment">//add the property object to the temp index</span>
            <span class="keyword">if</span> (p &amp;&amp; ![propertyIndex objectForKey:p<span class="variable">.name</span>]) {
                [propertyIndex setValue:p forKey:p<span class="variable">.name</span>];
            }
        }

        free(properties);

        <span class="comment">//ascend to the super of the class</span>
        <span class="comment">//(will do that until it reaches the root class - JSONModel)</span>
        class = [class superclass];
    }

    <span class="comment">//finally store the property index in the static property index</span>
    objc_setAssociatedObject(
                             <span class="keyword">self</span><span class="variable">.class</span>,
                             &amp;kClassPropertiesKey,
                             [propertyIndex <span class="keyword">copy</span>],
                             OBJC_ASSO<span class="built_in">CIATION_RETAIN</span> <span class="comment">// This is atomic</span>
                             );
}
</code></pre><p>è¿™ä¹ˆå¤šä»£ç ï¼Œå…¶å®æ€»ç»“èµ·æ¥å°±å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>è·å–å½“å‰ç±»çš„çš„property listï¼Œé€šè¿‡class_copyPropertyList runtimeçš„æ–¹æ³•</li>
<li><p>éå†æ¯ä¸€ä¸ªproperyï¼Œè§£æä»–ä»¬çš„å±æ€§ï¼Œè¿™é‡Œçš„å±æ€§åŒ…æ‹¬æ˜¯å¦åªè¯»ã€ç±»å‹ã€æ˜¯å¦æ˜¯weakç±»å‹ï¼Œæ˜¯å¦æ˜¯åŸå­æ€§çš„ç­‰ç­‰ï¼Œå¦‚æœä¸äº†è§£ï¼Œå¯ä»¥çœ‹å¦‚ä¸‹çš„è¡¨æ ¼ï¼š</p>
<p>  | Code        | Meaning          |<br>  | :â€”â€”â€”â€”-: |:â€”â€”â€”â€”-<br>  | R      | The property is read-only (readonly).<br>  | C      | The property is a copy of the value last assigned (copy).<br>  | &amp; | The property is a reference to the value last assigned (retain).<br>  | N | The property is non-atomic (nonatomic).<br>  | G<name> | The property defines a custom getter selector name. The name follows the G (for example, GcustomGetter,).<br>  | S<name> | The property defines a custom setter selector name. The name follows the S (for example, ScustomSetter:,).<br>  | D | The property is dynamic (@dynamic).<br>  | W | The property is a weak reference (__weak).<br>  | P | The property is eligible for garbage collection.<br>  | t<encoding> | Specifies the type using old-style encoding.</encoding></name></name></p>
</li>
<li><p>æ ¹æ®è§£æç»“æœï¼Œæ£€æµ‹æ˜¯ä¸æ˜¯åˆæ³•ï¼Œå¦‚æœåˆæ³•åˆ›å»ºå¯¹åº”çš„JSONModelClassPropertyå¹¶èµ‹å€¼ç›¸åº”çš„å±æ€§å€¼ã€‚</p>
</li>
<li><p>ç„¶åé‡å¤æ‰§è¡Œï¼ŒæŸ¥çœ‹å®Œå½“å‰çš„ç±»å°±å»æŸ¥è¯¢å…¶çˆ¶ç±»ï¼Œç›´åˆ°æ²¡æœ‰ä¸ºæ­¢ã€‚</p>
</li>
<li><p>æœ€åå°†è§£æå‡ºæ¥çš„property listé€šè¿‡Associate Objectç»™èµ‹å€¼ï¼Œè¿™å’Œæˆ‘ä»¬åˆšåˆšåœ¨<strong>setup</strong>ä¸­çœ‹åˆ°çš„ç›¸å‘¼åº”ã€‚</p>
</li>
</ul>
<p>åŒæ ·ï¼Œé™„ä¸Šå…³äºpropertyå±æ€§çš„<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html" target="_blank" rel="external">è‹¹æœçš„å®˜æ–¹æ–‡æ¡£é“¾æ¥</a></p>
<p>è¿™ä¸€æ­¥åŸºæœ¬å°±è§£é‡Šå®Œäº†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹ä¸€æ­¥ã€‚</p>
<h5 id="é‡ç‚¹2:_ç¬¬å››æ­¥___doesDictionary:(NSDictionary)dict_matchModelWithKeyMapper:(JSONKeyMapper)keyMapper_error:(NSError**)err">é‡ç‚¹2: ç¬¬å››æ­¥ __doesDictionary:(NSDictionary<em>)dict matchModelWithKeyMapper:(JSONKeyMapper</em>)keyMapper error:(NSError**)err</h5><p>è€æ ·å­ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä»–çš„å®ç°ï¼š</p>
<pre><code>-(<span class="built_in">BOOL</span>)__doesDictionary:(<span class="built_in">NSDictionary</span>*)dict matchModelWithKeyMapper:(JSONKeyMapper*)keyMapper error:(<span class="built_in">NSError</span>**)err
{
    <span class="comment">//check if all required properties are present</span>
    <span class="built_in">NSArray</span>* incomingKeysArray = [dict allKeys];
    <span class="built_in">NSMutableSet</span>* requiredProperties = [<span class="keyword">self</span> __requiredPropertyNames]<span class="variable">.mutableCopy</span>;
    <span class="built_in">NSSet</span>* incomingKeys = [<span class="built_in">NSSet</span> setWithArray: incomingKeysArray];

    <span class="comment">//transform the key names, if neccessary</span>
    <span class="keyword">if</span> (keyMapper || globalKeyMapper) {

        <span class="built_in">NSMutableSet</span>* transformedIncomingKeys = [<span class="built_in">NSMutableSet</span> setWithCapacity: requiredProperties<span class="variable">.count</span>];
        <span class="built_in">NSString</span>* transformedName = <span class="literal">nil</span>;

        <span class="comment">//loop over the required properties list</span>
        <span class="keyword">for</span> (JSONModelClassProperty* property <span class="keyword">in</span> [<span class="keyword">self</span> __properties__]) {

            transformedName = (keyMapper||globalKeyMapper) ? [<span class="keyword">self</span> __mapString:property<span class="variable">.name</span> withKeyMapper:keyMapper importing:<span class="literal">YES</span>] : property<span class="variable">.name</span>;

            <span class="comment">//chek if exists and if so, add to incoming keys</span>
            <span class="keyword">id</span> value;
            <span class="keyword">@try</span> {
                value = [dict valueForKeyPath:transformedName];
            }
            <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) {
                value = dict[transformedName];
            }

            <span class="keyword">if</span> (value) {
                [transformedIncomingKeys addObject: property<span class="variable">.name</span>];
            }
        }

        <span class="comment">//overwrite the raw incoming list with the mapped key names</span>
        incomingKeys = transformedIncomingKeys;
    }

    <span class="comment">//check for missing input keys</span>
    <span class="keyword">if</span> (![requiredProperties isSubsetOfSet:incomingKeys]) {

        <span class="comment">//get a list of the missing properties</span>
        [requiredProperties minusSet:incomingKeys];

        <span class="comment">//not all required properties are in - invalid input</span>
        JMLog(<span class="string">@"Incoming data was invalid [%@ initWithDictionary:]. Keys missing: %@"</span>, <span class="keyword">self</span><span class="variable">.class</span>, requiredProperties);

        <span class="keyword">if</span> (err) *err = [JSONModelError errorInvalidDataWithMissingKeys:requiredProperties];
        <span class="keyword">return</span> <span class="literal">NO</span>;
    }

    <span class="comment">//not needed anymore</span>
    incomingKeys= <span class="literal">nil</span>;
    requiredProperties= <span class="literal">nil</span>;

    <span class="keyword">return</span> <span class="literal">YES</span>;
}
</code></pre><p>æŠ›å¼€æˆ‘ä»¬æš‚æ—¶è¿˜ä¸ç†Ÿæ‚‰çš„keyMapper(<b>ç”¨è¿‡Mantleçš„äººä¼°è®¡æœ‰ä¸€å®šäº†è§£ã€‚</b>)ï¼Œæ•´ä¸ªå‡½æ•°éå¸¸å®¹æ˜“ç†è§£ã€‚æˆ‘ä»¬é¦–å…ˆè·å–æˆ‘ä»¬ä¼ å…¥çš„ä»£è¡¨JSONæ•°æ®çš„Dictionaryï¼Œç„¶åå’Œæˆ‘ä»¬è§£æå‡ºæ¥çš„property listè¿›è¡Œå¯¹æ¯”ï¼ˆåŸºäºNSSetï¼‰ï¼Œ<b>å¦‚æœå¾—åˆ°property listå®¤Dictionaryçš„è¶…é›†ï¼Œæ„å‘³ç€JSONä¸­çš„æ•°æ®ä¸èƒ½å®Œå…¨è¦†ç›–æˆ‘ä»¬ç”Ÿå‘½çš„å±æ€§ï¼Œè¯´æ˜æˆ‘ä»¬æœ‰å±æ€§å¾—ä¸åˆ°èµ‹å€¼ï¼Œå› æ­¤ä¼šåˆ¤æ–­å‡ºé”™ã€‚</b>åœ¨é»˜è®¤çš„å®ç°ä¸­ï¼Œå¦‚æœå‡ºç°æ²¡åŒ¹é…çš„å®ç°ï¼Œå°±æ˜¯å¯¼è‡´Crash</p>
<h5 id="é‡ç‚¹2:_ç¬¬äº”æ­¥___importDictionary:(NSDictionary)dict_withKeyMapper:(JSONKeyMapper)keyMapper_validation:(BOOL)validation_error:(NSError**)err">é‡ç‚¹2: ç¬¬äº”æ­¥ __importDictionary:(NSDictionary<em>)dict withKeyMapper:(JSONKeyMapper</em>)keyMapper validation:(BOOL)validation error:(NSError**)err</h5><p>ç»§ç»­çœ‹å®ç°ï¼š</p>
<pre><code>-(<span class="built_in">BOOL</span>)__importDictionary:(<span class="built_in">NSDictionary</span>*)dict withKeyMapper:(JSONKeyMapper*)keyMapper validation:(<span class="built_in">BOOL</span>)validation error:(<span class="built_in">NSError</span>**)err
{
    <span class="comment">//loop over the incoming keys and set self's properties</span>
    <span class="keyword">for</span> (JSONModelClassProperty* property <span class="keyword">in</span> [<span class="keyword">self</span> __properties__]) {

        <span class="comment">//convert key name ot model keys, if a mapper is provided</span>
        <span class="built_in">NSString</span>* jsonKeyPath = (keyMapper||globalKeyMapper) ? [<span class="keyword">self</span> __mapString:property<span class="variable">.name</span> withKeyMapper:keyMapper importing:<span class="literal">YES</span>] : property<span class="variable">.name</span>;
        <span class="comment">//JMLog(@"keyPath: %@", jsonKeyPath);</span>

        <span class="comment">//general check for data type compliance</span>
        <span class="keyword">id</span> jsonValue;
        <span class="keyword">@try</span> {
            jsonValue = [dict valueForKeyPath: jsonKeyPath];
        }
        <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) {
            jsonValue = dict[jsonKeyPath];
        }

        <span class="comment">//check for Optional properties</span>
        <span class="keyword">if</span> (isNull(jsonValue)) {
            <span class="comment">//skip this property, continue with next property</span>
            <span class="keyword">if</span> (property<span class="variable">.isOptional</span> || !validation) <span class="keyword">continue</span>;

            <span class="keyword">if</span> ([property<span class="variable">.type</span> isSubclassOfClass:[JSONModel class]]) {
                <span class="built_in">NSMutableDictionary</span> *infoKey = [<span class="built_in">NSMutableDictionary</span> new];
                <span class="keyword">for</span> (<span class="built_in">NSString</span> *name <span class="keyword">in</span> dict<span class="variable">.allKeys</span>) {
                    <span class="keyword">id</span> value = [dict objectForKey:name];
                    <span class="built_in">NSMutableString</span> *ignoredCaseName = [<span class="built_in">NSMutableString</span> stringWithString:[name lowercaseString]];
                    <span class="built_in">NSString</span> *ignoredCaseKey  = [property<span class="variable">.name</span> lowercaseString];

                    <span class="built_in">NSRange</span> range = [ignoredCaseName rangeOfString:ignoredCaseKey];
                    <span class="keyword">if</span> (range<span class="variable">.location</span> != <span class="built_in">NSNotFound</span>) {
                        [ignoredCaseName deleteCharactersInRange:range];
                        <span class="built_in">NSString</span> *newPropertyName = [ignoredCaseName <span class="keyword">copy</span>];
                        <span class="keyword">if</span> (!isNull(value)) {
                            [infoKey setObject:value forKey:newPropertyName];
                        }
                    }
                }

                jsonValue = [infoKey <span class="keyword">copy</span>];
            }

            <span class="keyword">if</span> (err &amp;&amp; isNull(jsonValue)) {
                <span class="comment">//null value for required property</span>
                <span class="built_in">NSString</span>* msg = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"Value of required model key %@ is null"</span>, property<span class="variable">.name</span>];
                JSONModelError* dataErr = [JSONModelError errorInvalidDataWithMessage:msg];
                *err = [dataErr errorByPrependingKeyPathComponent:property<span class="variable">.name</span>];

                <span class="keyword">return</span> <span class="literal">NO</span>;
            }
        }

        Class jsonValueClass = [jsonValue class];
        <span class="built_in">BOOL</span> isValueOfAllowedType = <span class="literal">NO</span>;

        <span class="keyword">for</span> (Class allowedType <span class="keyword">in</span> allowedJSONTypes) {
            <span class="keyword">if</span> ( [jsonValueClass isSubclassOfClass: allowedType] ) {
                isValueOfAllowedType = <span class="literal">YES</span>;
                <span class="keyword">break</span>;
            }
        }

        <span class="keyword">if</span> (isValueOfAllowedType==<span class="literal">NO</span>) {
            <span class="comment">//type not allowed</span>
            JMLog(<span class="string">@"Type %@ is not allowed in JSON."</span>, <span class="built_in">NSStringFromClass</span>(jsonValueClass));

            <span class="keyword">if</span> (err) {
                <span class="built_in">NSString</span>* msg = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"Type %@ is not allowed in JSON."</span>, <span class="built_in">NSStringFromClass</span>(jsonValueClass)];
                JSONModelError* dataErr = [JSONModelError errorInvalidDataWithMessage:msg];
                *err = [dataErr errorByPrependingKeyPathComponent:property<span class="variable">.name</span>];
            }
            <span class="keyword">return</span> <span class="literal">NO</span>;
        }

        <span class="comment">//check if there's matching property in the model</span>
        <span class="keyword">if</span> (property) {

            <span class="comment">// check for custom setter, than the model doesn't need to do any guessing</span>
            <span class="comment">// how to read the property's value from JSON</span>
            <span class="keyword">if</span> ([<span class="keyword">self</span> __customSetValue:jsonValue forProperty:property]) {
                <span class="comment">//skip to next JSON key</span>
                <span class="keyword">continue</span>;
            };

            <span class="comment">// 0) handle primitives</span>
            <span class="keyword">if</span> (property<span class="variable">.type</span> == <span class="literal">nil</span> &amp;&amp; property<span class="variable">.structName</span>==<span class="literal">nil</span>) {

                <span class="comment">//generic setter</span>
                <span class="keyword">if</span> (jsonValue != [<span class="keyword">self</span> valueForKey:property<span class="variable">.name</span>]) {
                    [<span class="keyword">self</span> setValue:jsonValue forKey: property<span class="variable">.name</span>];
                }

                <span class="comment">//skip directly to the next key</span>
                <span class="keyword">continue</span>;
            }

            <span class="comment">// 0.5) handle nils</span>
            <span class="keyword">if</span> (isNull(jsonValue)) {
                <span class="keyword">if</span> ([<span class="keyword">self</span> valueForKey:property<span class="variable">.name</span>] != <span class="literal">nil</span>) {
                    [<span class="keyword">self</span> setValue:<span class="literal">nil</span> forKey: property<span class="variable">.name</span>];
                }
                <span class="keyword">continue</span>;
            }


            <span class="comment">// 1) check if property is itself a JSONModel</span>
            <span class="keyword">if</span> ([<span class="keyword">self</span> __isJSONModelSubClass:property<span class="variable">.type</span>]) {

                <span class="comment">//initialize the property's model, store it</span>
                JSONModelError* initErr = <span class="literal">nil</span>;
                <span class="keyword">id</span> value = [[property<span class="variable">.type</span> alloc] initWithDictionary: jsonValue error:&amp;initErr];

                <span class="keyword">if</span> (!value) {
                    <span class="comment">//skip this property, continue with next property</span>
                    <span class="keyword">if</span> (property<span class="variable">.isOptional</span> || !validation) <span class="keyword">continue</span>;

                    <span class="comment">// Propagate the error, including the property name as the key-path component</span>
                    <span class="keyword">if</span>((err != <span class="literal">nil</span>) &amp;&amp; (initErr != <span class="literal">nil</span>))
                    {
                        *err = [initErr errorByPrependingKeyPathComponent:property<span class="variable">.name</span>];
                    }
                    <span class="keyword">return</span> <span class="literal">NO</span>;
                }
                <span class="keyword">if</span> (![value isEqual:[<span class="keyword">self</span> valueForKey:property<span class="variable">.name</span>]]) {
                    [<span class="keyword">self</span> setValue:value forKey: property<span class="variable">.name</span>];
                }

                <span class="comment">//for clarity, does the same without continue</span>
                <span class="keyword">continue</span>;

            } <span class="keyword">else</span> {

                <span class="comment">// 2) check if there's a protocol to the property</span>
                <span class="comment">//  ) might or not be the case there's a built in transofrm for it</span>
                <span class="keyword">if</span> (property<span class="variable">.protocol</span>) {

                    <span class="comment">//JMLog(@"proto: %@", p.protocol);</span>
                    jsonValue = [<span class="keyword">self</span> __transform:jsonValue forProperty:property error:err];
                    <span class="keyword">if</span> (!jsonValue) {
                        <span class="keyword">if</span> ((err != <span class="literal">nil</span>) &amp;&amp; (*err == <span class="literal">nil</span>)) {
                            <span class="built_in">NSString</span>* msg = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"Failed to transform value, but no error was set during transformation. (%@)"</span>, property];
                            JSONModelError* dataErr = [JSONModelError errorInvalidDataWithMessage:msg];
                            *err = [dataErr errorByPrependingKeyPathComponent:property<span class="variable">.name</span>];
                        }
                        <span class="keyword">return</span> <span class="literal">NO</span>;
                    }
                }

                <span class="comment">// 3.1) handle matching standard JSON types</span>
                <span class="keyword">if</span> (property<span class="variable">.isStandardJSONType</span> &amp;&amp; [jsonValue isKindOfClass: property<span class="variable">.type</span>]) {

                    <span class="comment">//mutable properties</span>
                    <span class="keyword">if</span> (property<span class="variable">.isMutable</span>) {
                        jsonValue = [jsonValue mutableCopy];
                    }

                    <span class="comment">//set the property value</span>
                    <span class="keyword">if</span> (![jsonValue isEqual:[<span class="keyword">self</span> valueForKey:property<span class="variable">.name</span>]]) {
                        [<span class="keyword">self</span> setValue:jsonValue forKey: property<span class="variable">.name</span>];
                    }
                    <span class="keyword">continue</span>;
                }

                <span class="comment">// 3.3) handle values to transform</span>
                <span class="keyword">if</span> (
                    (![jsonValue isKindOfClass:property<span class="variable">.type</span>] &amp;&amp; !isNull(jsonValue))
                    ||
                    <span class="comment">//the property is mutable</span>
                    property<span class="variable">.isMutable</span>
                    ||
                    <span class="comment">//custom struct property</span>
                    property<span class="variable">.structName</span>
                    ) {

                    <span class="comment">// searched around the web how to do this better</span>
                    <span class="comment">// but did not find any solution, maybe that's the best idea? (hardly)</span>
                    Class sourceClass = [JSONValueTransformer classByResolvingClusterClasses:[jsonValue class]];

                    <span class="comment">//JMLog(@"to type: [%@] from type: [%@] transformer: [%@]", p.type, sourceClass, selectorName);</span>

                    <span class="comment">//build a method selector for the property and json object classes</span>
                    <span class="built_in">NSString</span>* selectorName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@From%@:"</span>,
                                              (property<span class="variable">.structName</span>? property<span class="variable">.structName</span> : property<span class="variable">.type</span>), <span class="comment">//target name</span>
                                              sourceClass]; <span class="comment">//source name</span>
                    SEL selector = <span class="built_in">NSSelectorFromString</span>(selectorName);

                    <span class="comment">//check for custom transformer</span>
                    <span class="built_in">BOOL</span> foundCustomTransformer = <span class="literal">NO</span>;
                    <span class="keyword">if</span> ([valueTransformer respondsToSelector:selector]) {
                        foundCustomTransformer = <span class="literal">YES</span>;
                    } <span class="keyword">else</span> {
                        <span class="comment">//try for hidden custom transformer</span>
                        selectorName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"__%@"</span>,selectorName];
                        selector = <span class="built_in">NSSelectorFromString</span>(selectorName);
                        <span class="keyword">if</span> ([valueTransformer respondsToSelector:selector]) {
                            foundCustomTransformer = <span class="literal">YES</span>;
                        }
                    }

                    <span class="comment">//check if there's a transformer with that name</span>
                    <span class="keyword">if</span> (foundCustomTransformer) {

                        <span class="comment">//it's OK, believe me...</span>
<span class="preprocessor">#pragma clang diagnostic push</span>
<span class="preprocessor">#pragma clang diagnostic ignored <span class="title">"-Warc-performSelector-leaks"</span></span>
                        <span class="comment">//transform the value</span>
                        jsonValue = [valueTransformer performSelector:selector withObject:jsonValue];
<span class="preprocessor">#pragma clang diagnostic pop</span>

                        <span class="keyword">if</span> (![jsonValue isEqual:[<span class="keyword">self</span> valueForKey:property<span class="variable">.name</span>]]) {
                            [<span class="keyword">self</span> setValue:jsonValue forKey: property<span class="variable">.name</span>];
                        }

                    } <span class="keyword">else</span> {

                        <span class="comment">// it's not a JSON data type, and there's no transformer for it</span>
                        <span class="comment">// if property type is not supported - that's a programmer mistaked -&gt; exception</span>
                        <span class="keyword">@throw</span> [<span class="built_in">NSException</span> exceptionWithName:<span class="string">@"Type not allowed"</span>
                                                       reason:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@ type not supported for %@.%@"</span>, property<span class="variable">.type</span>, [<span class="keyword">self</span> class], property<span class="variable">.name</span>]
                                                     userInfo:<span class="literal">nil</span>];
                        <span class="keyword">return</span> <span class="literal">NO</span>;
                    }

                } <span class="keyword">else</span> {
                    <span class="comment">// 3.4) handle "all other" cases (if any)</span>
                    <span class="keyword">if</span> (![jsonValue isEqual:[<span class="keyword">self</span> valueForKey:property<span class="variable">.name</span>]]) {
                        [<span class="keyword">self</span> setValue:jsonValue forKey: property<span class="variable">.name</span>];
                    }
                }
            }
        }
    }

    <span class="keyword">return</span> <span class="literal">YES</span>;
}
</code></pre><p>è¿™ä¸€ä¸ªå‡½æ•°çœ‹ç€å“äººï¼Œå…¶å®éå¸¸å®¹æ˜“ç†è§£ã€‚æ ¹æ®æˆ‘ä»¬åˆšåˆšå¾—åˆ°çš„property listï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªå–å‡ºæ¥ï¼Œç”¨property nameä½œä¸ºkeyï¼Œæ¥æŸ¥è¯¢åœ¨å¯¹åº”çš„JSONå­—å…¸ä¸­çš„valueã€‚ç„¶ååˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªæƒ…å†µï¼š</p>
<ul>
<li>æ£€æŸ¥æ˜¯ä¸æ˜¯ç©ºå€¼ã€‚å¦‚æœè¯¥å±æ€§æ˜¯optionalï¼Œé‚£ä¹ˆæ— æ‰€è°“ã€‚å¦‚æœä¸èƒ½ä¸ºç©ºï¼Œé‚£ä¹ˆæŠ›å‡ºé”™è¯¯ã€‚</li>
<li>æ£€æŸ¥è¿™ä¸ªå€¼æ˜¯ä¸æ˜¯åˆæ³•çš„JSONç±»å‹ï¼Œå¦‚æœä¸æ˜¯ï¼ŒæŠ›å‡ºé”™è¯¯ã€‚</li>
<li>å¦‚æœpropertyæ˜¯éè‡ªå®šä¹‰JSONModelå­ç±»çš„å­—æ®µï¼ŒåŸºäºKey-Valueèµ‹å€¼ï¼Œå½“ç„¶ï¼Œä½ å¯ä»¥è‡ªå·±override setterã€‚</li>
<li>å¦‚æœæ˜¯è‡ªå®šä¹‰çš„JSONModelå­ç±»æ˜¯ï¼Œåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„æ–°ç±»ï¼Œè§£æå¯¹åº”çš„valueã€‚</li>
<li>å¦‚æœå†ä¸è¡Œï¼Œè¿›è¡Œä¸€ç³»åˆ—çš„åˆ¤æ–­å’Œåˆ©ç”¨JSONValueTransformerè¿›è¡Œç±»å‹è½¬æ¢è¿›è¡Œè§£æã€‚</li>
</ul>
<p>ä¸ºä»€ä¹ˆè¦è¿›è¡ŒJSONValueTransformerçš„è½¬æ¢å‘¢ï¼Œæ˜¯å› ä¸ºåœ¨iOSçš„è§†çº¿ä¸­ï¼Œç”±äºæŠ½è±¡å·¥å‚çš„å­˜åœ¨ï¼Œæ„å»ºäº†å¤§é‡çš„ç°‡ç±»ï¼Œæ¯”å¦‚NSArray, NSNumber, NSDictionaryç­‰ç­‰ï¼Œä»–ä»¬åªæ˜¯å¯¹å¤–æš´éœ²çš„ä¸€å±‚çš®ï¼Œå®è´¨ä¸Šåº•å±‚å¯¹äºçœŸæ­£çš„ç±»ã€‚æ¯”å¦‚NSArrayI &lt;=&gt; NSArrayç­‰ç­‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡JSONValueTransformerå¾—åˆ°çœŸæ­£çš„Class Typeï¼ŒåŒæ—¶é€šè¿‡class Typeæ‰¾åˆ°æœ€åˆé€‚çš„è½¬æ¢æ–¹æ³•ï¼Œåœ¨JSONValueTransformer.mçš„æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬èƒ½æ‰¾åˆ°ä¸€å¤§å †<b>xxxFromYYY</b>çš„å‡½æ•°ã€‚</p>
<p>å¥½äº†ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼ŒJSONModelçš„æºç è§£è¯»å°±å·®ä¸å¤šäº†ï¼Œä¸‹å‘¨å¸¦æ¥SDWebImageCacheçš„è§£è¯»ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/09/17/code-of-JSONModel/" data-id="cjqdxq1xu0011mxi1bk52hhgj" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/09/17/code-of-JSONModel/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
    <article id="post-A-New-Start" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/09/11/A-New-Start/" class="article-date">
  <time datetime="2015-09-11T04:15:55.000Z" itemprop="datePublished">2015-09-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/09/11/A-New-Start/">iOSä¸‹è½½æ¨¡å—çš„å®ç°</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>è¿™æ˜¯æˆ‘åœ¨å®ä¹ çš„æ—¶å€™å¯¹äºä¸€ä¸ªä¸‹è½½æ¨¡å—çš„å®ç°ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹å¿ƒå¾—ä½“ä¼šã€‚è¿™ä¸ªæ¨¡å—å®Œå…¨ç‹¬ç«‹å®ç°ï¼Œä¸”ä¸ä¾èµ–äºå…¬å¸ä»»ä½•çš„ä»£ç ï¼Œä¸ä¼šæ¶‰åŠä»»ä½•éšç§ã€‚</p>
<h3 id="ä¸‹è½½æ¨¡å—çš„éœ€æ±‚">ä¸‹è½½æ¨¡å—çš„éœ€æ±‚</h3><p>åœ¨å®ç°ä¸€ä¸ªæ–°æ¨¡å—ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç†æ¸…æ¥šè¿™ä¸ªæ¨¡å—éœ€è¦æ”¯æŒæœ€å°çš„åŠŸèƒ½é›†ï¼Œå¹¶é€æ­¥æ‰©å±•ã€‚å¹¶ä¸”ç”±äºä¸‹è½½æ¨¡å—æ˜¯å­˜åœ¨æ½œåœ¨çš„å¯èƒ½æ€§è¢«å¤šä¸ªæ¨¡å—è°ƒç”¨ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ç‰¹åˆ«è¦æ³¨æ„æ¨¡å—çš„å°è£…ã€‚</p>
<h4 id="åŠŸèƒ½éœ€æ±‚">åŠŸèƒ½éœ€æ±‚</h4><h5 id="æ”¯æŒä¸‹è½½">æ”¯æŒä¸‹è½½</h5><p>   ä¸‹è½½æ¨¡å—æœ€åŸºæœ¬çš„è‡ªç„¶å°±æ˜¯å¯ä»¥æ­£ç¡®çš„å°†éœ€è¦ä¸‹è½½çš„ä¸œè¥¿ä¸‹è½½åˆ°æŒ‡å®šè·¯å¾„ï¼Œè¿™é‡Œä¸‹è½½çš„ä¸œè¥¿åŒ…æ‹¬ä½†æ˜¯ä¸å±€é™äºå›¾ç‰‡ã€æ–‡æœ¬æ–‡æ¡£ã€å‹ç¼©æ–‡ä»¶ç­‰ç­‰ã€‚å› æ­¤ï¼Œè¿™äº›ä¸‹è½½ä¸œè¥¿çš„å¤§å°æ˜¯ä¸ç­‰çš„ï¼Œåœ¨è®¾è®¡åŠŸèƒ½çš„æ—¶å€™ï¼Œéœ€è¦è®²è¿™ç‚¹è€ƒè™‘è¿›å»ã€‚</p>
<h5 id="æ”¯æŒå–æ¶ˆä¸‹è½½">æ”¯æŒå–æ¶ˆä¸‹è½½</h5><p>   å¤„äºæ§åˆ¶è§’åº¦çš„è€ƒè™‘ï¼Œç”šè‡³æ˜¯å‡ºäºå½“æµé‡å’Œèµ„æºèŠ‚çœçš„è§’åº¦è€ƒè™‘ï¼Œæˆ‘ä»¬éƒ½å·²ç»å¯¹ä¸‹è½½ä»»åŠ¡æœ‰æ§åˆ¶æƒã€‚å¯ä»¥éšæ—¶æ ¹æ®æˆ‘ä»¬ä¸šåŠ¡å¤„äºçš„çŠ¶æ€ï¼Œå¯¹ä¸‹è½½ä»»åŠ¡è¿›è¡Œæš‚åœæˆ–è€…å®Œæ•´çš„åœæ­¢å–æ¶ˆã€‚</p>
<h5 id="æ”¯æŒå¹¶å‘ä¸‹è½½">æ”¯æŒå¹¶å‘ä¸‹è½½</h5><p>   ä¸‹è½½ä»»åŠ¡çš„ä¸ªæ•°è‚¯å®šä¸ä¼šåªæœ‰ä¸€ä¸ªï¼Œè€Œæ˜¯å¯èƒ½åŒæ—¶å­˜åœ¨å¤šä¸ªã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°±éœ€è¦è€ƒè™‘å¦‚ä½•å»æ”¯æŒå¤šä¸ªä¸‹è½½ä»»åŠ¡åŒæ—¶å¹¶å‘çš„ä¸‹è½½ã€‚å…¶å¤–ï¼Œæˆ‘ä»¬è¿˜è¦è€ƒè™‘åˆ°æ½œåœ¨çš„ä»»åŠ¡ä¹‹é—´çš„å…³è”æ€§å’Œä¾èµ–æ€§ï¼ˆæ¯”å¦‚Bä¸‹è½½ä»»åŠ¡éœ€è¦ä¾èµ–äºAä¸‹è½½ä»»åŠ¡çš„å®Œæˆï¼‰</p>
<p>åˆæ­¥çš„ä»»åŠ¡æˆ‘ä»¬å¯ä»¥è®¤ä¸ºå°±æ˜¯å¦‚ä¸Šä¸‰ä¸ªå°±å¯ä»¥ï¼ˆ<b>åˆæœŸè®¾è®¡æ¨¡å—çœŸçš„ä¸è¦è€ƒè™‘è¿‡å¤šåŠŸèƒ½ï¼Œå…ˆå¼€å§‹åšèµ·æ¥ï¼Œä¸€ç‚¹ç‚¹çœ‹ç€è‡ªå·±é€ çš„è½®å­å¯ä»¥è¿è½¬èµ·æ¥ï¼Œæˆå°±æ„Ÿä¼šä¿ƒä½¿ä½ ä¼šä¸åœçš„å»å®Œå–„ã€‚å½“ç„¶ï¼Œä½ çš„ä»£ç ä¸€å®šè¦å†™çš„æ•´æ´æ˜“è¯»ï¼</b>ï¼‰</p>
        
          <p class="article-more-link">
            <a href="/2015/09/11/A-New-Start/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://satanwoo.github.io/2015/09/11/A-New-Start/" data-id="cjqdxq1tw0000mxi1by75xkix" class="article-share-link">Share</a>
      
        <a href="http://satanwoo.github.io/2015/09/11/A-New-Start/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://satanwoo-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
    </nav>
  
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Growth/">Growth</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Machine-Learning/">Machine Learning</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/">Math</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Performance/">Performance</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/R/">R</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Reverse-Engineering/">Reverse Engineering</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swift/">Swift</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XNU/">XNU</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS/">iOS</a><span class="tag-list-count">38</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/">shell</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 10px;">Android</a> <a href="/tags/C/" style="font-size: 10px;">C</a> <a href="/tags/Growth/" style="font-size: 10px;">Growth</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Machine-Learning/" style="font-size: 10px;">Machine Learning</a> <a href="/tags/Math/" style="font-size: 10px;">Math</a> <a href="/tags/Performance/" style="font-size: 10px;">Performance</a> <a href="/tags/R/" style="font-size: 12.5px;">R</a> <a href="/tags/Reverse-Engineering/" style="font-size: 17.5px;">Reverse Engineering</a> <a href="/tags/Swift/" style="font-size: 17.5px;">Swift</a> <a href="/tags/XNU/" style="font-size: 12.5px;">XNU</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/01/01/Synchronized/">æŠ›å¼€æ€§èƒ½ï¼Œè°ˆè°ˆä¸è¯¥ç”¨@Synchronizedçš„åŸå› </a>
          </li>
        
          <li>
            <a href="/2018/12/22/LD-1/">é€šè¿‡Xcode 10é“¾æ¥libstdc++æ¥æ·±å…¥åˆ†ætbdæ–‡ä»¶</a>
          </li>
        
          <li>
            <a href="/2018/10/06/JSDebugger-INTRO/">è°ˆè°ˆJSDebugger</a>
          </li>
        
          <li>
            <a href="/2018/05/09/MNIST/">C++å®ç°ä¸€ä¸ªè¯†åˆ«MNISTæ•°å­—çš„å·ç§¯ç¥ç»ç½‘ç»œ</a>
          </li>
        
          <li>
            <a href="/2018/04/01/jsengine/">åŠ¨æ‰‹åˆ¶ä½œä¸€ä¸ªç®€æ˜“çš„iOSåŠ¨æ€æ‰§è¡Œå™¨</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 SatanWoo<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/sitemap.xml" class="mobile-nav-link">map</a>
  
</nav>
    
<script>
  var disqus_shortname = 'satanwoo-2';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>